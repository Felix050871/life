{% extends "base.html" %}

{% block title %}Statistiche - Workly{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-chart-bar me-2"></i>Statistiche e Reportistica
        </h1>
        <div class="btn-group">
            <button class="btn btn-outline-primary" id="exportBtn">
                <i class="fas fa-download me-1"></i>Esporta Dati
            </button>
            <button class="btn btn-outline-secondary" onclick="window.print()">
                <i class="fas fa-print me-1"></i>Stampa
            </button>
        </div>
    </div>
    
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h3>{{ stats.total_users }}</h3>
                    <p class="mb-0">Utenti Totali</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                    <h3>{{ stats.active_locations }}</h3>
                    <p class="mb-0">Sedi Attive</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h3>{{ stats.today_attendances }}</h3>
                    <p class="mb-0">Presenze Oggi</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-sign-out-alt fa-2x mb-2"></i>
                    <h3>{{ stats.today_checked_out }}</h3>
                    <p class="mb-0">Uscite Registrate</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Monthly Overview -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Andamento Presenze (Ultimi 30 giorni)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="attendanceChart" height="100"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Statistiche Mensili
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Ore Totali:</span>
                            <strong>{{ "%.1f"|format(stats.monthly_hours) }}h</strong>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Giorni Lavorativi:</span>
                            <strong>{{ stats.monthly_days }}</strong>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Ritardi:</span>
                            <strong class="text-warning">{{ stats.late_arrivals }}</strong>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Variazione vs Mese Scorso:</span>
                            {% if stats.hours_change > 0 %}
                                <span class="badge bg-success">+{{ "%.1f"|format(stats.hours_change) }}%</span>
                            {% elif stats.hours_change < 0 %}
                                <span class="badge bg-danger">{{ "%.1f"|format(stats.hours_change) }}%</span>
                            {% else %}
                                <span class="badge bg-secondary">0%</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Performers and Recent Interventions -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trophy me-2"></i>Top Performers (Ore Mensili)
                    </h5>
                </div>
                <div class="card-body">
                    {% if stats.top_performers %}
                        {% for performer in stats.top_performers %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>{{ performer.name }}</strong>
                                {% if loop.index == 1 %}
                                    <i class="fas fa-crown text-warning ms-1"></i>
                                {% elif loop.index == 2 %}
                                    <i class="fas fa-medal text-secondary ms-1"></i>
                                {% elif loop.index == 3 %}
                                    <i class="fas fa-award text-warning ms-1"></i>
                                {% endif %}
                            </div>
                            <span class="badge bg-primary">{{ "%.1f"|format(performer.hours) }}h</span>
                        </div>
                        {% if not loop.last %}<hr>{% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-muted mb-0">Nessun dato disponibile per questo mese.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks me-2"></i>Interventi Recenti
                    </h5>
                </div>
                <div class="card-body">
                    {% if stats.recent_interventions %}
                        {% for intervention in stats.recent_interventions %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ intervention.title }}</strong><br>
                                    <small class="text-muted">{{ intervention.user.full_name }}</small>
                                </div>
                                <span class="badge 
                                    {% if intervention.status == 'completed' %}bg-success
                                    {% elif intervention.status == 'in_progress' %}bg-warning
                                    {% else %}bg-secondary
                                    {% endif %}">
                                    {{ intervention.status|title }}
                                </span>
                            </div>
                            <small class="text-muted">
                                {{ intervention.intervention_type|title }} - 
                                {{ intervention.created_at.strftime('%d/%m/%Y') }}
                            </small>
                        </div>
                        {% if not loop.last %}<hr>{% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-muted mb-0">Nessun intervento recente.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Analytics -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Distribuzione Orari per Sede
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <canvas id="locationChart" height="80"></canvas>
                        </div>
                        <div class="col-md-4">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Sede</th>
                                            <th>Ore Totali</th>
                                            <th>Presenze</th>
                                        </tr>
                                    </thead>
                                    <tbody id="locationStatsTable">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Attendance Chart
fetch('/api/attendance_chart')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index',
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    if (context.datasetIndex === 0) {
                                        label += context.parsed.y.toFixed(1) + ' ore';
                                    } else {
                                        label += context.parsed.y + ' utenti';
                                    }
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Ore Totali'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Numero Utenti'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Data'
                        }
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Error loading attendance chart:', error);
        document.getElementById('attendanceChart').getContext('2d').fillText('Errore nel caricamento dei dati', 10, 50);
    });

// Location Distribution Chart (Mock data since no API endpoint exists)
const locationCtx = document.getElementById('locationChart').getContext('2d');
const locationChart = new Chart(locationCtx, {
    type: 'doughnut',
    data: {
        labels: ['Sede Centrale', 'Filiale Nord', 'Ufficio Sud'],
        datasets: [{
            data: [45, 30, 25],
            backgroundColor: [
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(255, 206, 86, 0.8)'
            ],
            borderColor: [
                'rgba(54, 162, 235, 1)',
                'rgba(255, 99, 132, 1)',
                'rgba(255, 206, 86, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed + '%';
                    }
                }
            }
        }
    }
});

// Populate location stats table (Mock data)
const locationStats = [
    { name: 'Sede Centrale', hours: 1240.5, attendances: 156 },
    { name: 'Filiale Nord', hours: 890.2, attendances: 112 },
    { name: 'Ufficio Sud', hours: 654.8, attendances: 87 }
];

const tableBody = document.getElementById('locationStatsTable');
locationStats.forEach(stat => {
    const row = tableBody.insertRow();
    row.innerHTML = `
        <td>${stat.name}</td>
        <td>${stat.hours.toFixed(1)}h</td>
        <td>${stat.attendances}</td>
    `;
});

// Export functionality
document.getElementById('exportBtn').addEventListener('click', function() {
    // This would typically call an API endpoint for Excel export
    alert('Funzionalità di export in sviluppo. I dati verranno esportati in formato Excel.');
});

// Print styles
const printStyles = `
    @media print {
        .btn, .navbar, .footer { display: none !important; }
        .card { border: 1px solid #000 !important; page-break-inside: avoid; }
        .container { max-width: 100% !important; }
    }
`;

const styleSheet = document.createElement("style");
styleSheet.innerText = printStyles;
document.head.appendChild(styleSheet);
</script>
{% endblock %}
