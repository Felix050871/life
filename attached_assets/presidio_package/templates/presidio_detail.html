{% extends "base.html" %}

{% block title %}Dettaglio Presidio - {{ super() }}{% endblock %}

{% block head %}
<style>
.coverage-day-card {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
    background-color: #f8f9fa;
}

.coverage-day-header {
    background-color: #6c757d;
    color: white;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #dee2e6;
    font-weight: bold;
    border-top-left-radius: 0.375rem;
    border-top-right-radius: 0.375rem;
}

.coverage-time-slot {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e9ecef;
    background-color: white;
}

.coverage-time-slot:last-child {
    border-bottom: none;
    border-bottom-left-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
}

.role-badge {
    margin: 0.125rem;
}

.time-range {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: #495057;
    font-size: 1.1em;
}

.template-info-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}

.template-info-card .card-body {
    padding: 1.5rem;
}

.no-coverage-day {
    padding: 0.75rem 1rem;
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    color: #6c757d;
    font-style: italic;
    text-align: center;
    border: 1px dashed #dee2e6;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-shield-alt me-2"></i>Dettaglio Presidio
        {% if template %}
        <small class="text-muted">{{ template.name }}</small>
        {% endif %}
    </h2>
    <div>
        <a href="{{ url_for('view_presidi') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Torna alla Lista
        </a>
    </div>
</div>

<!-- Template Info -->
{% if template %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card template-info-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="card-title mb-1">
                            <i class="fas fa-shield-alt me-2"></i>{{ template.name }}
                        </h5>
                        <p class="card-text mb-1">
                            <i class="fas fa-calendar me-1"></i>
                            Periodo: {{ template.start_date.strftime('%d/%m/%Y') }} - {{ template.end_date.strftime('%d/%m/%Y') }}
                        </p>
                        {% if template.description %}
                        <p class="card-text mb-0">
                            <i class="fas fa-info-circle me-1"></i>{{ template.description }}
                        </p>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="mb-2">
                            {% if template.is_active %}
                            <span class="badge bg-success fs-6">Attivo</span>
                            {% else %}
                            <span class="badge bg-secondary fs-6">Inattivo</span>
                            {% endif %}
                        </div>
                        <small class="opacity-75">
                            Creato da {{ template.creator.get_full_name() }}<br>
                            il {{ template.created_at.strftime('%d/%m/%Y alle %H:%M') }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Coverage Details -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar-week me-2"></i>Coperture Settimanali</h5>
            </div>
            <div class="card-body">
                {% if template and template.coverages %}
                {% set coverage_by_day = {} %}
                {% for coverage in template.coverages %}
                    {% if coverage.day_of_week not in coverage_by_day %}
                        {% set _ = coverage_by_day.update({coverage.day_of_week: []}) %}
                    {% endif %}
                    {% set _ = coverage_by_day[coverage.day_of_week].append(coverage) %}
                {% endfor %}

                {% set day_names = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'] %}
                
                {% for day_num in range(7) %}
                <div class="coverage-day-card">
                    <div class="coverage-day-header">
                        <i class="fas fa-calendar-day me-2"></i>{{ day_names[day_num] }}
                        {% if day_num in coverage_by_day %}
                        <span class="badge bg-light text-dark ms-2">{{ coverage_by_day[day_num]|length }} coperture</span>
                        {% endif %}
                    </div>
                    
                    {% if day_num in coverage_by_day %}
                        {% for coverage in coverage_by_day[day_num]|sort(attribute='start_time') %}
                        <div class="coverage-time-slot">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <span class="time-range">
                                        {{ coverage.start_time.strftime('%H:%M') }} - {{ coverage.end_time.strftime('%H:%M') }}
                                    </span>
                                </div>
                                <div class="col-md-6">
                                    {% for role in coverage.get_required_roles() %}
                                    <span class="badge bg-primary role-badge">{{ role }}</span>
                                    {% endfor %}
                                </div>
                                <div class="col-md-3">
                                    {% set duration = coverage.get_duration_hours() %}
                                    {% set hours = duration|int %}
                                    {% set minutes = ((duration - hours) * 60)|int %}
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ hours }}h{% if minutes %} {{ minutes }}'{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="no-coverage-day">
                        <i class="fas fa-calendar-times me-2"></i>Nessuna copertura configurata
                    </div>
                    {% endif %}
                </div>
                {% endfor %}

                <!-- Coverage Summary -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="fas fa-chart-bar me-2"></i>Riepilogo Copertura</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h4 text-primary mb-0">{{ template.coverages|length }}</div>
                                            <small class="text-muted">Fasce orarie totali</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            {% set covered_days = template.coverages|map(attribute='day_of_week')|unique|list|length %}
                                            <div class="h4 text-success mb-0">{{ covered_days }}</div>
                                            <small class="text-muted">Giorni coperti</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            {% set total_hours = template.coverages|sum(attribute='get_duration_hours') %}
                                            <div class="h4 text-info mb-0">{{ "%.1f"|format(total_hours) }}</div>
                                            <small class="text-muted">Ore totali/settimana</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            {% set all_roles = [] %}
                                            {% for coverage in template.coverages %}
                                                {% for role in coverage.get_required_roles() %}
                                                    {% if role not in all_roles %}
                                                        {% set _ = all_roles.append(role) %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                            <div class="h4 text-warning mb-0">{{ all_roles|length }}</div>
                                            <small class="text-muted">Ruoli coinvolti</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nessuna Copertura Configurata</h5>
                    <p class="text-muted">Questo template non ha ancora coperture configurate</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}