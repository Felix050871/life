{% extends "base.html" %}

{% block title %}Gestione Festività{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-calendar-day"></i> Gestione Festività</h2>
                {% if current_user.can_manage_holidays() %}
                <div class="btn-group">
                    <a href="{{ url_for('add_holiday') }}" class="btn btn-success">
                        <i class="fas fa-plus"></i> Aggiungi Festività
                    </a>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateHolidaysModal">
                        <i class="fas fa-magic"></i> Genera Festività
                    </button>
                </div>
                {% endif %}
            </div>

            {% if holidays %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Festività Configurate</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Data</th>
                                    <th>Ambito</th>
                                    <th>Descrizione</th>
                                    <th>Stato</th>
                                    <th>Creata da</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for holiday in holidays %}
                                <tr class="{{ 'table-secondary' if not holiday.active else '' }}">
                                    <td>
                                        <strong>{{ holiday.name }}</strong>
                                        {% if not holiday.active %}
                                        <small class="text-muted">(Disattivata)</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ holiday.date_display }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'info' if holiday.sede else 'success' }}">
                                            {{ holiday.scope_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if holiday.description %}
                                        {{ holiday.description }}
                                        {% else %}
                                        <em class="text-muted">Nessuna descrizione</em>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if holiday.active %}
                                        <span class="badge bg-success">Attiva</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Disattivata</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ holiday.creator.get_full_name() if holiday.creator else 'N/A' }}</td>
                                    <td>
                                        {% if current_user.can_manage_holidays() %}
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('edit_holiday', holiday_id=holiday.id) }}" 
                                               class="btn btn-sm btn-outline-primary" title="Modifica festività">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="confirmDelete('{{ holiday.name }}', '{{ url_for('delete_holiday', holiday_id=holiday.id) }}')"
                                                    title="Elimina festività">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        {% else %}
                                        <span class="badge bg-secondary">Solo lettura</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Nessuna festività configurata</strong><br>
                Clicca su "Aggiungi Festività" per iniziare a configurare le festività nazionali.
            </div>
            {% endif %}

            <div class="mt-4">
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Torna alla Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal per generazione festività automatiche -->
<div class="modal fade" id="generateHolidaysModal" tabindex="-1" aria-labelledby="generateHolidaysModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateHolidaysModalLabel">Genera Festività Nazionali</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Questa funzione aggiungerà automaticamente le festività nazionali italiane standard:</p>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Capodanno <span class="badge bg-primary rounded-pill">1 Gen</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Epifania <span class="badge bg-primary rounded-pill">6 Gen</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Festa della Liberazione <span class="badge bg-primary rounded-pill">25 Apr</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Festa del Lavoro <span class="badge bg-primary rounded-pill">1 Mag</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Festa della Repubblica <span class="badge bg-primary rounded-pill">2 Giu</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Ferragosto <span class="badge bg-primary rounded-pill">15 Ago</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Ognissanti <span class="badge bg-primary rounded-pill">1 Nov</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Immacolata Concezione <span class="badge bg-primary rounded-pill">8 Dec</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Natale <span class="badge bg-primary rounded-pill">25 Dec</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Santo Stefano <span class="badge bg-primary rounded-pill">26 Dec</span>
                    </li>
                </ul>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Nota:</strong> Le festività già esistenti non verranno duplicate.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <form action="{{ url_for('generate_holidays') }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-magic me-1"></i>Genera Festività
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal per conferma eliminazione -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Conferma Eliminazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Sei sicuro di voler eliminare la festività <strong id="holidayName"></strong>?</p>
                <p class="text-muted">Questa azione non può essere annullata.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Elimina</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDelete(holidayName, deleteUrl) {
    document.getElementById('holidayName').textContent = holidayName;
    document.getElementById('deleteForm').action = deleteUrl;
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}

// Rimossa funzione generateHolidays() - ora usa form POST direttamente
</script>
{% endblock %}