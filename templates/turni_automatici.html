{% extends "base.html" %}

{% block title %}Gestione Turni Automatici{% endblock %}

{% block content %}
<div class="container-fluid">
            <!-- Header Row -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1 class="h3 mb-0">
                            <i class="fas fa-calendar-plus me-2"></i>
                            Gestione Turni Automatici
                        </h1>
                    </div>
                </div>
            </div>

            <!-- Template Selection Row -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-cog me-2"></i>
                                Selezione Template di Copertura
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="template-selection-form" class="row g-3">
                                <div class="col-md-6">
                                    <label for="template-select" class="form-label">Template di Copertura:</label>
                                    <select id="template-select" name="template_id" class="form-select" onchange="templateChanged()">
                                        <option value="">Seleziona un template...</option>
                                        {% for template in templates %}
                                        <option value="{{ template.id }}">{{ template.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-end align-items-end h-100">
                                        <button type="button" id="generate-btn" class="btn btn-secondary w-100" disabled>
                                            <i class="fas fa-magic me-2"></i>
                                            Genera Turni Automatici
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Template Message -->
            <div id="no-template-message" class="row">
                <div class="col-md-12">
                    <div class="card shadow-sm">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Nessun template selezionato</h5>
                            <p class="text-muted">Seleziona un template di copertura per visualizzare e gestire i turni.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Template Shifts Display -->
            <div id="template-shifts" style="display: none;">
                <!-- Template Info -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-0" id="template-name-display">Template di Copertura</h5>
                                        <p class="text-muted mb-0" id="weeks-count">0 settimane</p>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-info fs-6" id="total-shifts-count">0 turni</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weeks Container -->
                <div id="weeks-container">
                    <!-- Weeks will be loaded here -->
                </div>
        </div>

{% endblock %}

{% block extra_js %}
<script>
// Global state
let currentTemplate = null;
let currentTemplateName = null;

function templateChanged() {
    const select = document.getElementById('template-select');
    const templateId = select.value;
    const templateName = select.options[select.selectedIndex].text;
    
    currentTemplate = templateId;
    currentTemplateName = templateName;
    
    const generateBtn = document.getElementById('generate-btn');
    
    if (templateId) {
        // Abilita pulsante
        generateBtn.disabled = false;
        generateBtn.className = 'btn btn-primary w-100';
        
        // Carica turni per il template selezionato
        loadShiftsForTemplate(templateId, templateName);
    } else {
        // Disabilita pulsante
        generateBtn.disabled = true;
        generateBtn.className = 'btn btn-secondary w-100';
        
        // Nascondi turni
        document.getElementById('no-template-message').style.display = 'block';
        document.getElementById('template-shifts').style.display = 'none';
        document.getElementById('weeks-count').textContent = '0 settimane';
    }
}

function loadShiftsForTemplate(templateId, templateName) {
    console.log('Loading shifts for template:', templateId, templateName);
    
    // Mostra loading
    document.getElementById('no-template-message').style.display = 'none';
    document.getElementById('template-shifts').style.display = 'block';
    document.getElementById('template-name-display').innerHTML = 'Caricamento turni per: <strong>' + templateName + '</strong>...';
    document.getElementById('weeks-container').innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Caricamento...</div>';
    
    // Richiesta AJAX - SEMPLICE
    fetch('/api/get_shifts_for_template/' + templateId, {
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => {
            console.log('API Response status:', response.status);
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('API Success - data received');
            
            // Display data
            displayShiftsFromAPI(data, templateName);
        })
        .catch(error => {
            console.error('API Error:', error);
            document.getElementById('weeks-container').innerHTML = 
                '<div class="alert alert-danger">Errore caricamento: ' + error.message + '</div>';
        });
}

function displayShiftsFromAPI(data, templateName) {
    document.getElementById('template-name-display').innerHTML = templateName;
    document.getElementById('weeks-container').innerHTML = '<div class="alert alert-success">Turni caricati correttamente!</div>';
    
    // Debug per 01/10
    if (data.weeks) {
        data.weeks.forEach((week) => {
            week.days.forEach((day) => {
                if (day.date === '01/10') {
                    console.log('01/10 from API:', day.shifts.length, 'shifts, missing:', day.missing_roles.length);
                    day.shifts.forEach(shift => {
                        console.log('01/10 SHIFT:', shift.time, shift.role, shift.user);
                    });
                }
            });
        });
    }
}

console.log('Workforce Management App initialized');
</script>
{% endblock %}