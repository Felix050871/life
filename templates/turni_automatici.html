{% extends "base.html" %}

{% block title %}Gestione Turni - Life{% endblock %}

{% block head %}
<style>
.template-info-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    margin-bottom: 20px;
}

.template-card {
    border: 1px solid #e3e6f0;
    border-radius: 10px;
    background: #fff;
    transition: transform 0.2s, box-shadow 0.2s;
}

.template-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.template-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 10px 10px 0 0;
}

.week-card {
    border: 1px solid #444;
    border-radius: 8px;
    margin-bottom: 20px;
    background: #2c3e50;
    color: #ffffff;
}

.week-header {
    background: #34495e;
    padding: 12px 16px;
    border-bottom: 1px solid #555;
    color: #ffffff;
}

.shift-day {
    border-right: 1px solid #555;
    padding: 8px;
    min-height: 120px;
    background: #3a4a5c;
}

.shift-day:last-child {
    border-right: none;
}

.shift-item {
    background: #28a745;
    border: 1px solid #1e7e34;
    border-radius: 4px;
    padding: 4px 6px;
    margin: 2px 0;
    font-size: 11px;
    line-height: 1.2;
    color: #ffffff;
    font-weight: 500;
}

.shift-day .text-center small {
    color: #ffffff !important;
}

.shift-day .text-muted {
    color: #adb5bd !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-cogs me-2"></i>Gestione Turni
        </h1>
    </div>

    <!-- Form Selezione Template -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-calendar-plus me-2"></i>Seleziona Template per Generazione Turni
                    </h6>
                </div>
                <div class="card-body">
                    {% if presidio_templates %}
                    <div class="row g-3 align-items-end">
                        <div class="col-md-8">
                            <label for="template_id" class="form-label">Seleziona Template Presidio</label>
                            <select class="form-select" name="template_id" id="template_id" required onchange="loadTemplateRoles()">
                                <option value="">-- Seleziona Template --</option>
                                {% for template in presidio_templates %}
                                <option value="{{ template.id }}" 
                                        data-start="{{ template.start_date.strftime('%d/%m/%Y') }}"
                                        data-end="{{ template.end_date.strftime('%d/%m/%Y') }}"
                                        data-period="{{ template.get_period_display() }}"
                                        data-sede="{{ template.sede.name if template.sede else 'N/D' }}">
                                    {{ template.name }} - {{ template.sede.name if template.sede else 'N/D' }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-primary w-100" onclick="loadTemplateRoles()" id="next-btn" disabled>
                                <i class="fas fa-arrow-right me-1"></i>Avanti: Seleziona Utenti
                            </button>
                        </div>
                    </div>
                    
                    <!-- Sezione selezione utenti (nascosta inizialmente) -->
                    <div id="user-selection-section" style="display: none;" class="mt-4">
                        <hr>
                        <h5 class="mb-3"><i class="fas fa-users me-2"></i>Seleziona Utenti per Ruolo</h5>
                        <p class="text-muted mb-3">Seleziona gli utenti che potranno essere assegnati ai turni per ciascun ruolo richiesto.</p>
                        
                        <form method="POST" action="{{ url_for('shifts.genera_turni_da_template') }}" id="generate-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="template_id" id="selected_template_id" value=""/>
                            
                            <div id="roles-container">
                                <!-- Populated by JavaScript -->
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" onclick="cancelUserSelection()">
                                    <i class="fas fa-arrow-left me-1"></i>Indietro
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-magic me-1"></i>Genera Turni
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5 class="text-warning">Nessun template disponibile</h5>
                        <p class="text-muted">Non ci sono template presidio attivi. Creane uno dalla sezione "Gestione Presidi".</p>
                        <a href="{{ url_for('presidio.presidio_coverage') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>Crea Template
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Visualizzazione Turni -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-calendar-week me-2"></i>Turni per Settimana
                    </h6>
                    <span class="badge bg-secondary" id="weeks-count">0 settimane</span>
                </div>
                <div class="card-body" id="shifts-content">
                    <div class="text-center py-5" id="no-template-message">
                        <i class="fas fa-hand-point-up fa-3x text-info mb-3"></i>
                        <h5 class="text-info">Seleziona un template</h5>
                        <p class="text-muted">Seleziona un template presidio sopra per visualizzare i turni esistenti.</p>
                    </div>
                    
                    <div id="template-shifts" style="display: none;">
                        <div class="alert alert-info mb-3" id="template-alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="template-name-display"></span>
                        </div>
                        <div id="weeks-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Nascondi la sezione turni all'avvio
    document.getElementById('no-template-message').style.display = 'block';
    document.getElementById('template-shifts').style.display = 'none';
});

function loadTemplateRoles() {
    var templateId = document.getElementById('template_id').value;
    var nextBtn = document.getElementById('next-btn');
    
    if (!templateId) {
        nextBtn.disabled = true;
        document.getElementById('user-selection-section').style.display = 'none';
        return;
    }
    
    // Abilita pulsante
    nextBtn.disabled = false;
    
    // Carica ruoli e utenti via AJAX
    fetch('/shifts/api/get_template_roles/' + templateId, {
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Memorizza template ID
            document.getElementById('selected_template_id').value = templateId;
            
            // Mostra sezione selezione utenti
            document.getElementById('user-selection-section').style.display = 'block';
            
            // Popola ruoli
            var rolesContainer = document.getElementById('roles-container');
            rolesContainer.innerHTML = '';
            
            if (data.roles && data.roles.length > 0) {
                data.roles.forEach(function(roleData) {
                    var roleCard = document.createElement('div');
                    roleCard.className = 'card mb-3';
                    
                    var roleHTML = `
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-user-tag me-2"></i>${roleData.role} 
                                <span class="badge bg-light text-dark ms-2">${roleData.count} richiesti</span>
                            </h6>
                        </div>
                        <div class="card-body">
                    `;
                    
                    if (roleData.users && roleData.users.length > 0) {
                        roleHTML += '<div class="row">';
                        roleData.users.forEach(function(user) {
                            roleHTML += `
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="selected_users" value="${user.id}" 
                                               id="user_${user.id}" checked>
                                        <label class="form-check-label" for="user_${user.id}">
                                            ${user.full_name}
                                        </label>
                                    </div>
                                </div>
                            `;
                        });
                        roleHTML += '</div>';
                        
                        // Pulsanti seleziona/deseleziona tutti
                        roleHTML += `
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary me-2" 
                                        onclick="selectAllInRole('${roleData.role}')">
                                    <i class="fas fa-check-square me-1"></i>Seleziona Tutti
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" 
                                        onclick="deselectAllInRole('${roleData.role}')">
                                    <i class="fas fa-square me-1"></i>Deseleziona Tutti
                                </button>
                            </div>
                        `;
                    } else {
                        roleHTML += `
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Nessun utente trovato con ruolo "${roleData.role}"
                            </div>
                        `;
                    }
                    
                    roleHTML += '</div>';
                    roleCard.innerHTML = roleHTML;
                    rolesContainer.appendChild(roleCard);
                });
            } else {
                rolesContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Nessun ruolo richiesto trovato nel template
                    </div>
                `;
            }
            
            // Scorri alla sezione
            document.getElementById('user-selection-section').scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('Errore nel caricamento dei ruoli: ' + (data.message || 'Errore sconosciuto'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Errore nella comunicazione con il server');
    });
}

function selectAllInRole(role) {
    var checkboxes = document.querySelectorAll('input[name="selected_users"]');
    checkboxes.forEach(function(checkbox) {
        checkbox.checked = true;
    });
}

function deselectAllInRole(role) {
    var checkboxes = document.querySelectorAll('input[name="selected_users"]');
    checkboxes.forEach(function(checkbox) {
        checkbox.checked = false;
    });
}

function cancelUserSelection() {
    document.getElementById('user-selection-section').style.display = 'none';
    document.getElementById('template_id').value = '';
    document.getElementById('next-btn').disabled = true;
}

function loadShiftsForTemplate(templateId, templateName) {
    
    // Mostra loading
    document.getElementById('no-template-message').style.display = 'none';
    document.getElementById('template-shifts').style.display = 'block';
    document.getElementById('template-name-display').innerHTML = 'Caricamento turni per: <strong>' + templateName + '</strong>...';
    document.getElementById('weeks-container').innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Caricamento...</div>';
    
    // Richiesta AJAX per caricare i turni con credentials
    fetch('/shifts/api/get_shifts_for_template/' + templateId, {
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => {
            if (response.status === 302) {
                throw new Error('Sessione scaduta - ricarica la pagina');
            }
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            
            // DEBUG: Controlla se ci sono missing_roles nei dati
            if (data.weeks) {
                Object.keys(data.weeks).forEach(function(weekKey) {
                    var week = data.weeks[weekKey];
                    if (week.days && Array.isArray(week.days)) {
                        week.days.forEach(function(day, i) {
                            if (day && day.missing_roles && day.missing_roles.length > 0) {
                            }
                        });
                    }
                });
            }
            
            // DISPLAY DIRECTLY FROM API DATA - NO COMPLEX LOGIC
            displayShiftsFromAPI(data, templateName);
            return; // EXIT HERE - NO MORE COMPLEX PROCESSING
        })
        .catch(error => {
            console.error('API Error:', error);
            document.getElementById('weeks-container').innerHTML = '<div class="alert alert-danger">Errore caricamento: ' + error.message + '</div>';
        });
}

function displayShiftsFromAPI(data, templateName) {
    
    // CALCOLO MISSING_ROLES NEL FRONTEND - SOLO PER GIORNI NEL PERIODO TEMPLATE
    if (data.weeks && data.period) {
        // Estrai date periodo template (es. "01/10/2025 - 31/10/2025")
        let periodParts = data.period.split(' - ');
        let startDate = parseTemplateDate(periodParts[0]);
        let endDate = parseTemplateDate(periodParts[1]);
        
        Object.keys(data.weeks).forEach(function(weekKey) {
            let week = data.weeks[weekKey];
            if (week.days && Array.isArray(week.days)) {
                week.days.forEach(function(day, dayIndex) {
                    if (day && day.date) {
                        // Reset missing_roles
                        day.missing_roles = [];
                        
                        // Verifica se questo giorno è nel periodo del template
                        let dayDate = parseTemplateDate(day.date + '/2025'); // Aggiungi anno
                        
                        if (dayDate >= startDate && dayDate <= endDate) {
                            // CALCOLO DINAMICO MISSING_ROLES DAL DATABASE
                            loadCoverageRequirementsForDaySync(templateName, day, dayDate, startDate, endDate);
                        }
                    }
                });
            }
        });
    }
    
    // Renderizza turni usando il codice esistente alla fine del file
    renderTurniLayout(data, templateName);
}

// Funzione helper per parsing date template
function parseTemplateDate(dateStr) {
    // Converte "02/10" o "02/10/2025" in oggetto Date
    let parts = dateStr.split('/');
    if (parts.length === 2) {
        // Aggiungi anno corrente
        parts.push('2025');
    }
    return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
}

// Cache per coperture per evitare chiamate multiple 
var templateCoverageCache = {};

// Funzione per caricare coperture dinamicamente con cache
function loadCoverageRequirementsForDaySync(templateName, day, dayDate, startDate, endDate) {
    // Estrai templateId dal nome
    let templateId = null;
    if (templateName.includes('Settembre')) templateId = 3;
    else if (templateName.includes('Ottobre')) templateId = 5;
    else if (templateName.includes('Novembre')) templateId = 6;
    else if (templateName.includes('Agosto')) templateId = 4;
    
    if (!templateId) return;
    
    // Se già in cache, applica subito
    if (templateCoverageCache[templateId]) {
        applyMissingRolesFromCache(day, dayDate, templateCoverageCache[templateId]);
        return;
    }
    
    // Carica dal server e metti in cache
    fetch('/api/get_coverage_requirements/' + templateId, {
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.coverages) {
            templateCoverageCache[templateId] = data.coverages;
            applyMissingRolesFromCache(day, dayDate, data.coverages);
        }
    })
}

// Funzione per applicare missing_roles da cache
function applyMissingRolesFromCache(day, dayDate, coverages) {
    // Converte da domenica=0 a lunedì=0 per il database
    let normalizedDayOfWeek = dayDate.getDay() === 0 ? 6 : dayDate.getDay() - 1;
    
    // Filtra coperture per questo giorno della settimana
    let dayCoverages = coverages.filter(c => c.day_of_week === normalizedDayOfWeek);
    
    // Reset e calcola missing_roles
    if (!day.missing_roles) day.missing_roles = [];
    
    dayCoverages.forEach(function(coverage) {
        let timeSlot = coverage.start_time + '-' + coverage.end_time;
        
        coverage.required_roles.forEach(function(requiredRole) {
            // Verifica se esiste un turno con questo ruolo per questo slot
            let roleFound = day.shifts && day.shifts.some(function(shift) {
                return shift.role === requiredRole && shift.time === timeSlot;
            });
            
            if (!roleFound) {
                let missingText = requiredRole + ' mancante (' + timeSlot + ')';
                if (day.missing_roles.indexOf(missingText) === -1) {
                    day.missing_roles.push(missingText);
                }
            }
        });
    });
    
    
    // FORZA RE-RENDER dopo calcolo missing_roles
    updateDayDisplay(day);
}

// Funzione per aggiornare la visualizzazione di un singolo giorno
function updateDayDisplay(day) {
    if (!day.date || !day.missing_roles || day.missing_roles.length === 0) return;
    
    // Usa setTimeout per assicurare che il DOM sia completamente renderizzato
    setTimeout(function() {
        // Trova l'elemento del giorno nel DOM con controlli di sicurezza
        let dateElements = document.querySelectorAll('.date-text');
        dateElements.forEach(function(element) {
            if (element && element.textContent === day.date) {
                let dayContainer = element.closest('.shift-day');
                if (dayContainer) {
                    let shiftsContainer = dayContainer.querySelector('.shifts-container');
                    if (shiftsContainer) {
                        // Rimuovi alert esistenti
                        let existingAlerts = shiftsContainer.querySelectorAll('.bg-danger');
                        existingAlerts.forEach(alert => alert.remove());
                        
                        // Aggiungi nuovi alert per missing_roles
                        day.missing_roles.forEach(function(missing) {
                            let alertDiv = document.createElement('div');
                            alertDiv.className = 'shift-item mb-2 p-2 bg-danger text-white rounded';
                            alertDiv.innerHTML = '<small class="d-block"><i class="fas fa-exclamation-triangle me-1"></i><strong>MANCANTE</strong></small>' +
                                               '<small class="d-block">' + missing + '</small>';
                            shiftsContainer.appendChild(alertDiv);
                        });
                    }
                }
            }
        });
    }, 200); // Delay per assicurare il rendering completo
}

// Funzione per renderizzare il layout turni
function renderTurniLayout(data, templateName) {
    // Update template name - RIPRISTINO LAYOUT ORIGINALE
    document.getElementById('template-name-display').innerHTML = 'Turni esistenti per: <strong>' + templateName + '</strong>';
    
    var container = document.getElementById('weeks-container');
    
    if (!data.weeks || Object.keys(data.weeks).length === 0) {
        container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Nessun turno trovato per questo template.</div>';
        document.getElementById('weeks-count').textContent = '0 settimane';
        return;
    }
    
    var weeksCount = Object.keys(data.weeks).length;
    document.getElementById('weeks-count').textContent = weeksCount + ' settiman' + (weeksCount === 1 ? 'a' : 'e');
    
    var html = '';
    
    // LAYOUT ORIGINALE: Process each week con struttura tabella
    Object.keys(data.weeks).forEach(function(weekKey) {
        var week = data.weeks[weekKey];
        
        // Week card con layout originale
        html += '<div class="week-card">';
        html += '<div class="week-header">';
        html += '<div class="d-flex justify-content-between align-items-center">';
        html += '<h6 class="mb-0"><i class="fas fa-calendar-week me-2"></i>Settimana ' + week.start + ' - ' + week.end + '</h6>';
        html += '<div>';
        html += '<span class="badge bg-primary me-2">' + week.shift_count + ' turni</span>';
        html += '<span class="badge bg-secondary me-2">' + week.unique_users + ' persone</span>';
        html += '<span class="badge bg-info">' + week.total_hours + 'h</span>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        
        // Tabella con giorni della settimana - LAYOUT ORIGINALE
        html += '<div class="row g-0">';
        
        var dayNames = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];
        
        for (var i = 0; i < 7; i++) {
            var day = week.days[i] || {}; // Protezione contro undefined
            html += '<div class="col shift-day">';
            html += '<div class="p-2">';
            html += '<strong class="day-name">' + dayNames[i] + '</strong>';
            html += '<br><small class="date-text">' + (day.date || '') + '</small>';
            html += '<div class="shifts-container mt-2">';
            
            // Show shifts
            if (day.shifts && day.shifts.length > 0) {
                day.shifts.forEach(function(shift) {
                    html += '<div class="shift-item mb-2 p-2 bg-success text-white rounded">';
                    html += '<small class="d-block"><strong>' + shift.role + '</strong></small>';
                    html += '<small class="d-block">' + shift.user + '</small>';
                    html += '<small class="d-block text-light">' + shift.time + '</small>';
                    html += '</div>';
                });
            }
            
            // Show missing roles - ALERT ROSSI COME ORIGINALE
            if (day.missing_roles && day.missing_roles.length > 0) {
                day.missing_roles.forEach(function(missing) {
                    html += '<div class="shift-item mb-2 p-2 bg-danger text-white rounded">';
                    html += '<small class="d-block"><i class="fas fa-exclamation-triangle me-1"></i><strong>MANCANTE</strong></small>';
                    html += '<small class="d-block">' + missing + '</small>';
                    html += '</div>';
                });
            }
            
            if ((!day.shifts || day.shifts.length === 0) && (!day.missing_roles || day.missing_roles.length === 0)) {
                html += '<small class="text-muted">Nessun turno</small>';
            }
            
            html += '</div>';
            html += '</div>';
            html += '</div>';
        }
        
        html += '</div>';
        html += '</div>';
    });
    
    container.innerHTML = html;
}

// End of simplified API-only logic
</script>
{% endblock %}
