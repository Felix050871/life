<!DOCTYPE html>
<html lang="it" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}Life Platform - Gestione del personale e benessere aziendale{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <!-- SheetJS for Excel export -->  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Main Layout -->
    {% if current_user.is_authenticated %}
    <!-- Project Title Bar with User Menu -->
    <nav class="navbar navbar-expand-lg project-title-bar">
        <div class="container-fluid">
            <!-- Sidebar Toggle (Mobile Only) - Solo se non siamo su index, home o profilo -->
            {% if request.endpoint != 'index' and request.endpoint != 'home' and request.endpoint != 'user_management.user_profile' %}
            <button class="btn btn-link text-white d-md-none p-0 me-2 sidebar-mobile-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
                <i class="fas fa-bars" style="font-size: 1.2rem;"></i>
            </button>
            {% endif %}
            
            <!-- Logo -->
            <a class="navbar-brand text-white d-flex align-items-center" href="{{ url_for('home') if not current_user.is_system_admin else url_for('index') }}">
                {% if current_user.company and current_user.company.logo %}
                <img src="{{ url_for('static', filename=current_user.company.logo) }}" alt="{{ current_user.company.name }}" style="height: 30px; width: auto; margin-right: 0.5rem;">
                {% else %}
                <img src="{{ url_for('static', filename='images/life_logo.png') }}" alt="Life Platform" style="height: 30px; width: auto; margin-right: 0.5rem;">
                {% endif %}
                <span class="d-none d-sm-inline">Life Platform</span>
            </a>
            
            <!-- Burger Menu Toggle (for top menu) -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Collapsible Content -->
            <div class="collapse navbar-collapse" id="navbarContent">
                <!-- Left: Platform Tabs and Admin -->
                <div class="navbar-nav me-auto">
                    {% if not current_user.is_system_admin %}
                        <!-- Platform Tabs -->
                        <a href="{{ url_for('dashboard.dashboard') }}" class="nav-link text-white">
                            <img src="{{ url_for('static', filename='img/flow_icon.png') }}" alt="FLOW" style="height: 20px; width: auto; margin-right: 0.4rem;">FLOW
                        </a>
                        {% if current_user.has_permission('can_access_hubly') %}
                        <a href="{{ url_for('circle.home') }}" class="nav-link text-white">
                            <img src="{{ url_for('static', filename='img/circle_icon.png') }}" alt="CIRCLE" style="height: 20px; width: auto; margin-right: 0.4rem;">CIRCLE
                        </a>
                        {% endif %}
                        
                        <!-- Admin Menu (Only for Company ADMIN with permissions) -->
                        {% set is_company_admin = current_user.role == 'Amministratore' and not current_user.is_system_admin %}
                        {% set has_admin_permissions = (current_user.can_manage_roles() or current_user.can_view_roles() or current_user.can_manage_users() or current_user.can_view_users()) %}
                        {% if is_company_admin and has_admin_permissions %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-warning" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-shield me-1"></i>Amministrazione
                            </a>
                            <ul class="dropdown-menu">
                                {% if current_user.can_manage_roles() or current_user.can_view_roles() %}
                                <li><a class="dropdown-item" href="{{ url_for('admin.manage_roles') }}">
                                    <i class="fas fa-users-gear me-1"></i>Ruoli
                                </a></li>
                                {% endif %}
                                {% if current_user.can_manage_users() or current_user.can_view_users() %}
                                <li><a class="dropdown-item" href="{{ url_for('user_management.user_management') }}">
                                    <i class="fas fa-users me-1"></i>Utenti
                                </a></li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin.email_settings') }}">
                                    <i class="fas fa-envelope-circle-check me-1"></i>Configurazione Email
                                </a></li>
                            </ul>
                        </li>
                        {% endif %}
                    {% endif %}
                </div>
                
                <!-- Right: User Menu and Messages -->
                <div class="navbar-nav ms-auto">
                    <!-- System Administration (Only for SUPERADMIN) -->
                    {% if current_user.is_system_admin %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-cogs me-1"></i>Amministrazione Sistema
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('companies.list_companies') }}">
                                <i class="fas fa-building me-1"></i>Gestione Aziende
                            </a></li>
                        </ul>
                    </li>
                    {% endif %}
                    
                    <!-- Messages -->
                    {% if current_user.can_send_messages() or current_user.can_view_messages() %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-white position-relative" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-envelope me-1"></i><span class="d-lg-none">Messaggi</span>
                            {% if unread_messages_count > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem; padding: 0.2em 0.4em; margin-left: -0.5rem;">
                                {{ unread_messages_count if unread_messages_count < 100 else '99+' }}
                            </span>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            {% if current_user.can_send_messages() %}
                            <li><a class="dropdown-item" href="{{ url_for('messages.send_message') }}">
                                <i class="fas fa-paper-plane me-1"></i>Invia Messaggio
                            </a></li>
                            {% endif %}
                            {% if current_user.can_view_messages() %}
                            <li><a class="dropdown-item" href="{{ url_for('messages.internal_messages') }}">
                                <i class="fas fa-inbox me-1"></i>Visualizza Messaggi
                            </a></li>
                            {% endif %}
                        </ul>
                    </li>
                    {% endif %}
                    
                    <!-- User Menu -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-white d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" style="gap: 0.5rem;">
                            <img src="{{ current_user.get_profile_image_url() }}" 
                                 alt="{{ current_user.get_full_name() }}" 
                                 class="rounded-circle"
                                 style="width: 28px; height: 28px; object-fit: cover; border: 1px solid rgba(255,255,255,0.3);">
                            <span>{{ current_user.first_name or current_user.username }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('user_management.user_profile') }}">
                                <i class="fas fa-user-edit me-1"></i>Profilo
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                                <i class="fas fa-sign-out-alt me-1"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="main-wrapper">
        <!-- Sidebar - Nascosta nella home page, pagina profilo e pagine amministrazione -->
        {% set hide_sidebar = request.endpoint == 'index' or request.endpoint == 'home' or request.endpoint == 'user_management.user_profile' or request.endpoint == 'user_management.user_management' or request.endpoint == 'user_management.edit_user' or (request.endpoint and request.endpoint.startswith('admin.')) %}
        <nav class="sidebar {% if hide_sidebar %}d-none{% endif %}" id="sidebar">
            {% set is_circle = request.endpoint and request.endpoint.startswith('circle') %}
            
            <div class="sidebar-header">
                {% if is_circle %}
                <a href="{{ url_for('circle.home') }}" class="brand">
                    <img src="{{ url_for('static', filename='img/circle_icon.png') }}" alt="CIRCLE" style="height: 24px; width: auto; margin-right: 0.5rem;"><span>CIRCLE</span>
                </a>
                {% else %}
                <a href="{{ url_for('dashboard.dashboard') }}" class="brand">
                    <img src="{{ url_for('static', filename='img/flow_icon.png') }}" alt="FLOW" style="height: 24px; width: auto; margin-right: 0.5rem;"><span>FLOW</span>
                </a>
                {% endif %}
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <ul class="sidebar-nav">
            {% if is_circle %}
                <!-- MENU CIRCLE -->
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('circle_news.index') }}" class="sidebar-nav-link">
                        <i class="fas fa-newspaper"></i>
                        <span>News & Comunicazioni</span>
                    </a>
                </li>
                
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('circle.delorean') }}" class="sidebar-nav-link">
                        <i class="fas fa-history"></i>
                        <span>Delorean</span>
                    </a>
                </li>
                
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('circle_groups.index') }}" class="sidebar-nav-link">
                        <i class="fas fa-users"></i>
                        <span>Gruppi</span>
                    </a>
                </li>
                
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('circle_polls.index') }}" class="sidebar-nav-link">
                        <i class="fas fa-poll"></i>
                        <span>Sondaggi</span>
                    </a>
                </li>
                
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('circle_calendar.index') }}" class="sidebar-nav-link">
                        <i class="fas fa-calendar"></i>
                        <span>Calendario</span>
                    </a>
                </li>
                
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('circle_documents.index') }}" class="sidebar-nav-link">
                        <i class="fas fa-folder-open"></i>
                        <span>Documenti</span>
                    </a>
                </li>
                
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('circle_tools.index') }}" class="sidebar-nav-link">
                        <i class="fas fa-tools"></i>
                        <span>Strumenti</span>
                    </a>
                </li>
                
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('circle.personas') }}" class="sidebar-nav-link">
                        <i class="fas fa-id-card"></i>
                        <span>Personas</span>
                    </a>
                </li>
                
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('circle.tech_feed') }}" class="sidebar-nav-link">
                        <i class="fas fa-microchip"></i>
                        <span>Tech Feed</span>
                    </a>
                </li>
            {% else %}
                <!-- MENU FLOW -->
                <!-- DASHBOARD -->
                {% if current_user.can_access_dashboard() %}
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('dashboard.dashboard') }}" class="sidebar-nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                {% endif %}
                <!-- RUOLI - Solo se ha almeno un permesso ruoli E non è ADMIN aziendale (sono nella topbar) -->
                {% set has_roles_permission = current_user.can_manage_roles() or current_user.can_view_roles() %}
                {% set is_company_admin = current_user.role == 'Amministratore' and not current_user.is_system_admin %}
                {% if has_roles_permission and not is_company_admin %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-users-gear"></i>
                        <span>Ruoli</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_roles() %}
                        <li><a href="{{ url_for('admin.manage_roles') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Ruoli
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_roles() %}
                        <li><a href="{{ url_for('admin.manage_roles') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Ruoli
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- UTENTI - Solo se ha almeno un permesso utenti E non è ADMIN aziendale (sono nella topbar) -->
                {% set has_users_permission = current_user.can_manage_users() or current_user.can_view_users() %}
                {% if has_users_permission and not is_company_admin %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-users"></i>
                        <span>Utenti</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_users() %}
                        <li><a href="{{ url_for('user_management.user_management') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Utenti
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_users() %}
                        <li><a href="{{ url_for('user_management.user_management') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Utenti
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- HR - Human Resources - Solo se ha almeno un permesso HR -->
                {% if current_user.can_access_hr_menu() %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-id-card"></i>
                        <span>HR</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_hr_data() or current_user.can_view_hr_data() %}
                        <li><a href="{{ url_for('hr.hr_list') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list"></i>Elenco Dipendenti
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_my_hr_data() %}
                        <li><a href="{{ url_for('hr.hr_detail', user_id=current_user.id) }}" class="sidebar-submenu-link">
                            <i class="fas fa-user"></i>I Miei Dati HR
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_hr_data() or current_user.can_view_hr_data() %}
                        <li><a href="{{ url_for('hr.hr_export') }}" class="sidebar-submenu-link">
                            <i class="fas fa-file-excel"></i>Export Excel
                        </a></li>
                        {% endif %}
                        {% if current_user.can_access_mansioni_menu() %}
                        <li><a href="{{ url_for('mansioni.index') }}" class="sidebar-submenu-link">
                            <i class="fas fa-briefcase"></i>Mansionario
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- COMMESSE - Gestione Progetti -->
                {% if current_user.can_access_commesse_menu() %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-project-diagram"></i>
                        <span>Commesse</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_commesse() or current_user.can_view_commesse() %}
                        <li><a href="{{ url_for('commesse.manage_commesse') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list"></i>Elenco Commesse
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_commesse() %}
                        <li><a href="{{ url_for('commesse.create_commessa') }}" class="sidebar-submenu-link">
                            <i class="fas fa-plus"></i>Nuova Commessa
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- SEDI - Solo se ha almeno un permesso sedi -->
                {% set has_sedi_permission = current_user.can_manage_sedi() or current_user.can_view_sedi() %}
                {% if has_sedi_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-building"></i>
                        <span>Sedi</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_sedi() %}
                        <li><a href="{{ url_for('admin.manage_sedi') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Sedi
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_sedi() %}
                        <li><a href="{{ url_for('admin.manage_sedi') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Sedi
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- ORARI - Solo se ha almeno un permesso orari -->
                {% set has_schedules_permission = current_user.can_manage_schedules() or current_user.can_view_schedules() %}
                {% if has_schedules_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-clock"></i>
                        <span>Orari</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_schedules() %}
                        <li><a href="{{ url_for('admin.manage_work_schedules') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Orari
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_schedules() %}
                        <li><a href="{{ url_for('admin.manage_work_schedules') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Orari
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- TURNI - Solo se ha almeno un permesso turni E sede supporta turni -->
                {% set has_shifts_permission = current_user.can_manage_shifts() or current_user.can_view_shifts() %}
                {% if has_shifts_permission and ((current_user.sede_obj and current_user.sede_obj.is_turni_mode()) or current_user.all_sedi) %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Turni</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_shifts() %}
                        <li><a href="{{ url_for('presidio.presidio_coverage') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestione Coperture
                        </a></li>
                        <li><a href="{{ url_for('shifts.turni_automatici') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cogs"></i>Gestione Turni
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_shifts() %}
                        <li><a href="{{ url_for('presidio.presidio_coverage') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizza Coperture
                        </a></li>
                        <li><a href="{{ url_for('shifts.visualizza_turni') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list"></i>Visualizza Turni
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- REPERIBILITÀ - Solo se ha almeno un permesso reperibilità -->
                {% set has_reperibilita_permission = current_user.can_manage_reperibilita() or current_user.can_view_reperibilita() or current_user.can_manage_coverage() or current_user.can_view_coverage() or current_user.can_manage_interventions() or current_user.can_view_interventions() %}
                {% if has_reperibilita_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-phone-alt"></i>
                        <span>Reperibilità</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_reperibilita() %}
                        <li><a href="{{ url_for('reperibilita.generate_shifts') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Reperibilità
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_reperibilita() %}
                        <li><a href="{{ url_for('reperibilita.reperibilita_shifts') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Reperibilità
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_coverage() %}
                        <li><a href="{{ url_for('reperibilita.reperibilita_coverage') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Coperture Reperibilità
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_coverage() %}
                        <li><a href="{{ url_for('reperibilita.reperibilita_coverage') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Coperture Reperibilità
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_interventions() %}
                        <li><a href="{{ url_for('interventions.my') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Interventi
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_interventions() %}
                        <li><a href="{{ url_for('interventions.my') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Interventi
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- PRESENZE - Solo se ha almeno un permesso presenze -->
                {% set has_attendance_permission = current_user.can_manage_attendance() or current_user.can_view_attendance() or current_user.can_access_attendance() or current_user.can_view_sede_attendance() or current_user.can_access_timesheets() %}
                {% if has_attendance_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-clock"></i>
                        <span>Presenze</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_access_attendance() %}
                        <li><a href="{{ url_for('attendance.my_attendance') }}" class="sidebar-submenu-link">
                            <i class="fas fa-user-clock"></i>Le Mie Presenze
                        </a></li>
                        {% endif %}
                        {% if current_user.can_access_timesheets() %}
                        <li><a href="{{ url_for('attendance.timesheets') }}" class="sidebar-submenu-link">
                            <i class="fas fa-calendar-alt"></i>Timesheets
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_sede_attendance() %}
                        <li><a href="{{ url_for('attendance.attendance', view='sede') }}" class="sidebar-submenu-link">
                            <i class="fas fa-users"></i>Presenze Sede
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_attendance() %}
                        <li><a href="{{ url_for('dashboard.dashboard_team') }}" class="sidebar-submenu-link">
                            <i class="fas fa-chart-line"></i>Dashboard Presenze
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_hr_data() or current_user.can_manage_commesse() or current_user.role in ['Admin', 'Amministratore'] %}
                        <li><a href="{{ url_for('attendance.timesheet_reopen_requests') }}" class="sidebar-submenu-link">
                            <i class="fas fa-unlock-alt"></i>Richieste Riapertura
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- FERIE/PERMESSI/MALATTIE - Solo se ha almeno un permesso leave -->
                {% set has_leave_permission = current_user.can_manage_leave() or current_user.can_view_leave() or current_user.can_request_leave() or current_user.can_manage_leave_types() %}
                {% if has_leave_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-calendar-check"></i>
                        <span>Assenze</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_request_leave() %}
                        <li><a href="{{ url_for('leave.create_leave_request') }}" class="sidebar-submenu-link">
                            <i class="fas fa-plus"></i>Richiedi Assenza
                        </a></li>
                        <li><a href="{{ url_for('leave.leave_requests', view='my') }}" class="sidebar-submenu-link">
                            <i class="fas fa-user"></i>Le Mie Richieste
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_leave() %}
                        <li><a href="{{ url_for('leave.leave_types') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list-alt"></i>Gestisci Tipologie
                        </a></li>
                        {% endif %}
                        {% if current_user.can_approve_leave() %}
                        <li><a href="{{ url_for('leave.leave_requests', view='approve') }}" class="sidebar-submenu-link">
                            <i class="fas fa-check"></i>Approva Richieste
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_leave() %}
                        <li><a href="{{ url_for('leave.leave_requests', view='view') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizza Richieste
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- STRAORDINARI - Solo se ha almeno un permesso straordinari -->
                {% set has_overtime_permission = current_user.can_access_overtime_menu() %}
                {% if has_overtime_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-business-time"></i>
                        <span>Straordinari</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_create_overtime_requests() %}
                        <li><a href="{{ url_for('expense.create_overtime_request') }}" class="sidebar-submenu-link">
                            <i class="fas fa-plus"></i>Nuova Richiesta
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_my_overtime_requests() %}
                        <li><a href="{{ url_for('expense.my_overtime_requests') }}" class="sidebar-submenu-link">
                            <i class="fas fa-user-clock"></i>Le Mie Richieste
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_overtime_requests() or current_user.can_approve_overtime_requests() %}
                        <li><a href="{{ url_for('expense.overtime_requests_management') }}" class="sidebar-submenu-link">
                            <i class="fas fa-tasks"></i>Gestisci Richieste
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_overtime_types() %}
                        <li><a href="{{ url_for('expense.overtime_types') }}" class="sidebar-submenu-link">
                            <i class="fas fa-tags"></i>Gestisci Tipologie
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- NOTE SPESE - Solo se ha almeno un permesso note spese -->
                {% set has_expense_permission = current_user.can_access_expense_reports_menu() %}
                {% if has_expense_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-receipt"></i>
                        <span>Note Spese</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_create_expense_reports() %}
                        <li><a href="{{ url_for('expense.create_expense_report') }}" class="sidebar-submenu-link">
                            <i class="fas fa-plus"></i>Crea Nota Spese
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_my_expense_reports() %}
                        <li><a href="{{ url_for('expense.expense_reports') }}?view=my" class="sidebar-submenu-link">
                            <i class="fas fa-user"></i>Le Mie Note Spese
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_expense_reports() or current_user.can_approve_expense_reports() %}
                        <li><a href="{{ url_for('expense.expense_reports') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list"></i>Visualizza Note Spese
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_expense_reports() %}
                        <li><a href="{{ url_for('expense.expense_categories') }}" class="sidebar-submenu-link">
                            <i class="fas fa-tags"></i>Gestisci Categorie
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- RIMBORSI CHILOMETRICI - Solo se ha almeno un permesso rimborsi -->
                {% set has_mileage_permission = current_user.can_access_mileage_menu() %}
                {% if has_mileage_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-car"></i>
                        <span>Rimborsi Chilometrici</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_create_mileage_requests() %}
                        <li><a href="{{ url_for('expense.create_mileage_request') }}" class="sidebar-submenu-link">
                            <i class="fas fa-plus"></i>Nuova Richiesta
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_my_mileage_requests() %}
                        <li><a href="{{ url_for('expense.my_mileage_requests') }}" class="sidebar-submenu-link">
                            <i class="fas fa-user"></i>Le Mie Richieste
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_mileage_requests() or current_user.can_manage_mileage_requests() %}
                        <li><a href="{{ url_for('expense.mileage_requests') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list"></i>Visualizza Richieste
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- FESTIVITÀ - Solo se ha almeno un permesso festività -->
                {% set has_holidays_permission = current_user.can_manage_holidays() or current_user.can_view_holidays() %}
                {% if has_holidays_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-gifts"></i>
                        <span>Festività</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_holidays() %}
                        <li><a href="{{ url_for('holidays.holidays') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Festività
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_holidays() %}
                        <li><a href="{{ url_for('holidays.holidays') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Festività
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- TABELLE ACI - Solo per amministratori -->
                {% if current_user.has_role('Amministratore') %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-car"></i>
                        <span>Tabelle ACI</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        <li><a href="{{ url_for('aci.tables') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list"></i>Visualizza Tabelle
                        </a></li>
                        <li><a href="{{ url_for('aci.upload') }}" class="sidebar-submenu-link">
                            <i class="fas fa-upload"></i>Carica Excel
                        </a></li>
                        <li><a href="{{ url_for('aci.create') }}" class="sidebar-submenu-link">
                            <i class="fas fa-plus"></i>Nuovo Record
                        </a></li>
                        <li><a href="{{ url_for('aci.export') }}" class="sidebar-submenu-link">
                            <i class="fas fa-download"></i>Export Excel
                        </a></li>
                    </ul>
                </li>
                {% endif %}

                <!-- GESTIONE QR - Solo se ha almeno un permesso QR -->
                {% set has_qr_permission = current_user.can_manage_qr() %}
                {% if has_qr_permission %}
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('admin.admin_qr_codes') }}" class="sidebar-nav-link">
                        <i class="fas fa-qrcode"></i>
                        <span>Gestione QR</span>
                    </a>
                </li>
                {% endif %}

                <!-- STATISTICHE/REPORT - Solo se ha almeno un permesso report -->
                {% set has_reports_permission = current_user.can_view_reports() %}
                {% if has_reports_permission %}
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('reports.reports') }}" class="sidebar-nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>Statistiche</span>
                    </a>
                </li>
                {% endif %}
            {% endif %}
            </ul>
        </nav>

        <!-- Content Wrapper - Full width nella home page -->
        <div class="content-wrapper {% if request.endpoint == 'index' or request.endpoint == 'home' or request.endpoint == 'user_management.user_profile' %}sidebar-collapsed{% endif %}" id="content-wrapper">
            <!-- Main Content -->
            <div class="main-content">
                <div class="container-fluid" style="{% if request.endpoint == 'index' or request.endpoint == 'home' or request.endpoint == 'user_management.user_profile' %}padding: 0;{% endif %}">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <div class="content-area">
                        {% block content %}{% endblock %}
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="app-footer">
                <div class="container-fluid">
                    <div class="text-center py-2">
                        <small class="text-muted">
                            <strong>Life Platform</strong> - Gestione del personale e benessere aziendale<br>
                            <a href="{{ url_for('legal.privacy') }}" class="text-muted me-2"><i class="fas fa-shield-alt me-1"></i>Privacy Policy</a>
                            <a href="{{ url_for('legal.terms') }}" class="text-muted me-2"><i class="fas fa-file-contract me-1"></i>Termini di Servizio</a>
                            <a href="javascript:void(0)" onclick="manageCookies()" class="text-muted"><i class="fas fa-cookie-bite me-1"></i>Cookie</a>
                        </small>
                    </div>
                </div>
            </footer>
        </div>
    {% endif %}
    
    <!-- Non-authenticated layout (login page) -->
    {% if not current_user.is_authenticated %}
    <div class="min-vh-100 d-flex flex-column">
        <div class="flex-grow-1 d-flex justify-content-center align-items-center">
            <div class="col-md-4">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                {% block login_content %}{% endblock %}
            </div>
        </div>
        
        <!-- Login Footer -->
        <div class="py-3">
            <div class="text-center">
                <small class="text-muted">
                    <strong>Life Platform</strong> - Gestione del personale e benessere aziendale<br>
                    <a href="{{ url_for('legal.privacy') }}" class="text-muted me-2"><i class="fas fa-shield-alt me-1"></i>Privacy Policy</a>
                    <a href="{{ url_for('legal.terms') }}" class="text-muted me-2"><i class="fas fa-file-contract me-1"></i>Termini di Servizio</a>
                    <a href="javascript:void(0)" onclick="manageCookies()" class="text-muted"><i class="fas fa-cookie-bite me-1"></i>Cookie</a>
                </small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sidebar functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const contentWrapper = document.getElementById('content-wrapper');
            
            // Su mobile usa la classe 'show', su desktop usa 'sidebar-collapsed'
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('show');
            } else {
                sidebar.classList.toggle('sidebar-collapsed');
                if (contentWrapper) {
                    contentWrapper.classList.toggle('sidebar-collapsed');
                }
            }
        }

        function toggleSubmenu(link) {
            const submenu = link.nextElementSibling;
            const isExpanded = link.classList.contains('expanded');
            
            // Close all other submenus
            document.querySelectorAll('.sidebar-nav-link.expanded').forEach(el => {
                if (el !== link) {
                    el.classList.remove('expanded');
                    el.nextElementSibling.classList.remove('show');
                }
            });
            
            // Toggle current submenu
            if (isExpanded) {
                link.classList.remove('expanded');
                submenu.classList.remove('show');
            } else {
                link.classList.add('expanded');
                submenu.classList.add('show');
            }
        }

        // Mobile sidebar toggle
        document.addEventListener('DOMContentLoaded', function() {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.add('sidebar-collapsed');
                }
            }
        });

        // Close sidebar on mobile when clicking outside
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const mobileToggleButton = document.querySelector('.sidebar-mobile-toggle');
                
                // Se la sidebar è aperta e clicchi fuori (non sulla sidebar stessa o sul toggle button)
                if (sidebar && sidebar.classList.contains('show')) {
                    const clickedOnSidebar = sidebar.contains(e.target);
                    const clickedOnToggle = mobileToggleButton && mobileToggleButton.contains(e.target);
                    
                    if (!clickedOnSidebar && !clickedOnToggle) {
                        sidebar.classList.remove('show');
                    }
                }
            }
        });

        // Add CSRF token to all forms
        document.addEventListener('DOMContentLoaded', function() {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const forms = document.querySelectorAll('form');
            
            forms.forEach(function(form) {
                if (!form.querySelector('input[name="csrf_token"]')) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'csrf_token';
                    input.value = csrfToken;
                    form.appendChild(input);
                }
            });
        });

    </script>
    <!-- Global Loading Overlay -->
    <div id="globalLoadingOverlay" class="loading-overlay d-none">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="text-white">Elaborazione in corso...</h5>
            <p class="text-white-50 mb-0">Attendere prego</p>
        </div>
    </div>

    <!-- Global Confirmation Modal -->
    <div class="modal fade" id="globalConfirmModal" tabindex="-1" aria-labelledby="globalConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="globalConfirmModalLabel">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>Conferma Operazione
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="globalConfirmModalBody">
                    <!-- Il messaggio verrà inserito dinamicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Annulla
                    </button>
                    <button type="button" class="btn btn-danger" id="globalConfirmModalOk">
                        <i class="fas fa-check me-1"></i>Conferma
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Loading Script -->
    <script>
        // Global Loading Overlay System
        class LoadingManager {
            constructor() {
                this.overlay = document.getElementById('globalLoadingOverlay');
                this.isShowing = false;
                this.timeoutId = null;
            }

            show() {
                if (!this.isShowing) {
                    this.overlay.classList.remove('d-none');
                    this.isShowing = true;
                    // Auto-hide dopo 30 secondi come fallback
                    this.timeoutId = setTimeout(() => {
                        this.hide();
                    }, 30000);
                }
            }

            hide() {
                if (this.isShowing) {
                    this.overlay.classList.add('d-none');
                    this.isShowing = false;
                    if (this.timeoutId) {
                        clearTimeout(this.timeoutId);
                        this.timeoutId = null;
                    }
                }
            }
        }

        // Initialize global loading manager
        const loadingManager = new LoadingManager();

        // Auto-attach to forms and buttons that cause navigation/submission
        document.addEventListener('DOMContentLoaded', function() {
            // Form submissions (excluding forms inside modals for cancel actions)
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    // Check if the form is being submitted by a modal dismiss button
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.hasAttribute('data-bs-dismiss')) {
                        return; // Don't show overlay for modal dismiss actions
                    }
                    
                    // Delay slightly to allow form processing
                    setTimeout(() => {
                        loadingManager.show();
                    }, 100);
                });
            });

            // Links that cause navigation (excluding anchors, modals, export links, download links, modal dismiss buttons, and no-loading class)
            document.querySelectorAll('a[href]:not([href^="#"]):not([data-bs-toggle]):not([href*="export"]):not([href*="download"]):not([data-bs-dismiss]):not(.no-loading)').forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    // Only show loading for internal navigation
                    if (href && !href.startsWith('http') && !href.startsWith('mailto') && !href.startsWith('tel')) {
                        setTimeout(() => {
                            loadingManager.show();
                        }, 100);
                    }
                });
            });

            // Disable overlay for all modal dismiss buttons (Annulla, Close)
            document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(dismissBtn => {
                dismissBtn.addEventListener('click', function(e) {
                    // Never show loading overlay for modal dismiss actions
                    e.stopPropagation();
                });
            });

            // Also disable overlay for buttons with "Annulla" text (backup protection)
            document.querySelectorAll('button').forEach(btn => {
                if (btn.textContent.trim().toLowerCase().includes('annulla')) {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }
            });

            // Export buttons - Solo feedback sul pulsante senza overlay
            document.querySelectorAll('a[href*="export"], .export-btn').forEach(exportBtn => {
                exportBtn.addEventListener('click', function(e) {
                    // Cambia il testo del pulsante per indicare generazione in corso
                    const originalHTML = this.innerHTML;
                    const originalClass = this.className;
                    
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generazione in corso...';
                    this.classList.add('disabled');
                    this.style.pointerEvents = 'none';
                    
                    // Ripristina dopo 5 secondi (tempo ragionevole per download)
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                        this.className = originalClass;
                        this.style.pointerEvents = 'auto';
                    }, 5000);
                });
            });

            // Download buttons - Solo feedback sul pulsante senza overlay
            document.querySelectorAll('a[href*="download"]').forEach(downloadBtn => {
                downloadBtn.addEventListener('click', function(e) {
                    // Cambia il testo del pulsante per indicare download in corso
                    const originalHTML = this.innerHTML;
                    const originalClass = this.className;
                    
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Download...';
                    this.classList.add('disabled');
                    this.style.pointerEvents = 'none';
                    
                    // Ripristina dopo 3 secondi (tempo ragionevole per iniziare il download)
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                        this.className = originalClass;
                        this.style.pointerEvents = 'auto';
                    }, 3000);
                });
            });

            // Hide loading on page load (in case of back navigation)
            loadingManager.hide();
        });

        // Hide loading on page visibility change or beforeunload
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                loadingManager.hide();
            }
        });

        window.addEventListener('beforeunload', function() {
            loadingManager.hide();
        });

        // Expose globally for manual control
        window.showLoading = () => loadingManager.show();
        window.hideLoading = () => loadingManager.hide();

        // Global Confirmation Modal System
        class ConfirmationManager {
            constructor() {
                this.modal = new bootstrap.Modal(document.getElementById('globalConfirmModal'));
                this.currentCallback = null;
                this.setupEventListeners();
            }

            setupEventListeners() {
                const confirmBtn = document.getElementById('globalConfirmModalOk');
                const modal = document.getElementById('globalConfirmModal');

                if (confirmBtn) {
                    confirmBtn.addEventListener('click', () => {
                        this.modal.hide();
                        if (this.currentCallback) {
                            setTimeout(() => {
                                this.currentCallback();
                                this.currentCallback = null;
                            }, 300);
                        }
                    });
                }

                if (modal) {
                    modal.addEventListener('hidden.bs.modal', () => {
                        this.currentCallback = null;
                    });
                }
            }

            show(title, message, onConfirm, confirmBtnText = 'Conferma', confirmBtnClass = 'btn-danger') {
                document.getElementById('globalConfirmModalLabel').innerHTML = 
                    `<i class="fas fa-exclamation-triangle text-warning me-2"></i>${title}`;
                document.getElementById('globalConfirmModalBody').innerHTML = message;
                
                const confirmBtn = document.getElementById('globalConfirmModalOk');
                confirmBtn.className = `btn ${confirmBtnClass}`;
                confirmBtn.innerHTML = `<i class="fas fa-check me-1"></i>${confirmBtnText}`;
                
                this.currentCallback = onConfirm;
                this.modal.show();
            }
        }

        // Initialize global confirmation manager
        const confirmationManager = new ConfirmationManager();

        // Replace all confirm() calls with custom modal
        window.showConfirm = (title, message, onConfirm, confirmBtnText, confirmBtnClass) => {
            confirmationManager.show(title, message, onConfirm, confirmBtnText, confirmBtnClass);
        };

        // Function to replace form onsubmit with modal confirmation
        function replaceConfirmForms() {
            document.querySelectorAll('form[onsubmit*="confirm("]').forEach(form => {
                const onsubmitAttr = form.getAttribute('onsubmit');
                const confirmMatch = onsubmitAttr.match(/confirm\('([^']+)'\)/);
                
                if (confirmMatch) {
                    const confirmMessage = confirmMatch[1];
                    
                    // Remove the original onsubmit attribute
                    form.removeAttribute('onsubmit');
                    
                    // Add click handler to submit button
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Extract specific title and message from confirmMessage
                            let title = 'Conferma Eliminazione';
                            let message = confirmMessage;
                            let confirmBtnText = 'Elimina';
                            let confirmBtnClass = 'btn-danger';
                            
                            // Customize based on message content
                            if (confirmMessage.includes('nota spese')) {
                                title = 'Elimina Nota Spese';
                                message = '<p><i class="fas fa-receipt me-2 text-danger"></i>Vuoi eliminare definitivamente questa nota spese?</p>' +
                                         '<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>' +
                                         '<strong>Attenzione:</strong> Tutti i dati verranno persi per sempre.</small></div>';
                            } else if (confirmMessage.includes('tipologia')) {
                                title = 'Elimina Tipologia';
                                message = '<p><i class="fas fa-tags me-2 text-danger"></i>Vuoi eliminare definitivamente questa tipologia di permesso?</p>' +
                                         '<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>' +
                                         '<strong>Attenzione:</strong> Non sarà più possibile utilizzarla per nuove richieste.</small></div>';
                            } else if (confirmMessage.includes('utente')) {
                                title = 'Elimina Utente';
                                message = '<p><i class="fas fa-user-times me-2 text-danger"></i>Vuoi eliminare definitivamente questo utente?</p>' +
                                         '<div class="alert alert-danger mt-3 mb-0"><small><i class="fas fa-exclamation-triangle me-1"></i>' +
                                         '<strong>Attenzione:</strong> Tutti i dati associati verranno persi per sempre.</small></div>';
                            } else if (confirmMessage.includes('sede')) {
                                title = 'Elimina Sede';
                                message = '<p><i class="fas fa-building me-2 text-danger"></i>Vuoi eliminare definitivamente questa sede?</p>' +
                                         '<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>' +
                                         '<strong>Attenzione:</strong> L\'operazione non può essere annullata.</small></div>';
                            } else if (confirmMessage.includes('ruolo')) {
                                title = 'Elimina Ruolo';
                                message = '<p><i class="fas fa-user-tag me-2 text-danger"></i>Vuoi eliminare definitivamente questo ruolo?</p>' +
                                         '<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>' +
                                         '<strong>Attenzione:</strong> Gli utenti associati perderanno i permessi di questo ruolo.</small></div>';
                            } else if (confirmMessage.includes('orario')) {
                                title = 'Elimina Orario di Lavoro';
                                message = '<p><i class="fas fa-clock me-2 text-danger"></i>Vuoi eliminare definitivamente questo orario di lavoro?</p>' +
                                         '<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>' +
                                         '<strong>Attenzione:</strong> Gli utenti assegnati perderanno questo orario.</small></div>';
                            } else if (confirmMessage.includes('turni')) {
                                title = 'Elimina Turni';
                                message = '<p><i class="fas fa-calendar-times me-2 text-danger"></i>Vuoi eliminare questi turni?</p>' +
                                         '<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>' +
                                         '<strong>Attenzione:</strong> I turni verranno rimossi dal sistema.</small></div>';
                            } else {
                                // Generic fallback
                                message = '<p><i class="fas fa-exclamation-triangle me-2 text-warning"></i>' + confirmMessage + '</p>';
                            }
                            
                            confirmationManager.show(title, message, () => {
                                form.submit();
                            }, confirmBtnText, confirmBtnClass);
                        });
                    }
                }
            });
        }

        // Run replacement on page load
        replaceConfirmForms();

        // Also run when new content is added dynamically
        const observer = new MutationObserver(() => {
            replaceConfirmForms();
        });
        observer.observe(document.body, { childList: true, subtree: true });

        // Global confirmDelete function for consistent deletion confirmations
        window.confirmDelete = function(itemName, deleteUrl, itemType = 'elemento') {
            let title = 'Conferma Eliminazione';
            let message = `<p><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Vuoi eliminare definitivamente <strong>${itemName}</strong>?</p>` +
                         `<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>` +
                         `<strong>Attenzione:</strong> Questa operazione non può essere annullata.</small></div>`;
            
            // Customize based on item type
            if (itemType === 'categoria' || deleteUrl.includes('categories')) {
                title = 'Elimina Categoria';
                message = `<p><i class="fas fa-tags me-2 text-danger"></i>Vuoi eliminare definitivamente la categoria <strong>${itemName}</strong>?</p>` +
                         `<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>` +
                         `<strong>Attenzione:</strong> Non sarà più possibile utilizzarla per nuove voci.</small></div>`;
            }
            
            confirmationManager.show(title, message, () => {
                // Create a form and submit it
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = deleteUrl;
                
                // Add CSRF token if available
                const csrfToken = document.querySelector('meta[name=csrf-token]');
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrf_token';
                    csrfInput.value = csrfToken.getAttribute('content');
                    form.appendChild(csrfInput);
                }
                
                document.body.appendChild(form);
                form.submit();
            }, 'Elimina', 'btn-danger');
        };
    </script>

    <!-- Cookie Consent Banner (GDPR Compliance) -->
    <div id="cookieConsentBanner" class="cookie-consent-banner" style="display: none;">
        <div class="cookie-consent-content">
            <div class="cookie-consent-text">
                <h5><i class="fas fa-cookie-bite me-2"></i>Questo sito utilizza i cookie</h5>
                <p>Utilizziamo cookie essenziali per garantire il funzionamento della piattaforma e cookie di preferenza per migliorare la tua esperienza. Continuando a utilizzare il sito, acconsenti all'uso dei cookie in conformità con la nostra <a href="{{ url_for('legal.privacy') }}" class="text-primary">Privacy Policy</a>.</p>
            </div>
            <div class="cookie-consent-buttons">
                <button type="button" class="btn btn-outline-light btn-sm" onclick="manageCookies()">
                    <i class="fas fa-cog me-1"></i>Gestisci
                </button>
                <button type="button" class="btn btn-light btn-sm" onclick="acceptAllCookies()">
                    <i class="fas fa-check me-1"></i>Accetta Tutti
                </button>
            </div>
        </div>
    </div>

    <!-- Cookie Settings Modal -->
    <div class="modal fade" id="cookieSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-cookie-bite me-2"></i>Impostazioni Cookie</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Gestisci le tue preferenze sui cookie. I cookie essenziali sono sempre attivi perché necessari per il funzionamento della piattaforma.</p>
                    
                    <div class="cookie-category mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Cookie Essenziali</h6>
                                <small class="text-muted">Necessari per autenticazione, sessione e sicurezza (CSRF)</small>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" checked disabled>
                            </div>
                        </div>
                    </div>

                    <div class="cookie-category mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-sliders-h me-2"></i>Cookie di Preferenza</h6>
                                <small class="text-muted">Memorizzano le tue preferenze (tema, lingua, impostazioni interfaccia)</small>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="preferenceCookies" checked>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <small><i class="fas fa-info-circle me-1"></i>Non utilizziamo cookie di terze parti o di tracciamento per finalità pubblicitarie.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-primary" onclick="saveCookiePreferences()">
                        <i class="fas fa-save me-1"></i>Salva Preferenze
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .cookie-consent-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-top: 2px solid #007bff;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            z-index: 9999;
            padding: 1rem;
        }

        .cookie-consent-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .cookie-consent-text {
            flex: 1;
            min-width: 250px;
        }

        .cookie-consent-text h5 {
            color: #fff;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .cookie-consent-text p {
            color: #ccc;
            margin-bottom: 0;
            font-size: 0.9rem;
        }

        .cookie-consent-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .cookie-category {
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 0.5rem;
        }

        @media (max-width: 768px) {
            .cookie-consent-content {
                flex-direction: column;
                align-items: stretch;
            }

            .cookie-consent-buttons {
                justify-content: stretch;
            }

            .cookie-consent-buttons button {
                flex: 1;
            }
        }
    </style>

    <script>
        // Cookie Consent Management using localStorage (works better in iframe environments like Replit)
        const COOKIE_CONSENT_KEY = 'life_cookie_consent';

        function getConsentFromStorage() {
            try {
                const consent = localStorage.getItem(COOKIE_CONSENT_KEY);
                return consent ? JSON.parse(consent) : null;
            } catch (e) {
                console.error('Error reading consent from storage:', e);
                return null;
            }
        }

        function saveConsentToStorage(preferences) {
            try {
                localStorage.setItem(COOKIE_CONSENT_KEY, JSON.stringify(preferences));
                return true;
            } catch (e) {
                console.error('Error saving consent to storage:', e);
                return false;
            }
        }

        function checkCookieConsent() {
            const consent = getConsentFromStorage();
            const banner = document.getElementById('cookieConsentBanner');
            
            if (!consent) {
                // Show banner if no consent given
                banner.style.display = 'block';
            } else {
                // Hide banner and apply saved preferences
                banner.style.display = 'none';
                applyCookiePreferences(consent);
            }
        }

        function acceptAllCookies() {
            const preferences = {
                essential: true,
                preference: true,
                timestamp: new Date().toISOString()
            };
            
            if (saveConsentToStorage(preferences)) {
                document.getElementById('cookieConsentBanner').style.display = 'none';
                applyCookiePreferences(preferences);
            } else {
                alert('Errore nel salvataggio delle preferenze. Riprova.');
            }
        }

        function manageCookies() {
            const modal = new bootstrap.Modal(document.getElementById('cookieSettingsModal'));
            modal.show();
            
            // Load current preferences
            const consent = getConsentFromStorage();
            if (consent) {
                document.getElementById('preferenceCookies').checked = consent.preference || false;
            }
        }

        function saveCookiePreferences() {
            const preferences = {
                essential: true, // Always true
                preference: document.getElementById('preferenceCookies').checked,
                timestamp: new Date().toISOString()
            };
            
            if (saveConsentToStorage(preferences)) {
                document.getElementById('cookieConsentBanner').style.display = 'none';
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('cookieSettingsModal'));
                modal.hide();
                
                applyCookiePreferences(preferences);
                
                // Show success message
                alert('Preferenze cookie salvate con successo!');
            } else {
                alert('Errore nel salvataggio delle preferenze. Riprova.');
            }
        }

        function applyCookiePreferences(preferences) {
            // Apply cookie preferences (currently only essential and preference cookies)
            // This can be extended to disable/enable specific features based on preferences
            console.log('Cookie preferences applied:', preferences);
        }

        // Check consent on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkCookieConsent();
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
