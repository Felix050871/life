<!DOCTYPE html>
<html lang="it" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}Workly - Workforce Management Platform{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <!-- SheetJS for Excel export -->  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Main Layout -->
    {% if current_user.is_authenticated %}
    <!-- Project Title Bar with User Menu -->
    <div class="project-title-bar">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-briefcase me-2"></i>Workly Platform
                </h5>
                
                <!-- User Menu and Messages -->
                <div class="d-flex align-items-center gap-3">
                    <!-- Messages -->
                    {% if current_user.can_send_messages() or current_user.can_view_messages() %}
                    <div class="dropdown">
                        <a class="btn btn-outline-light btn-sm dropdown-toggle position-relative" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-envelope me-1"></i>
                            {% if unread_messages_count > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem; padding: 0.2em 0.4em; margin-left: -0.5rem;">
                                {{ unread_messages_count if unread_messages_count < 100 else '99+' }}
                            </span>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            {% if current_user.can_send_messages() %}
                            <li><a class="dropdown-item" href="{{ url_for('send_message') }}">
                                <i class="fas fa-paper-plane me-1"></i>Invia Messaggio
                            </a></li>
                            {% endif %}
                            {% if current_user.can_view_messages() %}
                            <li><a class="dropdown-item" href="{{ url_for('internal_messages') }}">
                                <i class="fas fa-inbox me-1"></i>Visualizza Messaggi
                            </a></li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <!-- User Menu -->
                    <div class="dropdown">
                        <a class="btn btn-outline-light btn-sm dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>{{ current_user.first_name or current_user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('user_profile') }}">
                                <i class="fas fa-user-edit me-1"></i>Profilo
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                                <i class="fas fa-sign-out-alt me-1"></i>Logout
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-wrapper">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="{% if current_user.can_access_dashboard() %}{{ url_for('dashboard.dashboard') }}{% else %}{{ url_for('index') }}{% endif %}" class="brand">
                    <i class="fas fa-briefcase me-2"></i><span>Workly</span>
                </a>
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <ul class="sidebar-nav">
                <!-- DASHBOARD -->
                {% if current_user.can_access_dashboard() %}
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('dashboard.dashboard') }}" class="sidebar-nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                {% endif %}
                <!-- RUOLI - Solo se ha almeno un permesso ruoli -->
                {% set has_roles_permission = current_user.can_manage_roles() or current_user.can_view_roles() %}
                {% if has_roles_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-users-gear"></i>
                        <span>Ruoli</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_roles() %}
                        <li><a href="{{ url_for('manage_roles') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Ruoli
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_roles() %}
                        <li><a href="{{ url_for('manage_roles') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Ruoli
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- UTENTI - Temporarily disabled during blueprint migration -->
                <!-- {% set has_users_permission = current_user.can_manage_users() or current_user.can_view_users() %} -->

                <!-- SEDI - Solo se ha almeno un permesso sedi -->
                {% set has_sedi_permission = current_user.can_manage_sedi() or current_user.can_view_sedi() %}
                {% if has_sedi_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-building"></i>
                        <span>Sedi</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_sedi() %}
                        <li><a href="{{ url_for('manage_sedi') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Sedi
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_sedi() %}
                        <li><a href="{{ url_for('manage_sedi') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Sedi
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- ORARI - Solo se ha almeno un permesso orari -->
                {% set has_schedules_permission = current_user.can_manage_schedules() or current_user.can_view_schedules() %}
                {% if has_schedules_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-clock"></i>
                        <span>Orari</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_schedules() %}
                        <li><a href="{{ url_for('manage_work_schedules') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Orari
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_schedules() %}
                        <li><a href="{{ url_for('manage_work_schedules') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Orari
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- TURNI - Solo se ha almeno un permesso turni E sede supporta turni -->
                {% set has_shifts_permission = current_user.can_manage_shifts() or current_user.can_view_shifts() %}
                {% if has_shifts_permission and ((current_user.sede_obj and current_user.sede_obj.is_turni_mode()) or current_user.all_sedi) %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Turni</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_shifts() %}
                        <li><a href="{{ url_for('presidio_coverage') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestione Coperture
                        </a></li>
                        <li><a href="{{ url_for('shifts.turni_automatici') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cogs"></i>Gestione Turni
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_shifts() %}
                        <li><a href="{{ url_for('view_presidi') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizza Coperture
                        </a></li>
                        <li><a href="{{ url_for('shifts.visualizza_turni') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list"></i>Visualizza Turni
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- REPERIBILITÀ - Solo se ha almeno un permesso reperibilità -->
                {% set has_reperibilita_permission = current_user.can_manage_reperibilita() or current_user.can_view_reperibilita() or current_user.can_manage_coverage() or current_user.can_view_coverage() or current_user.can_manage_interventions() or current_user.can_view_interventions() %}
                {% if has_reperibilita_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-phone-alt"></i>
                        <span>Reperibilità</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_reperibilita() %}
                        <li><a href="{{ url_for('generate_reperibilita_shifts') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Reperibilità
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_reperibilita() %}
                        <li><a href="{{ url_for('reperibilita_shifts') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Reperibilità
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_coverage() %}
                        <li><a href="{{ url_for('reperibilita_coverage') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Coperture Reperibilità
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_coverage() %}
                        <li><a href="{{ url_for('reperibilita_coverage') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Coperture Reperibilità
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_interventions() %}
                        <li><a href="{{ url_for('my_interventions') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Interventi
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_interventions() %}
                        <li><a href="{{ url_for('my_interventions') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Interventi
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- PRESENZE - Solo se ha almeno un permesso presenze -->
                {% set has_attendance_permission = current_user.can_manage_attendance() or current_user.can_view_attendance() or current_user.can_access_attendance() or current_user.can_view_sede_attendance() %}
                {% if has_attendance_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-clock"></i>
                        <span>Presenze</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_access_attendance() %}
                        <li><a href="{{ url_for('attendance') }}" class="sidebar-submenu-link">
                            <i class="fas fa-user-clock"></i>Le Mie Presenze
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_sede_attendance() %}
                        <li><a href="{{ url_for('attendance', view='sede') }}" class="sidebar-submenu-link">
                            <i class="fas fa-users"></i>Presenze Sede
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_attendance() %}
                        <li><a href="{{ url_for('dashboard.dashboard_team') }}" class="sidebar-submenu-link">
                            <i class="fas fa-chart-line"></i>Dashboard Presenze
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- FERIE/PERMESSI/MALATTIE - Solo se ha almeno un permesso leave -->
                {% set has_leave_permission = current_user.can_manage_leave() or current_user.can_view_leave() or current_user.can_request_leave() or current_user.can_manage_leave_types() %}
                {% if has_leave_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-calendar-check"></i>
                        <span>Ferie/Permessi</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_request_leave() %}
                        <li><a href="{{ url_for('leave.create_leave_request') }}" class="sidebar-submenu-link">
                            <i class="fas fa-plus"></i>Richiedi Ferie/Permessi
                        </a></li>
                        <li><a href="{{ url_for('leave.leave_requests', view='my') }}" class="sidebar-submenu-link">
                            <i class="fas fa-user"></i>Le Mie Richieste
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_leave() %}
                        <li><a href="{{ url_for('leave_types') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list-alt"></i>Gestisci Tipologie
                        </a></li>
                        {% endif %}
                        {% if current_user.can_approve_leave() %}
                        <li><a href="{{ url_for('leave.leave_requests', view='approve') }}" class="sidebar-submenu-link">
                            <i class="fas fa-check"></i>Approva Richieste
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_leave() %}
                        <li><a href="{{ url_for('leave.leave_requests', view='view') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizza Richieste
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- STRAORDINARI - Solo se ha almeno un permesso straordinari -->
                {% set has_overtime_permission = current_user.can_access_overtime_menu() %}
                {% if has_overtime_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-business-time"></i>
                        <span>Straordinari</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_create_overtime_requests() %}
                        <li><a href="{{ url_for('create_overtime_request') }}" class="sidebar-submenu-link">
                            <i class="fas fa-plus"></i>Nuova Richiesta
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_my_overtime_requests() %}
                        <li><a href="{{ url_for('my_overtime_requests') }}" class="sidebar-submenu-link">
                            <i class="fas fa-user-clock"></i>Le Mie Richieste
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_overtime_requests() or current_user.can_approve_overtime_requests() %}
                        <li><a href="{{ url_for('overtime_requests_management') }}" class="sidebar-submenu-link">
                            <i class="fas fa-tasks"></i>Gestisci Richieste
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_overtime_types() %}
                        <li><a href="{{ url_for('overtime_types') }}" class="sidebar-submenu-link">
                            <i class="fas fa-tags"></i>Gestisci Tipologie
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- NOTE SPESE - Solo se ha almeno un permesso note spese -->
                {% set has_expense_permission = current_user.can_access_expense_reports_menu() %}
                {% if has_expense_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-receipt"></i>
                        <span>Note Spese</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_create_expense_reports() %}
                        <li><a href="{{ url_for('create_expense_report') }}" class="sidebar-submenu-link">
                            <i class="fas fa-plus"></i>Crea Nota Spese
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_my_expense_reports() %}
                        <li><a href="{{ url_for('expense_reports') }}?view=my" class="sidebar-submenu-link">
                            <i class="fas fa-user"></i>Le Mie Note Spese
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_expense_reports() or current_user.can_approve_expense_reports() %}
                        <li><a href="{{ url_for('expense_reports') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list"></i>Visualizza Note Spese
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_expense_reports() %}
                        <li><a href="{{ url_for('expense_categories') }}" class="sidebar-submenu-link">
                            <i class="fas fa-tags"></i>Gestisci Categorie
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- RIMBORSI CHILOMETRICI - Solo se ha almeno un permesso rimborsi -->
                {% set has_mileage_permission = current_user.can_access_mileage_menu() %}
                {% if has_mileage_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-car"></i>
                        <span>Rimborsi Chilometrici</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_create_mileage_requests() %}
                        <li><a href="{{ url_for('create_mileage_request') }}" class="sidebar-submenu-link">
                            <i class="fas fa-plus"></i>Nuova Richiesta
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_my_mileage_requests() %}
                        <li><a href="{{ url_for('my_mileage_requests') }}" class="sidebar-submenu-link">
                            <i class="fas fa-user"></i>Le Mie Richieste
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_mileage_requests() or current_user.can_manage_mileage_requests() %}
                        <li><a href="{{ url_for('mileage_requests') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list"></i>Visualizza Richieste
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- FESTIVITÀ - Solo se ha almeno un permesso festività -->
                {% set has_holidays_permission = current_user.can_manage_holidays() or current_user.can_view_holidays() %}
                {% if has_holidays_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-gifts"></i>
                        <span>Festività</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_holidays() %}
                        <li><a href="{{ url_for('holidays') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Festività
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_holidays() %}
                        <li><a href="{{ url_for('holidays') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Festività
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- TABELLE ACI - Solo per amministratori -->
                {% if current_user.has_role('Amministratore') %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-car"></i>
                        <span>Tabelle ACI</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        <li><a href="{{ url_for('aci_tables') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list"></i>Visualizza Tabelle
                        </a></li>
                        <li><a href="{{ url_for('aci_upload') }}" class="sidebar-submenu-link">
                            <i class="fas fa-upload"></i>Carica Excel
                        </a></li>
                        <li><a href="{{ url_for('aci_create') }}" class="sidebar-submenu-link">
                            <i class="fas fa-plus"></i>Nuovo Record
                        </a></li>
                        <li><a href="{{ url_for('aci_export') }}" class="sidebar-submenu-link">
                            <i class="fas fa-download"></i>Export Excel
                        </a></li>
                    </ul>
                </li>
                {% endif %}

                <!-- GESTIONE QR - Solo se ha almeno un permesso QR -->
                {% set has_qr_permission = current_user.can_manage_qr() %}
                {% if has_qr_permission %}
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('admin_generate_qr_codes') }}" class="sidebar-nav-link">
                        <i class="fas fa-qrcode"></i>
                        <span>Gestione QR</span>
                    </a>
                </li>
                {% endif %}

                <!-- STATISTICHE/REPORT - Solo se ha almeno un permesso report -->
                {% set has_reports_permission = current_user.can_view_reports() %}
                {% if has_reports_permission %}
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('reports') }}" class="sidebar-nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>Statistiche</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>

        <!-- Content Wrapper -->
        <div class="content-wrapper" id="content-wrapper">
            <!-- Main Content -->
            <div class="main-content">
                <div class="container-fluid" style="padding: 0;">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <div class="content-area">
                        {% block content %}{% endblock %}
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="app-footer">
                <div class="container-fluid">
                    <div class="text-center py-2">
                        <small class="text-muted">
                            <strong>WORKLY</strong> Workforce Management Platform by <strong>NS12 S.p.A.</strong>
                        </small>
                    </div>
                </div>
            </footer>
        </div>
    {% endif %}
    
    <!-- Non-authenticated layout (login page) -->
    {% if not current_user.is_authenticated %}
    <div class="min-vh-100 d-flex flex-column">
        <div class="flex-grow-1 d-flex justify-content-center align-items-center">
            <div class="col-md-4">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                {% block login_content %}{% endblock %}
            </div>
        </div>
        
        <!-- Login Footer -->
        <div class="py-3">
            <div class="text-center">
                <small class="text-muted">
                    <strong>WORKLY</strong> Workforce Management Platform by <strong>NS12 S.p.A.</strong>
                </small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sidebar functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const contentWrapper = document.getElementById('content-wrapper');
            
            sidebar.classList.toggle('sidebar-collapsed');
            contentWrapper.classList.toggle('sidebar-collapsed');
        }

        function toggleSubmenu(link) {
            const submenu = link.nextElementSibling;
            const isExpanded = link.classList.contains('expanded');
            
            // Close all other submenus
            document.querySelectorAll('.sidebar-nav-link.expanded').forEach(el => {
                if (el !== link) {
                    el.classList.remove('expanded');
                    el.nextElementSibling.classList.remove('show');
                }
            });
            
            // Toggle current submenu
            if (isExpanded) {
                link.classList.remove('expanded');
                submenu.classList.remove('show');
            } else {
                link.classList.add('expanded');
                submenu.classList.add('show');
            }
        }

        // Mobile sidebar toggle
        document.addEventListener('DOMContentLoaded', function() {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.add('sidebar-collapsed');
                }
            }
        });

        // Close sidebar on mobile when clicking outside
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const toggleButton = document.querySelector('.sidebar-toggle');
                
                if (sidebar && !sidebar.contains(e.target) && !toggleButton.contains(e.target)) {
                    sidebar.classList.remove('show');
                }
            }
        });

        // Add CSRF token to all forms
        document.addEventListener('DOMContentLoaded', function() {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const forms = document.querySelectorAll('form');
            
            forms.forEach(function(form) {
                if (!form.querySelector('input[name="csrf_token"]')) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'csrf_token';
                    input.value = csrfToken;
                    form.appendChild(input);
                }
            });
        });

    </script>
    <!-- Global Loading Overlay -->
    <div id="globalLoadingOverlay" class="loading-overlay d-none">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="text-white">Elaborazione in corso...</h5>
            <p class="text-white-50 mb-0">Attendere prego</p>
        </div>
    </div>

    <!-- Global Confirmation Modal -->
    <div class="modal fade" id="globalConfirmModal" tabindex="-1" aria-labelledby="globalConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="globalConfirmModalLabel">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>Conferma Operazione
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="globalConfirmModalBody">
                    <!-- Il messaggio verrà inserito dinamicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Annulla
                    </button>
                    <button type="button" class="btn btn-danger" id="globalConfirmModalOk">
                        <i class="fas fa-check me-1"></i>Conferma
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Loading Script -->
    <script>
        // Global Loading Overlay System
        class LoadingManager {
            constructor() {
                this.overlay = document.getElementById('globalLoadingOverlay');
                this.isShowing = false;
                this.timeoutId = null;
            }

            show() {
                if (!this.isShowing) {
                    this.overlay.classList.remove('d-none');
                    this.isShowing = true;
                    // Auto-hide dopo 30 secondi come fallback
                    this.timeoutId = setTimeout(() => {
                        this.hide();
                    }, 30000);
                }
            }

            hide() {
                if (this.isShowing) {
                    this.overlay.classList.add('d-none');
                    this.isShowing = false;
                    if (this.timeoutId) {
                        clearTimeout(this.timeoutId);
                        this.timeoutId = null;
                    }
                }
            }
        }

        // Initialize global loading manager
        const loadingManager = new LoadingManager();

        // Auto-attach to forms and buttons that cause navigation/submission
        document.addEventListener('DOMContentLoaded', function() {
            // Form submissions (excluding forms inside modals for cancel actions)
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    // Check if the form is being submitted by a modal dismiss button
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.hasAttribute('data-bs-dismiss')) {
                        return; // Don't show overlay for modal dismiss actions
                    }
                    
                    // Delay slightly to allow form processing
                    setTimeout(() => {
                        loadingManager.show();
                    }, 100);
                });
            });

            // Links that cause navigation (excluding anchors, modals, export links, and modal dismiss buttons)
            document.querySelectorAll('a[href]:not([href^="#"]):not([data-bs-toggle]):not([href*="export"]):not([data-bs-dismiss])').forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    // Only show loading for internal navigation
                    if (href && !href.startsWith('http') && !href.startsWith('mailto') && !href.startsWith('tel')) {
                        setTimeout(() => {
                            loadingManager.show();
                        }, 100);
                    }
                });
            });

            // Disable overlay for all modal dismiss buttons (Annulla, Close)
            document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(dismissBtn => {
                dismissBtn.addEventListener('click', function(e) {
                    // Never show loading overlay for modal dismiss actions
                    e.stopPropagation();
                });
            });

            // Also disable overlay for buttons with "Annulla" text (backup protection)
            document.querySelectorAll('button').forEach(btn => {
                if (btn.textContent.trim().toLowerCase().includes('annulla')) {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }
            });

            // Export buttons - Solo feedback sul pulsante senza overlay
            document.querySelectorAll('a[href*="export"], .export-btn').forEach(exportBtn => {
                exportBtn.addEventListener('click', function(e) {
                    // Cambia il testo del pulsante per indicare generazione in corso
                    const originalHTML = this.innerHTML;
                    const originalClass = this.className;
                    
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generazione in corso...';
                    this.classList.add('disabled');
                    this.style.pointerEvents = 'none';
                    
                    // Ripristina dopo 5 secondi (tempo ragionevole per download)
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                        this.className = originalClass;
                        this.style.pointerEvents = 'auto';
                    }, 5000);
                });
            });

            // Hide loading on page load (in case of back navigation)
            loadingManager.hide();
        });

        // Hide loading on page visibility change or beforeunload
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                loadingManager.hide();
            }
        });

        window.addEventListener('beforeunload', function() {
            loadingManager.hide();
        });

        // Expose globally for manual control
        window.showLoading = () => loadingManager.show();
        window.hideLoading = () => loadingManager.hide();

        // Global Confirmation Modal System
        class ConfirmationManager {
            constructor() {
                this.modal = new bootstrap.Modal(document.getElementById('globalConfirmModal'));
                this.currentCallback = null;
                this.setupEventListeners();
            }

            setupEventListeners() {
                const confirmBtn = document.getElementById('globalConfirmModalOk');
                const modal = document.getElementById('globalConfirmModal');

                if (confirmBtn) {
                    confirmBtn.addEventListener('click', () => {
                        this.modal.hide();
                        if (this.currentCallback) {
                            setTimeout(() => {
                                this.currentCallback();
                                this.currentCallback = null;
                            }, 300);
                        }
                    });
                }

                if (modal) {
                    modal.addEventListener('hidden.bs.modal', () => {
                        this.currentCallback = null;
                    });
                }
            }

            show(title, message, onConfirm, confirmBtnText = 'Conferma', confirmBtnClass = 'btn-danger') {
                document.getElementById('globalConfirmModalLabel').innerHTML = 
                    `<i class="fas fa-exclamation-triangle text-warning me-2"></i>${title}`;
                document.getElementById('globalConfirmModalBody').innerHTML = message;
                
                const confirmBtn = document.getElementById('globalConfirmModalOk');
                confirmBtn.className = `btn ${confirmBtnClass}`;
                confirmBtn.innerHTML = `<i class="fas fa-check me-1"></i>${confirmBtnText}`;
                
                this.currentCallback = onConfirm;
                this.modal.show();
            }
        }

        // Initialize global confirmation manager
        const confirmationManager = new ConfirmationManager();

        // Replace all confirm() calls with custom modal
        window.showConfirm = (title, message, onConfirm, confirmBtnText, confirmBtnClass) => {
            confirmationManager.show(title, message, onConfirm, confirmBtnText, confirmBtnClass);
        };

        // Function to replace form onsubmit with modal confirmation
        function replaceConfirmForms() {
            document.querySelectorAll('form[onsubmit*="confirm("]').forEach(form => {
                const onsubmitAttr = form.getAttribute('onsubmit');
                const confirmMatch = onsubmitAttr.match(/confirm\('([^']+)'\)/);
                
                if (confirmMatch) {
                    const confirmMessage = confirmMatch[1];
                    
                    // Remove the original onsubmit attribute
                    form.removeAttribute('onsubmit');
                    
                    // Add click handler to submit button
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Extract specific title and message from confirmMessage
                            let title = 'Conferma Eliminazione';
                            let message = confirmMessage;
                            let confirmBtnText = 'Elimina';
                            let confirmBtnClass = 'btn-danger';
                            
                            // Customize based on message content
                            if (confirmMessage.includes('nota spese')) {
                                title = 'Elimina Nota Spese';
                                message = '<p><i class="fas fa-receipt me-2 text-danger"></i>Vuoi eliminare definitivamente questa nota spese?</p>' +
                                         '<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>' +
                                         '<strong>Attenzione:</strong> Tutti i dati verranno persi per sempre.</small></div>';
                            } else if (confirmMessage.includes('tipologia')) {
                                title = 'Elimina Tipologia';
                                message = '<p><i class="fas fa-tags me-2 text-danger"></i>Vuoi eliminare definitivamente questa tipologia di permesso?</p>' +
                                         '<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>' +
                                         '<strong>Attenzione:</strong> Non sarà più possibile utilizzarla per nuove richieste.</small></div>';
                            } else if (confirmMessage.includes('utente')) {
                                title = 'Elimina Utente';
                                message = '<p><i class="fas fa-user-times me-2 text-danger"></i>Vuoi eliminare definitivamente questo utente?</p>' +
                                         '<div class="alert alert-danger mt-3 mb-0"><small><i class="fas fa-exclamation-triangle me-1"></i>' +
                                         '<strong>Attenzione:</strong> Tutti i dati associati verranno persi per sempre.</small></div>';
                            } else if (confirmMessage.includes('sede')) {
                                title = 'Elimina Sede';
                                message = '<p><i class="fas fa-building me-2 text-danger"></i>Vuoi eliminare definitivamente questa sede?</p>' +
                                         '<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>' +
                                         '<strong>Attenzione:</strong> L\'operazione non può essere annullata.</small></div>';
                            } else if (confirmMessage.includes('ruolo')) {
                                title = 'Elimina Ruolo';
                                message = '<p><i class="fas fa-user-tag me-2 text-danger"></i>Vuoi eliminare definitivamente questo ruolo?</p>' +
                                         '<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>' +
                                         '<strong>Attenzione:</strong> Gli utenti associati perderanno i permessi di questo ruolo.</small></div>';
                            } else if (confirmMessage.includes('orario')) {
                                title = 'Elimina Orario di Lavoro';
                                message = '<p><i class="fas fa-clock me-2 text-danger"></i>Vuoi eliminare definitivamente questo orario di lavoro?</p>' +
                                         '<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>' +
                                         '<strong>Attenzione:</strong> Gli utenti assegnati perderanno questo orario.</small></div>';
                            } else if (confirmMessage.includes('turni')) {
                                title = 'Elimina Turni';
                                message = '<p><i class="fas fa-calendar-times me-2 text-danger"></i>Vuoi eliminare questi turni?</p>' +
                                         '<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>' +
                                         '<strong>Attenzione:</strong> I turni verranno rimossi dal sistema.</small></div>';
                            } else {
                                // Generic fallback
                                message = '<p><i class="fas fa-exclamation-triangle me-2 text-warning"></i>' + confirmMessage + '</p>';
                            }
                            
                            confirmationManager.show(title, message, () => {
                                form.submit();
                            }, confirmBtnText, confirmBtnClass);
                        });
                    }
                }
            });
        }

        // Run replacement on page load
        replaceConfirmForms();

        // Also run when new content is added dynamically
        const observer = new MutationObserver(() => {
            replaceConfirmForms();
        });
        observer.observe(document.body, { childList: true, subtree: true });

        // Global confirmDelete function for consistent deletion confirmations
        window.confirmDelete = function(itemName, deleteUrl, itemType = 'elemento') {
            let title = 'Conferma Eliminazione';
            let message = `<p><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Vuoi eliminare definitivamente <strong>${itemName}</strong>?</p>` +
                         `<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>` +
                         `<strong>Attenzione:</strong> Questa operazione non può essere annullata.</small></div>`;
            
            // Customize based on item type
            if (itemType === 'categoria' || deleteUrl.includes('categories')) {
                title = 'Elimina Categoria';
                message = `<p><i class="fas fa-tags me-2 text-danger"></i>Vuoi eliminare definitivamente la categoria <strong>${itemName}</strong>?</p>` +
                         `<div class="alert alert-warning mt-3 mb-0"><small><i class="fas fa-info-circle me-1"></i>` +
                         `<strong>Attenzione:</strong> Non sarà più possibile utilizzarla per nuove voci.</small></div>`;
            }
            
            confirmationManager.show(title, message, () => {
                // Create a form and submit it
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = deleteUrl;
                
                // Add CSRF token if available
                const csrfToken = document.querySelector('meta[name=csrf-token]');
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrf_token';
                    csrfInput.value = csrfToken.getAttribute('content');
                    form.appendChild(csrfInput);
                }
                
                document.body.appendChild(form);
                form.submit();
            }, 'Elimina', 'btn-danger');
        };
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
