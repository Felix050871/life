<!DOCTYPE html>
<html lang="it" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}Workly - Workforce Staff Platform{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Main Layout -->
    {% if current_user.is_authenticated %}
    <!-- Project Title Bar with User Menu -->
    <div class="project-title-bar">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-briefcase me-2"></i>Workly Platform
                </h5>
                
                <!-- User Menu and Messages -->
                <div class="d-flex align-items-center gap-3">
                    <!-- Messages -->
                    {% if current_user.can_send_messages() or current_user.can_view_messages() %}
                    <div class="dropdown">
                        <a class="btn btn-outline-light btn-sm dropdown-toggle position-relative" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-envelope me-1"></i>
                            {% if unread_messages_count > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem; padding: 0.2em 0.4em; margin-left: -0.5rem;">
                                {{ unread_messages_count if unread_messages_count < 100 else '99+' }}
                            </span>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            {% if current_user.can_send_messages() %}
                            <li><a class="dropdown-item" href="{{ url_for('send_message') }}">
                                <i class="fas fa-paper-plane me-1"></i>Invia Messaggio
                            </a></li>
                            {% endif %}
                            {% if current_user.can_view_messages() %}
                            <li><a class="dropdown-item" href="{{ url_for('internal_messages') }}">
                                <i class="fas fa-inbox me-1"></i>Visualizza Messaggi
                            </a></li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <!-- User Menu -->
                    <div class="dropdown">
                        <a class="btn btn-outline-light btn-sm dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>{{ current_user.first_name or current_user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('user_management') }}">
                                <i class="fas fa-user-edit me-1"></i>Profilo
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt me-1"></i>Logout
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-wrapper">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="{% if current_user.can_access_dashboard() %}{{ url_for('dashboard') }}{% else %}{{ url_for('index') }}{% endif %}" class="brand">
                    <i class="fas fa-briefcase me-2"></i><span>Workly</span>
                </a>
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <ul class="sidebar-nav">
                <!-- DASHBOARD -->
                {% if current_user.can_access_dashboard() %}
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('dashboard') }}" class="sidebar-nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                {% endif %}
                <!-- RUOLI - Solo se ha almeno un permesso ruoli -->
                {% set has_roles_permission = current_user.can_manage_roles() or current_user.can_view_roles() %}
                {% if has_roles_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-users-gear"></i>
                        <span>Ruoli</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_roles() %}
                        <li><a href="{{ url_for('manage_roles') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Ruoli
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_roles() %}
                        <li><a href="{{ url_for('manage_roles') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Ruoli
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- UTENTI - Solo se ha almeno un permesso utenti -->
                {% set has_users_permission = current_user.can_manage_users() or current_user.can_view_users() %}
                {% if has_users_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-users"></i>
                        <span>Utenti</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_users() %}
                        <li><a href="{{ url_for('user_management') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Utenti
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_users() %}
                        <li><a href="{{ url_for('user_management') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Utenti
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- SEDI - Solo se ha almeno un permesso sedi -->
                {% set has_sedi_permission = current_user.can_manage_sedi() or current_user.can_view_sedi() %}
                {% if has_sedi_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-building"></i>
                        <span>Sedi</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_sedi() %}
                        <li><a href="{{ url_for('manage_sedi') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Sedi
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_sedi() %}
                        <li><a href="{{ url_for('manage_sedi') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Sedi
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- ORARI - Solo se ha almeno un permesso orari -->
                {% set has_schedules_permission = current_user.can_manage_schedules() or current_user.can_view_schedules() %}
                {% if has_schedules_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-clock"></i>
                        <span>Orari</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_schedules() %}
                        <li><a href="{{ url_for('manage_work_schedules') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Orari
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_schedules() %}
                        <li><a href="{{ url_for('manage_work_schedules') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Orari
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- TURNI - Solo se ha almeno un permesso turni E sede supporta turni -->
                {% set has_shifts_permission = current_user.can_manage_shifts() or current_user.can_view_shifts() %}
                {% if has_shifts_permission and ((current_user.sede_obj and current_user.sede_obj.is_turni_mode()) or current_user.all_sedi) %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Turni</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_shifts() %}
                        <li><a href="{{ url_for('presidio_coverage') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Turni
                        </a></li>
                        <li><a href="{{ url_for('turni_automatici') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cogs"></i>Gestione Turni
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_shifts() %}
                        <li><a href="{{ url_for('view_presidi') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Turni
                        </a></li>
                        <li><a href="{{ url_for('visualizza_turni') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list"></i>Visualizza Coperture
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- REPERIBILITÀ - Solo se ha almeno un permesso reperibilità -->
                {% set has_reperibilita_permission = current_user.can_manage_reperibilita() or current_user.can_view_reperibilita() or current_user.can_manage_coverage() or current_user.can_view_coverage() or current_user.can_manage_interventions() or current_user.can_view_interventions() %}
                {% if has_reperibilita_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-phone-alt"></i>
                        <span>Reperibilità</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_reperibilita() %}
                        <li><a href="{{ url_for('generate_reperibilita_shifts') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Reperibilità
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_reperibilita() %}
                        <li><a href="{{ url_for('reperibilita_shifts') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Reperibilità
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_coverage() %}
                        <li><a href="{{ url_for('reperibilita_coverage') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Coperture Reperibilità
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_coverage() %}
                        <li><a href="{{ url_for('reperibilita_coverage') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Coperture Reperibilità
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_interventions() %}
                        <li><a href="{{ url_for('my_interventions') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Interventi
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_interventions() %}
                        <li><a href="{{ url_for('my_interventions') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Interventi
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- PRESENZE - Solo se ha almeno un permesso presenze -->
                {% set has_attendance_permission = current_user.can_manage_attendance() or current_user.can_view_attendance() or current_user.can_access_attendance() or current_user.can_view_sede_attendance() %}
                {% if has_attendance_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-clock"></i>
                        <span>Presenze</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_access_attendance() %}
                        <li><a href="{{ url_for('attendance') }}" class="sidebar-submenu-link">
                            <i class="fas fa-user-clock"></i>Le Mie Presenze
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_sede_attendance() %}
                        <li><a href="{{ url_for('attendance', view='sede') }}" class="sidebar-submenu-link">
                            <i class="fas fa-users"></i>Presenze Sede
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_attendance() %}
                        <li><a href="{{ url_for('dashboard_team') }}" class="sidebar-submenu-link">
                            <i class="fas fa-chart-line"></i>Dashboard Presenze
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- FERIE/PERMESSI/MALATTIE - Solo se ha almeno un permesso leave -->
                {% set has_leave_permission = current_user.can_manage_leave() or current_user.can_view_leave() or current_user.can_request_leave() or current_user.can_manage_leave_types() %}
                {% if has_leave_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-calendar-check"></i>
                        <span>Ferie/Permessi</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_request_leave() %}
                        <li><a href="{{ url_for('leave_requests') }}" class="sidebar-submenu-link">
                            <i class="fas fa-plus"></i>Richiedi Ferie/Permessi
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_leave_types() %}
                        <li><a href="{{ url_for('leave_types') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list-alt"></i>Gestire Tipologie
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_leave() %}
                        <li><a href="{{ url_for('leave_requests') }}" class="sidebar-submenu-link">
                            <i class="fas fa-check"></i>Approva Richieste
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_leave() %}
                        <li><a href="{{ url_for('leave_requests') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizza Richieste
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- NOTE SPESE - Solo se ha almeno un permesso note spese -->
                {% set has_expense_permission = current_user.can_access_expense_reports_menu() %}
                {% if has_expense_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-receipt"></i>
                        <span>Note Spese</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_create_expense_reports() %}
                        <li><a href="{{ url_for('create_expense_report') }}" class="sidebar-submenu-link">
                            <i class="fas fa-plus"></i>Crea Nota Spese
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_expense_reports() or current_user.can_approve_expense_reports() or current_user.can_create_expense_reports() %}
                        <li><a href="{{ url_for('expense_reports') }}" class="sidebar-submenu-link">
                            <i class="fas fa-list"></i>Visualizza Note Spese
                        </a></li>
                        {% endif %}
                        {% if current_user.can_manage_expense_reports() %}
                        <li><a href="{{ url_for('expense_categories') }}" class="sidebar-submenu-link">
                            <i class="fas fa-tags"></i>Gestisci Categorie
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- FESTIVITÀ - Solo se ha almeno un permesso festività -->
                {% set has_holidays_permission = current_user.can_manage_holidays() or current_user.can_view_holidays() %}
                {% if has_holidays_permission %}
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link" onclick="toggleSubmenu(this)">
                        <i class="fas fa-gifts"></i>
                        <span>Festività</span>
                        <i class="fas fa-chevron-right dropdown-arrow"></i>
                    </a>
                    <ul class="sidebar-submenu">
                        {% if current_user.can_manage_holidays() %}
                        <li><a href="{{ url_for('holidays') }}" class="sidebar-submenu-link">
                            <i class="fas fa-cog"></i>Gestire Festività
                        </a></li>
                        {% endif %}
                        {% if current_user.can_view_holidays() %}
                        <li><a href="{{ url_for('holidays') }}" class="sidebar-submenu-link">
                            <i class="fas fa-eye"></i>Visualizzare Festività
                        </a></li>
                        {% endif %}
                    </ul>
                </li>
                {% endif %}

                <!-- GESTIONE QR - Solo se ha almeno un permesso QR -->
                {% set has_qr_permission = current_user.can_manage_qr() %}
                {% if has_qr_permission %}
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('admin_generate_qr_codes') }}" class="sidebar-nav-link">
                        <i class="fas fa-qrcode"></i>
                        <span>Gestione QR</span>
                    </a>
                </li>
                {% endif %}



                <!-- STATISTICHE/REPORT - Solo se ha almeno un permesso report -->
                {% set has_reports_permission = current_user.can_view_reports() %}
                {% if has_reports_permission %}
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('reports') }}" class="sidebar-nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>Statistiche</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>

        <!-- Content Wrapper -->
        <div class="content-wrapper" id="content-wrapper">
            <!-- Main Content -->
            <div class="main-content">
                <div class="container-fluid" style="padding: 0;">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <div class="content-area">
                        {% block content %}{% endblock %}
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="app-footer">
                <div class="container-fluid">
                    <div class="text-center py-2">
                        <small class="text-muted">
                            <strong>WORKLY</strong> Workforce Management Platform by <strong>NS12 S.p.A.</strong>
                        </small>
                    </div>
                </div>
            </footer>
        </div>
    {% endif %}
    
    <!-- Non-authenticated layout (login page) -->
    {% if not current_user.is_authenticated %}
    <div class="min-vh-100 d-flex flex-column">
        <div class="flex-grow-1 d-flex justify-content-center align-items-center">
            <div class="col-md-4">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                {% block login_content %}{% endblock %}
            </div>
        </div>
        
        <!-- Login Footer -->
        <div class="py-3">
            <div class="text-center">
                <small class="text-muted">
                    <strong>WORKLY</strong> Workforce Management Platform by <strong>NS12 S.p.A.</strong>
                </small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sidebar functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const contentWrapper = document.getElementById('content-wrapper');
            
            sidebar.classList.toggle('sidebar-collapsed');
            contentWrapper.classList.toggle('sidebar-collapsed');
        }

        function toggleSubmenu(link) {
            const submenu = link.nextElementSibling;
            const isExpanded = link.classList.contains('expanded');
            
            // Close all other submenus
            document.querySelectorAll('.sidebar-nav-link.expanded').forEach(el => {
                if (el !== link) {
                    el.classList.remove('expanded');
                    el.nextElementSibling.classList.remove('show');
                }
            });
            
            // Toggle current submenu
            if (isExpanded) {
                link.classList.remove('expanded');
                submenu.classList.remove('show');
            } else {
                link.classList.add('expanded');
                submenu.classList.add('show');
            }
        }

        // Mobile sidebar toggle
        document.addEventListener('DOMContentLoaded', function() {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.add('sidebar-collapsed');
                }
            }
        });

        // Close sidebar on mobile when clicking outside
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const toggleButton = document.querySelector('.sidebar-toggle');
                
                if (sidebar && !sidebar.contains(e.target) && !toggleButton.contains(e.target)) {
                    sidebar.classList.remove('show');
                }
            }
        });

        // Add CSRF token to all forms
        document.addEventListener('DOMContentLoaded', function() {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const forms = document.querySelectorAll('form');
            
            forms.forEach(function(form) {
                if (!form.querySelector('input[name="csrf_token"]')) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'csrf_token';
                    input.value = csrfToken;
                    form.appendChild(input);
                }
            });
        });

        console.log('Workforce Management App initialized');
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
