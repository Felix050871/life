{% extends "base.html" %}

{% block title %}Scheda HR - {{ user.get_full_name() }} - Life Platform{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
        <i class="fas fa-id-card me-2"></i>
        Scheda HR - {{ user.get_full_name() }}
    </h1>
    <a href="{{ url_for('hr.hr_list') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Torna alla Lista
    </a>
</div>

<form method="POST" action="{{ url_for('hr.hr_detail', user_id=user.id) }}" enctype="multipart/form-data">
    
    <!-- ========================================= -->
    <!-- SEZIONE 1: DATI CONTRATTUALI -->
    <!-- ========================================= -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-file-contract me-2"></i>DATI CONTRATTUALI
            </h5>
        </div>
        <div class="card-body">
            <!-- Riga 1: Matricola, Tipo Contratto, Data Assunzione, Data Fine -->
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">COD SI (Matricola)</label>
                    <input type="text" class="form-control font-monospace" 
                           value="{{ hr_data.cod_si or hr_data.matricola or 'Non assegnato' }}" 
                           disabled style="background-color: #e9ecef;">
                    <small class="text-muted d-block mt-1">
                        {% if hr_data.cod_si %}
                        <i class="fas fa-check-circle text-success"></i> Assegnato automaticamente
                        {% elif hr_data.matricola %}
                        <i class="fas fa-exclamation-triangle text-warning"></i> Legacy: {{ hr_data.matricola }}
                        {% else %}
                        <i class="fas fa-info-circle text-info"></i> Verrà assegnato alla creazione
                        {% endif %}
                    </small>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Tipologia Contratto</label>
                    <select name="contract_type" id="contract_type" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        <option value="Tempo Indeterminato" {% if hr_data.contract_type == 'Tempo Indeterminato' %}selected{% endif %}>Tempo Indeterminato</option>
                        <option value="Tempo Determinato" {% if hr_data.contract_type == 'Tempo Determinato' %}selected{% endif %}>Tempo Determinato</option>
                        <option value="Apprendistato" {% if hr_data.contract_type == 'Apprendistato' %}selected{% endif %}>Apprendistato</option>
                        <option value="Stage/Tirocinio" {% if hr_data.contract_type == 'Stage/Tirocinio' %}selected{% endif %}>Stage/Tirocinio</option>
                        <option value="Collaborazione" {% if hr_data.contract_type == 'Collaborazione' %}selected{% endif %}>Collaborazione</option>
                        <option value="In Distacco" {% if hr_data.contract_type == 'In Distacco' %}selected{% endif %}>In Distacco</option>
                        <option value="Consulente/P.IVA" {% if hr_data.contract_type == 'Consulente/P.IVA' %}selected{% endif %}>Consulente/P.IVA</option>
                        <option value="Fornitore" {% if hr_data.contract_type == 'Fornitore' %}selected{% endif %}>Fornitore</option>
                        <option value="Altro" {% if hr_data.contract_type == 'Altro' %}selected{% endif %}>Altro</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3" id="distacco_supplier_field" style="display: {% if hr_data.contract_type == 'In Distacco' %}block{% else %}none{% endif %};">
                    <label class="form-label">Fornitore / Azienda Distaccante</label>
                    <input type="text" name="distacco_supplier" class="form-control" 
                           value="{{ hr_data.distacco_supplier or '' }}"
                           placeholder="Nome azienda"
                           {% if not can_edit %}disabled{% endif %}>
                    <small class="text-muted">Azienda che fornisce il personale</small>
                </div>
                <div class="col-md-3 mb-3" id="consulente_vat_field" style="display: {% if hr_data.contract_type == 'Consulente/P.IVA' %}block{% else %}none{% endif %};">
                    <label class="form-label">Partita IVA</label>
                    <input type="text" name="consulente_vat" class="form-control" 
                           value="{{ hr_data.consulente_vat or '' }}"
                           placeholder="IT12345678901"
                           {% if not can_edit %}disabled{% endif %}>
                    <small class="text-muted">Partita IVA del consulente</small>
                </div>
                <div class="col-md-3 mb-3" id="fornitore_nome_field" style="display: {% if hr_data.contract_type == 'Fornitore' %}block{% else %}none{% endif %};">
                    <label class="form-label">Nome Fornitore</label>
                    <input type="text" name="nome_fornitore" class="form-control" 
                           value="{{ hr_data.nome_fornitore or '' }}"
                           placeholder="Nome del fornitore"
                           {% if not can_edit %}disabled{% endif %}>
                    <small class="text-muted">Denominazione fornitore</small>
                </div>
                <div class="col-md-3 mb-3" id="fornitore_piva_field" style="display: {% if hr_data.contract_type == 'Fornitore' %}block{% else %}none{% endif %};">
                    <label class="form-label">Partita IVA Fornitore</label>
                    <input type="text" name="partita_iva_fornitore" class="form-control" 
                           value="{{ hr_data.partita_iva_fornitore or '' }}"
                           placeholder="IT12345678901"
                           {% if not can_edit %}disabled{% endif %}>
                    <small class="text-muted">P.IVA del fornitore</small>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Data Assunzione</label>
                    <input type="date" name="hire_date" class="form-control" 
                           value="{{ hr_data.hire_date.strftime('%Y-%m-%d') if hr_data.hire_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Data Fine Rapporto</label>
                    <input type="date" name="contract_end_date" class="form-control" 
                           value="{{ hr_data.contract_end_date.strftime('%Y-%m-%d') if hr_data.contract_end_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Riga 2: CCNL, Mansione, Qualifica, Livello -->
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">CCNL</label>
                    <input type="text" name="ccnl" class="form-control" 
                           value="{{ hr_data.ccnl or '' }}"
                           placeholder="es. Commercio, Metalmeccanico"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Mansione</label>
                    <select name="mansione" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        {% for mansione in mansioni %}
                        <option value="{{ mansione.nome }}" {% if hr_data.mansione == mansione.nome %}selected{% endif %}>
                            {{ mansione.nome }}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Gestisci il mansionario dal menu HR</small>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Qualifica</label>
                    <input type="text" name="qualifica" class="form-control" 
                           value="{{ hr_data.qualifica or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Livello</label>
                    <input type="text" name="ccnl_level" class="form-control" 
                           value="{{ hr_data.ccnl_level or '' }}"
                           placeholder="es. D2, 3° livello"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Riga 3: Orario, Tipologia Orario, %, Tipo PT -->
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Orario (h/sett.)</label>
                    <input type="number" step="0.1" name="work_hours_week" class="form-control" 
                           value="{{ hr_data.work_hours_week or '' }}"
                           placeholder="40"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Tipologia Orario</label>
                    <select name="working_time_type" class="form-select" id="working_time_type" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        <option value="FT" {% if hr_data.working_time_type == 'FT' %}selected{% endif %}>FT (Full Time)</option>
                        <option value="PT" {% if hr_data.working_time_type == 'PT' %}selected{% endif %}>PT (Part Time)</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Percentuale PT (%)</label>
                    <input type="number" step="0.1" name="part_time_percentage" class="form-control" 
                           value="{{ hr_data.part_time_percentage or '' }}"
                           placeholder="es. 50, 75"
                           id="part_time_percentage"
                           {% if not can_edit %}disabled{% endif %}>
                    <small class="text-muted">Solo se Part Time</small>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Tipo Part Time</label>
                    <select name="part_time_type" class="form-select" id="part_time_type" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        <option value="Verticale" {% if hr_data.part_time_type == 'Verticale' %}selected{% endif %}>Verticale</option>
                        <option value="Orizzontale" {% if hr_data.part_time_type == 'Orizzontale' %}selected{% endif %}>Orizzontale</option>
                    </select>
                    <small class="text-muted">Solo se Part Time</small>
                </div>
            </div>

            <!-- Riga 4: Tipo Assunzione -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Tipo di Assunzione</label>
                    <input type="text" name="tipo_assunzione" class="form-control" 
                           value="{{ hr_data.tipo_assunzione or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Riga 5: Superminimo, Rimborsi, Ticket Restaurant, Rischio INAIL -->
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Superminimo / SM Assorbibile (€)</label>
                    <input type="number" step="0.01" name="superminimo" class="form-control" 
                           value="{{ hr_data.superminimo or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Rimborsi / Diarie (€)</label>
                    <input type="number" step="0.01" name="rimborsi_diarie" class="form-control" 
                           value="{{ hr_data.rimborsi_diarie or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Ticket Restaurant</label>
                    <div class="form-check form-switch mt-2">
                        <input type="checkbox" name="ticket_restaurant" class="form-check-input" 
                               {% if hr_data.ticket_restaurant %}checked{% endif %}
                               {% if not can_edit %}disabled{% endif %}>
                        <label class="form-check-label">Ha ticket restaurant</label>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Rischio INAIL</label>
                    <input type="text" name="rischio_inail" class="form-control" 
                           value="{{ hr_data.rischio_inail or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Note Contratto -->
            <div class="row">
                <div class="col-12 mb-3">
                    <label class="form-label">Altro / Note Contrattuali</label>
                    <textarea name="other_notes" class="form-control" rows="2"
                              {% if not can_edit %}disabled{% endif %}>{{ hr_data.other_notes or '' }}</textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- SEZIONE 2: ANAGRAFICA RISORSA -->
    <!-- ========================================= -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-user me-2"></i>ANAGRAFICA RISORSA
            </h5>
        </div>
        <div class="card-body">
            <!-- Dati Personali -->
            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-id-badge me-2"></i>Dati Personali</h6>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Codice Fiscale</label>
                    <input type="text" name="codice_fiscale" class="form-control text-uppercase" 
                           value="{{ hr_data.codice_fiscale or '' }}" 
                           maxlength="16"
                           disabled
                           title="Il codice fiscale viene calcolato automaticamente dai dati anagrafici">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Data di Nascita</label>
                    <input type="date" name="birth_date" class="form-control" 
                           value="{{ hr_data.birth_date.strftime('%Y-%m-%d') if hr_data.birth_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">Età</label>
                    <input type="text" class="form-control" 
                           value="{% if hr_data.get_age() %}{{ hr_data.get_age() }} anni{% endif %}" disabled>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Sesso</label>
                    <select name="gender" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        <option value="M" {% if hr_data.gender == 'M' %}selected{% endif %}>Maschile</option>
                        <option value="F" {% if hr_data.gender == 'F' %}selected{% endif %}>Femminile</option>
                        <option value="A" {% if hr_data.gender == 'A' %}selected{% endif %}>Altro</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-5 mb-3">
                    <label class="form-label">Luogo di Nascita</label>
                    <input type="text" name="birth_city" class="form-control" 
                           value="{{ hr_data.birth_city or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">Provincia</label>
                    <input type="text" name="birth_province" class="form-control text-uppercase" 
                           value="{{ hr_data.birth_province or '' }}" 
                           maxlength="2"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-5 mb-3">
                    <label class="form-label">Paese di Nascita</label>
                    <input type="text" name="birth_country" class="form-control" 
                           value="{{ hr_data.birth_country or 'Italia' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Residenza -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-home me-2"></i>Residenza</h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Indirizzo (Comune di Residenza)</label>
                    <input type="text" name="address" class="form-control" 
                           value="{{ hr_data.address or '' }}"
                           placeholder="Via/Piazza, Numero"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Città</label>
                    <input type="text" name="city" class="form-control" 
                           value="{{ hr_data.city or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">CAP</label>
                    <input type="text" name="postal_code" class="form-control" 
                           value="{{ hr_data.postal_code or '' }}"
                           maxlength="5"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Domicilio (se diverso dalla residenza)</label>
                    <input type="text" name="alternative_domicile" class="form-control" 
                           value="{{ hr_data.alternative_domicile or '' }}"
                           placeholder="Indirizzo completo"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Contatti -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-phone me-2"></i>Contatti</h6>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Recapito Telefonico</label>
                    <input type="tel" name="phone" class="form-control" 
                           value="{{ hr_data.phone or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">E-mail Personale</label>
                    <input type="email" name="personal_email" class="form-control" 
                           value="{{ hr_data.personal_email or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">E-mail Aziendale</label>
                    <input type="email" class="form-control" value="{{ user.email }}" disabled>
                </div>
            </div>

            <!-- Titolo di Studio -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-graduation-cap me-2"></i>Formazione</h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Titolo di Studio</label>
                    <select name="education_level" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        <option value="Licenza Media" {% if hr_data.education_level == 'Licenza Media' %}selected{% endif %}>Licenza Media</option>
                        <option value="Diploma" {% if hr_data.education_level == 'Diploma' %}selected{% endif %}>Diploma</option>
                        <option value="Laurea Triennale" {% if hr_data.education_level == 'Laurea Triennale' %}selected{% endif %}>Laurea Triennale</option>
                        <option value="Laurea Magistrale" {% if hr_data.education_level == 'Laurea Magistrale' %}selected{% endif %}>Laurea Magistrale</option>
                        <option value="Master" {% if hr_data.education_level == 'Master' %}selected{% endif %}>Master</option>
                        <option value="Dottorato" {% if hr_data.education_level == 'Dottorato' %}selected{% endif %}>Dottorato</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Campo di Studio</label>
                    <input type="text" name="education_field" class="form-control" 
                           value="{{ hr_data.education_field or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Altri Dati Personali -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-info-circle me-2"></i>Altri Dati</h6>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Stato Civile</label>
                    <select name="marital_status" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        <option value="Celibe/Nubile" {% if hr_data.marital_status == 'Celibe/Nubile' %}selected{% endif %}>Celibe/Nubile</option>
                        <option value="Coniugato/a" {% if hr_data.marital_status == 'Coniugato/a' %}selected{% endif %}>Coniugato/a</option>
                        <option value="Divorziato/a" {% if hr_data.marital_status == 'Divorziato/a' %}selected{% endif %}>Divorziato/a</option>
                        <option value="Vedovo/a" {% if hr_data.marital_status == 'Vedovo/a' %}selected{% endif %}>Vedovo/a</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Familiari a Carico</label>
                    <input type="number" name="dependents_number" class="form-control" 
                           value="{{ hr_data.dependents_number or '' }}"
                           min="0"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Fruizione Permessi L. 104/92</label>
                    <div class="form-check form-switch mt-2">
                        <input type="checkbox" name="law_104_benefits" class="form-check-input" 
                               {% if hr_data.law_104_benefits %}checked{% endif %}
                               {% if not can_edit %}disabled{% endif %}>
                        <label class="form-check-label">Usufruisce L. 104/92</label>
                    </div>
                </div>
            </div>

            <!-- Contatto di Emergenza -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-phone-volume me-2"></i>Contatto di Emergenza</h6>
            <div class="row">
                <div class="col-md-5 mb-3">
                    <label class="form-label">Nome Contatto</label>
                    <input type="text" name="emergency_contact_name" class="form-control" 
                           value="{{ hr_data.emergency_contact_name or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Telefono Emergenza</label>
                    <input type="tel" name="emergency_contact_phone" class="form-control" 
                           value="{{ hr_data.emergency_contact_phone or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Relazione</label>
                    <input type="text" name="emergency_contact_relation" class="form-control" 
                           value="{{ hr_data.emergency_contact_relation or '' }}"
                           placeholder="es. Coniuge, Genitore"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Dati Operativi -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-building me-2"></i>Dati Operativi</h6>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Sede di Assunzione</label>
                    <select name="sede_id" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Nessuna</option>
                        {% for sede in sedi %}
                        <option value="{{ sede.id }}" {% if hr_data.sede_id == sede.id %}selected{% endif %}>
                            {{ sede.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Sede indicata nel contratto di assunzione</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Orario di Lavoro</label>
                    <select name="work_schedule_id" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Nessuno</option>
                        {% for schedule in work_schedules %}
                        <option value="{{ schedule.id }}" {% if hr_data.work_schedule_id == schedule.id %}selected{% endif %}>
                            {{ schedule.name }} ({{ schedule.code }})
                        </option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Orario di lavoro assegnato al dipendente</small>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="form-check form-switch mt-4">
                        <input type="checkbox" name="all_sedi" class="form-check-input" id="all_sedi"
                               {% if hr_data.all_sedi %}checked{% endif %}
                               {% if not can_edit %}disabled{% endif %}>
                        <label class="form-check-label fw-bold" for="all_sedi">
                            Accesso a Tutte le Sedi
                        </label>
                    </div>
                    <small class="text-muted d-block mt-1">Può operare in tutte le sedi aziendali</small>
                </div>
            </div>

            <!-- Patente di Guida -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-id-card me-2"></i>Patente di Guida</h6>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Numero Patente</label>
                    <input type="text" name="driver_license_number" class="form-control" 
                           value="{{ hr_data.driver_license_number or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo Patente</label>
                    <input type="text" name="driver_license_type" class="form-control" 
                           value="{{ hr_data.driver_license_type or '' }}"
                           placeholder="es. B, C, D, BE"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Scadenza Patente</label>
                    <input type="date" name="driver_license_expiry" class="form-control" 
                           value="{{ hr_data.driver_license_expiry.strftime('%Y-%m-%d') if hr_data.driver_license_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Veicolo ACI - Selezione a cascata -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-car me-2"></i>Veicolo ACI (Rimborsi Chilometrici)</h6>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo Veicolo</label>
                    <select id="tipoVeicoloSelectHR" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona tipo</option>
                        {% set tipi = [] %}
                        {% for vehicle in aci_vehicles %}
                            {% if vehicle.tipologia not in tipi %}
                                {% set _ = tipi.append(vehicle.tipologia) %}
                            {% endif %}
                        {% endfor %}
                        {% for tipo in tipi|sort %}
                        <option value="{{ tipo }}">{{ tipo }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Tipo di veicolo (es. Autovettura, Motociclo)</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Marca</label>
                    <select id="marcaVeicoloSelectHR" class="form-select" disabled>
                        <option value="">Seleziona prima il tipo</option>
                    </select>
                    <small class="text-muted">Marca del veicolo</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Modello e Costo/km</label>
                    <select name="aci_vehicle_id" id="modelloVeicoloSelectHR" class="form-select" disabled>
                        <option value="">Seleziona prima la marca</option>
                    </select>
                    <small class="text-muted">Modello specifico con costo chilometrico</small>
                </div>
            </div>
            
            <!-- Upload Libretto di Circolazione -->
            <div class="row mt-3">
                <div class="col-md-8 mb-3">
                    <label class="form-label">Libretto di Circolazione</label>
                    {% if hr_data.vehicle_registration_document %}
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" value="{{ hr_data.vehicle_registration_document.split('/')[-1] }}" disabled>
                        <a href="/static/uploads/vehicle_docs/{{ hr_data.vehicle_registration_document.split('/')[-1] }}" 
                           target="_blank" class="btn btn-outline-primary" title="Visualizza libretto">
                            <i class="fas fa-eye me-1"></i>Visualizza
                        </a>
                        <a href="/static/uploads/vehicle_docs/{{ hr_data.vehicle_registration_document.split('/')[-1] }}" 
                           download class="btn btn-outline-success" title="Scarica libretto">
                            <i class="fas fa-download me-1"></i>Scarica
                        </a>
                    </div>
                    {% endif %}
                    <input type="file" name="vehicle_registration_document" class="form-control" 
                           accept=".pdf,.jpg,.jpeg,.png"
                           {% if not can_edit %}disabled{% endif %}>
                    <small class="text-muted">Carica una copia del libretto di circolazione (PDF, JPG, PNG - max 5MB)</small>
                </div>
                <div class="col-md-4 mb-3">
                    {% if hr_data.vehicle_registration_document %}
                    <label class="form-label">Azioni</label>
                    <div class="d-grid">
                        <button type="button" class="btn btn-outline-danger" 
                                onclick="if(confirm('Confermi l\'eliminazione del libretto caricato?')) { document.getElementById('deleteVehicleDoc').value='1'; this.form.submit(); }"
                                {% if not can_edit %}disabled{% endif %}>
                            <i class="fas fa-trash me-1"></i>Elimina Documento
                        </button>
                        <input type="hidden" id="deleteVehicleDoc" name="delete_vehicle_doc" value="0">
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Gestione Straordinari / Banca Ore -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-clock me-2"></i>Gestione Straordinari</h6>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="form-check mt-4">
                        <input type="checkbox" id="overtime_enabled" name="overtime_enabled" class="form-check-input" 
                               {% if hr_data.overtime_enabled %}checked{% endif %}
                               {% if not can_edit %}disabled{% endif %}>
                        <label class="form-check-label fw-bold" for="overtime_enabled">
                            Abilitato a Straordinari
                        </label>
                    </div>
                </div>
                <div class="col-md-3 mb-3" id="overtimeTypeField" style="display: none;">
                    <label class="form-label">Tipologia Straordinario</label>
                    <select name="overtime_type" id="overtime_type" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        <option value="Straordinario Pagato" {% if hr_data.overtime_type == 'Straordinario Pagato' %}selected{% endif %}>Straordinario Pagato</option>
                        <option value="Banca Ore" {% if hr_data.overtime_type == 'Banca Ore' %}selected{% endif %}>Banca Ore</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3" id="bancaOreLimiteField" style="display: none;">
                    <label class="form-label">Limite Massimo Ore</label>
                    <div class="input-group">
                        <input type="text" name="banca_ore_limite_max" class="form-control" 
                               value="{{ (hr_data.banca_ore_limite_max|string).replace('.', ',') if hr_data.banca_ore_limite_max else '' }}"
                               {% if not can_edit %}disabled{% endif %}>
                        <span class="input-group-text">ore</span>
                    </div>
                    <small class="text-muted">Limite massimo ore accumulabili</small>
                </div>
                <div class="col-md-3 mb-3" id="bancaOrePeriodoField" style="display: none;">
                    <label class="form-label">Periodo Validità</label>
                    <div class="input-group">
                        <input type="text" name="banca_ore_periodo_mesi" class="form-control" 
                               value="{{ hr_data.banca_ore_periodo_mesi if hr_data.banca_ore_periodo_mesi else '' }}"
                               {% if not can_edit %}disabled{% endif %}>
                        <span class="input-group-text">mesi</span>
                    </div>
                    <small class="text-muted">Periodo entro cui usufruire ore</small>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- SEZIONE 3: VISITE E FORMAZIONE -->
    <!-- ========================================= -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="card-title mb-0">
                <i class="fas fa-clipboard-check me-2"></i>VISITE MEDICHE E FORMAZIONE OBBLIGATORIA
            </h5>
        </div>
        <div class="card-body">
            <!-- Requisiti Minimi -->
            <div class="row mb-4">
                <div class="col-md-12 mb-3">
                    <label class="form-label fw-bold">Possesso Requisiti Minimi</label>
                    <select name="minimum_requirements" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        <option value="SI" {% if hr_data.minimum_requirements == 'SI' %}selected{% endif %}>SI</option>
                        <option value="NO" {% if hr_data.minimum_requirements == 'NO' %}selected{% endif %}>NO</option>
                        <option value="DA FORMARE" {% if hr_data.minimum_requirements == 'DA FORMARE' %}selected{% endif %}>DA FORMARE</option>
                    </select>
                </div>
            </div>

            <!-- Visita Medica -->
            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-stethoscope me-2"></i>Visita Medica</h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Ultima Visita</label>
                    <input type="date" name="medical_visit_date" class="form-control" 
                           value="{{ hr_data.medical_visit_date.strftime('%Y-%m-%d') if hr_data.medical_visit_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza Visita</label>
                    <input type="date" name="medical_visit_expiry" class="form-control" 
                           value="{{ hr_data.medical_visit_expiry.strftime('%Y-%m-%d') if hr_data.medical_visit_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Formazione Generale (Art. 36-37) - Periodicità: 5 anni -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-book-open me-2"></i>Formazione e Informazione (Artt. 36 e 37) <small class="text-muted">- Periodicità: 5 anni</small></h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Formazione</label>
                    <input type="date" name="training_general_date" class="form-control" 
                           value="{{ hr_data.training_general_date.strftime('%Y-%m-%d') if hr_data.training_general_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza</label>
                    <input type="date" name="training_general_expiry" class="form-control" 
                           value="{{ hr_data.training_general_expiry.strftime('%Y-%m-%d') if hr_data.training_general_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Formazione RSPP - Periodicità: 5 anni -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-hard-hat me-2"></i>Formazione RSPP <small class="text-muted">- Periodicità: 5 anni</small></h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Formazione</label>
                    <input type="date" name="training_rspp_date" class="form-control" 
                           value="{{ hr_data.training_rspp_date.strftime('%Y-%m-%d') if hr_data.training_rspp_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza</label>
                    <input type="date" name="training_rspp_expiry" class="form-control" 
                           value="{{ hr_data.training_rspp_expiry.strftime('%Y-%m-%d') if hr_data.training_rspp_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Formazione RLS - Periodicità: ANNUALE -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-users-cog me-2"></i>Formazione RLS <small class="text-muted">- Periodicità: ANNUALE</small></h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Formazione</label>
                    <input type="date" name="training_rls_date" class="form-control" 
                           value="{{ hr_data.training_rls_date.strftime('%Y-%m-%d') if hr_data.training_rls_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza</label>
                    <input type="date" name="training_rls_expiry" class="form-control" 
                           value="{{ hr_data.training_rls_expiry.strftime('%Y-%m-%d') if hr_data.training_rls_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Formazione Primo Soccorso - Periodicità: consigliata almeno 3 anni -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-first-aid me-2"></i>Formazione Primo Soccorso <small class="text-muted">- Periodicità: consigliata almeno 3 anni</small></h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Formazione</label>
                    <input type="date" name="training_first_aid_date" class="form-control" 
                           value="{{ hr_data.training_first_aid_date.strftime('%Y-%m-%d') if hr_data.training_first_aid_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza</label>
                    <input type="date" name="training_first_aid_expiry" class="form-control" 
                           value="{{ hr_data.training_first_aid_expiry.strftime('%Y-%m-%d') if hr_data.training_first_aid_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Formazione Emergenza - Periodicità: consigliata almeno 3 anni -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-fire-extinguisher me-2"></i>Formazione Emergenza <small class="text-muted">- Periodicità: consigliata almeno 3 anni</small></h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Formazione</label>
                    <input type="date" name="training_emergency_date" class="form-control" 
                           value="{{ hr_data.training_emergency_date.strftime('%Y-%m-%d') if hr_data.training_emergency_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza</label>
                    <input type="date" name="training_emergency_expiry" class="form-control" 
                           value="{{ hr_data.training_emergency_expiry.strftime('%Y-%m-%d') if hr_data.training_emergency_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Formazione Preposto - Periodicità: 2 anni -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-user-tie me-2"></i>Formazione Preposto <small class="text-muted">- Periodicità: 2 anni</small></h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Formazione</label>
                    <input type="date" name="training_supervisor_date" class="form-control" 
                           value="{{ hr_data.training_supervisor_date.strftime('%Y-%m-%d') if hr_data.training_supervisor_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza</label>
                    <input type="date" name="training_supervisor_expiry" class="form-control" 
                           value="{{ hr_data.training_supervisor_expiry.strftime('%Y-%m-%d') if hr_data.training_supervisor_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>
        </div>
    </div>

    <!-- Pulsanti Azione -->
    {% if can_edit %}
    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
        <a href="{{ url_for('hr.hr_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-times me-2"></i>Annulla
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Salva Modifiche
        </button>
    </div>
    {% endif %}
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestione visibilità campi condizionali per tipo contratto
    const contractTypeSelect = document.getElementById('contract_type');
    const distaccoSupplierField = document.getElementById('distacco_supplier_field');
    const consulenteVatField = document.getElementById('consulente_vat_field');
    const fornitoreNomeField = document.getElementById('fornitore_nome_field');
    const fornitorePivaField = document.getElementById('fornitore_piva_field');
    
    if (contractTypeSelect && distaccoSupplierField && consulenteVatField && fornitoreNomeField && fornitorePivaField) {
        contractTypeSelect.addEventListener('change', function() {
            // Nascondi tutti i campi condizionali e azzera i loro valori
            const distaccoInput = distaccoSupplierField.querySelector('input');
            const consulenteInput = consulenteVatField.querySelector('input');
            const fornitoreNomeInput = fornitoreNomeField.querySelector('input');
            const fornitorePivaInput = fornitorePivaField.querySelector('input');
            
            distaccoSupplierField.style.display = 'none';
            consulenteVatField.style.display = 'none';
            fornitoreNomeField.style.display = 'none';
            fornitorePivaField.style.display = 'none';
            if (distaccoInput) distaccoInput.value = '';
            if (consulenteInput) consulenteInput.value = '';
            if (fornitoreNomeInput) fornitoreNomeInput.value = '';
            if (fornitorePivaInput) fornitorePivaInput.value = '';
            
            // Mostra solo il campo appropriato
            if (this.value === 'In Distacco') {
                distaccoSupplierField.style.display = 'block';
            } else if (this.value === 'Consulente/P.IVA') {
                consulenteVatField.style.display = 'block';
            } else if (this.value === 'Fornitore') {
                fornitoreNomeField.style.display = 'block';
                fornitorePivaField.style.display = 'block';
            }
        });
    }
    
    // Gestione cascading selection veicoli ACI
    const tipoSelect = document.getElementById('tipoVeicoloSelectHR');
    const marcaSelect = document.getElementById('marcaVeicoloSelectHR');
    const modelloSelect = document.getElementById('modelloVeicoloSelectHR');
    
    if (!tipoSelect || !marcaSelect || !modelloSelect) return;
    
    // Salva il veicolo corrente per pre-selezionarlo
    const currentVehicleId = {% if hr_data.aci_vehicle_id %}{{ hr_data.aci_vehicle_id }}{% else %}null{% endif %};
    
    tipoSelect.addEventListener('change', function() {
        const tipo = this.value;
        marcaSelect.disabled = true;
        modelloSelect.disabled = true;
        marcaSelect.innerHTML = '<option value="">Caricamento...</option>';
        modelloSelect.innerHTML = '<option value="">Seleziona prima marca</option>';
        
        if (tipo) {
            fetch(`/aci/api/marcas?tipologia=${encodeURIComponent(tipo)}`)
                .then(response => response.json())
                .then(data => {
                    marcaSelect.innerHTML = '<option value="">Seleziona marca</option>';
                    if (data.success && data.marcas && data.marcas.length > 0) {
                        data.marcas.forEach(marca => {
                            const option = document.createElement('option');
                            option.value = marca;
                            option.textContent = marca;
                            marcaSelect.appendChild(option);
                        });
                        marcaSelect.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error loading marche:', error);
                    marcaSelect.innerHTML = '<option value="">Errore caricamento</option>';
                });
        } else {
            marcaSelect.innerHTML = '<option value="">Seleziona prima il tipo</option>';
            modelloSelect.innerHTML = '<option value="">Seleziona prima marca</option>';
        }
    });
    
    marcaSelect.addEventListener('change', function() {
        const tipo = tipoSelect.value;
        const marca = this.value;
        modelloSelect.disabled = true;
        modelloSelect.innerHTML = '<option value="">Caricamento...</option>';
        
        if (tipo && marca) {
            fetch(`/aci/api/modelos?tipologia=${encodeURIComponent(tipo)}&marca=${encodeURIComponent(marca)}`)
                .then(response => response.json())
                .then(data => {
                    modelloSelect.innerHTML = '<option value="">Seleziona modello</option>';
                    if (data.success && data.modelos && data.modelos.length > 0) {
                        data.modelos.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = `${item.modello} (€${item.costo_km}/km)`;
                            modelloSelect.appendChild(option);
                        });
                        modelloSelect.disabled = false;
                        
                        // Se c'è un veicolo corrente, selezionalo
                        if (currentVehicleId) {
                            modelloSelect.value = currentVehicleId;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading modelli:', error);
                    modelloSelect.innerHTML = '<option value="">Errore caricamento</option>';
                });
        } else {
            modelloSelect.innerHTML = '<option value="">Seleziona prima marca</option>';
        }
    });
    
    // Pre-carica il veicolo selezionato se esiste
    {% if hr_data.aci_vehicle %}
    tipoSelect.value = '{{ hr_data.aci_vehicle.tipologia }}';
    tipoSelect.dispatchEvent(new Event('change'));
    
    // Aspetta che le marche vengano caricate
    setTimeout(() => {
        marcaSelect.value = '{{ hr_data.aci_vehicle.marca }}';
        marcaSelect.dispatchEvent(new Event('change'));
    }, 500);
    {% endif %}
    
    // Gestione visibilità campi straordinari/banca ore
    const overtimeEnabled = document.getElementById('overtime_enabled');
    const overtimeTypeField = document.getElementById('overtimeTypeField');
    const overtimeType = document.getElementById('overtime_type');
    const bancaOreLimiteField = document.getElementById('bancaOreLimiteField');
    const bancaOrePeriodoField = document.getElementById('bancaOrePeriodoField');
    
    function toggleOvertimeFields() {
        if (overtimeEnabled && overtimeEnabled.checked) {
            overtimeTypeField.style.display = 'block';
            toggleBancaOreFields();
        } else {
            overtimeTypeField.style.display = 'none';
            bancaOreLimiteField.style.display = 'none';
            bancaOrePeriodoField.style.display = 'none';
            if (overtimeType) overtimeType.value = '';
        }
    }
    
    function toggleBancaOreFields() {
        if (overtimeEnabled && overtimeEnabled.checked && overtimeType && overtimeType.value === 'Banca Ore') {
            bancaOreLimiteField.style.display = 'block';
            bancaOrePeriodoField.style.display = 'block';
        } else {
            bancaOreLimiteField.style.display = 'none';
            bancaOrePeriodoField.style.display = 'none';
        }
    }
    
    if (overtimeEnabled) {
        overtimeEnabled.addEventListener('change', toggleOvertimeFields);
        toggleOvertimeFields(); // Initialize on load
    }
    
    if (overtimeType) {
        overtimeType.addEventListener('change', toggleBancaOreFields);
    }
});
</script>
{% endblock %}
