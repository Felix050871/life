{% extends "base.html" %}

{% block title %}Scheda HR - {{ user.get_full_name() }} - Life Platform{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
        <i class="fas fa-id-card me-2"></i>
        Scheda HR - {{ user.get_full_name() }}
    </h1>
    <div>
        <a href="{{ url_for('hr.contract_history', user_id=user.id) }}" class="btn btn-outline-info me-2">
            <i class="fas fa-history me-2"></i>Storico Contrattuale
        </a>
        <a href="{{ url_for('hr.hr_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Torna alla Lista
        </a>
    </div>
</div>

<!-- TAB NAVIGATION -->
<ul class="nav nav-tabs mb-4" id="hrTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="anagrafica-tab" data-bs-toggle="tab" data-bs-target="#anagrafica" type="button" role="tab" aria-controls="anagrafica" aria-selected="true">
            <i class="fas fa-user me-2"></i>Dati Anagrafici
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="contrattuali-tab" data-bs-toggle="tab" data-bs-target="#contrattuali" type="button" role="tab" aria-controls="contrattuali" aria-selected="false">
            <i class="fas fa-file-contract me-2"></i>Dati Contrattuali
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="visite-tab" data-bs-toggle="tab" data-bs-target="#visite" type="button" role="tab" aria-controls="visite" aria-selected="false">
            <i class="fas fa-heartbeat me-2"></i>Visite Mediche e Formazione
        </button>
    </li>
</ul>

<form method="POST" action="{{ url_for('hr.hr_detail', user_id=user.id) }}" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

<!-- TAB CONTENT -->
<div class="tab-content" id="hrTabsContent">

    <!-- ========================================= -->
    <!-- TAB 1: DATI ANAGRAFICI -->
    <!-- ========================================= -->
    <div class="tab-pane fade show active" id="anagrafica" role="tabpanel" aria-labelledby="anagrafica-tab">
        <!-- Dati Personali -->
        <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-id-badge me-2"></i>Dati Personali</h6>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Codice Fiscale</label>
                <input type="text" name="codice_fiscale" class="form-control text-uppercase" 
                       value="{{ hr_data.codice_fiscale or '' }}" 
                       maxlength="16"
                       {% if not can_edit %}disabled{% endif %}
                       placeholder="RSSMRA80A01H501Z"
                       title="Modifica manualmente se necessario correggere eventuali anomalie">
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Data di Nascita</label>
                <input type="date" name="birth_date" class="form-control" 
                       value="{{ hr_data.birth_date.strftime('%Y-%m-%d') if hr_data.birth_date else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-2 mb-3">
                <label class="form-label">Età</label>
                <input type="text" class="form-control" 
                       value="{% if hr_data.get_age() %}{{ hr_data.get_age() }} anni{% endif %}" disabled>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Sesso</label>
                <select name="gender" class="form-select" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Seleziona...</option>
                    <option value="M" {% if hr_data.gender == 'M' %}selected{% endif %}>Maschile</option>
                    <option value="F" {% if hr_data.gender == 'F' %}selected{% endif %}>Femminile</option>
                    <option value="A" {% if hr_data.gender == 'A' %}selected{% endif %}>Altro</option>
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col-md-5 mb-3">
                <label class="form-label">Paese di Nascita</label>
                <select name="birth_country" id="birth_country" class="form-select" {% if not can_edit %}disabled{% endif %}>
                    <option value="Italia" {% if not hr_data.birth_country or hr_data.birth_country == 'Italia' %}selected{% endif %}>Italia</option>
                    <optgroup label="Principali Paesi Europei">
                        <option value="Francia" {% if hr_data.birth_country == 'Francia' %}selected{% endif %}>Francia</option>
                        <option value="Germania" {% if hr_data.birth_country == 'Germania' %}selected{% endif %}>Germania</option>
                        <option value="Spagna" {% if hr_data.birth_country == 'Spagna' %}selected{% endif %}>Spagna</option>
                        <option value="Regno Unito" {% if hr_data.birth_country == 'Regno Unito' %}selected{% endif %}>Regno Unito</option>
                        <option value="Svizzera" {% if hr_data.birth_country == 'Svizzera' %}selected{% endif %}>Svizzera</option>
                        <option value="Austria" {% if hr_data.birth_country == 'Austria' %}selected{% endif %}>Austria</option>
                        <option value="Belgio" {% if hr_data.birth_country == 'Belgio' %}selected{% endif %}>Belgio</option>
                        <option value="Paesi Bassi" {% if hr_data.birth_country == 'Paesi Bassi' %}selected{% endif %}>Paesi Bassi</option>
                        <option value="Portogallo" {% if hr_data.birth_country == 'Portogallo' %}selected{% endif %}>Portogallo</option>
                        <option value="Grecia" {% if hr_data.birth_country == 'Grecia' %}selected{% endif %}>Grecia</option>
                        <option value="Polonia" {% if hr_data.birth_country == 'Polonia' %}selected{% endif %}>Polonia</option>
                        <option value="Romania" {% if hr_data.birth_country == 'Romania' %}selected{% endif %}>Romania</option>
                        <option value="Albania" {% if hr_data.birth_country == 'Albania' %}selected{% endif %}>Albania</option>
                    </optgroup>
                    <optgroup label="Altri Paesi">
                        <option value="Stati Uniti" {% if hr_data.birth_country == 'Stati Uniti' %}selected{% endif %}>Stati Uniti</option>
                        <option value="Canada" {% if hr_data.birth_country == 'Canada' %}selected{% endif %}>Canada</option>
                        <option value="Brasile" {% if hr_data.birth_country == 'Brasile' %}selected{% endif %}>Brasile</option>
                        <option value="Argentina" {% if hr_data.birth_country == 'Argentina' %}selected{% endif %}>Argentina</option>
                        <option value="Cina" {% if hr_data.birth_country == 'Cina' %}selected{% endif %}>Cina</option>
                        <option value="India" {% if hr_data.birth_country == 'India' %}selected{% endif %}>India</option>
                        <option value="Marocco" {% if hr_data.birth_country == 'Marocco' %}selected{% endif %}>Marocco</option>
                        <option value="Tunisia" {% if hr_data.birth_country == 'Tunisia' %}selected{% endif %}>Tunisia</option>
                        <option value="Egitto" {% if hr_data.birth_country == 'Egitto' %}selected{% endif %}>Egitto</option>
                        <option value="Nigeria" {% if hr_data.birth_country == 'Nigeria' %}selected{% endif %}>Nigeria</option>
                        <option value="Senegal" {% if hr_data.birth_country == 'Senegal' %}selected{% endif %}>Senegal</option>
                    </optgroup>
                </select>
            </div>
            <div class="col-md-5 mb-3" id="birth_city_container">
                <label class="form-label">Comune di Nascita</label>
                <select name="birth_city" id="birth_city" class="form-select" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Seleziona...</option>
                    <option value="Roma" {% if hr_data.birth_city == 'Roma' %}selected{% endif %}>Roma</option>
                    <option value="Milano" {% if hr_data.birth_city == 'Milano' %}selected{% endif %}>Milano</option>
                    <option value="Napoli" {% if hr_data.birth_city == 'Napoli' %}selected{% endif %}>Napoli</option>
                    <option value="Torino" {% if hr_data.birth_city == 'Torino' %}selected{% endif %}>Torino</option>
                    <option value="Palermo" {% if hr_data.birth_city == 'Palermo' %}selected{% endif %}>Palermo</option>
                    <option value="Genova" {% if hr_data.birth_city == 'Genova' %}selected{% endif %}>Genova</option>
                    <option value="Bologna" {% if hr_data.birth_city == 'Bologna' %}selected{% endif %}>Bologna</option>
                    <option value="Firenze" {% if hr_data.birth_city == 'Firenze' %}selected{% endif %}>Firenze</option>
                    <option value="Bari" {% if hr_data.birth_city == 'Bari' %}selected{% endif %}>Bari</option>
                    <option value="Catania" {% if hr_data.birth_city == 'Catania' %}selected{% endif %}>Catania</option>
                    <option value="Venezia" {% if hr_data.birth_city == 'Venezia' %}selected{% endif %}>Venezia</option>
                    <option value="Verona" {% if hr_data.birth_city == 'Verona' %}selected{% endif %}>Verona</option>
                    <option value="Messina" {% if hr_data.birth_city == 'Messina' %}selected{% endif %}>Messina</option>
                    <option value="Padova" {% if hr_data.birth_city == 'Padova' %}selected{% endif %}>Padova</option>
                    <option value="Trieste" {% if hr_data.birth_city == 'Trieste' %}selected{% endif %}>Trieste</option>
                    <option value="Brescia" {% if hr_data.birth_city == 'Brescia' %}selected{% endif %}>Brescia</option>
                    <option value="Parma" {% if hr_data.birth_city == 'Parma' %}selected{% endif %}>Parma</option>
                    <option value="Taranto" {% if hr_data.birth_city == 'Taranto' %}selected{% endif %}>Taranto</option>
                    <option value="Prato" {% if hr_data.birth_city == 'Prato' %}selected{% endif %}>Prato</option>
                    <option value="Modena" {% if hr_data.birth_city == 'Modena' %}selected{% endif %}>Modena</option>
                    <option value="Reggio Calabria" {% if hr_data.birth_city == 'Reggio Calabria' %}selected{% endif %}>Reggio Calabria</option>
                    <option value="Reggio Emilia" {% if hr_data.birth_city == 'Reggio Emilia' %}selected{% endif %}>Reggio Emilia</option>
                    <option value="Perugia" {% if hr_data.birth_city == 'Perugia' %}selected{% endif %}>Perugia</option>
                    <option value="Ravenna" {% if hr_data.birth_city == 'Ravenna' %}selected{% endif %}>Ravenna</option>
                    <option value="Livorno" {% if hr_data.birth_city == 'Livorno' %}selected{% endif %}>Livorno</option>
                    <option value="Cagliari" {% if hr_data.birth_city == 'Cagliari' %}selected{% endif %}>Cagliari</option>
                    <option value="Foggia" {% if hr_data.birth_city == 'Foggia' %}selected{% endif %}>Foggia</option>
                    <option value="Rimini" {% if hr_data.birth_city == 'Rimini' %}selected{% endif %}>Rimini</option>
                    <option value="Salerno" {% if hr_data.birth_city == 'Salerno' %}selected{% endif %}>Salerno</option>
                    <option value="Ferrara" {% if hr_data.birth_city == 'Ferrara' %}selected{% endif %}>Ferrara</option>
                </select>
                <small class="text-muted">Se il comune non è in lista, verrà usato codice generico</small>
            </div>
            <div class="col-md-2 mb-3" id="birth_province_container">
                <label class="form-label">Prov.</label>
                <select name="birth_province" id="birth_province" class="form-select" {% if not can_edit %}disabled{% endif %}>
                    <option value="">-</option>
                    <option value="AG" {% if hr_data.birth_province == 'AG' %}selected{% endif %}>AG</option>
                    <option value="AL" {% if hr_data.birth_province == 'AL' %}selected{% endif %}>AL</option>
                    <option value="AN" {% if hr_data.birth_province == 'AN' %}selected{% endif %}>AN</option>
                    <option value="AO" {% if hr_data.birth_province == 'AO' %}selected{% endif %}>AO</option>
                    <option value="AR" {% if hr_data.birth_province == 'AR' %}selected{% endif %}>AR</option>
                    <option value="AP" {% if hr_data.birth_province == 'AP' %}selected{% endif %}>AP</option>
                    <option value="AT" {% if hr_data.birth_province == 'AT' %}selected{% endif %}>AT</option>
                    <option value="AV" {% if hr_data.birth_province == 'AV' %}selected{% endif %}>AV</option>
                    <option value="BA" {% if hr_data.birth_province == 'BA' %}selected{% endif %}>BA</option>
                    <option value="BT" {% if hr_data.birth_province == 'BT' %}selected{% endif %}>BT</option>
                    <option value="BL" {% if hr_data.birth_province == 'BL' %}selected{% endif %}>BL</option>
                    <option value="BN" {% if hr_data.birth_province == 'BN' %}selected{% endif %}>BN</option>
                    <option value="BG" {% if hr_data.birth_province == 'BG' %}selected{% endif %}>BG</option>
                    <option value="BI" {% if hr_data.birth_province == 'BI' %}selected{% endif %}>BI</option>
                    <option value="BO" {% if hr_data.birth_province == 'BO' %}selected{% endif %}>BO</option>
                    <option value="BZ" {% if hr_data.birth_province == 'BZ' %}selected{% endif %}>BZ</option>
                    <option value="BS" {% if hr_data.birth_province == 'BS' %}selected{% endif %}>BS</option>
                    <option value="BR" {% if hr_data.birth_province == 'BR' %}selected{% endif %}>BR</option>
                    <option value="CA" {% if hr_data.birth_province == 'CA' %}selected{% endif %}>CA</option>
                    <option value="CL" {% if hr_data.birth_province == 'CL' %}selected{% endif %}>CL</option>
                    <option value="CB" {% if hr_data.birth_province == 'CB' %}selected{% endif %}>CB</option>
                    <option value="CI" {% if hr_data.birth_province == 'CI' %}selected{% endif %}>CI</option>
                    <option value="CE" {% if hr_data.birth_province == 'CE' %}selected{% endif %}>CE</option>
                    <option value="CT" {% if hr_data.birth_province == 'CT' %}selected{% endif %}>CT</option>
                    <option value="CZ" {% if hr_data.birth_province == 'CZ' %}selected{% endif %}>CZ</option>
                    <option value="CH" {% if hr_data.birth_province == 'CH' %}selected{% endif %}>CH</option>
                    <option value="CO" {% if hr_data.birth_province == 'CO' %}selected{% endif %}>CO</option>
                    <option value="CS" {% if hr_data.birth_province == 'CS' %}selected{% endif %}>CS</option>
                    <option value="CR" {% if hr_data.birth_province == 'CR' %}selected{% endif %}>CR</option>
                    <option value="KR" {% if hr_data.birth_province == 'KR' %}selected{% endif %}>KR</option>
                    <option value="CN" {% if hr_data.birth_province == 'CN' %}selected{% endif %}>CN</option>
                    <option value="EN" {% if hr_data.birth_province == 'EN' %}selected{% endif %}>EN</option>
                    <option value="FM" {% if hr_data.birth_province == 'FM' %}selected{% endif %}>FM</option>
                    <option value="FE" {% if hr_data.birth_province == 'FE' %}selected{% endif %}>FE</option>
                    <option value="FI" {% if hr_data.birth_province == 'FI' %}selected{% endif %}>FI</option>
                    <option value="FG" {% if hr_data.birth_province == 'FG' %}selected{% endif %}>FG</option>
                    <option value="FC" {% if hr_data.birth_province == 'FC' %}selected{% endif %}>FC</option>
                    <option value="FR" {% if hr_data.birth_province == 'FR' %}selected{% endif %}>FR</option>
                    <option value="GE" {% if hr_data.birth_province == 'GE' %}selected{% endif %}>GE</option>
                    <option value="GO" {% if hr_data.birth_province == 'GO' %}selected{% endif %}>GO</option>
                    <option value="GR" {% if hr_data.birth_province == 'GR' %}selected{% endif %}>GR</option>
                    <option value="IM" {% if hr_data.birth_province == 'IM' %}selected{% endif %}>IM</option>
                    <option value="IS" {% if hr_data.birth_province == 'IS' %}selected{% endif %}>IS</option>
                    <option value="SP" {% if hr_data.birth_province == 'SP' %}selected{% endif %}>SP</option>
                    <option value="AQ" {% if hr_data.birth_province == 'AQ' %}selected{% endif %}>AQ</option>
                    <option value="LT" {% if hr_data.birth_province == 'LT' %}selected{% endif %}>LT</option>
                    <option value="LE" {% if hr_data.birth_province == 'LE' %}selected{% endif %}>LE</option>
                    <option value="LC" {% if hr_data.birth_province == 'LC' %}selected{% endif %}>LC</option>
                    <option value="LI" {% if hr_data.birth_province == 'LI' %}selected{% endif %}>LI</option>
                    <option value="LO" {% if hr_data.birth_province == 'LO' %}selected{% endif %}>LO</option>
                    <option value="LU" {% if hr_data.birth_province == 'LU' %}selected{% endif %}>LU</option>
                    <option value="MC" {% if hr_data.birth_province == 'MC' %}selected{% endif %}>MC</option>
                    <option value="MN" {% if hr_data.birth_province == 'MN' %}selected{% endif %}>MN</option>
                    <option value="MS" {% if hr_data.birth_province == 'MS' %}selected{% endif %}>MS</option>
                    <option value="MT" {% if hr_data.birth_province == 'MT' %}selected{% endif %}>MT</option>
                    <option value="ME" {% if hr_data.birth_province == 'ME' %}selected{% endif %}>ME</option>
                    <option value="MI" {% if hr_data.birth_province == 'MI' %}selected{% endif %}>MI</option>
                    <option value="MO" {% if hr_data.birth_province == 'MO' %}selected{% endif %}>MO</option>
                    <option value="MB" {% if hr_data.birth_province == 'MB' %}selected{% endif %}>MB</option>
                    <option value="NA" {% if hr_data.birth_province == 'NA' %}selected{% endif %}>NA</option>
                    <option value="NO" {% if hr_data.birth_province == 'NO' %}selected{% endif %}>NO</option>
                    <option value="NU" {% if hr_data.birth_province == 'NU' %}selected{% endif %}>NU</option>
                    <option value="OG" {% if hr_data.birth_province == 'OG' %}selected{% endif %}>OG</option>
                    <option value="OT" {% if hr_data.birth_province == 'OT' %}selected{% endif %}>OT</option>
                    <option value="OR" {% if hr_data.birth_province == 'OR' %}selected{% endif %}>OR</option>
                    <option value="PD" {% if hr_data.birth_province == 'PD' %}selected{% endif %}>PD</option>
                    <option value="PA" {% if hr_data.birth_province == 'PA' %}selected{% endif %}>PA</option>
                    <option value="PR" {% if hr_data.birth_province == 'PR' %}selected{% endif %}>PR</option>
                    <option value="PV" {% if hr_data.birth_province == 'PV' %}selected{% endif %}>PV</option>
                    <option value="PG" {% if hr_data.birth_province == 'PG' %}selected{% endif %}>PG</option>
                    <option value="PU" {% if hr_data.birth_province == 'PU' %}selected{% endif %}>PU</option>
                    <option value="PE" {% if hr_data.birth_province == 'PE' %}selected{% endif %}>PE</option>
                    <option value="PC" {% if hr_data.birth_province == 'PC' %}selected{% endif %}>PC</option>
                    <option value="PI" {% if hr_data.birth_province == 'PI' %}selected{% endif %}>PI</option>
                    <option value="PT" {% if hr_data.birth_province == 'PT' %}selected{% endif %}>PT</option>
                    <option value="PN" {% if hr_data.birth_province == 'PN' %}selected{% endif %}>PN</option>
                    <option value="PZ" {% if hr_data.birth_province == 'PZ' %}selected{% endif %}>PZ</option>
                    <option value="PO" {% if hr_data.birth_province == 'PO' %}selected{% endif %}>PO</option>
                    <option value="RG" {% if hr_data.birth_province == 'RG' %}selected{% endif %}>RG</option>
                    <option value="RA" {% if hr_data.birth_province == 'RA' %}selected{% endif %}>RA</option>
                    <option value="RC" {% if hr_data.birth_province == 'RC' %}selected{% endif %}>RC</option>
                    <option value="RE" {% if hr_data.birth_province == 'RE' %}selected{% endif %}>RE</option>
                    <option value="RI" {% if hr_data.birth_province == 'RI' %}selected{% endif %}>RI</option>
                    <option value="RN" {% if hr_data.birth_province == 'RN' %}selected{% endif %}>RN</option>
                    <option value="RM" {% if hr_data.birth_province == 'RM' %}selected{% endif %}>RM</option>
                    <option value="RO" {% if hr_data.birth_province == 'RO' %}selected{% endif %}>RO</option>
                    <option value="SA" {% if hr_data.birth_province == 'SA' %}selected{% endif %}>SA</option>
                    <option value="VS" {% if hr_data.birth_province == 'VS' %}selected{% endif %}>VS</option>
                    <option value="SS" {% if hr_data.birth_province == 'SS' %}selected{% endif %}>SS</option>
                    <option value="SV" {% if hr_data.birth_province == 'SV' %}selected{% endif %}>SV</option>
                    <option value="SI" {% if hr_data.birth_province == 'SI' %}selected{% endif %}>SI</option>
                    <option value="SR" {% if hr_data.birth_province == 'SR' %}selected{% endif %}>SR</option>
                    <option value="SO" {% if hr_data.birth_province == 'SO' %}selected{% endif %}>SO</option>
                    <option value="SU" {% if hr_data.birth_province == 'SU' %}selected{% endif %}>SU</option>
                    <option value="TA" {% if hr_data.birth_province == 'TA' %}selected{% endif %}>TA</option>
                    <option value="TE" {% if hr_data.birth_province == 'TE' %}selected{% endif %}>TE</option>
                    <option value="TR" {% if hr_data.birth_province == 'TR' %}selected{% endif %}>TR</option>
                    <option value="TO" {% if hr_data.birth_province == 'TO' %}selected{% endif %}>TO</option>
                    <option value="TP" {% if hr_data.birth_province == 'TP' %}selected{% endif %}>TP</option>
                    <option value="TN" {% if hr_data.birth_province == 'TN' %}selected{% endif %}>TN</option>
                    <option value="TV" {% if hr_data.birth_province == 'TV' %}selected{% endif %}>TV</option>
                    <option value="TS" {% if hr_data.birth_province == 'TS' %}selected{% endif %}>TS</option>
                    <option value="UD" {% if hr_data.birth_province == 'UD' %}selected{% endif %}>UD</option>
                    <option value="VA" {% if hr_data.birth_province == 'VA' %}selected{% endif %}>VA</option>
                    <option value="VE" {% if hr_data.birth_province == 'VE' %}selected{% endif %}>VE</option>
                    <option value="VB" {% if hr_data.birth_province == 'VB' %}selected{% endif %}>VB</option>
                    <option value="VC" {% if hr_data.birth_province == 'VC' %}selected{% endif %}>VC</option>
                    <option value="VR" {% if hr_data.birth_province == 'VR' %}selected{% endif %}>VR</option>
                    <option value="VV" {% if hr_data.birth_province == 'VV' %}selected{% endif %}>VV</option>
                    <option value="VI" {% if hr_data.birth_province == 'VI' %}selected{% endif %}>VI</option>
                    <option value="VT" {% if hr_data.birth_province == 'VT' %}selected{% endif %}>VT</option>
                </select>
            </div>
        </div>

        <!-- Residenza -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-home me-2"></i>Residenza</h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Indirizzo (Comune di Residenza)</label>
                <input type="text" name="address" class="form-control" 
                       value="{{ hr_data.address or '' }}"
                       placeholder="Via/Piazza, Numero"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Città</label>
                <input type="text" name="city" class="form-control" 
                       value="{{ hr_data.city or '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-2 mb-3">
                <label class="form-label">CAP</label>
                <input type="text" name="postal_code" class="form-control" 
                       value="{{ hr_data.postal_code or '' }}"
                       maxlength="5"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label class="form-label">Domicilio (se diverso dalla residenza)</label>
                <input type="text" name="alternative_domicile" class="form-control" 
                       value="{{ hr_data.alternative_domicile or '' }}"
                       placeholder="Indirizzo completo"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>

        <!-- Contatti -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-phone me-2"></i>Contatti</h6>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Recapito Telefonico</label>
                <input type="tel" name="phone" class="form-control" 
                       value="{{ hr_data.phone or '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">E-mail Personale</label>
                <input type="email" name="personal_email" class="form-control" 
                       value="{{ hr_data.personal_email or '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">E-mail Aziendale</label>
                <input type="email" class="form-control" value="{{ user.email }}" disabled>
            </div>
        </div>

        <!-- Titolo di Studio -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-graduation-cap me-2"></i>Formazione</h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Titolo di Studio</label>
                <select name="education_level" class="form-select" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Seleziona...</option>
                    <option value="Licenza Media" {% if hr_data.education_level == 'Licenza Media' %}selected{% endif %}>Licenza Media</option>
                    <option value="Diploma" {% if hr_data.education_level == 'Diploma' %}selected{% endif %}>Diploma</option>
                    <option value="Laurea Triennale" {% if hr_data.education_level == 'Laurea Triennale' %}selected{% endif %}>Laurea Triennale</option>
                    <option value="Laurea Magistrale" {% if hr_data.education_level == 'Laurea Magistrale' %}selected{% endif %}>Laurea Magistrale</option>
                    <option value="Master" {% if hr_data.education_level == 'Master' %}selected{% endif %}>Master</option>
                    <option value="Dottorato" {% if hr_data.education_level == 'Dottorato' %}selected{% endif %}>Dottorato</option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Campo di Studio</label>
                <input type="text" name="education_field" class="form-control" 
                       value="{{ hr_data.education_field or '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>

        <!-- Altri Dati Personali -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-info-circle me-2"></i>Altri Dati</h6>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Stato Civile</label>
                <select name="marital_status" class="form-select" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Seleziona...</option>
                    <option value="Celibe/Nubile" {% if hr_data.marital_status == 'Celibe/Nubile' %}selected{% endif %}>Celibe/Nubile</option>
                    <option value="Coniugato/a" {% if hr_data.marital_status == 'Coniugato/a' %}selected{% endif %}>Coniugato/a</option>
                    <option value="Divorziato/a" {% if hr_data.marital_status == 'Divorziato/a' %}selected{% endif %}>Divorziato/a</option>
                    <option value="Vedovo/a" {% if hr_data.marital_status == 'Vedovo/a' %}selected{% endif %}>Vedovo/a</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Familiari a Carico</label>
                <input type="number" name="dependents_number" class="form-control" 
                       value="{{ hr_data.dependents_number or '' }}"
                       min="0"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Fruizione Permessi L. 104/92</label>
                <div class="form-check form-switch mt-2">
                    <input type="checkbox" name="law_104_benefits" class="form-check-input" 
                           {% if hr_data.law_104_benefits %}checked{% endif %}
                           {% if not can_edit %}disabled{% endif %}>
                    <label class="form-check-label">Usufruisce L. 104/92</label>
                </div>
            </div>
        </div>

        <!-- Contatto di Emergenza -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-phone-volume me-2"></i>Contatto di Emergenza</h6>
        <div class="row">
            <div class="col-md-5 mb-3">
                <label class="form-label">Nome Contatto</label>
                <input type="text" name="emergency_contact_name" class="form-control" 
                       value="{{ hr_data.emergency_contact_name or '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Telefono Emergenza</label>
                <input type="tel" name="emergency_contact_phone" class="form-control" 
                       value="{{ hr_data.emergency_contact_phone or '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Relazione</label>
                <input type="text" name="emergency_contact_relation" class="form-control" 
                       value="{{ hr_data.emergency_contact_relation or '' }}"
                       placeholder="es. Coniuge, Genitore"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>

        <!-- Documento Identità -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-id-card me-2"></i>Documento Identità</h6>
        <div class="row">
            <div class="col-md-3 mb-3">
                <label class="form-label">Tipo Documento</label>
                <select name="id_card_type" class="form-select" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Seleziona...</option>
                    <option value="Carta d'Identità" {% if hr_data.id_card_type == "Carta d'Identità" %}selected{% endif %}>Carta d'Identità</option>
                    <option value="Passaporto" {% if hr_data.id_card_type == "Passaporto" %}selected{% endif %}>Passaporto</option>
                    <option value="Patente" {% if hr_data.id_card_type == "Patente" %}selected{% endif %}>Patente</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Numero Documento</label>
                <input type="text" name="id_card_number" class="form-control text-uppercase" 
                       value="{{ hr_data.id_card_number or '' }}"
                       placeholder="AX1234567"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Upload Documento</label>
                {% if hr_data.id_card_file %}
                <div class="mb-2">
                    <a href="{{ url_for('static', filename=hr_data.id_card_file) }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-file-pdf me-1"></i>Visualizza Documento
                    </a>
                    {% if can_edit %}
                    <button type="button" class="btn btn-sm btn-outline-danger"
                            onclick="if(confirm('Confermi l\'eliminazione del documento?')) { document.getElementById('deleteIdCard').value='1'; this.form.submit(); }">
                        <i class="fas fa-trash me-1"></i>Elimina
                    </button>
                    <input type="hidden" id="deleteIdCard" name="delete_id_card" value="0">
                    {% endif %}
                </div>
                {% endif %}
                <input type="file" name="id_card_file" class="form-control" 
                       accept=".pdf,.jpg,.jpeg,.png"
                       {% if not can_edit %}disabled{% endif %}>
                <small class="text-muted">Carica copia del documento (PDF, JPG, PNG - max 5MB)</small>
            </div>
        </div>

        <!-- Veicolo ACI - Selezione a cascata -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-car me-2"></i>Veicolo ACI (Rimborsi Chilometrici)</h6>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Tipo Veicolo</label>
                <select id="tipoVeicoloSelectHR" class="form-select" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Seleziona tipo</option>
                    {% set tipi = [] %}
                    {% for vehicle in aci_vehicles %}
                        {% if vehicle.tipologia not in tipi %}
                            {% set _ = tipi.append(vehicle.tipologia) %}
                        {% endif %}
                    {% endfor %}
                    {% for tipo in tipi|sort %}
                    <option value="{{ tipo }}">{{ tipo }}</option>
                    {% endfor %}
                </select>
                <small class="text-muted">Tipo di veicolo (es. Autovettura, Motociclo)</small>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Marca</label>
                <select id="marcaVeicoloSelectHR" class="form-select" disabled>
                    <option value="">Seleziona prima il tipo</option>
                </select>
                <small class="text-muted">Marca del veicolo</small>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Modello e Costo/km</label>
                <select name="aci_vehicle_id" id="modelloVeicoloSelectHR" class="form-select" disabled>
                    <option value="">Seleziona prima la marca</option>
                </select>
                <small class="text-muted">Modello specifico con costo chilometrico</small>
            </div>
        </div>
        
        <!-- Upload Libretto di Circolazione -->
        <div class="row mt-3">
            <div class="col-md-8 mb-3">
                <label class="form-label">Libretto di Circolazione</label>
                {% if hr_data.vehicle_registration_document %}
                <div class="input-group mb-2">
                    <input type="text" class="form-control" value="{{ hr_data.vehicle_registration_document.split('/')[-1] }}" disabled>
                    <a href="/static/uploads/vehicle_docs/{{ hr_data.vehicle_registration_document.split('/')[-1] }}" 
                       target="_blank" class="btn btn-outline-primary" title="Visualizza libretto">
                        <i class="fas fa-eye me-1"></i>Visualizza
                    </a>
                    <a href="/static/uploads/vehicle_docs/{{ hr_data.vehicle_registration_document.split('/')[-1] }}" 
                       download class="btn btn-outline-success" title="Scarica libretto">
                        <i class="fas fa-download me-1"></i>Scarica
                    </a>
                </div>
                {% endif %}
                <input type="file" name="vehicle_registration_document" class="form-control" 
                       accept=".pdf,.jpg,.jpeg,.png"
                       {% if not can_edit %}disabled{% endif %}>
                <small class="text-muted">Carica una copia del libretto di circolazione (PDF, JPG, PNG - max 5MB)</small>
            </div>
            <div class="col-md-4 mb-3">
                {% if hr_data.vehicle_registration_document %}
                <label class="form-label">Azioni</label>
                <div class="d-grid">
                    <button type="button" class="btn btn-outline-danger" 
                            onclick="if(confirm('Confermi l\'eliminazione del libretto caricato?')) { document.getElementById('deleteVehicleDoc').value='1'; this.form.submit(); }"
                            {% if not can_edit %}disabled{% endif %}>
                        <i class="fas fa-trash me-1"></i>Elimina Documento
                    </button>
                    <input type="hidden" id="deleteVehicleDoc" name="delete_vehicle_doc" value="0">
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Configurazione Rimborso Chilometrico -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-cog me-2"></i>Configurazione Rimborso Chilometrico</h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Tipologia Rimborso</label>
                <select name="mileage_reimbursement_type" class="form-select" id="mileageReimbursementType" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Nessuna configurazione</option>
                    <option value="libero" {% if hr_data.mileage_reimbursement_type == 'libero' %}selected{% endif %}>Libero (Calcolo da tabelle ACI)</option>
                    <option value="fisso" {% if hr_data.mileage_reimbursement_type == 'fisso' %}selected{% endif %}>Fisso (Importo massimo annuale)</option>
                    <option value="entrambi" {% if hr_data.mileage_reimbursement_type == 'entrambi' %}selected{% endif %}>Entrambi (Dipendente può scegliere)</option>
                </select>
                <small class="text-muted">
                    <strong>Libero:</strong> Rimborso calcolato da km × tariffa ACI<br>
                    <strong>Fisso:</strong> Rimborso forfettario con limite annuale<br>
                    <strong>Entrambi:</strong> Dipendente può usare entrambe le modalità
                </small>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Importo Massimo Annuale (Fisso)</label>
                <div class="input-group">
                    <span class="input-group-text">€</span>
                    <input type="text" name="mileage_fixed_max_annual" id="mileageFixedMaxAnnual" 
                           class="form-control" 
                           value="{{ '%.2f'|format(hr_data.mileage_fixed_max_annual or 0) if hr_data.mileage_fixed_max_annual else '' }}"
                           placeholder="0.00"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <small class="text-muted">
                    Importo massimo annuale per rimborsi fissi (es. 3000.00)<br>
                    <span id="fixedBalanceInfo" class="text-info" style="display:none;">
                        <i class="fas fa-info-circle me-1"></i>Disponibile anno corrente: <strong id="fixedBalance">€ 0.00</strong>
                    </span>
                </small>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- TAB 2: DATI CONTRATTUALI -->
    <!-- ========================================= -->
    <div class="tab-pane fade" id="contrattuali" role="tabpanel" aria-labelledby="contrattuali-tab">
        <!-- Riga 1: COD SI, Codice Zucchetti, Tipologia Contratto -->
        <div class="row">
            <div class="col-md-2 mb-3">
                <label class="form-label fw-bold">COD SI (Matricola)</label>
                <input type="text" class="form-control font-monospace" 
                       value="{{ user.matricola or 'Non assegnato' }}" 
                       disabled style="background-color: #e9ecef;">
                <small class="text-muted d-block mt-1">
                    {% if user.matricola %}
                    <i class="fas fa-check-circle text-success"></i> Assegnato automaticamente
                    {% else %}
                    <i class="fas fa-info-circle text-info"></i> Verrà assegnato alla creazione
                    {% endif %}
                </small>
            </div>
            <div class="col-md-2 mb-3">
                <label class="form-label fw-bold">Codice per Export</label>
                <input type="text" name="cod_zucchetti" class="form-control" 
                       value="{{ hr_data.cod_zucchetti or '' }}"
                       placeholder="Codice esterno"
                       {% if not can_edit %}disabled{% endif %}>
                <small class="text-muted">Codice per sistemi di export/integrazione</small>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Tipologia Contratto <span class="text-danger">*</span></label>
                <select name="contract_type" id="contract_type" class="form-select" required {% if not can_edit %}disabled{% endif %}>
                    <option value="">Seleziona...</option>
                    <option value="Tempo Indeterminato" {% if hr_data.contract_type == 'Tempo Indeterminato' %}selected{% endif %}>Tempo Indeterminato</option>
                    <option value="Tempo Determinato" {% if hr_data.contract_type == 'Tempo Determinato' %}selected{% endif %}>Tempo Determinato</option>
                    <option value="Apprendistato" {% if hr_data.contract_type == 'Apprendistato' %}selected{% endif %}>Apprendistato</option>
                    <option value="Stage/Tirocinio" {% if hr_data.contract_type == 'Stage/Tirocinio' %}selected{% endif %}>Stage/Tirocinio</option>
                    <option value="Collaborazione" {% if hr_data.contract_type == 'Collaborazione' %}selected{% endif %}>Collaborazione</option>
                    <option value="In Distacco" {% if hr_data.contract_type == 'In Distacco' %}selected{% endif %}>In Distacco</option>
                    <option value="Consulente/P.IVA" {% if hr_data.contract_type == 'Consulente/P.IVA' %}selected{% endif %}>Consulente/P.IVA</option>
                    <option value="Fornitore" {% if hr_data.contract_type == 'Fornitore' %}selected{% endif %}>Fornitore</option>
                    <option value="Altro" {% if hr_data.contract_type == 'Altro' %}selected{% endif %}>Altro</option>
                </select>
            </div>
            <div class="col-md-3 mb-3" id="distacco_supplier_field" style="display: {% if hr_data.contract_type == 'In Distacco' %}block{% else %}none{% endif %};">
                <label class="form-label">Fornitore / Azienda Distaccante</label>
                <input type="text" name="distacco_supplier" class="form-control" 
                       value="{{ hr_data.distacco_supplier or '' }}"
                       placeholder="Nome azienda"
                       {% if not can_edit %}disabled{% endif %}>
                <small class="text-muted">Azienda che fornisce il personale</small>
            </div>
            <div class="col-md-3 mb-3" id="consulente_vat_field" style="display: {% if hr_data.contract_type == 'Consulente/P.IVA' %}block{% else %}none{% endif %};">
                <label class="form-label">Partita IVA</label>
                <input type="text" name="consulente_vat" class="form-control" 
                       value="{{ hr_data.consulente_vat or '' }}"
                       placeholder="IT12345678901"
                       {% if not can_edit %}disabled{% endif %}>
                <small class="text-muted">Partita IVA del consulente</small>
            </div>
            <div class="col-md-3 mb-3" id="fornitore_nome_field" style="display: {% if hr_data.contract_type == 'Fornitore' %}block{% else %}none{% endif %};">
                <label class="form-label">Nome Fornitore</label>
                <input type="text" name="nome_fornitore" class="form-control" 
                       value="{{ hr_data.nome_fornitore or '' }}"
                       placeholder="Nome del fornitore"
                       {% if not can_edit %}disabled{% endif %}>
                <small class="text-muted">Denominazione fornitore</small>
            </div>
            <div class="col-md-3 mb-3" id="fornitore_piva_field" style="display: {% if hr_data.contract_type == 'Fornitore' %}block{% else %}none{% endif %};">
                <label class="form-label">Partita IVA Fornitore</label>
                <input type="text" name="partita_iva_fornitore" class="form-control" 
                       value="{{ hr_data.partita_iva_fornitore or '' }}"
                       placeholder="IT12345678901"
                       {% if not can_edit %}disabled{% endif %}>
                <small class="text-muted">P.IVA del fornitore</small>
            </div>
            <div class="col-md-2 mb-3">
                <label class="form-label">Data Assunzione <span class="text-danger">*</span></label>
                <input type="date" name="hire_date" id="hire_date" class="form-control" 
                       value="{{ hr_data.hire_date.strftime('%Y-%m-%d') if hr_data.hire_date else '' }}"
                       required
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-2 mb-3">
                <label class="form-label">Data Fine Rapporto</label>
                <input type="date" name="contract_end_date" class="form-control" 
                       value="{{ hr_data.contract_end_date.strftime('%Y-%m-%d') if hr_data.contract_end_date else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>

        <!-- Riga 2: CCNL, Qualifica, Livello, Mansione -->
        <div class="row">
            <div class="col-md-3 mb-3">
                <label class="form-label">CCNL <span class="text-danger ccnl-required-flag">*</span></label>
                <select id="ccnl_contract_id" name="ccnl_contract_id" class="form-select ccnl-conditional-required" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Seleziona CCNL...</option>
                    {% for ccnl in ccnl_list %}
                    <option value="{{ ccnl.id }}" {% if hr_data.ccnl_contract_id == ccnl.id %}selected{% endif %}>
                        {{ ccnl.nome }}
                    </option>
                    {% endfor %}
                </select>
                <input type="hidden" name="ccnl" value="{{ hr_data.ccnl or '' }}">
                <small class="text-muted">Gestisci i CCNL dal menu HR</small>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Qualifica <span class="text-danger ccnl-required-flag">*</span></label>
                <select id="ccnl_qualification_id" name="ccnl_qualification_id" class="form-select ccnl-conditional-required" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Prima seleziona CCNL...</option>
                </select>
                <input type="hidden" name="qualifica" value="{{ hr_data.qualifica or '' }}">
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Livello <span class="text-danger ccnl-required-flag">*</span></label>
                <select id="ccnl_level_id" name="ccnl_level_id" class="form-select ccnl-conditional-required" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Prima seleziona Qualifica...</option>
                </select>
                <input type="hidden" name="ccnl_level" value="{{ hr_data.ccnl_level or '' }}">
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Mansione <span class="text-danger ccnl-required-flag">*</span></label>
                <select name="mansione" id="mansione" class="form-select ccnl-conditional-required" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Seleziona...</option>
                    {% for mansione in mansioni %}
                    <option value="{{ mansione.nome }}" {% if hr_data.mansione == mansione.nome %}selected{% endif %}>
                        {{ mansione.nome }}
                    </option>
                    {% endfor %}
                </select>
                <small class="text-muted">Gestisci il mansionario dal menu HR</small>
            </div>
        </div>

        <!-- Riga 3: Orario settimanale e Orario di Lavoro -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Orario (h/sett.) <span class="text-danger">*</span></label>
                <input type="number" step="0.1" name="work_hours_week" id="work_hours_week" class="form-control" 
                       value="{{ hr_data.work_hours_week or '' }}"
                       placeholder="40"
                       required
                       min="0"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Orario di Lavoro <span class="text-danger ccnl-required-flag">*</span></label>
                <select name="work_schedule_id" id="work_schedule_id" class="form-select ccnl-conditional-required" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Nessuno</option>
                    {% for schedule in work_schedules %}
                    <option value="{{ schedule.id }}" {% if hr_data.work_schedule_id == schedule.id %}selected{% endif %}>
                        {{ schedule.name }} ({{ schedule.code }})
                    </option>
                    {% endfor %}
                </select>
                <small class="text-muted">Orario di lavoro assegnato al dipendente</small>
            </div>
        </div>

        <!-- Riga 4: Tipo Assunzione -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Tipo di Assunzione</label>
                <input type="text" name="tipo_assunzione" class="form-control" 
                       value="{{ hr_data.tipo_assunzione or '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>

        <!-- Riga 5: Superminimo, Tipologia, Rimborsi, Rischio INAIL -->
        <div class="row">
            <div class="col-md-3 mb-3">
                <label class="form-label">Superminimo / SM (€) <span class="text-danger ccnl-required-flag">*</span></label>
                <input type="number" step="0.01" name="superminimo" id="superminimo" class="form-control ccnl-conditional-required" 
                       value="{{ hr_data.superminimo or '' }}"
                       min="0"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Tipologia Superminimo <span class="text-danger ccnl-required-flag">*</span></label>
                <select name="superminimo_type" id="superminimo_type" class="form-select ccnl-conditional-required" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Seleziona...</option>
                    <option value="Assorbibile" {% if hr_data.superminimo_type == 'Assorbibile' %}selected{% endif %}>Assorbibile</option>
                    <option value="Non assorbibile" {% if hr_data.superminimo_type == 'Non assorbibile' %}selected{% endif %}>Non assorbibile</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Rimborsi / Diarie (€) <span class="text-danger ccnl-required-flag">*</span></label>
                <input type="number" step="0.01" name="rimborsi_diarie" id="rimborsi_diarie" class="form-control ccnl-conditional-required" 
                       value="{{ hr_data.rimborsi_diarie or '' }}"
                       min="0"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Rischio INAIL <span class="text-danger ccnl-required-flag">*</span></label>
                <input type="text" name="rischio_inail" id="rischio_inail" class="form-control ccnl-conditional-required" 
                       value="{{ hr_data.rischio_inail or '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>

        <!-- Riga 6: Ticket Restaurant e Valore -->
        <div class="row">
            <div class="col-md-3 mb-3">
                <label class="form-label">Ticket Restaurant <span class="text-danger ccnl-required-flag">*</span></label>
                <div class="form-check form-switch mt-2">
                    <input type="checkbox" name="ticket_restaurant" id="ticket_restaurant" class="form-check-input" 
                           {% if hr_data.ticket_restaurant %}checked{% endif %}
                           {% if not can_edit %}disabled{% endif %}>
                    <label class="form-check-label">Ha ticket restaurant</label>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Valore Buoni Pasto (€/giorno) <span class="text-danger ccnl-required-flag">*</span></label>
                <input type="number" step="0.01" name="meal_vouchers_value" id="meal_vouchers_value" class="form-control ccnl-conditional-required" 
                       value="{{ hr_data.meal_vouchers_value or '' }}"
                       min="0"
                       {% if not can_edit or not hr_data.ticket_restaurant %}disabled{% endif %}>
                <small class="text-muted">Valore giornaliero buoni pasto</small>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Carta Carburante <span class="text-danger ccnl-required-flag">*</span></label>
                <div class="form-check form-switch mt-2">
                    <input type="checkbox" name="fuel_card" id="fuel_card" class="form-check-input" 
                           {% if hr_data.fuel_card %}checked{% endif %}
                           {% if not can_edit %}disabled{% endif %}>
                    <label class="form-check-label">Ha carta carburante aziendale</label>
                </div>
            </div>
        </div>

        <!-- Dati Economici e Amministrativi -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-euro-sign me-2"></i>Dati Economici e Amministrativi</h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">IBAN</label>
                <input type="text" name="iban" class="form-control text-uppercase" 
                       value="{{ hr_data.iban or '' }}"
                       maxlength="34"
                       placeholder="IT60X0542811101000000123456"
                       {% if not can_edit %}disabled{% endif %}>
                <small class="text-muted">IBAN per bonifico stipendio</small>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Costo Azienda Giornaliero (€)</label>
                <input type="number" step="0.01" name="daily_company_cost" class="form-control" 
                       value="{{ hr_data.daily_company_cost or '' }}"
                       placeholder="250.00"
                       {% if not can_edit %}disabled{% endif %}>
                <small class="text-muted">Costo totale aziendale al giorno</small>
            </div>
        </div>

        <!-- Dati Operativi -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-building me-2"></i>Dati Operativi <span class="text-danger ccnl-required-flag">*</span></h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Sede di Assunzione <span class="text-danger ccnl-required-flag">*</span></label>
                <select name="sede_id" id="sede_id" class="form-select ccnl-conditional-required" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Nessuna</option>
                    {% for sede in sedi %}
                    <option value="{{ sede.id }}" {% if hr_data.sede_id == sede.id %}selected{% endif %}>
                        {{ sede.name }}
                    </option>
                    {% endfor %}
                </select>
                <small class="text-muted">Sede indicata nel contratto di assunzione</small>
            </div>
            <div class="col-md-6 mb-3">
                <div class="form-check form-switch mt-4">
                    <input type="checkbox" name="all_sedi" class="form-check-input" id="all_sedi"
                           {% if hr_data.all_sedi %}checked{% endif %}
                           {% if not can_edit %}disabled{% endif %}>
                    <label class="form-check-label fw-bold" for="all_sedi">
                        Accesso a Tutte le Sedi <span class="text-danger ccnl-required-flag">*</span>
                    </label>
                </div>
                <small class="text-muted d-block mt-1">Può operare in tutte le sedi aziendali</small>
            </div>
        </div>
        
        <!-- Gestione Straordinari / Banca Ore -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-clock me-2"></i>Gestione Straordinari <span class="text-danger ccnl-required-flag">*</span></h6>
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="form-check mt-4">
                    <input type="checkbox" id="overtime_enabled" name="overtime_enabled" class="form-check-input" 
                           {% if hr_data.overtime_enabled %}checked{% endif %}
                           {% if not can_edit %}disabled{% endif %}>
                    <label class="form-check-label fw-bold" for="overtime_enabled">
                        Abilitato a Straordinari <span class="text-danger ccnl-required-flag">*</span>
                    </label>
                </div>
            </div>
            <div class="col-md-3 mb-3" id="overtimeTypeField" style="display: none;">
                <label class="form-label">Tipologia Straordinario <span class="text-danger ccnl-required-flag">*</span></label>
                <select name="overtime_type" id="overtime_type" class="form-select ccnl-conditional-required" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Seleziona...</option>
                    <option value="Straordinario Pagato" {% if hr_data.overtime_type == 'Straordinario Pagato' %}selected{% endif %}>Straordinario Pagato</option>
                    <option value="Banca Ore" {% if hr_data.overtime_type == 'Banca Ore' %}selected{% endif %}>Banca Ore</option>
                </select>
            </div>
            <div class="col-md-3 mb-3" id="bancaOreLimiteField" style="display: none;">
                <label class="form-label">Limite Massimo Ore</label>
                <div class="input-group">
                    <input type="text" name="banca_ore_limite_max" class="form-control" 
                           value="{{ (hr_data.banca_ore_limite_max|string).replace('.', ',') if hr_data.banca_ore_limite_max else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                    <span class="input-group-text">ore</span>
                </div>
                <small class="text-muted">Limite massimo ore accumulabili</small>
            </div>
            <div class="col-md-3 mb-3" id="bancaOrePeriodoField" style="display: none;">
                <label class="form-label">Periodo Validità</label>
                <div class="input-group">
                    <input type="text" name="banca_ore_periodo_mesi" class="form-control" 
                           value="{{ hr_data.banca_ore_periodo_mesi if hr_data.banca_ore_periodo_mesi else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                    <span class="input-group-text">mesi</span>
                </div>
                <small class="text-muted">Periodo entro cui usufruire ore</small>
            </div>
        </div>

        <!-- Maturazione Ferie e Permessi -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-umbrella-beach me-2"></i>Maturazione Ferie e Permessi</h6>
        <div class="row">
            <!-- Toggle Ore/Giorni per Ferie -->
            <div class="col-md-3 mb-3">
                <label class="form-label">Unità di Misura Ferie</label>
                <select name="ferie_unit" id="ferieUnitSelect" class="form-select" {% if not can_edit %}disabled{% endif %}>
                    <option value="hours" {% if hr_data.ferie_unit == 'hours' or not hr_data.ferie_unit %}selected{% endif %}>Ore</option>
                    <option value="days" {% if hr_data.ferie_unit == 'days' %}selected{% endif %}>Giorni</option>
                </select>
                <small class="text-muted">Scegli come gestire le ferie</small>
            </div>
            
            <!-- Ore Giornaliere (visibile solo se Giorni selezionato) -->
            <div class="col-md-3 mb-3" id="ferieDailyHoursField" style="display: none;">
                <label class="form-label">Ore per Giorno</label>
                <div class="input-group">
                    <input type="text" name="ferie_daily_hours" id="ferieDailyHoursInput" class="form-control" 
                           value="{{ (hr_data.ferie_daily_hours|string).replace('.', ',') if hr_data.ferie_daily_hours else '8' }}"
                           placeholder="8"
                           {% if not can_edit %}disabled{% endif %}>
                    <span class="input-group-text">h</span>
                </div>
                <small class="text-muted">Ore in un giorno lavorativo</small>
            </div>
            
            <!-- Ferie Maturate al Mese -->
            <div class="col-md-6 mb-3">
                <label class="form-label" id="ferieMaturateLabel">Ferie Maturate al Mese</label>
                <div class="input-group">
                    <input type="text" name="gg_ferie_maturate_mese" id="ferieMaturateInput" class="form-control" 
                           value="{{ (hr_data.gg_ferie_maturate_mese|string).replace('.', ',') if hr_data.gg_ferie_maturate_mese else '0' }}"
                           placeholder="18.66"
                           data-unit="{{ hr_data.ferie_unit or 'hours' }}"
                           {% if not can_edit %}disabled{% endif %}>
                    <span class="input-group-text" id="ferieMaturateUnit">h/mese</span>
                </div>
                <small class="text-muted" id="ferieMaturateHelp">Es: 18.66 ore/mese = 224 ore/anno (28 giorni x 8 ore)</small>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Ore Permesso (ROL) Maturate al Mese</label>
                <div class="input-group">
                    <input type="text" name="hh_permesso_maturate_mese" class="form-control" 
                           value="{{ (hr_data.hh_permesso_maturate_mese|string).replace('.', ',') if hr_data.hh_permesso_maturate_mese else '0' }}"
                           placeholder="7"
                           {% if not can_edit %}disabled{% endif %}>
                    <span class="input-group-text">h/mese</span>
                </div>
                <small class="text-muted">Es: 7 ore/mese = 84 ore/anno (ROL). Usato per calcolare il monte permessi disponibile.</small>
            </div>
        </div>

        <!-- Note Contratto -->
        <div class="row">
            <div class="col-12 mb-3">
                <label class="form-label">Altro / Note Contrattuali</label>
                <textarea name="other_notes" class="form-control" rows="2"
                          {% if not can_edit %}disabled{% endif %}>{{ hr_data.other_notes or '' }}</textarea>
            </div>
        </div>

        <!-- ========================================= -->
        <!-- SEZIONE DISTACCHI -->
        <!-- ========================================= -->
        <h5 class="border-bottom pb-2 mb-3 mt-5">
            <i class="fas fa-building me-2"></i>Distacchi presso Clienti
        </h5>
        
        <!-- Lista Distacchi Esistenti -->
        {% if secondment_periods %}
        <div class="table-responsive mb-4">
            <table class="table table-sm table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Cliente</th>
                        <th>Data Accordo</th>
                        <th>Data Inizio</th>
                        <th>Data Fine</th>
                        <th>Durata</th>
                        <th>Stato</th>
                        <th>Note</th>
                        {% if can_edit %}<th>Azioni</th>{% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for secondment in secondment_periods %}
                    <tr {% if secondment.get_status() == 'active' %}class="table-info"{% endif %}>
                        <td><strong>{{ secondment.client_name }}</strong></td>
                        <td>
                            {% if secondment.agreement_date %}
                            {{ secondment.agreement_date.strftime('%d/%m/%Y') }}
                            {% else %}
                            <em class="text-muted">-</em>
                            {% endif %}
                        </td>
                        <td>{{ secondment.start_date.strftime('%d/%m/%Y') }}</td>
                        <td>
                            {% if secondment.end_date %}
                            {{ secondment.end_date.strftime('%d/%m/%Y') }}
                            {% else %}
                            <em class="text-muted">In corso</em>
                            {% endif %}
                        </td>
                        <td>{{ secondment.get_duration_days() }} giorni</td>
                        <td>
                            {% set status = secondment.get_status() %}
                            {% if status == 'active' %}
                            <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Attivo</span>
                            {% elif status == 'future' %}
                            <span class="badge bg-info"><i class="fas fa-clock me-1"></i>Futuro</span>
                            {% else %}
                            <span class="badge bg-secondary"><i class="fas fa-check me-1"></i>Concluso</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if secondment.notes %}
                            <small>{{ secondment.notes[:50] }}{% if secondment.notes|length > 50 %}...{% endif %}</small>
                            {% else %}
                            <em class="text-muted">-</em>
                            {% endif %}
                        </td>
                        {% if can_edit %}
                        <td>
                            {% if secondment.is_editable() %}
                            <button type="button" class="btn btn-sm btn-outline-primary me-1" title="Modifica"
                                    onclick="editSecondment({{ secondment.id }}, '{{ secondment.client_name }}', '{{ secondment.agreement_date.strftime('%Y-%m-%d') if secondment.agreement_date else '' }}', '{{ secondment.start_date.strftime('%Y-%m-%d') }}', '{{ secondment.end_date.strftime('%Y-%m-%d') if secondment.end_date else '' }}', `{{ secondment.notes or '' }}`)">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% endif %}
                            <button type="button" class="btn btn-sm btn-outline-danger" title="Elimina"
                                    onclick="deleteSecondment({{ secondment.id }}, '{{ secondment.client_name }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-secondary mb-4">
            <i class="fas fa-info-circle me-2"></i>Nessun periodo di distacco registrato per questo dipendente.
        </div>
        {% endif %}

        <!-- Form Aggiungi Distacco -->
        {% if can_edit %}
        <div class="card border-primary mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Aggiungi Nuovo Distacco</h6>
            </div>
            <div class="card-body">
                <!-- Hidden CSRF token per le richieste JavaScript -->
                <input type="hidden" id="secondment-csrf-token" value="{{ csrf_token() }}">
                <div id="secondment-form">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Nome Cliente <span class="text-danger">*</span></label>
                            <input type="text" id="client_name" class="form-control"
                                   placeholder="es. Acme Corporation">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Data Accordo</label>
                            <input type="date" id="agreement_date" class="form-control">
                            <small class="text-muted">Opzionale</small>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Data Inizio <span class="text-danger">*</span></label>
                            <input type="date" id="start_date" class="form-control">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Data Fine</label>
                            <input type="date" id="end_date" class="form-control">
                            <small class="text-muted">Opzionale</small>
                        </div>
                        <div class="col-md-2 mb-3 d-flex align-items-end">
                            <button type="button" class="btn btn-primary w-100" onclick="addSecondment()">
                                <i class="fas fa-plus me-1"></i>Aggiungi
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Note</label>
                            <textarea id="notes" class="form-control" rows="2" 
                                      placeholder="Note aggiuntive sul distacco (opzionale)"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
        function getCsrfToken() {
            return document.getElementById('secondment-csrf-token').value;
        }
        
        function showOverlay(message) {
            let overlay = document.getElementById('secondment-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'secondment-overlay';
                overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;';
                overlay.innerHTML = `<div style="background:white;padding:30px;border-radius:8px;text-align:center;"><div class="spinner-border text-primary mb-3"></div><div style="color:#333;font-size:16px;">${message}</div></div>`;
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'flex';
        }
        
        function hideOverlay() {
            const overlay = document.getElementById('secondment-overlay');
            if (overlay) overlay.style.display = 'none';
        }
        
        function addSecondment() {
            const clientName = document.getElementById('client_name').value;
            const agreementDate = document.getElementById('agreement_date').value;
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const notes = document.getElementById('notes').value;
            
            if (!clientName || !startDate) {
                alert('Nome Cliente e Data Inizio sono obbligatori');
                return;
            }
            
            showOverlay('Aggiunta distacco in corso...');
            
            const formData = new FormData();
            formData.append('csrf_token', getCsrfToken());
            formData.append('client_name', clientName);
            if (agreementDate) formData.append('agreement_date', agreementDate);
            formData.append('start_date', startDate);
            if (endDate) formData.append('end_date', endDate);
            if (notes) formData.append('notes', notes);
            
            fetch('{{ url_for("hr.add_secondment", user_id=user.id) }}', {
                method: 'POST',
                body: formData
            }).then(response => {
                hideOverlay();
                if (response.ok) {
                    sessionStorage.setItem('secondment_message', 'Distacco aggiunto con successo!');
                    window.location.reload();
                } else {
                    alert('Errore durante l\'aggiunta del distacco');
                }
            }).catch(err => {
                hideOverlay();
                alert('Errore di rete durante l\'aggiunta del distacco');
            });
        }
        
        function editSecondment(id, clientName, agreementDate, startDate, endDate, notes) {
            document.getElementById('client_name').value = clientName;
            document.getElementById('agreement_date').value = agreementDate;
            document.getElementById('start_date').value = startDate;
            document.getElementById('end_date').value = endDate;
            document.getElementById('notes').value = notes;
            
            const btn = document.querySelector('#secondment-form button');
            btn.innerHTML = '<i class="fas fa-save me-1"></i>Salva Modifiche';
            btn.onclick = () => updateSecondment(id);
            
            document.getElementById('secondment-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function updateSecondment(id) {
            const clientName = document.getElementById('client_name').value;
            const agreementDate = document.getElementById('agreement_date').value;
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const notes = document.getElementById('notes').value;
            
            if (!clientName || !startDate) {
                alert('Nome Cliente e Data Inizio sono obbligatori');
                return;
            }
            
            showOverlay('Aggiornamento distacco in corso...');
            
            const formData = new FormData();
            formData.append('csrf_token', getCsrfToken());
            formData.append('client_name', clientName);
            if (agreementDate) formData.append('agreement_date', agreementDate);
            formData.append('start_date', startDate);
            if (endDate) formData.append('end_date', endDate);
            if (notes) formData.append('notes', notes);
            
            fetch(`{{ url_for("hr.update_secondment", user_id=user.id, secondment_id=0) }}`.replace('/0', `/${id}`), {
                method: 'POST',
                body: formData
            }).then(response => {
                hideOverlay();
                if (response.ok) {
                    sessionStorage.setItem('secondment_message', 'Distacco aggiornato con successo!');
                    window.location.reload();
                } else {
                    alert('Errore durante l\'aggiornamento del distacco');
                }
            }).catch(err => {
                hideOverlay();
                alert('Errore di rete durante l\'aggiornamento del distacco');
            });
        }
        
        function deleteSecondment(secondmentId, clientName) {
            if (!confirm(`Confermi l'eliminazione del distacco presso ${clientName}?`)) {
                return;
            }
            
            showOverlay('Eliminazione distacco in corso...');
            
            const formData = new FormData();
            formData.append('csrf_token', getCsrfToken());
            
            fetch(`{{ url_for("hr.delete_secondment", user_id=user.id, secondment_id=0) }}`.replace('/0', `/${secondmentId}`), {
                method: 'POST',
                body: formData
            }).then(response => {
                hideOverlay();
                if (response.ok) {
                    sessionStorage.setItem('secondment_message', 'Distacco eliminato con successo!');
                    window.location.reload();
                } else {
                    alert('Errore durante l\'eliminazione del distacco');
                }
            }).catch(err => {
                hideOverlay();
                alert('Errore di rete durante l\'eliminazione del distacco');
            });
        }
        
        // Mostra messaggio di successo se presente
        window.addEventListener('DOMContentLoaded', function() {
            const message = sessionStorage.getItem('secondment_message');
            if (message) {
                sessionStorage.removeItem('secondment_message');
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `<i class="fas fa-check-circle me-2"></i>${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
                setTimeout(() => alertDiv.remove(), 5000);
            }
        });
        </script>
        {% endif %}
    </div>

    <!-- ========================================= -->
    <!-- TAB 3: VISITE MEDICHE E FORMAZIONE -->
    <!-- ========================================= -->
    <div class="tab-pane fade" id="visite" role="tabpanel" aria-labelledby="visite-tab">
        <!-- Requisiti Minimi -->
        <div class="row mb-4">
            <div class="col-md-12 mb-3">
                <label class="form-label fw-bold">Possesso Requisiti Minimi</label>
                <select name="minimum_requirements" class="form-select" {% if not can_edit %}disabled{% endif %}>
                    <option value="">Seleziona...</option>
                    <option value="SI" {% if hr_data.minimum_requirements == 'SI' %}selected{% endif %}>SI</option>
                    <option value="NO" {% if hr_data.minimum_requirements == 'NO' %}selected{% endif %}>NO</option>
                    <option value="DA FORMARE" {% if hr_data.minimum_requirements == 'DA FORMARE' %}selected{% endif %}>DA FORMARE</option>
                </select>
            </div>
        </div>

        <!-- Visita Medica -->
        <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-stethoscope me-2"></i>Visita Medica</h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Data Ultima Visita</label>
                <input type="date" name="medical_visit_date" class="form-control" 
                       value="{{ hr_data.medical_visit_date.strftime('%Y-%m-%d') if hr_data.medical_visit_date else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Scadenza Visita</label>
                <input type="date" name="medical_visit_expiry" class="form-control" 
                       value="{{ hr_data.medical_visit_expiry.strftime('%Y-%m-%d') if hr_data.medical_visit_expiry else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>

        <!-- Formazione Generale (Art. 36-37) - Periodicità: 5 anni -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-book-open me-2"></i>Formazione e Informazione (Artt. 36 e 37) <small class="text-muted">- Periodicità: 5 anni</small></h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Data Formazione</label>
                <input type="date" name="training_general_date" class="form-control" 
                       value="{{ hr_data.training_general_date.strftime('%Y-%m-%d') if hr_data.training_general_date else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Scadenza</label>
                <input type="date" name="training_general_expiry" class="form-control" 
                       value="{{ hr_data.training_general_expiry.strftime('%Y-%m-%d') if hr_data.training_general_expiry else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>

        <!-- Formazione RSPP - Periodicità: 5 anni -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-hard-hat me-2"></i>Formazione RSPP <small class="text-muted">- Periodicità: 5 anni</small></h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Data Formazione</label>
                <input type="date" name="training_rspp_date" class="form-control" 
                       value="{{ hr_data.training_rspp_date.strftime('%Y-%m-%d') if hr_data.training_rspp_date else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Scadenza</label>
                <input type="date" name="training_rspp_expiry" class="form-control" 
                       value="{{ hr_data.training_rspp_expiry.strftime('%Y-%m-%d') if hr_data.training_rspp_expiry else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>

        <!-- Formazione RLS - Periodicità: ANNUALE -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-users-cog me-2"></i>Formazione RLS <small class="text-muted">- Periodicità: ANNUALE</small></h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Data Formazione</label>
                <input type="date" name="training_rls_date" class="form-control" 
                       value="{{ hr_data.training_rls_date.strftime('%Y-%m-%d') if hr_data.training_rls_date else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Scadenza</label>
                <input type="date" name="training_rls_expiry" class="form-control" 
                       value="{{ hr_data.training_rls_expiry.strftime('%Y-%m-%d') if hr_data.training_rls_expiry else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>

        <!-- Formazione Primo Soccorso - Periodicità: consigliata almeno 3 anni -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-first-aid me-2"></i>Formazione Primo Soccorso <small class="text-muted">- Periodicità: consigliata almeno 3 anni</small></h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Data Formazione</label>
                <input type="date" name="training_first_aid_date" class="form-control" 
                       value="{{ hr_data.training_first_aid_date.strftime('%Y-%m-%d') if hr_data.training_first_aid_date else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Scadenza</label>
                <input type="date" name="training_first_aid_expiry" class="form-control" 
                       value="{{ hr_data.training_first_aid_expiry.strftime('%Y-%m-%d') if hr_data.training_first_aid_expiry else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>

        <!-- Formazione Emergenza - Periodicità: consigliata almeno 3 anni -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-fire-extinguisher me-2"></i>Formazione Emergenza <small class="text-muted">- Periodicità: consigliata almeno 3 anni</small></h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Data Formazione</label>
                <input type="date" name="training_emergency_date" class="form-control" 
                       value="{{ hr_data.training_emergency_date.strftime('%Y-%m-%d') if hr_data.training_emergency_date else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Scadenza</label>
                <input type="date" name="training_emergency_expiry" class="form-control" 
                       value="{{ hr_data.training_emergency_expiry.strftime('%Y-%m-%d') if hr_data.training_emergency_expiry else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>

        <!-- Formazione Preposto - Periodicità: 2 anni -->
        <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-user-tie me-2"></i>Formazione Preposto <small class="text-muted">- Periodicità: 2 anni</small></h6>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Data Formazione</label>
                <input type="date" name="training_supervisor_date" class="form-control" 
                       value="{{ hr_data.training_supervisor_date.strftime('%Y-%m-%d') if hr_data.training_supervisor_date else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Scadenza</label>
                <input type="date" name="training_supervisor_expiry" class="form-control" 
                       value="{{ hr_data.training_supervisor_expiry.strftime('%Y-%m-%d') if hr_data.training_supervisor_expiry else '' }}"
                       {% if not can_edit %}disabled{% endif %}>
            </div>
        </div>
    </div>

</div>

<!-- Pulsanti Azione -->
{% if can_edit %}
<div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
    <a href="{{ url_for('hr.hr_list') }}" class="btn btn-outline-secondary">
        <i class="fas fa-times me-2"></i>Annulla
    </a>
    <button type="submit" class="btn btn-primary" id="saveBtn">
        <i class="fas fa-save me-2"></i>Salva Modifiche
    </button>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const saveBtn = document.getElementById('saveBtn');
    
    if (saveBtn && form) {
        saveBtn.addEventListener('click', function(e) {
            console.log('Pulsante cliccato');
            console.log('Form valido:', form.checkValidity());
            if (!form.checkValidity()) {
                form.reportValidity();
            }
        });
        
        form.addEventListener('submit', function(e) {
            console.log('Form submit triggered');
        });
    }
});
</script>

</form>


<!-- ========================================= -->
<!-- SEZIONE AMMORTIZZATORI SOCIALI (READ-ONLY) -->
<!-- ========================================= -->
{% if current_user.can_view_social_safety_reports() or current_user.can_manage_social_safety_programs() or current_user.can_assign_social_safety_programs() %}
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-shield-alt me-2"></i>AMMORTIZZATORI SOCIALI
            </h5>
            <a href="{{ url_for('social_safety.user_assignments', user_id=user.id) }}" class="btn btn-sm btn-light">
                <i class="fas fa-external-link-alt me-2"></i>Vedi tutti
            </a>
        </div>
    </div>
    <div class="card-body">
        {% if active_safety_net_assignment %}
        <div class="alert alert-warning mb-3">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Assegnazione Attiva:</strong> {{ active_safety_net_assignment.program.name }} 
            ({{ active_safety_net_assignment.program.program_type }}) 
            - Riduzione {{ active_safety_net_assignment.program.reduction_percentage }}%
            dal {{ active_safety_net_assignment.start_date.strftime('%d/%m/%Y') }}
            {% if active_safety_net_assignment.end_date %}
            al {{ active_safety_net_assignment.end_date.strftime('%d/%m/%Y') }}
            {% endif %}
        </div>
        {% endif %}
        
        {% if safety_net_assignments %}
        <h6 class="border-bottom pb-2 mb-3">
            <i class="fas fa-history me-2"></i>Ultime Assegnazioni 
            {% if total_safety_net_assignments > 5 %}
            (mostrando 5 di {{ total_safety_net_assignments }})
            {% endif %}
        </h6>
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Programma</th>
                        <th>Tipo</th>
                        <th>Dal</th>
                        <th>Al</th>
                        <th>Riduzione Ore</th>
                        <th>Stato</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in safety_net_assignments %}
                    <tr {% if assignment == active_safety_net_assignment %}class="table-warning"{% elif assignment.status == 'pending' %}class="table-info"{% endif %}>
                        <td>
                            <strong>{{ assignment.program.name }}</strong>
                            {% if assignment.program.decree_number %}
                            <br><small class="text-muted">Decreto {{ assignment.program.decree_number }}</small>
                            {% endif %}
                            {% if assignment.status == 'pending' %}
                            <br><a href="{{ url_for('social_safety.manage_assignments') }}" class="badge bg-primary text-white text-decoration-none">
                                <i class="fas fa-tasks me-1"></i>Approva qui
                            </a>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ assignment.program.program_type }}</span>
                        </td>
                        <td>{{ assignment.start_date.strftime('%d/%m/%Y') }}</td>
                        <td>
                            {% if assignment.end_date %}
                            {{ assignment.end_date.strftime('%d/%m/%Y') }}
                            {% else %}
                            <em class="text-muted">In corso</em>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-warning text-dark">
                                -{{ assignment.program.reduction_percentage }}%
                            </span>
                        </td>
                        <td>
                            {% if assignment.status == 'pending' %}
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-clock me-1"></i>In Attesa Approvazione
                            </span>
                            {% elif assignment.status in ['approved', 'active'] %}
                            <span class="badge bg-success">
                                <i class="fas fa-check me-1"></i>Approvato
                            </span>
                            {% elif assignment.status == 'completed' %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-check-circle me-1"></i>Completato
                            </span>
                            {% elif assignment.status == 'cancelled' %}
                            <span class="badge bg-danger">
                                <i class="fas fa-times me-1"></i>Annullato
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">{{ assignment.status }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-secondary mb-0">
            <i class="fas fa-info-circle me-2"></i>
            Nessuna assegnazione di ammortizzatori sociali per questo dipendente.
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestione abilitazione campo valore buoni pasto in base al toggle ticket restaurant
    const ticketRestaurantToggle = document.getElementById('ticket_restaurant');
    const mealVouchersValueInput = document.getElementById('meal_vouchers_value');
    
    if (ticketRestaurantToggle && mealVouchersValueInput) {
        ticketRestaurantToggle.addEventListener('change', function() {
            if (this.checked) {
                mealVouchersValueInput.disabled = false;
            } else {
                mealVouchersValueInput.disabled = true;
                mealVouchersValueInput.value = '';
            }
        });
    }
    
    // Gestione visibilità campi nascita in base al paese selezionato
    const birthCountrySelect = document.getElementById('birth_country');
    const birthCityContainer = document.getElementById('birth_city_container');
    const birthProvinceContainer = document.getElementById('birth_province_container');
    
    if (birthCountrySelect && birthCityContainer && birthProvinceContainer) {
        function toggleBirthFields() {
            const isItaly = birthCountrySelect.value === 'Italia';
            birthCityContainer.style.display = isItaly ? 'block' : 'none';
            birthProvinceContainer.style.display = isItaly ? 'block' : 'none';
        }
        
        // Applica al caricamento
        toggleBirthFields();
        
        // Applica al cambio
        birthCountrySelect.addEventListener('change', toggleBirthFields);
    }
    
    // Gestione visibilità campi condizionali per tipo contratto
    const contractTypeSelect = document.getElementById('contract_type');
    const distaccoSupplierField = document.getElementById('distacco_supplier_field');
    const consulenteVatField = document.getElementById('consulente_vat_field');
    const fornitoreNomeField = document.getElementById('fornitore_nome_field');
    const fornitorePivaField = document.getElementById('fornitore_piva_field');
    
    if (contractTypeSelect && distaccoSupplierField && consulenteVatField && fornitoreNomeField && fornitorePivaField) {
        function updateCcnlFieldsRequirement() {
            const contractType = contractTypeSelect.value;
            const exemptTypes = ['In Distacco', 'Consulente/P.IVA', 'Fornitore'];
            const isRequired = !exemptTypes.includes(contractType);
            
            // Gestisci tutti i campi CCNL condizionali
            const ccnlFields = document.querySelectorAll('.ccnl-conditional-required');
            const ccnlFlags = document.querySelectorAll('.ccnl-required-flag');
            
            ccnlFields.forEach(field => {
                if (isRequired) {
                    field.setAttribute('required', 'required');
                } else {
                    field.removeAttribute('required');
                }
            });
            
            ccnlFlags.forEach(flag => {
                flag.style.display = isRequired ? 'inline' : 'none';
            });
        }
        
        contractTypeSelect.addEventListener('change', function() {
            // Nascondi tutti i campi condizionali e azzera i loro valori
            const distaccoInput = distaccoSupplierField.querySelector('input');
            const consulenteInput = consulenteVatField.querySelector('input');
            const fornitoreNomeInput = fornitoreNomeField.querySelector('input');
            const fornitorePivaInput = fornitorePivaField.querySelector('input');
            
            distaccoSupplierField.style.display = 'none';
            consulenteVatField.style.display = 'none';
            fornitoreNomeField.style.display = 'none';
            fornitorePivaField.style.display = 'none';
            if (distaccoInput) distaccoInput.value = '';
            if (consulenteInput) consulenteInput.value = '';
            if (fornitoreNomeInput) fornitoreNomeInput.value = '';
            if (fornitorePivaInput) fornitorePivaInput.value = '';
            
            // Mostra solo il campo appropriato
            if (this.value === 'In Distacco') {
                distaccoSupplierField.style.display = 'block';
            } else if (this.value === 'Consulente/P.IVA') {
                consulenteVatField.style.display = 'block';
            } else if (this.value === 'Fornitore') {
                fornitoreNomeField.style.display = 'block';
                fornitorePivaField.style.display = 'block';
            }
            
            // Aggiorna l'obbligatorietà dei campi CCNL
            updateCcnlFieldsRequirement();
        });
        
        // Applica al caricamento iniziale
        updateCcnlFieldsRequirement();
    }
    
    // Gestione cascading selection veicoli ACI
    const tipoSelect = document.getElementById('tipoVeicoloSelectHR');
    const marcaSelect = document.getElementById('marcaVeicoloSelectHR');
    const modelloSelect = document.getElementById('modelloVeicoloSelectHR');
    
    if (!tipoSelect || !marcaSelect || !modelloSelect) return;
    
    // Salva il veicolo corrente per pre-selezionarlo
    const currentVehicleId = {% if hr_data.aci_vehicle_id %}{{ hr_data.aci_vehicle_id }}{% else %}null{% endif %};
    
    tipoSelect.addEventListener('change', function() {
        const tipo = this.value;
        marcaSelect.disabled = true;
        modelloSelect.disabled = true;
        marcaSelect.innerHTML = '<option value="">Caricamento...</option>';
        modelloSelect.innerHTML = '<option value="">Seleziona prima marca</option>';
        
        if (tipo) {
            fetch(`/aci/api/marcas?tipologia=${encodeURIComponent(tipo)}`)
                .then(response => response.json())
                .then(data => {
                    marcaSelect.innerHTML = '<option value="">Seleziona marca</option>';
                    if (data.success && data.marcas && data.marcas.length > 0) {
                        data.marcas.forEach(marca => {
                            const option = document.createElement('option');
                            option.value = marca;
                            option.textContent = marca;
                            marcaSelect.appendChild(option);
                        });
                        marcaSelect.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error loading marche:', error);
                    marcaSelect.innerHTML = '<option value="">Errore caricamento</option>';
                });
        } else {
            marcaSelect.innerHTML = '<option value="">Seleziona prima il tipo</option>';
            modelloSelect.innerHTML = '<option value="">Seleziona prima marca</option>';
        }
    });
    
    marcaSelect.addEventListener('change', function() {
        const tipo = tipoSelect.value;
        const marca = this.value;
        modelloSelect.disabled = true;
        modelloSelect.innerHTML = '<option value="">Caricamento...</option>';
        
        if (tipo && marca) {
            fetch(`/aci/api/modelos?tipologia=${encodeURIComponent(tipo)}&marca=${encodeURIComponent(marca)}`)
                .then(response => response.json())
                .then(data => {
                    modelloSelect.innerHTML = '<option value="">Seleziona modello</option>';
                    if (data.success && data.modelos && data.modelos.length > 0) {
                        data.modelos.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = `${item.modello} (€${item.costo_km}/km)`;
                            modelloSelect.appendChild(option);
                        });
                        modelloSelect.disabled = false;
                        
                        // Se c'è un veicolo corrente, selezionalo
                        if (currentVehicleId) {
                            modelloSelect.value = currentVehicleId;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading modelli:', error);
                    modelloSelect.innerHTML = '<option value="">Errore caricamento</option>';
                });
        } else {
            modelloSelect.innerHTML = '<option value="">Seleziona prima marca</option>';
        }
    });
    
    // Pre-carica il veicolo selezionato se esiste
    {% if hr_data.aci_vehicle %}
    tipoSelect.value = '{{ hr_data.aci_vehicle.tipologia }}';
    tipoSelect.dispatchEvent(new Event('change'));
    
    // Aspetta che le marche vengano caricate
    setTimeout(() => {
        marcaSelect.value = '{{ hr_data.aci_vehicle.marca }}';
        marcaSelect.dispatchEvent(new Event('change'));
    }, 500);
    {% endif %}
    
    // Gestione visibilità campi straordinari/banca ore
    const overtimeEnabled = document.getElementById('overtime_enabled');
    const overtimeTypeField = document.getElementById('overtimeTypeField');
    const overtimeType = document.getElementById('overtime_type');
    const bancaOreLimiteField = document.getElementById('bancaOreLimiteField');
    const bancaOrePeriodoField = document.getElementById('bancaOrePeriodoField');
    
    function toggleOvertimeFields() {
        if (overtimeEnabled && overtimeEnabled.checked) {
            overtimeTypeField.style.display = 'block';
            toggleBancaOreFields();
        } else {
            overtimeTypeField.style.display = 'none';
            bancaOreLimiteField.style.display = 'none';
            bancaOrePeriodoField.style.display = 'none';
            if (overtimeType) overtimeType.value = '';
        }
    }
    
    function toggleBancaOreFields() {
        if (overtimeEnabled && overtimeEnabled.checked && overtimeType && overtimeType.value === 'Banca Ore') {
            bancaOreLimiteField.style.display = 'block';
            bancaOrePeriodoField.style.display = 'block';
        } else {
            bancaOreLimiteField.style.display = 'none';
            bancaOrePeriodoField.style.display = 'none';
        }
    }
    
    if (overtimeEnabled) {
        overtimeEnabled.addEventListener('change', toggleOvertimeFields);
        toggleOvertimeFields(); // Initialize on load
    }
    
    if (overtimeType) {
        overtimeType.addEventListener('change', toggleBancaOreFields);
    }
    
    // === CCNL Cascading Dropdowns Management ===
    const ccnlSelect = document.getElementById('ccnl_contract_id');
    const qualificaSelect = document.getElementById('ccnl_qualification_id');
    const livelloSelect = document.getElementById('ccnl_level_id');

    // Hidden inputs per legacy fields (dual-write strategy)
    const ccnlLegacy = document.querySelector('input[name="ccnl"]');
    const qualificaLegacy = document.querySelector('input[name="qualifica"]');
    const livelloLegacy = document.querySelector('input[name="ccnl_level"]');

    if (ccnlSelect && qualificaSelect && livelloSelect) {
        // Helper: mostra errori in Bootstrap alert
        function showCcnlError(message) {
            const flashContainer = document.querySelector('.flash-messages') || document.querySelector('.container-fluid');
            if (flashContainer) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show';
                alert.innerHTML = `
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    <i class="fas fa-exclamation-triangle me-2"></i>${message}
                `;
                flashContainer.insertBefore(alert, flashContainer.firstChild);
            }
        }

        // Event: CCNL cambiato -> carica qualifiche
        ccnlSelect.addEventListener('change', async function() {
            const ccnlId = this.value;
            const selectedOption = this.options[this.selectedIndex];
            
            // Reset dependent dropdowns
            qualificaSelect.innerHTML = '<option value="">Seleziona qualifica...</option>';
            livelloSelect.innerHTML = '<option value="">Prima seleziona Qualifica...</option>';
            qualificaSelect.disabled = true;
            livelloSelect.disabled = true;
            
            // Clear legacy fields
            if (qualificaLegacy) qualificaLegacy.value = '';
            if (livelloLegacy) livelloLegacy.value = '';
            
            // Update CCNL legacy field con label selezionata
            if (ccnlLegacy) ccnlLegacy.value = ccnlId ? selectedOption.textContent : '';
            
            if (!ccnlId) return;
            
            // Loading state
            qualificaSelect.innerHTML = '<option value="">Caricamento...</option>';
            
            try {
                const response = await fetch(`/api/ccnl/${ccnlId}/qualifications`);
                if (!response.ok) throw new Error('API error');
                
                const qualifications = await response.json();
                
                // Populate
                qualificaSelect.innerHTML = '<option value="">Seleziona qualifica...</option>';
                qualifications.forEach(q => {
                    const option = document.createElement('option');
                    option.value = q.id;
                    option.textContent = q.nome;
                    qualificaSelect.appendChild(option);
                });
                
                qualificaSelect.disabled = false;
                
            } catch (error) {
                console.error('Error loading qualifications:', error);
                showCcnlError('Errore nel caricamento delle qualifiche. Riprova.');
                qualificaSelect.innerHTML = '<option value="">Errore nel caricamento</option>';
            }
        });

        // Event: Qualifica cambiata -> carica livelli
        qualificaSelect.addEventListener('change', async function() {
            const qualificaId = this.value;
            const selectedOption = this.options[this.selectedIndex];
            
            // Reset dependent
            livelloSelect.innerHTML = '<option value="">Prima seleziona Qualifica...</option>';
            livelloSelect.disabled = true;
            
            // Clear legacy
            if (livelloLegacy) livelloLegacy.value = '';
            
            // Update Qualifica legacy field
            if (qualificaLegacy) qualificaLegacy.value = qualificaId ? selectedOption.textContent : '';
            
            if (!qualificaId) return;
            
            // Loading state
            livelloSelect.innerHTML = '<option value="">Caricamento...</option>';
            
            try {
                const response = await fetch(`/api/qualifications/${qualificaId}/levels`);
                if (!response.ok) throw new Error('API error');
                
                const levels = await response.json();
                
                // Populate
                livelloSelect.innerHTML = '<option value="">Seleziona livello...</option>';
                levels.forEach(l => {
                    const option = document.createElement('option');
                    option.value = l.id;
                    option.textContent = l.descrizione ? `${l.codice} (${l.descrizione})` : l.codice;
                    livelloSelect.appendChild(option);
                });
                
                livelloSelect.disabled = false;
                
            } catch (error) {
                console.error('Error loading levels:', error);
                showCcnlError('Errore nel caricamento dei livelli. Riprova.');
                livelloSelect.innerHTML = '<option value="">Errore nel caricamento</option>';
            }
        });

        // Event: Livello cambiato -> aggiorna legacy field
        livelloSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (livelloLegacy) livelloLegacy.value = this.value ? selectedOption.textContent : '';
        });

        // === Initial load: pre-populate se FK esistenti ===
        const currentCcnlId = {{ hr_data.ccnl_contract_id | tojson }};
        const currentQualificationId = {{ hr_data.ccnl_qualification_id | tojson }};
        const currentLevelId = {{ hr_data.ccnl_level_id | tojson }};
        
        async function initializeCcnlDropdowns() {
            if (!currentCcnlId) return;
            
            try {
                // Carica qualifiche per CCNL corrente
                const qualResponse = await fetch(`/api/ccnl/${currentCcnlId}/qualifications`);
                if (!qualResponse.ok) throw new Error('API error');
                const qualifications = await qualResponse.json();
                
                qualificaSelect.innerHTML = '<option value="">Seleziona qualifica...</option>';
                qualifications.forEach(q => {
                    const option = document.createElement('option');
                    option.value = q.id;
                    option.textContent = q.nome;
                    if (q.id == currentQualificationId) option.selected = true;
                    qualificaSelect.appendChild(option);
                });
                qualificaSelect.disabled = false;
                
                // Se qualifica selezionata, carica livelli
                if (currentQualificationId) {
                    const levelResponse = await fetch(`/api/qualifications/${currentQualificationId}/levels`);
                    if (!levelResponse.ok) throw new Error('API error');
                    const levels = await levelResponse.json();
                    
                    livelloSelect.innerHTML = '<option value="">Seleziona livello...</option>';
                    levels.forEach(l => {
                        const option = document.createElement('option');
                        option.value = l.id;
                        option.textContent = l.descrizione ? `${l.codice} (${l.descrizione})` : l.codice;
                        if (l.id == currentLevelId) option.selected = true;
                        livelloSelect.appendChild(option);
                    });
                    livelloSelect.disabled = false;
                }
                
            } catch (error) {
                console.error('Error initializing dropdowns:', error);
                showCcnlError('Errore inizializzazione campi CCNL. Ricarica la pagina.');
            }
        }
        
        // Run initialization
        initializeCcnlDropdowns();
    }
    
    // ========================================
    // GESTIONE TOGGLE ORE/GIORNI FERIE
    // ========================================
    const ferieUnitSelect = document.getElementById('ferieUnitSelect');
    const ferieDailyHoursField = document.getElementById('ferieDailyHoursField');
    const ferieMaturateInput = document.getElementById('ferieMaturateInput');
    const ferieMaturateLabel = document.getElementById('ferieMaturateLabel');
    const ferieMaturateUnit = document.getElementById('ferieMaturateUnit');
    const ferieMaturateHelp = document.getElementById('ferieMaturateHelp');
    
    function updateFerieFields() {
        const selectedUnit = ferieUnitSelect ? ferieUnitSelect.value : 'hours';
        
        if (selectedUnit === 'days') {
            // Mostra campo ore giornaliere
            if (ferieDailyHoursField) ferieDailyHoursField.style.display = 'block';
            
            // Aggiorna label e unità
            if (ferieMaturateLabel) ferieMaturateLabel.textContent = 'Giorni Ferie Maturati al Mese';
            if (ferieMaturateUnit) ferieMaturateUnit.textContent = 'gg/mese';
            if (ferieMaturateHelp) ferieMaturateHelp.textContent = 'Es: 2.33 giorni/mese = 28 giorni/anno. Max 5 giorni/mese.';
            if (ferieMaturateInput) {
                ferieMaturateInput.placeholder = '2.33';
                ferieMaturateInput.setAttribute('data-max', '5');
            }
        } else {
            // Nascondi campo ore giornaliere
            if (ferieDailyHoursField) ferieDailyHoursField.style.display = 'none';
            
            // Aggiorna label e unità
            if (ferieMaturateLabel) ferieMaturateLabel.textContent = 'Ore Ferie Maturate al Mese';
            if (ferieMaturateUnit) ferieMaturateUnit.textContent = 'h/mese';
            if (ferieMaturateHelp) ferieMaturateHelp.textContent = 'Es: 18.66 ore/mese = 224 ore/anno (28 giorni x 8 ore)';
            if (ferieMaturateInput) {
                ferieMaturateInput.placeholder = '18.66';
                ferieMaturateInput.removeAttribute('data-max');
            }
        }
    }
    
    // Event listener per il cambio di unità
    if (ferieUnitSelect) {
        ferieUnitSelect.addEventListener('change', updateFerieFields);
        // Inizializza al caricamento
        updateFerieFields();
    }
});
</script>
{% endblock %}
