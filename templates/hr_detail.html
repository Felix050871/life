{% extends "base.html" %}

{% block title %}Scheda HR - {{ user.get_full_name() }} - Life Platform{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
        <i class="fas fa-id-card me-2"></i>
        Scheda HR - {{ user.get_full_name() }}
    </h1>
    <a href="{{ url_for('hr.hr_list') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Torna alla Lista
    </a>
</div>

<form method="POST" action="{{ url_for('hr.hr_detail', user_id=user.id) }}">
    
    <!-- ========================================= -->
    <!-- SEZIONE 1: DATI CONTRATTUALI -->
    <!-- ========================================= -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-file-contract me-2"></i>DATI CONTRATTUALI
            </h5>
        </div>
        <div class="card-body">
            <!-- Riga 1: Matricola, Tipo Contratto, Data Assunzione, Data Fine -->
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">Matricola (COD SI)</label>
                    <input type="text" name="matricola" class="form-control" 
                           value="{{ hr_data.matricola or '' }}" 
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Tipologia Contratto</label>
                    <select name="contract_type" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        <option value="Tempo Indeterminato" {% if hr_data.contract_type == 'Tempo Indeterminato' %}selected{% endif %}>Tempo Indeterminato</option>
                        <option value="Tempo Determinato" {% if hr_data.contract_type == 'Tempo Determinato' %}selected{% endif %}>Tempo Determinato</option>
                        <option value="Apprendistato" {% if hr_data.contract_type == 'Apprendistato' %}selected{% endif %}>Apprendistato</option>
                        <option value="Stage/Tirocinio" {% if hr_data.contract_type == 'Stage/Tirocinio' %}selected{% endif %}>Stage/Tirocinio</option>
                        <option value="Collaborazione" {% if hr_data.contract_type == 'Collaborazione' %}selected{% endif %}>Collaborazione</option>
                        <option value="Altro" {% if hr_data.contract_type == 'Altro' %}selected{% endif %}>Altro</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Data Assunzione</label>
                    <input type="date" name="hire_date" class="form-control" 
                           value="{{ hr_data.hire_date.strftime('%Y-%m-%d') if hr_data.hire_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Data Fine Rapporto</label>
                    <input type="date" name="contract_end_date" class="form-control" 
                           value="{{ hr_data.contract_end_date.strftime('%Y-%m-%d') if hr_data.contract_end_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Riga 2: CCNL, Mansione, Qualifica, Livello -->
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">CCNL</label>
                    <input type="text" name="ccnl" class="form-control" 
                           value="{{ hr_data.ccnl or '' }}"
                           placeholder="es. Commercio, Metalmeccanico"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Mansione</label>
                    <input type="text" name="mansione" class="form-control" 
                           value="{{ hr_data.mansione or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Qualifica</label>
                    <input type="text" name="qualifica" class="form-control" 
                           value="{{ hr_data.qualifica or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Livello</label>
                    <input type="text" name="ccnl_level" class="form-control" 
                           value="{{ hr_data.ccnl_level or '' }}"
                           placeholder="es. D2, 3° livello"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Riga 3: Orario, Sede di Assunzione, Cliente, Tipo Assunzione -->
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Orario (h/sett.)</label>
                    <input type="number" step="0.1" name="work_hours_week" class="form-control" 
                           value="{{ hr_data.work_hours_week or '' }}"
                           placeholder="40"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Sede di Assunzione</label>
                    <select name="sede_id" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Nessuna</option>
                        {% for sede in user.company.sedi %}
                        <option value="{{ sede.id }}" {% if hr_data.sede_id == sede.id %}selected{% endif %}>
                            {{ sede.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Sede indicata nel contratto di assunzione</small>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Cliente</label>
                    <input type="text" name="cliente" class="form-control" 
                           value="{{ hr_data.cliente or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Tipo di Assunzione</label>
                    <input type="text" name="tipo_assunzione" class="form-control" 
                           value="{{ hr_data.tipo_assunzione or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Riga 4: Superminimo, Rimborsi, Ticket Restaurant, Rischio INAIL -->
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Superminimo / SM Assorbibile (€)</label>
                    <input type="number" step="0.01" name="superminimo" class="form-control" 
                           value="{{ hr_data.superminimo or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Rimborsi / Diarie (€)</label>
                    <input type="number" step="0.01" name="rimborsi_diarie" class="form-control" 
                           value="{{ hr_data.rimborsi_diarie or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Ticket Restaurant</label>
                    <div class="form-check form-switch mt-2">
                        <input type="checkbox" name="ticket_restaurant" class="form-check-input" 
                               {% if hr_data.ticket_restaurant %}checked{% endif %}
                               {% if not can_edit %}disabled{% endif %}>
                        <label class="form-check-label">Ha ticket restaurant</label>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Rischio INAIL</label>
                    <input type="text" name="rischio_inail" class="form-control" 
                           value="{{ hr_data.rischio_inail or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Note Contratto -->
            <div class="row">
                <div class="col-12 mb-3">
                    <label class="form-label">Altro / Note Contrattuali</label>
                    <textarea name="other_notes" class="form-control" rows="2"
                              {% if not can_edit %}disabled{% endif %}>{{ hr_data.other_notes or '' }}</textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- SEZIONE 2: ANAGRAFICA RISORSA -->
    <!-- ========================================= -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-user me-2"></i>ANAGRAFICA RISORSA
            </h5>
        </div>
        <div class="card-body">
            <!-- Dati Personali -->
            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-id-badge me-2"></i>Dati Personali</h6>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Codice Fiscale</label>
                    <input type="text" name="codice_fiscale" class="form-control text-uppercase" 
                           value="{{ hr_data.codice_fiscale or '' }}" 
                           maxlength="16"
                           disabled
                           title="Il codice fiscale viene calcolato automaticamente dai dati anagrafici">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Data di Nascita</label>
                    <input type="date" name="birth_date" class="form-control" 
                           value="{{ hr_data.birth_date.strftime('%Y-%m-%d') if hr_data.birth_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">Età</label>
                    <input type="text" class="form-control" 
                           value="{% if hr_data.get_age() %}{{ hr_data.get_age() }} anni{% endif %}" disabled>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Sesso</label>
                    <select name="gender" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        <option value="M" {% if hr_data.gender == 'M' %}selected{% endif %}>Maschile</option>
                        <option value="F" {% if hr_data.gender == 'F' %}selected{% endif %}>Femminile</option>
                        <option value="A" {% if hr_data.gender == 'A' %}selected{% endif %}>Altro</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-5 mb-3">
                    <label class="form-label">Luogo di Nascita</label>
                    <input type="text" name="birth_city" class="form-control" 
                           value="{{ hr_data.birth_city or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">Provincia</label>
                    <input type="text" name="birth_province" class="form-control text-uppercase" 
                           value="{{ hr_data.birth_province or '' }}" 
                           maxlength="2"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-5 mb-3">
                    <label class="form-label">Paese di Nascita</label>
                    <input type="text" name="birth_country" class="form-control" 
                           value="{{ hr_data.birth_country or 'Italia' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Residenza -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-home me-2"></i>Residenza</h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Indirizzo (Comune di Residenza)</label>
                    <input type="text" name="address" class="form-control" 
                           value="{{ hr_data.address or '' }}"
                           placeholder="Via/Piazza, Numero"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Città</label>
                    <input type="text" name="city" class="form-control" 
                           value="{{ hr_data.city or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">CAP</label>
                    <input type="text" name="postal_code" class="form-control" 
                           value="{{ hr_data.postal_code or '' }}"
                           maxlength="5"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Domicilio (se diverso dalla residenza)</label>
                    <input type="text" name="alternative_domicile" class="form-control" 
                           value="{{ hr_data.alternative_domicile or '' }}"
                           placeholder="Indirizzo completo"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Contatti -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-phone me-2"></i>Contatti</h6>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Recapito Telefonico</label>
                    <input type="tel" name="phone" class="form-control" 
                           value="{{ hr_data.phone or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">E-mail Personale</label>
                    <input type="email" name="personal_email" class="form-control" 
                           value="{{ hr_data.personal_email or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">E-mail Aziendale</label>
                    <input type="email" class="form-control" value="{{ user.email }}" disabled>
                </div>
            </div>

            <!-- Titolo di Studio -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-graduation-cap me-2"></i>Formazione</h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Titolo di Studio</label>
                    <select name="education_level" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        <option value="Licenza Media" {% if hr_data.education_level == 'Licenza Media' %}selected{% endif %}>Licenza Media</option>
                        <option value="Diploma" {% if hr_data.education_level == 'Diploma' %}selected{% endif %}>Diploma</option>
                        <option value="Laurea Triennale" {% if hr_data.education_level == 'Laurea Triennale' %}selected{% endif %}>Laurea Triennale</option>
                        <option value="Laurea Magistrale" {% if hr_data.education_level == 'Laurea Magistrale' %}selected{% endif %}>Laurea Magistrale</option>
                        <option value="Master" {% if hr_data.education_level == 'Master' %}selected{% endif %}>Master</option>
                        <option value="Dottorato" {% if hr_data.education_level == 'Dottorato' %}selected{% endif %}>Dottorato</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Campo di Studio</label>
                    <input type="text" name="education_field" class="form-control" 
                           value="{{ hr_data.education_field or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Altri Dati Personali -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-info-circle me-2"></i>Altri Dati</h6>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Stato Civile</label>
                    <select name="marital_status" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        <option value="Celibe/Nubile" {% if hr_data.marital_status == 'Celibe/Nubile' %}selected{% endif %}>Celibe/Nubile</option>
                        <option value="Coniugato/a" {% if hr_data.marital_status == 'Coniugato/a' %}selected{% endif %}>Coniugato/a</option>
                        <option value="Divorziato/a" {% if hr_data.marital_status == 'Divorziato/a' %}selected{% endif %}>Divorziato/a</option>
                        <option value="Vedovo/a" {% if hr_data.marital_status == 'Vedovo/a' %}selected{% endif %}>Vedovo/a</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Familiari a Carico</label>
                    <input type="number" name="dependents_number" class="form-control" 
                           value="{{ hr_data.dependents_number or '' }}"
                           min="0"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Fruizione Permessi L. 104/92</label>
                    <div class="form-check form-switch mt-2">
                        <input type="checkbox" name="law_104_benefits" class="form-check-input" 
                               {% if hr_data.law_104_benefits %}checked{% endif %}
                               {% if not can_edit %}disabled{% endif %}>
                        <label class="form-check-label">Usufruisce L. 104/92</label>
                    </div>
                </div>
            </div>

            <!-- Contatto di Emergenza -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-phone-volume me-2"></i>Contatto di Emergenza</h6>
            <div class="row">
                <div class="col-md-5 mb-3">
                    <label class="form-label">Nome Contatto</label>
                    <input type="text" name="emergency_contact_name" class="form-control" 
                           value="{{ hr_data.emergency_contact_name or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Telefono Emergenza</label>
                    <input type="tel" name="emergency_contact_phone" class="form-control" 
                           value="{{ hr_data.emergency_contact_phone or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Relazione</label>
                    <input type="text" name="emergency_contact_relation" class="form-control" 
                           value="{{ hr_data.emergency_contact_relation or '' }}"
                           placeholder="es. Coniuge, Genitore"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Patente di Guida -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-id-card me-2"></i>Patente di Guida</h6>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Numero Patente</label>
                    <input type="text" name="driver_license_number" class="form-control" 
                           value="{{ hr_data.driver_license_number or '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo Patente</label>
                    <input type="text" name="driver_license_type" class="form-control" 
                           value="{{ hr_data.driver_license_type or '' }}"
                           placeholder="es. B, C, D, BE"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Scadenza Patente</label>
                    <input type="date" name="driver_license_expiry" class="form-control" 
                           value="{{ hr_data.driver_license_expiry.strftime('%Y-%m-%d') if hr_data.driver_license_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Veicolo ACI - Selezione a cascata -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-car me-2"></i>Veicolo ACI (Rimborsi Chilometrici)</h6>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Tipo Veicolo</label>
                    <select id="tipoVeicoloSelectHR" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona tipo</option>
                        {% set tipi = [] %}
                        {% for vehicle in aci_vehicles %}
                            {% if vehicle.tipologia not in tipi %}
                                {% set _ = tipi.append(vehicle.tipologia) %}
                            {% endif %}
                        {% endfor %}
                        {% for tipo in tipi|sort %}
                        <option value="{{ tipo }}">{{ tipo }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Tipo di veicolo (es. Autovettura, Motociclo)</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Marca</label>
                    <select id="marcaVeicoloSelectHR" class="form-select" disabled>
                        <option value="">Seleziona prima il tipo</option>
                    </select>
                    <small class="text-muted">Marca del veicolo</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Modello e Costo/km</label>
                    <select name="aci_vehicle_id" id="modelloVeicoloSelectHR" class="form-select" disabled>
                        <option value="">Seleziona prima la marca</option>
                    </select>
                    <small class="text-muted">Modello specifico con costo chilometrico</small>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- SEZIONE 3: VISITE E FORMAZIONE -->
    <!-- ========================================= -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="card-title mb-0">
                <i class="fas fa-clipboard-check me-2"></i>VISITE MEDICHE E FORMAZIONE OBBLIGATORIA
            </h5>
        </div>
        <div class="card-body">
            <!-- Requisiti Minimi -->
            <div class="row mb-4">
                <div class="col-md-12 mb-3">
                    <label class="form-label fw-bold">Possesso Requisiti Minimi</label>
                    <select name="minimum_requirements" class="form-select" {% if not can_edit %}disabled{% endif %}>
                        <option value="">Seleziona...</option>
                        <option value="SI" {% if hr_data.minimum_requirements == 'SI' %}selected{% endif %}>SI</option>
                        <option value="NO" {% if hr_data.minimum_requirements == 'NO' %}selected{% endif %}>NO</option>
                        <option value="DA FORMARE" {% if hr_data.minimum_requirements == 'DA FORMARE' %}selected{% endif %}>DA FORMARE</option>
                    </select>
                </div>
            </div>

            <!-- Visita Medica -->
            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-stethoscope me-2"></i>Visita Medica</h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Ultima Visita</label>
                    <input type="date" name="medical_visit_date" class="form-control" 
                           value="{{ hr_data.medical_visit_date.strftime('%Y-%m-%d') if hr_data.medical_visit_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza Visita</label>
                    <input type="date" name="medical_visit_expiry" class="form-control" 
                           value="{{ hr_data.medical_visit_expiry.strftime('%Y-%m-%d') if hr_data.medical_visit_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Formazione Generale (Art. 36-37) - Periodicità: 5 anni -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-book-open me-2"></i>Formazione e Informazione (Artt. 36 e 37) <small class="text-muted">- Periodicità: 5 anni</small></h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Formazione</label>
                    <input type="date" name="training_general_date" class="form-control" 
                           value="{{ hr_data.training_general_date.strftime('%Y-%m-%d') if hr_data.training_general_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza</label>
                    <input type="date" name="training_general_expiry" class="form-control" 
                           value="{{ hr_data.training_general_expiry.strftime('%Y-%m-%d') if hr_data.training_general_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Formazione RSPP - Periodicità: 5 anni -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-hard-hat me-2"></i>Formazione RSPP <small class="text-muted">- Periodicità: 5 anni</small></h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Formazione</label>
                    <input type="date" name="training_rspp_date" class="form-control" 
                           value="{{ hr_data.training_rspp_date.strftime('%Y-%m-%d') if hr_data.training_rspp_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza</label>
                    <input type="date" name="training_rspp_expiry" class="form-control" 
                           value="{{ hr_data.training_rspp_expiry.strftime('%Y-%m-%d') if hr_data.training_rspp_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Formazione RLS - Periodicità: ANNUALE -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-users-cog me-2"></i>Formazione RLS <small class="text-muted">- Periodicità: ANNUALE</small></h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Formazione</label>
                    <input type="date" name="training_rls_date" class="form-control" 
                           value="{{ hr_data.training_rls_date.strftime('%Y-%m-%d') if hr_data.training_rls_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza</label>
                    <input type="date" name="training_rls_expiry" class="form-control" 
                           value="{{ hr_data.training_rls_expiry.strftime('%Y-%m-%d') if hr_data.training_rls_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Formazione Primo Soccorso - Periodicità: consigliata almeno 3 anni -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-first-aid me-2"></i>Formazione Primo Soccorso <small class="text-muted">- Periodicità: consigliata almeno 3 anni</small></h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Formazione</label>
                    <input type="date" name="training_first_aid_date" class="form-control" 
                           value="{{ hr_data.training_first_aid_date.strftime('%Y-%m-%d') if hr_data.training_first_aid_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza</label>
                    <input type="date" name="training_first_aid_expiry" class="form-control" 
                           value="{{ hr_data.training_first_aid_expiry.strftime('%Y-%m-%d') if hr_data.training_first_aid_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Formazione Emergenza - Periodicità: consigliata almeno 3 anni -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-fire-extinguisher me-2"></i>Formazione Emergenza <small class="text-muted">- Periodicità: consigliata almeno 3 anni</small></h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Formazione</label>
                    <input type="date" name="training_emergency_date" class="form-control" 
                           value="{{ hr_data.training_emergency_date.strftime('%Y-%m-%d') if hr_data.training_emergency_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza</label>
                    <input type="date" name="training_emergency_expiry" class="form-control" 
                           value="{{ hr_data.training_emergency_expiry.strftime('%Y-%m-%d') if hr_data.training_emergency_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>

            <!-- Formazione Preposto - Periodicità: 2 anni -->
            <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-user-tie me-2"></i>Formazione Preposto <small class="text-muted">- Periodicità: 2 anni</small></h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Data Formazione</label>
                    <input type="date" name="training_supervisor_date" class="form-control" 
                           value="{{ hr_data.training_supervisor_date.strftime('%Y-%m-%d') if hr_data.training_supervisor_date else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Scadenza</label>
                    <input type="date" name="training_supervisor_expiry" class="form-control" 
                           value="{{ hr_data.training_supervisor_expiry.strftime('%Y-%m-%d') if hr_data.training_supervisor_expiry else '' }}"
                           {% if not can_edit %}disabled{% endif %}>
                </div>
            </div>
        </div>
    </div>

    <!-- Pulsanti Azione -->
    {% if can_edit %}
    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
        <a href="{{ url_for('hr.hr_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-times me-2"></i>Annulla
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Salva Modifiche
        </button>
    </div>
    {% endif %}
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoSelect = document.getElementById('tipoVeicoloSelectHR');
    const marcaSelect = document.getElementById('marcaVeicoloSelectHR');
    const modelloSelect = document.getElementById('modelloVeicoloSelectHR');
    
    if (!tipoSelect || !marcaSelect || !modelloSelect) return;
    
    // Salva il veicolo corrente per pre-selezionarlo
    const currentVehicleId = {{ hr_data.aci_vehicle_id|default('null') }};
    
    tipoSelect.addEventListener('change', function() {
        const tipo = this.value;
        marcaSelect.disabled = true;
        modelloSelect.disabled = true;
        marcaSelect.innerHTML = '<option value="">Caricamento...</option>';
        modelloSelect.innerHTML = '<option value="">Seleziona prima marca</option>';
        
        if (tipo) {
            fetch(`/api/aci/marche/${encodeURIComponent(tipo)}`)
                .then(response => response.json())
                .then(data => {
                    marcaSelect.innerHTML = '<option value="">Seleziona marca</option>';
                    if (data.success && data.marche.length > 0) {
                        data.marche.forEach(marca => {
                            const option = document.createElement('option');
                            option.value = marca[0];
                            option.textContent = marca[1];
                            marcaSelect.appendChild(option);
                        });
                        marcaSelect.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error loading marche:', error);
                    marcaSelect.innerHTML = '<option value="">Errore caricamento</option>';
                });
        } else {
            marcaSelect.innerHTML = '<option value="">Seleziona prima il tipo</option>';
            modelloSelect.innerHTML = '<option value="">Seleziona prima marca</option>';
        }
    });
    
    marcaSelect.addEventListener('change', function() {
        const tipo = tipoSelect.value;
        const marca = this.value;
        modelloSelect.disabled = true;
        modelloSelect.innerHTML = '<option value="">Caricamento...</option>';
        
        if (tipo && marca) {
            fetch(`/api/aci/modelli/${encodeURIComponent(tipo)}/${encodeURIComponent(marca)}`)
                .then(response => response.json())
                .then(data => {
                    modelloSelect.innerHTML = '<option value="">Seleziona modello</option>';
                    if (data.success && data.modelli.length > 0) {
                        data.modelli.forEach(modello => {
                            const option = document.createElement('option');
                            option.value = modello[0];
                            option.textContent = modello[1];
                            modelloSelect.appendChild(option);
                        });
                        modelloSelect.disabled = false;
                        
                        // Se c'è un veicolo corrente, selezionalo
                        if (currentVehicleId) {
                            modelloSelect.value = currentVehicleId;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading modelli:', error);
                    modelloSelect.innerHTML = '<option value="">Errore caricamento</option>';
                });
        } else {
            modelloSelect.innerHTML = '<option value="">Seleziona prima marca</option>';
        }
    });
    
    // Pre-carica il veicolo selezionato se esiste
    {% if hr_data.aci_vehicle %}
    tipoSelect.value = '{{ hr_data.aci_vehicle.tipologia }}';
    tipoSelect.dispatchEvent(new Event('change'));
    
    // Aspetta che le marche vengano caricate
    setTimeout(() => {
        marcaSelect.value = '{{ hr_data.aci_vehicle.marca }}';
        marcaSelect.dispatchEvent(new Event('change'));
    }, 500);
    {% endif %}
});
</script>
{% endblock %}
