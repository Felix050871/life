{% extends "base.html" %}

{% block title %}Dashboard - Gestione Presenze{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
        <p class="text-muted">Benvenuto, {{ current_user.get_full_name() }} ({{ current_user.role }})</p>
    </div>
</div>

<!-- Dashboard Widgets Grid -->
<div class="row">
    <!-- Widget: Le Mie Presenze (Gestione Entrata/Uscita/Pausa) -->
    {% if current_user.can_view_my_attendance_widget() %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="fas fa-calendar-day me-2"></i>Le Mie Presenze</h5>
                <small class="text-muted">{{ today_date.strftime('%d/%m/%Y') if today_date else '' }}</small>
            </div>
            <div class="card-body">
                <!-- Today's Status -->
                <div class="alert alert-info mb-4">
                    <h6><i class="fas fa-calendar-day me-1"></i>Stato di Oggi - {{ today_date.strftime('%d/%m/%Y') if today_date else '' }}</h6>
                    <div class="row">
                        <div class="col-6">
                            <strong>Stato Attuale:</strong> 
                            {% if user_status == 'out' %}
                                <span class="badge bg-secondary">Non presente</span>
                            {% elif user_status == 'in' %}
                                <span class="badge bg-success">Presente</span>
                            {% elif user_status == 'break' %}
                                <span class="badge bg-warning">In Pausa</span>
                            {% endif %}
                        </div>
                        <div class="col-6">
                            <strong>Ore Lavorate:</strong> {{ format_hours(today_work_hours) if today_work_hours else '0h 00\'' }}
                        </div>
                    </div>
                    
                    {% if today_events %}
                    <div class="mt-3">
                        <strong>Eventi di Oggi:</strong>
                        <div class="row mt-2">
                            {% for event in today_events %}
                            <div class="col-6 col-md-3 mb-1">
                                <span class="badge w-100
                                    {% if event.event_type == 'clock_in' %}bg-success
                                    {% elif event.event_type == 'clock_out' %}bg-danger
                                    {% elif event.event_type == 'break_start' %}bg-warning text-dark
                                    {% elif event.event_type == 'break_end' %}bg-info
                                    {% endif %}">
                                    {% if event.event_type == 'clock_in' %}Entrata
                                    {% elif event.event_type == 'clock_out' %}Uscita
                                    {% elif event.event_type == 'break_start' %}Pausa
                                    {% elif event.event_type == 'break_end' %}Ripresa
                                    {% endif %}
                                    {{ event.timestamp|format_time_italian }}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="mt-2">
                        <p class="mb-0 text-dark">Nessuna registrazione per oggi. Clicca "Entrata" per iniziare.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Action Buttons -->
                <div class="text-center">
                    <div class="row mb-3">
                        <div class="col-6 col-md-3 mb-2">
                            {% if user_status == 'out' %}
                            <button type="button" class="btn btn-success w-100" onclick="handleClockIn()">
                                <i class="fas fa-play me-1"></i>Entrata
                            </button>
                            {% else %}
                            <button type="button" class="btn btn-outline-success w-100" disabled>
                                <i class="fas fa-play me-1"></i>Entrata
                            </button>
                            {% endif %}
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            {% if user_status == 'in' %}
                            <button type="button" class="btn btn-danger w-100" onclick="handleClockOut()">
                                <i class="fas fa-stop me-1"></i>Uscita
                            </button>
                            {% else %}
                            <button type="button" class="btn btn-outline-danger w-100" disabled>
                                <i class="fas fa-stop me-1"></i>Uscita
                            </button>
                            {% endif %}
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            {% if user_status == 'in' %}
                            <button type="button" class="btn btn-warning w-100" onclick="handleBreakStart()">
                                <i class="fas fa-pause me-1"></i>Pausa
                            </button>
                            {% else %}
                            <button type="button" class="btn btn-outline-warning w-100" disabled>
                                <i class="fas fa-pause me-1"></i>Pausa
                            </button>
                            {% endif %}
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            {% if user_status == 'break' %}
                            <button type="button" class="btn btn-info w-100" onclick="handleBreakEnd()">
                                <i class="fas fa-play me-1"></i>Ripresa
                            </button>
                            {% else %}
                            <button type="button" class="btn btn-outline-info w-100" disabled>
                                <i class="fas fa-play me-1"></i>Ripresa
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- General Intervention Buttons -->
                    <div class="row mb-3">
                        <div class="col-6 mb-2">
                            {% if user_status == 'in' and not active_general_intervention %}
                            <button type="button" class="btn btn-secondary w-100" onclick="showInterventionModal()">
                                <i class="fas fa-tools me-1"></i>Inizia Intervento
                            </button>
                            {% elif active_general_intervention %}
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="showEndGeneralInterventionModal()">
                                <i class="fas fa-stop me-1"></i>Termina Intervento
                            </button>
                            {% else %}
                            <button type="button" class="btn btn-outline-secondary w-100" disabled title="Devi essere presente per iniziare un intervento">
                                <i class="fas fa-tools me-1"></i>Inizia Intervento
                            </button>
                            {% endif %}
                        </div>
                        <div class="col-6 mb-2">
                            {% if active_general_intervention %}
                            <div class="alert alert-info py-2 px-3 mb-0">
                                <i class="fas fa-play me-1"></i>
                                <strong>Intervento in corso</strong><br>
                                <small>Iniziato: {{ active_general_intervention.start_datetime.strftime('%H:%M') }}</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Current Time Display -->
                    <div class="alert alert-secondary p-2">
                        <i class="fas fa-clock me-1"></i>
                        <span id="current-time"></span>
                    </div>
                    
                    <!-- Notes Section -->
                    <form method="POST" action="{{ url_for('attendance') }}" class="mt-3">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label for="notes" class="form-label">Note</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Note aggiuntive (opzionali)"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Salva Note
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Widget: Statistiche Team -->
    {% if current_user.can_view_team_stats_widget() and team_stats %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="fas fa-users me-2"></i>Statistiche Team</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    {% for role_name, count in team_stats.user_counts_by_role.items() %}
                    <div class="col-6 mb-2">
                        <div class="badge 
                            {% if role_name == 'Amministratore' %}bg-danger
                            {% elif role_name == 'Responsabile' %}bg-primary
                            {% elif role_name == 'Supervisore' %}bg-warning text-dark
                            {% elif role_name == 'Operatore' %}bg-info
                            {% else %}bg-secondary
                            {% endif %} w-100 p-2">
                            {{ count }} {{ role_name }}{{ 's' if count != 1 else '' }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <hr>
                <small class="text-muted">
                    <i class="fas fa-chart-bar me-1"></i>Totale: {{ team_stats.total_users }} utenti attivi
                </small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Widget: Gestione Team -->
    {% if current_user.can_view_team_management_widget() and team_management_data %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-user-cog me-2"></i>Gestione Team</h5>
                <a href="{{ url_for('user_management') }}" class="btn btn-sm btn-outline-primary">Gestisci</a>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="text-center">
                            <h4 class="text-success">{{ team_management_data.total_members }}</h4>
                            <small>Membri Attivi</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h4 class="text-warning">{{ team_management_data.pending_users }}</h4>
                            <small>In Sospeso</small>
                        </div>
                    </div>
                </div>
                {% if team_management_data.recent_additions %}
                <hr>
                <h6 class="small text-muted">Aggiunti di recente:</h6>
                {% for user in team_management_data.recent_additions %}
                <small class="d-block">{{ user.get_full_name() }} ({{ user.role }})</small>
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Widget: Richieste Ferie/Permessi -->
    {% if current_user.can_view_leave_requests_widget() and recent_leaves %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-calendar-check me-2"></i>Ferie/Permessi</h5>
                <a href="{{ url_for('leave_requests') }}" class="btn btn-sm btn-outline-primary">Visualizza</a>
            </div>
            <div class="card-body">
                {% for leave in recent_leaves[:5] %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <small><strong>{{ leave.user.get_full_name() if current_user.can_manage_leave() else 'La tua richiesta' }}</strong></small>
                        <br>
                        <small class="text-muted">{{ leave.start_date.strftime('%d/%m') }} - {{ leave.end_date.strftime('%d/%m') }}</small>
                    </div>
                    <span class="badge 
                        {% if leave.status == 'approved' %}bg-success
                        {% elif leave.status == 'rejected' %}bg-danger
                        {% else %}bg-warning text-dark
                        {% endif %}">
                        {% if leave.status == 'approved' %}Approvata
                        {% elif leave.status == 'rejected' %}Rifiutata
                        {% else %}In Attesa
                        {% endif %}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Widget: Presenze Giornaliere per Sede -->
    {% if current_user.can_view_daily_attendance_widget() and daily_attendance_data %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="fas fa-building me-2"></i>Presenze per Sede</h5>
                <small class="text-muted">Oggi</small>
            </div>
            <div class="card-body">
                {% for sede_name, data in daily_attendance_data.items() %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6>{{ sede_name }}</h6>
                        <span class="badge bg-{{ 'success' if data.coverage_rate >= 80 else 'warning' if data.coverage_rate >= 50 else 'danger' }}">
                            {{ data.coverage_rate|round }}%
                        </span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-{{ 'success' if data.coverage_rate >= 80 else 'warning' if data.coverage_rate >= 50 else 'danger' }}" 
                             style="width: {{ data.coverage_rate }}%"></div>
                    </div>
                    <small class="text-muted">{{ data.present_users|length }}/{{ data.total_users }} presenti</small>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Widget: Coperture Turni -->
    {% if current_user.can_view_shifts_coverage_widget() %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-clock me-2"></i>Coperture Turni</h5>
                <a href="{{ url_for('manage_turni') }}" class="btn btn-sm btn-outline-primary">Gestisci</a>
            </div>
            <div class="card-body">
                {% if shifts_coverage_alerts %}
                    {% for alert in shifts_coverage_alerts %}
                    <div class="alert alert-warning py-2 mb-2">
                        <small><i class="fas fa-exclamation-triangle me-1"></i>{{ alert.message }}</small>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-success">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <p class="mb-0">Tutti i turni di oggi sono coperti</p>
                    </div>
                {% endif %}
                
                {% if upcoming_shifts %}
                <hr>
                <h6 class="small text-muted">I tuoi prossimi turni:</h6>
                {% for shift in upcoming_shifts[:3] %}
                <small class="d-block">{{ shift.date.strftime('%d/%m') }} {{ shift.start_time.strftime('%H:%M') }}-{{ shift.end_time.strftime('%H:%M') }}</small>
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Widget: Reperibilità -->
    {% if current_user.can_view_reperibilita_widget() %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-phone-volume me-2"></i>Reperibilità</h5>
                <a href="{{ url_for('reperibilita_coverage') }}" class="btn btn-sm btn-outline-primary">Visualizza</a>
            </div>
            <div class="card-body">
                {% if active_intervention %}
                <div class="alert alert-info py-2 mb-3">
                    <small><i class="fas fa-play me-1"></i>Intervento attivo da {{ active_intervention.start_datetime.strftime('%H:%M') }}</small>
                </div>
                {% endif %}
                
                {% if upcoming_reperibilita_shifts %}
                <h6 class="small text-muted">I tuoi prossimi turni:</h6>
                {% for shift in upcoming_reperibilita_shifts[:4] %}
                <small class="d-block mb-1">
                    {{ shift.date.strftime('%d/%m') }} 
                    {{ shift.start_time.strftime('%H:%M') }}-{{ shift.end_time.strftime('%H:%M') }}
                </small>
                {% endfor %}
                {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-calendar-times fa-2x mb-2"></i>
                    <p class="mb-0">Nessun turno programmato</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>



<!-- Quick Stats - For users with stats access -->
{% if current_user.can_view_statistics() and not current_user.has_role('Amministratore') %}
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <h5>{{ format_hours(stats.total_hours_worked) }}</h5>
                <small>Ore Lavorate (30gg)</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-success">
            <div class="card-body text-center">
                <i class="fas fa-calendar-check fa-2x mb-2"></i>
                <h5>{{ stats.days_worked }}</h5>
                <small>Giorni Lavorati</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-info">
            <div class="card-body text-center">
                <i class="fas fa-briefcase fa-2x mb-2"></i>
                <h5>{{ stats.total_interventions }}</h5>
                <small>Interventi Totali</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-warning">
            <div class="card-body text-center">
                <i class="fas fa-umbrella-beach fa-2x mb-2"></i>
                <h5>{{ stats.pending_leaves }}</h5>
                <small>Richieste Pendenti</small>
            </div>
        </div>
    </div>
</div>
{% endif %}



<!-- Personal Attendance Section for managers -->
{% if current_user.can_manage_users() and current_user.can_view_attendance() %}
<div class="row mb-4">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header text-center">
                <h4><i class="fas fa-calendar-day me-2"></i>Le Mie Presenze - {{ today.strftime('%d/%m/%Y') if today else date.today().strftime('%d/%m/%Y') }}</h4>
            </div>
            <div class="card-body">
                <!-- Today's Status -->
                <div class="alert alert-info mb-4">
                    <h6><i class="fas fa-calendar-day me-1"></i>Stato di Oggi - {{ today_date.strftime('%d/%m/%Y') if today_date else '' }}</h6>
                    <div class="row">
                        <div class="col-6">
                            <strong>Stato Attuale:</strong> 
                            {% if user_status == 'out' %}
                                <span class="badge bg-secondary">Non presente</span>
                            {% elif user_status == 'in' %}
                                <span class="badge bg-success">Presente</span>
                            {% elif user_status == 'break' %}
                                <span class="badge bg-warning">In Pausa</span>
                            {% endif %}
                        </div>
                        <div class="col-6">
                            <strong>Ore Lavorate:</strong> {{ format_hours(today_work_hours) if today_work_hours else '0h 00\'' }}
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="row mb-3">
                    <div class="col-6 col-md-3 mb-2">
                        {% if user_status in ['out', 'break'] %}
                        <button type="button" class="btn btn-success w-100" onclick="handleClockIn()">
                            <i class="fas fa-sign-in-alt me-1"></i>Entrata
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-outline-success w-100" disabled>
                            <i class="fas fa-sign-in-alt me-1"></i>Entrata
                        </button>
                        {% endif %}
                    </div>
                    <div class="col-6 col-md-3 mb-2">
                        {% if user_status == 'in' %}
                        <button type="button" class="btn btn-danger w-100" onclick="handleClockOut()">
                            <i class="fas fa-sign-out-alt me-1"></i>Uscita
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-outline-danger w-100" disabled>
                            <i class="fas fa-sign-out-alt me-1"></i>Uscita
                        </button>
                        {% endif %}
                    </div>
                    <div class="col-6 col-md-3 mb-2">
                        {% if user_status == 'in' %}
                        <button type="button" class="btn btn-warning w-100" onclick="handleBreakStart()">
                            <i class="fas fa-pause me-1"></i>Pausa
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-outline-warning w-100" disabled>
                            <i class="fas fa-pause me-1"></i>Pausa
                        </button>
                        {% endif %}
                    </div>
                    <div class="col-6 col-md-3 mb-2">
                        {% if user_status == 'break' %}
                        <button type="button" class="btn btn-info w-100" onclick="handleBreakEnd()">
                            <i class="fas fa-play me-1"></i>Ripresa
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-outline-info w-100" disabled>
                            <i class="fas fa-play me-1"></i>Ripresa
                        </button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Current Time Display -->
                <div class="alert alert-secondary p-2">
                    <i class="fas fa-clock me-1"></i>
                    <span id="current-time-pm"></span>
                </div>
            </div>
        </div>
    </div>
</div>




<!-- Team Staff Section (for managers) -->
{% if current_user.can_manage_users() or current_user.can_view_shifts() %}
<div class="row mb-4">
    <div class="col">
        <h4><i class="fas fa-users-cog me-2"></i>Gestione Team</h4>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock me-2"></i>Presenze Team</h5>
                <small class="text-muted">{{ today_date.strftime('%d/%m/%Y') if today_date else '' }}</small>
            </div>
            <div class="card-body">
                {% if daily_attendance_data %}
                    {% for sede_name, data in daily_attendance_data.items() %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">{{ sede_name }}</h6>
                            <span class="badge bg-{{ 'success' if data.coverage_rate >= 80 else 'warning' if data.coverage_rate >= 50 else 'danger' }}">
                                {{ data.present_users|length }}/{{ data.total_users }}
                            </span>
                        </div>
                        {% if data.present_users %}
                            {% for user in data.present_users %}
                            <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                                <small>{{ user.get_full_name() }}</small>
                                <span class="badge bg-success">Presente</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <small class="text-muted">Nessun utente presente</small>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <p class="mb-0">Nessuna presenza registrata oggi</p>
                    </div>
                {% endif %}
                <div class="d-grid gap-2 mt-3">
                    <a href="{{ url_for('attendance', view='team') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-list-ul me-1"></i>Dettagli Completi
                    </a>
                </div>
            </div>
        </div>
    </div>

</div>
{% endif %}

<!-- Personal sections for non-admin users -->
{% if current_user.can_view_attendance() and not current_user.has_role('Amministratore') %}
<div class="row">
    <!-- Today's Attendance -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar-day me-2"></i>Presenza Oggi</h5>
            </div>
            <div class="card-body">
                {% if today_events %}
                <div class="row text-center">
                    <div class="col-6">
                        <strong>Entrata:</strong><br>
                        {% set first_clock_in = today_events | selectattr('event_type', 'equalto', 'clock_in') | first %}
                        {% if first_clock_in %}
                        <span class="text-success">{{ first_clock_in.timestamp|format_time_italian }}</span>
                        {% else %}
                        <span class="text-muted">Non registrata</span>
                        {% endif %}
                    </div>
                    <div class="col-6">
                        <strong>Uscita:</strong><br>
                        {% set last_clock_out = today_events | selectattr('event_type', 'equalto', 'clock_out') | list | last %}
                        {% if last_clock_out %}
                        <span class="text-success">{{ last_clock_out.timestamp|format_time_italian }}</span>
                        {% else %}
                        <span class="text-muted">Non registrata</span>
                        {% endif %}
                    </div>
                </div>
                {% if today_work_hours > 0 %}
                <div class="text-center mt-3">
                    <strong>Ore Lavorate: </strong>
                    <span class="badge bg-primary">{{ format_hours(today_work_hours) }}</span>
                </div>
                {% endif %}
                {% else %}
                <p class="text-white">Nessuna registrazione per oggi</p>
                {% endif %}
                
                <div class="text-center mt-3">
                    <a href="{{ url_for('attendance') }}" class="btn btn-primary">
                        <i class="fas fa-clock me-1"></i>Gestisci Presenze
                    </a>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- Reperibilità Section for authorized users -->
{% if current_user.can_view_reperibilita_widget() %}
<div class="row">
    <!-- Reperibilità Shifts -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-phone me-2"></i>Prossimi Turni Reperibilità</h5>
            </div>
            <div class="card-body">
                {% if upcoming_reperibilita_shifts %}
                <div class="list-group list-group-flush">
                    {% for shift in upcoming_reperibilita_shifts %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ shift.date.strftime('%d/%m/%Y') }}</strong><br>
                            <small class="text-muted">
                                {{ shift.start_time.strftime('%H:%M') }} - {{ shift.end_time.strftime('%H:%M') }}
                                {% if shift.description %}
                                    <br>{{ shift.description }}
                                {% endif %}
                            </small>
                        </div>
                        <span class="badge bg-warning text-dark">{{ "%.1f"|format(shift.get_duration_hours()) }}h</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">Nessun turno di reperibilità programmato</p>
                {% endif %}
                
                <div class="text-center mt-3">
                    <a href="{{ url_for('reperibilita_shifts') }}" class="btn btn-warning">
                        <i class="fas fa-phone me-1"></i>Gestisci Reperibilità
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Intervention Staff -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tools me-2"></i>Interventi Reperibilità</h5>
            </div>
            <div class="card-body">
                {% if active_intervention %}
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-1"></i>Intervento In Corso</h6>
                    <p><strong>Iniziato:</strong> {{ active_intervention.start_datetime.strftime('%d/%m/%Y alle %H:%M') }}</p>
                    <p><strong>Tipo:</strong> 
                        <span class="badge {% if active_intervention.is_remote %}bg-info{% else %}bg-secondary{% endif %}">
                            {% if active_intervention.is_remote %}
                            <i class="fas fa-laptop"></i> Da remoto
                            {% else %}
                            <i class="fas fa-building"></i> In presenza
                            {% endif %}
                        </span>
                        <span class="badge {% if active_intervention.priority == 'Alta' %}bg-danger{% elif active_intervention.priority == 'Media' %}bg-warning text-dark{% else %}bg-success{% endif %} ms-1">
                            {% if active_intervention.priority == 'Alta' %}
                            <i class="fas fa-exclamation-triangle"></i> Alta
                            {% elif active_intervention.priority == 'Media' %}
                            <i class="fas fa-minus"></i> Media
                            {% else %}
                            <i class="fas fa-check-circle"></i> Bassa
                            {% endif %}
                        </span>
                    </p>
                    {% if active_intervention.description %}
                    <p><strong>Descrizione:</strong> {{ active_intervention.description }}</p>
                    {% endif %}
                    {% if active_intervention.shift %}
                    <p><strong>Turno:</strong> {{ active_intervention.shift.date.strftime('%d/%m/%Y') }} {{ active_intervention.shift.start_time.strftime('%H:%M') }}-{{ active_intervention.shift.end_time.strftime('%H:%M') }}</p>
                    {% endif %}
                    
                    <button type="button" class="btn btn-danger" onclick="showEndInterventionModal()">
                        <i class="fas fa-stop me-1"></i>Termina Intervento
                    </button>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <p>Nessun intervento di reperibilità in corso.</p>
                    <p>Vai alla <a href="{{ url_for('reperibilita_shifts') }}">sezione reperibilità</a> per registrare un intervento su un turno specifico.</p>
                </div>
                {% endif %}
                
                <!-- Timeline Interventi Recenti -->
                {% if recent_interventions %}
                <div class="mt-4">
                    <h6><i class="fas fa-history me-2"></i>Interventi Recenti (ultimi 7 giorni)</h6>
                    <div class="timeline">
                        {% for intervention in recent_interventions %}
                        <div class="timeline-item">
                            <div class="timeline-marker {% if intervention.end_datetime %}bg-success{% else %}bg-warning{% endif %}">
                                <i class="fas {% if intervention.end_datetime %}fa-check{% else %}fa-clock{% endif %}"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <strong>{{ intervention.start_datetime.strftime('%d/%m/%Y alle %H:%M') }}</strong>
                                    {% if intervention.end_datetime %}
                                    - {{ intervention.end_datetime.strftime('%H:%M') }}
                                    <span class="badge bg-success ms-2">Completato</span>
                                    {% else %}
                                    <span class="badge bg-warning ms-2">In Corso</span>
                                    {% endif %}
                                    <span class="badge {% if intervention.is_remote %}bg-info{% else %}bg-secondary{% endif %} ms-1">
                                        {% if intervention.is_remote %}
                                        <i class="fas fa-laptop"></i> Remoto
                                        {% else %}
                                        <i class="fas fa-building"></i> Presenza
                                        {% endif %}
                                    </span>
                                    <span class="badge {% if intervention.priority == 'Alta' %}bg-danger{% elif intervention.priority == 'Media' %}bg-warning text-dark{% else %}bg-success{% endif %} ms-1">
                                        {% if intervention.priority == 'Alta' %}
                                        <i class="fas fa-exclamation-triangle"></i> Alta
                                        {% elif intervention.priority == 'Media' %}
                                        <i class="fas fa-minus"></i> Media
                                        {% else %}
                                        <i class="fas fa-check-circle"></i> Bassa
                                        {% endif %}
                                    </span>
                                </div>
                                {% if intervention.description %}
                                <div class="timeline-description">
                                    {{ intervention.description }}
                                </div>
                                {% endif %}
                                {% if intervention.end_datetime %}
                                <div class="timeline-duration">
                                    <small class="text-muted">
                                        Durata: {{ ((intervention.end_datetime - intervention.start_datetime).total_seconds() / 3600) | round(1) }}h
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal per iniziare intervento -->
<div class="modal fade" id="startInterventionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Inizia Intervento Reperibilità</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('start_intervention') }}">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="form-group mb-3">
                        <label for="intervention_type_dash">Tipo di intervento:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="is_remote" id="remote_dash" value="true" checked>
                            <label class="form-check-label" for="remote_dash">
                                <i class="fas fa-laptop me-1"></i>Da remoto
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="is_remote" id="presence_dash" value="false">
                            <label class="form-check-label" for="presence_dash">
                                <i class="fas fa-building me-1"></i>In presenza
                            </label>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="priority_dash">Priorità intervento:</label>
                        <select name="priority" id="priority_dash" class="form-select">
                            <option value="Bassa">
                                <i class="fas fa-check-circle"></i> Bassa - Problema non urgente
                            </option>
                            <option value="Media" selected>
                                <i class="fas fa-minus"></i> Media - Problema normale
                            </option>
                            <option value="Alta">
                                <i class="fas fa-exclamation-triangle"></i> Alta - Problema critico
                            </option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label for="start_description_dash">Descrizione dell'intervento:</label>
                        <textarea name="description" id="start_description_dash" class="form-control" rows="3" placeholder="Descrivi il tipo di intervento o problema da risolvere..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-play me-1"></i>Inizia Intervento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal per terminare intervento -->
<div class="modal fade" id="endInterventionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Termina Intervento Reperibilità</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('end_intervention') }}">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    {% if active_intervention %}
                    <div class="alert alert-info">
                        <p><strong>Intervento iniziato:</strong> {{ active_intervention.start_datetime.strftime('%d/%m/%Y alle %H:%M') }}</p>
                        {% if active_intervention.description %}
                        <p><strong>Descrizione iniziale:</strong> {{ active_intervention.description }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="form-group mb-3">
                        <label for="end_description_dash">Descrizione finale (facoltativa):</label>
                        <textarea name="description" id="end_description_dash" class="form-control" rows="3" placeholder="Descrivi come è stato risolto il problema...">{% if active_intervention %}{{ active_intervention.description }}{% endif %}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-stop me-1"></i>Termina Intervento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal per iniziare intervento generico -->
<div class="modal fade" id="generalInterventionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Inizia Intervento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('start_general_intervention') }}">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <!-- Sempre in presenza dato che l'utente deve essere presente -->
                    <input type="hidden" name="is_remote" value="false"/>
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Intervento in presenza:</strong> Gli interventi possono essere registrati solo quando sei presente in sede.
                    </div>
                    <div class="form-group mb-3">
                        <label for="priority_general">Priorità intervento:</label>
                        <select name="priority" id="priority_general" class="form-select">
                            <option value="Bassa">Bassa - Problema non urgente</option>
                            <option value="Media" selected>Media - Problema normale</option>
                            <option value="Alta">Alta - Problema critico</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label for="start_description_general">Descrizione dell'intervento:</label>
                        <textarea name="description" id="start_description_general" class="form-control" rows="3" placeholder="Descrivi il tipo di intervento o problema da risolvere..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-secondary">
                        <i class="fas fa-tools me-1"></i>Inizia Intervento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal per terminare intervento generico -->
<div class="modal fade" id="endGeneralInterventionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Termina Intervento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('end_general_intervention') }}">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    {% if active_general_intervention %}
                    <div class="alert alert-info">
                        <p><strong>Intervento iniziato:</strong> {{ active_general_intervention.start_datetime.strftime('%d/%m/%Y alle %H:%M') }}</p>
                        <p><strong>Priorità:</strong> 
                            {% if active_general_intervention.priority == 'Alta' %}
                                <span class="badge bg-danger">{{ active_general_intervention.priority }}</span>
                            {% elif active_general_intervention.priority == 'Media' %}
                                <span class="badge bg-warning">{{ active_general_intervention.priority }}</span>
                            {% else %}
                                <span class="badge bg-success">{{ active_general_intervention.priority }}</span>
                            {% endif %}
                        </p>
                        <p><strong>Tipologia:</strong> In presenza</p>
                        {% if active_general_intervention.description %}
                        <p><strong>Descrizione:</strong> {{ active_general_intervention.description }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="form-group mb-3">
                        <label for="end_description_general">Descrizione finale intervento (facoltativa):</label>
                        <textarea name="end_description" id="end_description_general" class="form-control" rows="3" placeholder="Aggiungi dettagli su come è stato risolto il problema o cosa è stato fatto durante l'intervento..."></textarea>
                        <small class="form-text text-muted">Questa descrizione sarà aggiunta a quella iniziale per completare il report dell'intervento</small>
                    </div>
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-1"></i>
                        <strong>Conferma terminazione intervento</strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-stop me-1"></i>Termina Intervento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function showStartInterventionModal() {
    const modal = new bootstrap.Modal(document.getElementById('startInterventionModal'));
    modal.show();
}

function showEndInterventionModal() {
    const modal = new bootstrap.Modal(document.getElementById('endInterventionModal'));
    modal.show();
}

function showInterventionModal() {
    const modal = new bootstrap.Modal(document.getElementById('generalInterventionModal'));
    modal.show();
}

function showEndGeneralInterventionModal() {
    const modal = new bootstrap.Modal(document.getElementById('endGeneralInterventionModal'));
    modal.show();
}
</script>

<style>
/* Timeline styles for interventions */
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 12px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--bs-border-color);
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -18px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 10px;
    border: 2px solid var(--bs-body-bg);
}

.timeline-content {
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 5px;
    padding: 12px;
}

.timeline-header {
    font-weight: bold;
    margin-bottom: 5px;
}

.timeline-description {
    margin-bottom: 5px;
    font-style: italic;
}

.timeline-duration {
    margin-bottom: 0;
}
</style>

<script>
// Aggiorna automaticamente le ore lavorate ogni 30 secondi
function updateWorkHours() {
    // Trova tutti gli elementi delle ore lavorate
    const workHourElements = document.querySelectorAll('[id^="work-hours-"]');
    
    workHourElements.forEach(element => {
        const idParts = element.id.split('-');
        if (idParts.length >= 4) {
            const userId = idParts[2];
            const dateStr = idParts.slice(3).join('-');
            
            // Effettua chiamata API per aggiornare le ore
            fetch(`/api/work_hours/${userId}/${dateStr}`)
                .then(response => response.json())
                .then(data => {
                    if (data.work_hours !== undefined) {
                        // Converti ore decimali in formato ore:minuti
                        const hours = Math.floor(data.work_hours);
                        const minutes = Math.floor((data.work_hours - hours) * 60);
                        element.textContent = `${hours}h ${minutes.toString().padStart(2, '0')}'`;
                    }
                })
                .catch(error => {
                    // Gestione silenziosa degli errori per evitare spam in console
                    // Solo per debug: console.log('Errore aggiornamento ore:', error);
                });
        }
    });
}

// Avvia aggiornamento automatico
setInterval(updateWorkHours, 30000); // Ogni 30 secondi

// Aggiorna al caricamento della pagina
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(updateWorkHours, 2000); // Dopo 2 secondi dal caricamento
    
    // Aggiorna l'ora corrente ogni secondo
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
});

// Update current time display
function updateCurrentTime() {
    // Check if we have any time elements first
    const timeElement = document.getElementById('current-time');
    const timeElementPM = document.getElementById('current-time-pm');
    
    if (!timeElement && !timeElementPM) {
        return; // No time elements found, skip update
    }
    
    const now = new Date();
    const timeString = now.toLocaleTimeString('it-IT', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    if (timeElement) {
        timeElement.textContent = timeString;
    }
    
    if (timeElementPM) {
        timeElementPM.textContent = timeString;
    }
}

// Handle clock-in with shift verification
async function handleClockIn() {
    try {
        const response = await fetch('{{ url_for("check_shift_before_clock_in") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        
        const data = await response.json();
        
        if (!data.success) {
            alert(data.message);
            return;
        }
        
        if (data.needs_confirmation) {
            showConfirmModal('Avvertenza', data.message, function() {
                submitClockIn();
            });
        } else {
            submitClockIn();
        }
    } catch (error) {
        console.error('Error checking shift:', error);
        showConfirmModal('Errore', 'Errore nella verifica del turno. Vuoi procedere comunque con la registrazione?', function() {
            submitClockIn();
        });
    }
}

// Handle clock-out with shift verification
async function handleClockOut() {
    try {
        const response = await fetch('{{ url_for("check_shift_before_clock_out") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        
        const data = await response.json();
        
        if (!data.success) {
            alert(data.message);
            return;
        }
        
        if (data.needs_confirmation) {
            showConfirmModal('Avvertenza', data.message, function() {
                submitClockOut();
            });
        } else {
            submitClockOut();
        }
    } catch (error) {
        console.error('Error checking shift:', error);
        showConfirmModal('Errore', 'Errore nella verifica del turno. Vuoi procedere comunque con la registrazione?', function() {
            submitClockOut();
        });
    }
}

// Handle break start
function handleBreakStart() {
    showConfirmModal('Conferma', 'Vuoi iniziare la pausa?', function() {
        submitBreakStart();
    });
}

// Handle break end
function handleBreakEnd() {
    showConfirmModal('Conferma', 'Vuoi terminare la pausa?', function() {
        submitBreakEnd();
    });
}

// Submit clock-in form
function submitClockIn() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("clock_in") }}';
    
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrf_token';
    csrfToken.value = '{{ csrf_token() }}';
    
    form.appendChild(csrfToken);
    document.body.appendChild(form);
    form.submit();
}

// Submit clock-out form
function submitClockOut() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("clock_out") }}';
    
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrf_token';
    csrfToken.value = '{{ csrf_token() }}';
    
    form.appendChild(csrfToken);
    document.body.appendChild(form);
    form.submit();
}

// Submit break start form
function submitBreakStart() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("break_start") }}';
    
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrf_token';
    csrfToken.value = '{{ csrf_token() }}';
    
    form.appendChild(csrfToken);
    document.body.appendChild(form);
    form.submit();
}

// Submit break end form
function submitBreakEnd() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("break_end") }}';
    
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrf_token';
    csrfToken.value = '{{ csrf_token() }}';
    
    form.appendChild(csrfToken);
    document.body.appendChild(form);
    form.submit();
}

// Funzione per mostrare modal di conferma personalizzato
function showConfirmModal(title, message, onConfirm) {
    document.getElementById('confirmModalLabel').textContent = title;
    document.getElementById('confirmModalBody').textContent = message;
    
    // Rimuovi eventi precedenti
    const okButton = document.getElementById('confirmModalOk');
    const newOkButton = okButton.cloneNode(true);
    okButton.parentNode.replaceChild(newOkButton, okButton);
    
    // Aggiungi nuovo evento
    newOkButton.addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
        modal.hide();
        onConfirm();
    });
    
    // Mostra il modal
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}
</script>

<!-- Modal di Conferma Personalizzato -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Conferma</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Il messaggio verrà inserito qui dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="confirmModalOk">Continua</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
