{% extends "base.html" %}

{% block title %}Dashboard - Workly Platform{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
        <p class="text-muted">Benvenuto, {{ current_user.get_full_name() }} ({{ current_user.role }})</p>
    </div>
</div>

<!-- Main Row: Personal Attendance (if applicable) -->
{% if current_user.can_view_my_attendance_widget() %}
<div class="row mb-4">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header text-center">
                <h4><i class="fas fa-user-clock me-2"></i>Le Mie Presenze - {{ today_date.strftime('%d/%m/%Y') if today_date else '' }}</h4>
            </div>
            <div class="card-body">
                <!-- Status Row -->
                <div class="row text-center mb-4">
                    <div class="col-md-4">
                        <div class="badge p-3 w-100 
                            {% if user_status == 'out' %}bg-secondary
                            {% elif user_status == 'in' %}bg-success
                            {% elif user_status == 'break' %}bg-warning text-dark
                            {% endif %}">
                            <h5 class="mb-1">
                                {% if user_status == 'out' %}Non presente
                                {% elif user_status == 'in' %}Presente
                                {% elif user_status == 'break' %}In Pausa
                                {% endif %}
                            </h5>
                            <small>Stato Attuale</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="badge bg-primary p-3 w-100">
                            <h5 class="mb-1">{{ format_hours(today_work_hours) if today_work_hours else '0h 00\'' }}</h5>
                            <small>Ore Lavorate</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="badge bg-info p-3 w-100">
                            <h5 class="mb-1" id="current-time">--:--</h5>
                            <small>Ora Corrente</small>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row mb-3">
                    <div class="col-6 col-md-3 mb-2">
                        {% if user_status == 'out' %}
                        <button type="button" class="btn btn-success w-100" onclick="handleClockIn()">
                            <i class="fas fa-play me-1"></i>Entrata
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-outline-success w-100" disabled>
                            <i class="fas fa-play me-1"></i>Entrata
                        </button>
                        {% endif %}
                    </div>
                    <div class="col-6 col-md-3 mb-2">
                        {% if user_status == 'in' %}
                        <button type="button" class="btn btn-danger w-100" onclick="handleClockOut()">
                            <i class="fas fa-stop me-1"></i>Uscita
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-outline-danger w-100" disabled>
                            <i class="fas fa-stop me-1"></i>Uscita
                        </button>
                        {% endif %}
                    </div>
                    <div class="col-6 col-md-3 mb-2">
                        {% if user_status == 'in' %}
                        <button type="button" class="btn btn-warning w-100" onclick="handleBreakStart()">
                            <i class="fas fa-pause me-1"></i>Pausa
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-outline-warning w-100" disabled>
                            <i class="fas fa-pause me-1"></i>Pausa
                        </button>
                        {% endif %}
                    </div>
                    <div class="col-6 col-md-3 mb-2">
                        {% if user_status == 'break' %}
                        <button type="button" class="btn btn-info w-100" onclick="handleBreakEnd()">
                            <i class="fas fa-play me-1"></i>Ripresa
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-outline-info w-100" disabled>
                            <i class="fas fa-play me-1"></i>Ripresa
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Today's Events (if any) -->
                {% if today_events %}
                <hr>
                <h6 class="text-muted mb-3">Eventi di Oggi:</h6>
                <div class="row">
                    {% for event in today_events %}
                    <div class="col-6 col-md-3 mb-2">
                        <span class="badge w-100
                            {% if event.event_type == 'clock_in' %}bg-success
                            {% elif event.event_type == 'clock_out' %}bg-danger
                            {% elif event.event_type == 'break_start' %}bg-warning text-dark
                            {% elif event.event_type == 'break_end' %}bg-info
                            {% endif %}">
                            {% if event.event_type == 'clock_in' %}Entrata
                            {% elif event.event_type == 'clock_out' %}Uscita
                            {% elif event.event_type == 'break_start' %}Pausa
                            {% elif event.event_type == 'break_end' %}Ripresa
                            {% endif %}
                            {{ event.timestamp|format_time_italian }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Statistics and Management Row -->
<div class="row mb-4">
    <!-- Team Statistics -->
    {% if current_user.can_view_team_stats_widget() and team_stats %}
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar me-2"></i>Statistiche Team</h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="text-center">
                            <h3 class="text-primary">{{ team_stats.total_users }}</h3>
                            <small>Utenti Totali</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h3 class="text-success">{{ team_stats.active_users }}</h3>
                            <small>Utenti Attivi</small>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    {% for role_name, count in team_stats.user_counts_by_role.items() %}
                    <div class="col-6 mb-2">
                        <div class="badge 
                            {% if role_name == 'Amministratore' %}bg-danger
                            {% elif role_name == 'Responsabile' %}bg-primary
                            {% elif role_name == 'Supervisore' %}bg-warning text-dark
                            {% elif role_name == 'Operatore' %}bg-info
                            {% else %}bg-secondary
                            {% endif %} w-100 p-2">
                            {{ count }} {{ role_name }}{{ 's' if count != 1 else '' }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Team Management -->
    {% if current_user.can_view_team_management_widget() and team_management_data %}
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-users-cog me-2"></i>Gestione Team</h5>
                <a href="{{ url_for('user_management') }}" class="btn btn-sm btn-outline-primary">Gestisci</a>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="text-center">
                            <h3 class="text-success">{{ team_management_data.total_members }}</h3>
                            <small>Membri Attivi</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h3 class="text-warning">{{ team_management_data.pending_users }}</h3>
                            <small>In Sospeso</small>
                        </div>
                    </div>
                </div>
                {% if team_management_data.recent_additions %}
                <hr>
                <h6 class="small text-muted">Aggiunti di recente:</h6>
                {% for user in team_management_data.recent_additions %}
                <small class="d-block">{{ user.get_full_name() }} ({{ user.role }})</small>
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Activity Row -->
<div class="row mb-4">
    <!-- Leave Requests -->
    {% if current_user.can_view_leave_requests_widget() and recent_leaves %}
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6><i class="fas fa-calendar-check me-1"></i>Ferie/Permessi</h6>
                <a href="{{ url_for('leave_requests') }}" class="btn btn-sm btn-outline-primary">Visualizza</a>
            </div>
            <div class="card-body">
                {% for leave in recent_leaves[:4] %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <small><strong>{{ leave.user.get_full_name() if current_user.can_manage_leave() else 'La tua richiesta' }}</strong></small>
                        <br>
                        <small class="text-muted">{{ leave.start_date.strftime('%d/%m') }} - {{ leave.end_date.strftime('%d/%m') }}</small>
                    </div>
                    <span class="badge 
                        {% if leave.status == 'approved' %}bg-success
                        {% elif leave.status == 'rejected' %}bg-danger
                        {% else %}bg-warning text-dark
                        {% endif %}">
                        {% if leave.status == 'approved' %}Approvata
                        {% elif leave.status == 'rejected' %}Rifiutata
                        {% else %}In Attesa
                        {% endif %}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Daily Attendance -->
    {% if current_user.can_view_daily_attendance_widget() and daily_attendance_data %}
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h6><i class="fas fa-building me-1"></i>Presenze per Sede</h6>
                <small class="text-muted">Oggi</small>
            </div>
            <div class="card-body">
                {% for sede_name, data in daily_attendance_data.items() %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <small><strong>{{ sede_name }}</strong></small>
                        <span class="badge bg-{{ 'success' if data.coverage_rate >= 80 else 'warning' if data.coverage_rate >= 50 else 'danger' }}">
                            {{ data.coverage_rate|round }}%
                        </span>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-{{ 'success' if data.coverage_rate >= 80 else 'warning' if data.coverage_rate >= 50 else 'danger' }}" 
                             style="width: {{ data.coverage_rate }}%"></div>
                    </div>
                    <small class="text-muted">{{ data.present_users|length }}/{{ data.total_users }} presenti</small>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Shifts Coverage -->
    {% if current_user.can_view_shifts_coverage_widget() %}
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6><i class="fas fa-clock me-1"></i>Coperture Turni</h6>
                <a href="{{ url_for('manage_turni') }}" class="btn btn-sm btn-outline-primary">Gestisci</a>
            </div>
            <div class="card-body">
                {% if shifts_coverage_alerts %}
                    {% for alert in shifts_coverage_alerts %}
                    <div class="alert alert-warning py-1 mb-2">
                        <small><i class="fas fa-exclamation-triangle me-1"></i>{{ alert.message }}</small>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-success mb-3">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <p class="mb-0 small">Tutti i turni coperti</p>
                    </div>
                {% endif %}
                
                {% if upcoming_shifts %}
                <hr>
                <h6 class="small text-muted">I tuoi prossimi turni:</h6>
                {% for shift in upcoming_shifts[:3] %}
                <small class="d-block">{{ shift.date.strftime('%d/%m') }} {{ shift.start_time.strftime('%H:%M') }}-{{ shift.end_time.strftime('%H:%M') }}</small>
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Reperibilità Section -->
{% if current_user.can_view_reperibilita_widget() %}
<div class="row mb-4">
    <div class="col-md-6 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-phone-volume me-2"></i>Reperibilità</h5>
                <a href="{{ url_for('reperibilita_coverage') }}" class="btn btn-sm btn-outline-primary">Visualizza</a>
            </div>
            <div class="card-body">
                {% if active_intervention %}
                <div class="alert alert-info py-2 mb-3">
                    <strong><i class="fas fa-play me-1"></i>Intervento attivo da {{ active_intervention.start_datetime.strftime('%H:%M') }}</strong>
                </div>
                {% endif %}
                
                {% if upcoming_reperibilita_shifts %}
                <h6 class="text-muted mb-3">I tuoi prossimi turni di reperibilità:</h6>
                <div class="row">
                    {% for shift in upcoming_reperibilita_shifts[:6] %}
                    <div class="col-md-6 mb-2">
                        <div class="badge bg-secondary w-100 p-2">
                            {{ shift.date.strftime('%d/%m') }} 
                            {{ shift.start_time.strftime('%H:%M') }}-{{ shift.end_time.strftime('%H:%M') }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-calendar-times fa-2x mb-2"></i>
                    <p class="mb-0">Nessun turno di reperibilità programmato</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Access Links (for admins and managers) -->
{% if current_user.can_manage_users() or current_user.can_view_shifts() or current_user.can_manage_leave() %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-external-link-alt me-2"></i>Accessi Rapidi</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    {% if current_user.can_view_attendance() %}
                    <div class="col-md-3 col-6 mb-3">
                        <a href="{{ url_for('attendance', view='team') }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-users-clock d-block mb-1"></i>
                            <small>Presenze Team</small>
                        </a>
                    </div>
                    {% endif %}
                    {% if current_user.can_manage_users() %}
                    <div class="col-md-3 col-6 mb-3">
                        <a href="{{ url_for('user_management') }}" class="btn btn-outline-success w-100">
                            <i class="fas fa-user-cog d-block mb-1"></i>
                            <small>Gestione Utenti</small>
                        </a>
                    </div>
                    {% endif %}
                    {% if current_user.can_view_shifts() %}
                    <div class="col-md-3 col-6 mb-3">
                        <a href="{{ url_for('manage_turni') }}" class="btn btn-outline-info w-100">
                            <i class="fas fa-calendar-alt d-block mb-1"></i>
                            <small>Gestione Turni</small>
                        </a>
                    </div>
                    {% endif %}
                    {% if current_user.can_manage_leave() %}
                    <div class="col-md-3 col-6 mb-3">
                        <a href="{{ url_for('leave_requests') }}" class="btn btn-outline-warning w-100">
                            <i class="fas fa-umbrella-beach d-block mb-1"></i>
                            <small>Ferie/Permessi</small>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// Clock functionality
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('it-IT', { 
        hour: '2-digit', 
        minute: '2-digit'
    });
    const timeElement = document.getElementById('current-time');
    if (timeElement) {
        timeElement.textContent = timeString;
    }
}

// Update time immediately and then every second
updateTime();
setInterval(updateTime, 1000);

// Attendance functions (keep existing ones from original dashboard)
function handleClockIn() {
    fetch('/attendance/clock_in/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Errore: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Errore di rete');
    });
}

function handleClockOut() {
    fetch('/attendance/clock_out/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Errore: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Errore di rete');
    });
}

function handleBreakStart() {
    fetch('/attendance/break_start/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Errore: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Errore di rete');
    });
}

function handleBreakEnd() {
    fetch('/attendance/break_end/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Errore: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Errore di rete');
    });
}
</script>
{% endblock %}