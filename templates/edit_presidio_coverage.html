{% extends "base.html" %}

{% block title %}Modifica Template Copertura Presidio{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-edit me-2"></i>Modifica Template Copertura Presidio</h2>
        <p class="text-muted">Modifica template {{ start_date.strftime('%d/%m/%Y') }} - {{ end_date.strftime('%d/%m/%Y') }}</p>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('view_presidio_coverage', period_key=period_key) }}" class="btn btn-secondary">
            <i class="fas fa-eye me-1"></i>Solo Visualizza
        </a>
    </div>
</div>

<!-- Avviso -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Attenzione:</strong> Le modifiche al template di copertura influenzeranno la generazione dei turni futuri.
            I turni già generati non saranno modificati automaticamente.
        </div>
    </div>
</div>

<!-- Form di modifica -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar-week me-2"></i>Coperture del Template</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="editCoverageForm">
                    {{ csrf_token() if csrf_token }}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    {% if coverages %}
                    <div class="table-responsive">
                        <table class="table table-striped" id="coveragesTable">
                            <thead>
                                <tr>
                                    <th>Giorno</th>
                                    <th>Orario Inizio</th>
                                    <th>Orario Fine</th>
                                    <th>Pausa Inizio</th>
                                    <th>Pausa Fine</th>
                                    <th>Ruoli</th>
                                    <th>Descrizione</th>
                                    <th>Stato</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for coverage in coverages %}
                                <tr data-coverage-id="{{ coverage.id }}">
                                    <td>
                                        <strong>{{ coverage.get_day_name() }}</strong>
                                        <input type="hidden" name="coverage_{{ coverage.id }}_day" value="{{ coverage.day_of_week }}">
                                    </td>
                                    <td>
                                        <input type="time" 
                                               name="coverage_{{ coverage.id }}_start_time" 
                                               value="{{ coverage.start_time.strftime('%H:%M') if coverage.start_time else '' }}" 
                                               class="form-control form-control-sm" 
                                               required>
                                    </td>
                                    <td>
                                        <input type="time" 
                                               name="coverage_{{ coverage.id }}_end_time" 
                                               value="{{ coverage.end_time.strftime('%H:%M') if coverage.end_time else '' }}" 
                                               class="form-control form-control-sm" 
                                               required>
                                    </td>
                                    <td>
                                        <input type="time" 
                                               name="coverage_{{ coverage.id }}_break_start_time" 
                                               value="{{ coverage.break_start_time.strftime('%H:%M') if coverage.break_start_time else '' }}" 
                                               class="form-control form-control-sm" 
                                               placeholder="Inizio pausa">
                                    </td>
                                    <td>
                                        <input type="time" 
                                               name="coverage_{{ coverage.id }}_break_end_time" 
                                               value="{{ coverage.break_end_time.strftime('%H:%M') if coverage.break_end_time else '' }}" 
                                               class="form-control form-control-sm" 
                                               placeholder="Fine pausa">
                                    </td>
                                    <td>
                                        <input type="text" 
                                               name="coverage_{{ coverage.id }}_roles" 
                                               value="{{ coverage.get_required_roles_display() }}" 
                                               class="form-control form-control-sm" 
                                               placeholder="es. Operatore, 2 Tecnico" 
                                               required>
                                    </td>
                                    <td>
                                        <input type="text" 
                                               name="coverage_{{ coverage.id }}_description" 
                                               value="{{ coverage.description or '' }}" 
                                               class="form-control form-control-sm" 
                                               placeholder="Descrizione opzionale">
                                    </td>
                                    <td>
                                        <select name="coverage_{{ coverage.id }}_is_active" class="form-select form-select-sm">
                                            <option value="1" {{ 'selected' if coverage.is_active else '' }}>Attiva</option>
                                            <option value="0" {{ 'selected' if not coverage.is_active else '' }}>Inattiva</option>
                                        </select>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteCoverageRow({{ coverage.id }})" 
                                                title="Elimina copertura">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex gap-2 justify-content-between">
                                <div>
                                    <a href="{{ url_for('view_presidio_coverage', period_key=period_key) }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-1"></i>Annulla
                                    </a>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-success" name="action" value="save">
                                        <i class="fas fa-save me-1"></i>Salva Modifiche
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5 class="text-muted">Nessuna copertura trovata per questo template</h5>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function deleteCoverageRow(coverageId) {
    if (confirm('Sei sicuro di voler eliminare questa copertura?')) {
        const row = document.querySelector(`tr[data-coverage-id="${coverageId}"]`);
        if (row) {
            // Aggiungi campo hidden per marcare come eliminata
            const deleteInput = document.createElement('input');
            deleteInput.type = 'hidden';
            deleteInput.name = `coverage_${coverageId}_delete`;
            deleteInput.value = '1';
            row.appendChild(deleteInput);
            
            // Nascondi la riga
            row.style.display = 'none';
        }
    }
}

// Validazione form
document.getElementById('editCoverageForm').addEventListener('submit', function(e) {
    const rows = document.querySelectorAll('tr[data-coverage-id]');
    
    for (let row of rows) {
        if (row.style.display !== 'none') {
            const startTime = row.querySelector('input[name$="_start_time"]').value;
            const endTime = row.querySelector('input[name$="_end_time"]').value;
            const breakStart = row.querySelector('input[name$="_break_start_time"]').value;
            const breakEnd = row.querySelector('input[name$="_break_end_time"]').value;
            
            // Validazione orario principale
            if (startTime >= endTime) {
                alert('L\'orario di fine deve essere successivo all\'orario di inizio');
                e.preventDefault();
                row.querySelector('input[name$="_start_time"]').focus();
                return;
            }
            
            // Validazione pause (se specificate)
            if (breakStart && breakEnd) {
                if (breakStart >= breakEnd) {
                    alert('L\'orario di fine pausa deve essere successivo all\'inizio pausa');
                    e.preventDefault();
                    row.querySelector('input[name$="_break_start_time"]').focus();
                    return;
                }
                
                // Controllo che la pausa sia all'interno dell'orario di lavoro
                if (breakStart < startTime || breakEnd > endTime) {
                    alert('La pausa deve essere compresa nell\'orario di lavoro');
                    e.preventDefault();
                    row.querySelector('input[name$="_break_start_time"]').focus();
                    return;
                }
            }
            
            // Se solo uno dei campi pausa è compilato
            if ((breakStart && !breakEnd) || (!breakStart && breakEnd)) {
                alert('Specificare entrambi gli orari della pausa o lasciarli vuoti');
                e.preventDefault();
                row.querySelector('input[name$="_break_start_time"]').focus();
                return;
            }
        }
    }
});
</script>
{% endblock %}