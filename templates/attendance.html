{% extends "base.html" %}

{% block title %}Presenze{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>
                        {% if show_team_data and view_mode == 'sede' %}
                            Presenze Sede
                        {% elif show_team_data %}
                            Dashboard Presenze
                        {% else %}
                            Le Mie Presenze
                        {% endif %}
                    </h5>
                    
                    <div class="d-flex gap-2">
                        {% if not show_team_data %}
                        <a href="{{ url_for('attendance.manual_timesheet') }}" class="btn btn-info btn-sm">
                            <i class="fas fa-keyboard me-1"></i>Timesheet Manuale
                        </a>
                        {% endif %}
                        
                        {% if current_user.can_view_sede_attendance() %}
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('attendance.attendance') }}" class="btn {% if not show_team_data %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                                <i class="fas fa-user me-1"></i>Le Mie
                            </a>
                            <a href="{{ url_for('attendance.attendance', view='sede') }}" class="btn {% if show_team_data and view_mode == 'sede' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                                <i class="fas fa-building me-1"></i>Sede
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card-body">
                    <!-- Timesheet Consolidation Alert -->
                    {% if timesheet_is_consolidated and not show_team_data %}
                    <div class="alert alert-warning border-warning mb-4">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-lock fa-2x me-3 mt-1"></i>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading mb-2">
                                    <strong>Timesheet Consolidato</strong>
                                </h6>
                                <p class="mb-2">
                                    Il timesheet per <strong>{{ current_month_timesheet.month }}/{{ current_month_timesheet.year }}</strong> 
                                    è stato consolidato il <strong>{{ current_month_timesheet.consolidated_at.strftime('%d/%m/%Y alle %H:%M') }}</strong> 
                                    {% if current_month_timesheet.consolidator %}da <strong>{{ current_month_timesheet.consolidator.get_full_name() }}</strong>{% endif %}.
                                </p>
                                <p class="mb-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Non puoi inserire, modificare o eliminare presenze per questo periodo.
                                </p>
                                {% if pending_reopen_request %}
                                <div class="alert alert-info mb-0 mt-3">
                                    <i class="fas fa-clock me-1"></i>
                                    <strong>Richiesta di Riapertura Pendente</strong>
                                    <p class="mb-0 mt-1 small">
                                        Hai già inviato una richiesta di riapertura il {{ pending_reopen_request.requested_at.strftime('%d/%m/%Y alle %H:%M') }}. 
                                        Attendi l'approvazione da parte di un responsabile.
                                    </p>
                                </div>
                                {% else %}
                                <div class="mt-3">
                                    <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#requestReopenModal">
                                        <i class="fas fa-unlock-alt me-1"></i>
                                        Richiedi Riapertura
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Date Filter Form -->
                    <form method="GET" action="{{ url_for('attendance.attendance') }}" class="row g-3 mb-4">
                        {% if current_user.role == 'Management' or current_user.can_view_sede_attendance() %}
                        <input type="hidden" name="view" value="{{ view_mode }}">
                        {% endif %}
                        <div class="col-md-3">
                            <label for="start_date" class="form-label">Data Inizio</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" 
                                   value="{{ request.args.get('start_date', start_date) }}">
                        </div>
                        <div class="col-md-3">
                            <label for="end_date" class="form-label">Data Fine</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" 
                                   value="{{ request.args.get('end_date', end_date) }}">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-filter me-1"></i>Filtra
                            </button>
                            <a href="{{ url_for('attendance.attendance', view=view_mode) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-undo me-1"></i>Reset
                            </a>
                        </div>
                    </form>
                    
                    {% if records %}
                    <!-- Visualizzazione organizzata per sede per utenti multi-sede -->
                    {% if is_multi_sede and view_mode == 'sede' and all_sedi_list %}
                        {% for sede in all_sedi_list %}
                        {% set sede_records = records_by_sede.get(sede.name, []) %}
                        <div class="mb-4">
                            <h6 class="{% if sede_records %}text-primary{% else %}text-muted{% endif %} border-bottom pb-2">
                                <i class="fas fa-building me-2"></i>{{ sede.name }}
                                {% if sede_records %}
                                <span class="badge bg-primary ms-2">{{ sede_records|length }} presenze</span>
                                {% else %}
                                <span class="badge bg-secondary ms-2">Nessuna presenza</span>
                                {% endif %}
                            </h6>
                            {% if sede_records %}
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Utente</th>
                                            <th>Sede</th>
                                            <th>Ora Inizio</th>
                                            <th>Pausa</th>
                                            <th>Ora Fine</th>
                                            <th>Ore Lavorate</th>
                                            <th>Note</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for record in sede_records %}
                                        <tr {% if record.shift_status == 'assente' %}class="table-danger bg-danger bg-opacity-25"{% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}class="table-info bg-info bg-opacity-10"{% endif %}>
                                            <td>
                                                {{ record.date.strftime('%d/%m/%Y') }}
                                                {% if record.shift_status == 'assente' %}
                                                <i class="fas fa-exclamation-circle text-danger ms-2" title="Nessuna presenza"></i>
                                                {% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}
                                                <i class="fas fa-calendar-alt text-info ms-2" title="{{ record.shift_status|title }}"></i>
                                                {% if record.is_pending %}
                                                <span class="badge bg-warning text-dark ms-2" title="In attesa di approvazione">
                                                    <i class="fas fa-clock me-1"></i>Pending
                                                </span>
                                                {% endif %}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.user %}
                                                <span class="text-primary">{{ record.user.get_full_name() }}</span>
                                                <small class="text-muted d-block">{{ record.user.role }}</small>
                                                {% else %}
                                                <span class="text-muted">--</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.user and record.user.sede_obj %}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-building me-1"></i>{{ record.user.sede_obj.name }}
                                                </span>
                                                {% else %}
                                                <span class="badge bg-secondary">Nessuna Sede</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.shift_status == 'assente' %}
                                                <span class="text-danger fw-bold">Nessuna presenza</span>
                                                {% elif record.shift_status == 'ferie' %}
                                                <span class="fw-bold" style="color: #28a745 !important;">{{ record.clock_in|format_time_italian if record.clock_in else '--:--' }}</span>
                                                <i class="fas fa-calendar-alt text-success ms-1" title="Ferie"></i>
                                                {% elif record.shift_status == 'permesso' %}
                                                <span class="fw-bold" style="color: #6f42c1 !important;">{{ record.clock_in|format_time_italian if record.clock_in else '--:--' }}</span>
                                                <i class="fas fa-clock text-primary ms-1" title="Permesso"></i>
                                                {% elif record.shift_status == 'malattia' %}
                                                <span class="fw-bold" style="color: #fd7e14 !important;">{{ record.clock_in|format_time_italian if record.clock_in else '--:--' }}</span>
                                                <i class="fas fa-thermometer-half" style="color: #fd7e14;" title="Malattia"></i>
                                                {% elif record.clock_in %}
                                                {% set indicators = record.get_attendance_indicators() %}
                                                <span style="{% if indicators.entry == 'ritardo' %}color: #dc3545 !important;{% elif indicators.entry == 'anticipo' %}color: #0dcaf0 !important;{% else %}color: #212529 !important;{% endif %}">
                                                    {{ record.clock_in|format_time_italian }}
                                                    {% if indicators.entry == 'ritardo' %}
                                                    <i class="fas fa-exclamation-triangle text-danger ms-1" title="Entrata in ritardo"></i>
                                                    {% elif indicators.entry == 'anticipo' %}
                                                    <i class="fas fa-thumbs-up text-info ms-1" title="Entrata in anticipo"></i>
                                                    {% endif %}
                                                </span>
                                                {% else %}
                                                <span class="text-muted">--:--</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.shift_status == 'assente' %}
                                                <span class="text-danger fw-bold">--</span>
                                                {% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}
                                                <span class="text-info">--</span>
                                                {% elif record.break_start and record.break_end %}
                                                <span class="text-warning">{{ record.break_start|format_time_italian }}</span> - 
                                                <span class="text-info">{{ record.break_end|format_time_italian }}</span>
                                                {% elif record.break_start %}
                                                <span class="text-warning">{{ record.break_start|format_time_italian }}</span> - 
                                                <span class="text-muted">--:--</span>
                                                {% else %}
                                                <span class="text-muted">--:--</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.shift_status == 'assente' %}
                                                <span class="text-danger fw-bold">Nessuna presenza</span>
                                                {% elif record.shift_status == 'ferie' %}
                                                <span class="fw-bold" style="color: #28a745 !important;">{{ record.clock_out|format_time_italian if record.clock_out else '--:--' }}</span>
                                                {% elif record.shift_status == 'permesso' %}
                                                <span class="fw-bold" style="color: #6f42c1 !important;">{{ record.clock_out|format_time_italian if record.clock_out else '--:--' }}</span>
                                                {% elif record.shift_status == 'malattia' %}
                                                <span class="fw-bold" style="color: #fd7e14 !important;">{{ record.clock_out|format_time_italian if record.clock_out else '--:--' }}</span>
                                                {% elif record.clock_out %}
                                                {% set indicators = record.get_attendance_indicators() %}
                                                <span style="{% if indicators.exit == 'anticipo' %}color: #ffc107 !important;{% elif indicators.exit == 'straordinario' %}color: #0dcaf0 !important;{% else %}color: #212529 !important;{% endif %}">
                                                    {{ record.clock_out|format_time_italian }}
                                                    {% if indicators.exit == 'anticipo' %}
                                                    <i class="fas fa-exclamation-triangle text-warning ms-1" title="Uscita anticipata"></i>
                                                    {% elif indicators.exit == 'straordinario' %}
                                                    <i class="fas fa-thumbs-up text-info ms-1" title="Straordinario"></i>
                                                    {% endif %}
                                                </span>
                                                {% else %}
                                                <span class="text-muted">--:--</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.shift_status == 'assente' %}
                                                <span class="badge bg-danger">Nessuna presenza</span>
                                                {% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}
                                                <span class="text-muted">--</span>
                                                {% elif record.clock_in and record.clock_out %}
                                                <span class="badge bg-primary">{{ format_hours(record.get_work_hours()) }}</span>
                                                {% else %}
                                                <span class="text-muted">--</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.shift_status == 'ferie' %}
                                                <span class="badge" style="background-color: #28a745;">Ferie</span>
                                                {% if record.notes and 'Ferie:' in record.notes %}
                                                <small class="d-block mt-1">{{ record.notes.replace('Ferie:', '').strip()[:50] }}{% if record.notes.replace('Ferie:', '').strip()|length > 50 %}...{% endif %}</small>
                                                {% endif %}
                                                {% elif record.shift_status == 'permesso' %}
                                                <span class="badge" style="background-color: #6f42c1;">Permesso</span>
                                                {% if record.notes and 'Permesso:' in record.notes %}
                                                <small class="d-block mt-1">{{ record.notes.replace('Permesso:', '').strip()[:50] }}{% if record.notes.replace('Permesso:', '').strip()|length > 50 %}...{% endif %}</small>
                                                {% endif %}
                                                {% elif record.shift_status == 'malattia' %}
                                                <span class="badge" style="background-color: #fd7e14;">Malattia</span>
                                                {% if record.notes and 'Malattia:' in record.notes %}
                                                <small class="d-block mt-1">{{ record.notes.replace('Malattia:', '').strip()[:50] }}{% if record.notes.replace('Malattia:', '').strip()|length > 50 %}...{% endif %}</small>
                                                {% endif %}
                                                {% elif record.notes %}
                                                <small>{{ record.notes[:50] }}{% if record.notes|length > 50 %}...{% endif %}</small>
                                                {% else %}
                                                <span class="text-muted">--</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Nessuna presenza registrata per questa sede nel periodo selezionato.
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        
                        <!-- Utenti senza sede (se presenti) -->
                        {% if records_by_sede.get('Nessuna Sede') %}
                        {% set sede_records = records_by_sede['Nessuna Sede'] %}
                        <div class="mb-4">
                            <h6 class="text-warning border-bottom pb-2">
                                <i class="fas fa-exclamation-triangle me-2"></i>Utenti Senza Sede
                                <span class="badge bg-warning ms-2">{{ sede_records|length }} presenze</span>
                            </h6>
                            <!-- Same table structure with updated styling -->
                        </div>
                        {% endif %}
                    {% else %}
                    <!-- Visualizzazione standard (utenti sede-specifica o visualizzazione normale) -->
                    {% if not show_team_data %}
                    <!-- Form inline per inserimento presenza manuale -->
                    <div class="card mb-4 {% if timesheet_is_consolidated %}border-warning{% else %}border-success{% endif %}">
                        <div class="card-header {% if timesheet_is_consolidated %}bg-warning bg-opacity-10{% else %}bg-success bg-opacity-10{% endif %}">
                            <h6 class="mb-0">
                                <i class="fas fa-plus-circle me-2"></i>Nuova Presenza Manuale
                                {% if timesheet_is_consolidated %}
                                <span class="badge bg-warning ms-2">
                                    <i class="fas fa-lock me-1"></i>Timesheet Consolidato
                                </span>
                                {% endif %}
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if timesheet_is_consolidated %}
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Il timesheet del mese corrente è consolidato. Non puoi inserire nuove presenze.
                                {% if not pending_reopen_request %}
                                <a href="#" onclick="$('#requestReopenModal').modal('show'); return false;" class="alert-link">
                                    Richiedi riapertura
                                </a>
                                {% endif %}
                            </div>
                            {% else %}
                            <form method="POST" action="{{ url_for('attendance.manual_entry') }}" class="row g-3">
                                <div class="col-md-2">
                                    <label for="entry_date_inline" class="form-label">Data <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control form-control-sm" id="entry_date_inline" name="entry_date" required max="{{ today_date.strftime('%Y-%m-%d') }}">
                                </div>
                                <div class="col-md-2">
                                    <label for="clock_in_time_inline" class="form-label">Ora Entrata <span class="text-danger">*</span></label>
                                    <input type="time" class="form-control form-control-sm" id="clock_in_time_inline" name="clock_in_time" required>
                                </div>
                                <div class="col-md-2">
                                    <label for="clock_out_time_inline" class="form-label">Ora Uscita <span class="text-danger">*</span></label>
                                    <input type="time" class="form-control form-control-sm" id="clock_out_time_inline" name="clock_out_time" required>
                                </div>
                                <div class="col-md-1">
                                    <label for="break_start_time_inline" class="form-label">Pausa Inizio</label>
                                    <input type="time" class="form-control form-control-sm" id="break_start_time_inline" name="break_start_time">
                                </div>
                                <div class="col-md-1">
                                    <label for="break_end_time_inline" class="form-label">Pausa Fine</label>
                                    <input type="time" class="form-control form-control-sm" id="break_end_time_inline" name="break_end_time">
                                </div>
                                <div class="col-md-3">
                                    <label for="notes_inline" class="form-label">Note</label>
                                    <input type="text" class="form-control form-control-sm" id="notes_inline" name="notes" placeholder="Note opzionali...">
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button type="submit" class="btn btn-success btn-sm w-100">
                                        <i class="fas fa-save me-1"></i>Salva
                                    </button>
                                </div>
                            </form>
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Puoi inserire presenze manualmente solo per date passate e se non ci sono già timbrature automatiche.
                            </small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    {% if show_team_data %}<th>Utente</th>{% endif %}
                                    <th>Sede</th>
                                    <th>Ora Inizio</th>
                                    <th>Pausa</th>
                                    <th>Ora Fine</th>
                                    <th>Ore Lavorate</th>
                                    <th>Note</th>
                                    {% if not show_team_data %}<th>Azioni</th>{% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% if not show_team_data and all_days %}
                                {# Vista personale con tutti i giorni del periodo #}
                                {% for day in all_days %}
                                    {% if day.has_records %}
                                        {# Giorno con presenze - mostra tutti i record di quel giorno #}
                                        {% for record in day.records %}
                                        <tr {% if day.is_weekend and not day.day_enabled %}class="table-secondary"{% elif record.shift_status == 'assente' %}class="table-danger bg-danger bg-opacity-25"{% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}class="table-info bg-info bg-opacity-10"{% elif day.is_weekend %}class="table-warning bg-warning bg-opacity-10"{% endif %}>
                                            <td>
                                                {{ record.date.strftime('%d/%m/%Y') }}
                                                {% if day.is_saturday %}
                                                <span class="badge bg-secondary ms-2">SAB</span>
                                                {% elif day.is_sunday %}
                                                <span class="badge bg-secondary ms-2">DOM</span>
                                                {% endif %}
                                                {% if not day.day_enabled %}
                                                <i class="fas fa-lock text-muted ms-2" title="Giorno non lavorativo"></i>
                                                {% endif %}
                                                {% if record.shift_status == 'assente' %}
                                                <i class="fas fa-exclamation-circle text-danger ms-2" title="Nessuna presenza"></i>
                                                {% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}
                                                <i class="fas fa-calendar-alt text-info ms-2" title="{{ record.shift_status|title }}"></i>
                                                {% if record.is_pending %}
                                                <span class="badge bg-warning text-dark ms-2" title="In attesa di approvazione">
                                                    <i class="fas fa-clock me-1"></i>Pending
                                                </span>
                                                {% endif %}
                                                {% endif %}
                                            </td>
                                            {# ... resto della row come prima #}
                                            <td>
                                                <span class="badge bg-info">
                                                    <i class="fas fa-building me-1"></i>{{ current_user.sede_obj.name if current_user.sede_obj else 'Nessuna Sede' }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if record.shift_status == 'assente' %}
                                                <span class="text-danger fw-bold">Nessuna presenza</span>
                                                {% elif record.shift_status == 'ferie' %}
                                                <span class="fw-bold" style="color: #28a745 !important;">{{ record.clock_in|format_time_italian if record.clock_in else '--:--' }}</span>
                                                <i class="fas fa-calendar-alt text-success ms-1" title="Ferie"></i>
                                                {% elif record.shift_status == 'permesso' %}
                                                <span class="fw-bold" style="color: #6f42c1 !important;">{{ record.clock_in|format_time_italian if record.clock_in else '--:--' }}</span>
                                                <i class="fas fa-clock text-primary ms-1" title="Permesso"></i>
                                                {% elif record.shift_status == 'malattia' %}
                                                <span class="fw-bold" style="color: #fd7e14 !important;">{{ record.clock_in|format_time_italian if record.clock_in else '--:--' }}</span>
                                                <i class="fas fa-thermometer-half" style="color: #fd7e14;" title="Malattia"></i>
                                                {% elif record.clock_in %}
                                                {% set indicators = record.get_attendance_indicators() %}
                                                <span style="{% if indicators.entry == 'ritardo' %}color: #dc3545 !important;{% elif indicators.entry == 'anticipo' %}color: #0dcaf0 !important;{% else %}color: #212529 !important;{% endif %}">
                                                    {{ record.clock_in|format_time_italian }}
                                                    {% if indicators.entry == 'ritardo' %}
                                                    <i class="fas fa-exclamation-triangle text-danger ms-1" title="Entrata in ritardo"></i>
                                                    {% elif indicators.entry == 'anticipo' %}
                                                    <i class="fas fa-check-circle text-info ms-1" title="Entrata in anticipo"></i>
                                                    {% endif %}
                                                </span>
                                                {% else %}
                                                <span class="text-muted">--:--</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.break_duration %}
                                                <span class="badge bg-warning text-dark">{{ format_hours(record.break_duration) }}</span>
                                                {% else %}
                                                <span class="text-muted">--</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.shift_status == 'assente' %}
                                                <span class="text-danger fw-bold">Nessuna presenza</span>
                                                {% elif record.shift_status == 'ferie' %}
                                                <span class="fw-bold" style="color: #28a745 !important;">{{ record.clock_out|format_time_italian if record.clock_out else '--:--' }}</span>
                                                {% elif record.shift_status == 'permesso' %}
                                                <span class="fw-bold" style="color: #6f42c1 !important;">{{ record.clock_out|format_time_italian if record.clock_out else '--:--' }}</span>
                                                {% elif record.shift_status == 'malattia' %}
                                                <span class="fw-bold" style="color: #fd7e14 !important;">{{ record.clock_out|format_time_italian if record.clock_out else '--:--' }}</span>
                                                {% elif record.clock_out %}
                                                {% set indicators = record.get_attendance_indicators() %}
                                                <span style="{% if indicators.exit == 'anticipo' %}color: #ffc107 !important;{% elif indicators.exit == 'straordinario' %}color: #0dcaf0 !important;{% else %}color: #212529 !important;{% endif %}">
                                                    {{ record.clock_out|format_time_italian }}
                                                    {% if indicators.exit == 'anticipo' %}
                                                    <i class="fas fa-exclamation-triangle text-warning ms-1" title="Uscita anticipata"></i>
                                                    {% elif indicators.exit == 'straordinario' %}
                                                    <i class="fas fa-thumbs-up text-info ms-1" title="Straordinario"></i>
                                                    {% endif %}
                                                </span>
                                                {% else %}
                                                <span class="text-muted">--:--</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.shift_status == 'assente' %}
                                                <span class="badge bg-danger">Nessuna presenza</span>
                                                {% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}
                                                <span class="text-muted">--</span>
                                                {% elif record.clock_in and record.clock_out %}
                                                <span class="badge bg-primary">{{ format_hours(record.get_work_hours()) }}</span>
                                                {% else %}
                                                <span class="text-muted">--</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.shift_status == 'ferie' %}
                                                <span class="badge" style="background-color: #28a745;">Ferie</span>
                                                {% if record.notes and 'Ferie:' in record.notes %}
                                                <small class="d-block mt-1">{{ record.notes.replace('Ferie:', '').strip()[:50] }}{% if record.notes.replace('Ferie:', '').strip()|length > 50 %}...{% endif %}</small>
                                                {% endif %}
                                                {% elif record.shift_status == 'permesso' %}
                                                <span class="badge" style="background-color: #6f42c1;">Permesso</span>
                                                {% if record.notes and 'Permesso:' in record.notes %}
                                                <small class="d-block mt-1">{{ record.notes.replace('Permesso:', '').strip()[:50] }}{% if record.notes.replace('Permesso:', '').strip()|length > 50 %}...{% endif %}</small>
                                                {% endif %}
                                                {% elif record.shift_status == 'malattia' %}
                                                <span class="badge" style="background-color: #fd7e14;">Malattia</span>
                                                {% if record.notes and 'Malattia:' in record.notes %}
                                                <small class="d-block mt-1">{{ record.notes.replace('Malattia:', '').strip()[:50] }}{% if record.notes.replace('Malattia:', '').strip()|length > 50 %}...{% endif %}</small>
                                                {% endif %}
                                                {% elif record.notes %}
                                                <small>{{ record.notes[:50] }}{% if record.notes|length > 50 %}...{% endif %}</small>
                                                {% else %}
                                                <span class="text-muted">--</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {# Pulsanti modifica/elimina solo per presenze manuali e date passate #}
                                                {% if record.is_manual and day.date <= today_date %}
                                                <button type="button" class="btn btn-sm btn-warning me-1" onclick="editManualEntry('{{ day.date.strftime('%Y-%m-%d') }}')" title="Modifica">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-danger" onclick="deleteManualEntry('{{ day.date.strftime('%Y-%m-%d') }}')" title="Elimina">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                {% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}
                                                <span class="badge bg-secondary" title="Gestito da sistema ferie/permessi">
                                                    <i class="fas fa-lock"></i>
                                                </span>
                                                {% elif day.date > today_date %}
                                                <span class="badge bg-secondary" title="Data futura - non modificabile">
                                                    <i class="fas fa-clock"></i>
                                                </span>
                                                {% else %}
                                                <span class="badge bg-secondary" title="Timbratura automatica - non modificabile">
                                                    <i class="fas fa-lock"></i>
                                                </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        {# Giorno senza presenze - mostra riga vuota con pulsante aggiungi #}
                                        <tr {% if day.is_weekend and not day.day_enabled %}class="table-secondary"{% elif day.is_weekend %}class="table-warning bg-warning bg-opacity-10"{% endif %}>
                                            <td>
                                                {{ day.date.strftime('%d/%m/%Y') }}
                                                {% if day.is_saturday %}
                                                <span class="badge bg-secondary ms-2">SAB</span>
                                                {% elif day.is_sunday %}
                                                <span class="badge bg-secondary ms-2">DOM</span>
                                                {% endif %}
                                                {% if not day.day_enabled %}
                                                <i class="fas fa-lock text-muted ms-2" title="Giorno non lavorativo"></i>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge bg-info">
                                                    <i class="fas fa-building me-1"></i>{{ current_user.sede_obj.name if current_user.sede_obj else 'Nessuna Sede' }}
                                                </span>
                                            </td>
                                            <td colspan="5" class="text-center text-muted">
                                                {% if not day.day_enabled %}
                                                <i class="fas fa-ban me-2"></i>Giorno non lavorativo
                                                {% else %}
                                                <i class="fas fa-minus me-2"></i>Nessuna presenza registrata
                                                {% endif %}
                                            </td>
                                            <td>
                                                {# Pulsante aggiungi solo per date passate e giorni lavorativi #}
                                                {% if day.date <= today_date and day.day_enabled %}
                                                <button type="button" class="btn btn-sm btn-success" onclick="addManualEntry('{{ day.date.strftime('%Y-%m-%d') }}')" title="Aggiungi presenza">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                                {% elif day.date > today_date %}
                                                <span class="badge bg-secondary" title="Data futura">
                                                    <i class="fas fa-clock"></i>
                                                </span>
                                                {% else %}
                                                <span class="text-muted">--</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                                {% else %}
                                {# Vista team o vecchia logica con records #}
                                {% for record in records %}
                                <tr {% if record.shift_status == 'assente' %}class="table-danger bg-danger bg-opacity-25"{% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}class="table-info bg-info bg-opacity-10"{% endif %}>
                                    <td>
                                        {{ record.date.strftime('%d/%m/%Y') }}
                                        {% if record.shift_status == 'assente' %}
                                        <i class="fas fa-exclamation-circle text-danger ms-2" title="Nessuna presenza e nessuna comunicazione di ferie/permessi/malattia"></i>
                                        {% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}
                                        <i class="fas fa-calendar-alt text-info ms-2" title="{{ record.shift_status|title }}"></i>
                                        {% if record.is_pending %}
                                        <span class="badge bg-warning text-dark ms-2" title="In attesa di approvazione">
                                            <i class="fas fa-clock me-1"></i>Pending
                                        </span>
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                    {% if show_team_data %}
                                    <td>
                                        {% if record.user %}
                                        <span class="text-primary">{{ record.user.get_full_name() }}</span>
                                        <small class="text-muted d-block">{{ record.user.role }}</small>
                                        {% else %}
                                        <span class="text-muted">--</span>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    <td>
                                        {% if record.user and record.user.sede_obj %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-building me-1"></i>{{ record.user.sede_obj.name }}
                                        </span>
                                        {% elif show_team_data %}
                                        <span class="badge bg-secondary">Nessuna Sede</span>
                                        {% else %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-building me-1"></i>{{ current_user.sede_obj.name if current_user.sede_obj else 'Nessuna Sede' }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.shift_status == 'assente' %}
                                        <span class="text-danger fw-bold">Nessuna presenza</span>
                                        {% elif record.shift_status == 'ferie' %}
                                        <span class="fw-bold" style="color: #28a745 !important;">{{ record.clock_in|format_time_italian if record.clock_in else '--:--' }}</span>
                                        <i class="fas fa-calendar-alt text-success ms-1" title="Ferie"></i>
                                        {% elif record.shift_status == 'permesso' %}
                                        <span class="fw-bold" style="color: #6f42c1 !important;">{{ record.clock_in|format_time_italian if record.clock_in else '--:--' }}</span>
                                        <i class="fas fa-clock text-primary ms-1" title="Permesso"></i>
                                        {% elif record.shift_status == 'malattia' %}
                                        <span class="fw-bold" style="color: #fd7e14 !important;">{{ record.clock_in|format_time_italian if record.clock_in else '--:--' }}</span>
                                        <i class="fas fa-thermometer-half" style="color: #fd7e14;" title="Malattia"></i>
                                        {% elif record.clock_in %}
                                        {% set indicators = record.get_attendance_indicators() %}
                                        <span style="{% if indicators.entry == 'ritardo' %}color: #dc3545 !important;{% elif indicators.entry == 'anticipo' %}color: #0dcaf0 !important;{% else %}color: #212529 !important;{% endif %}">
                                            {{ record.clock_in|format_time_italian }}
                                            {% if indicators.entry == 'ritardo' %}
                                            <i class="fas fa-exclamation-triangle text-danger ms-1" title="Entrata in ritardo"></i>
                                            {% elif indicators.entry == 'anticipo' %}
                                            <i class="fas fa-thumbs-up text-info ms-1" title="Entrata in anticipo"></i>
                                            {% endif %}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">--:--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.shift_status == 'assente' %}
                                        <span class="text-danger fw-bold">--</span>
                                        {% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}
                                        <span class="text-info">--</span>
                                        {% elif record.break_start and record.break_end %}
                                        <span class="text-warning">{{ record.break_start|format_time_italian }}</span> - 
                                        <span class="text-info">{{ record.break_end|format_time_italian }}</span>
                                        {% elif record.break_start %}
                                        <span class="text-warning">{{ record.break_start|format_time_italian }}</span> - 
                                        <span class="text-muted">--:--</span>
                                        {% else %}
                                        <span class="text-muted">--:--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.shift_status == 'assente' %}
                                        <span class="text-danger fw-bold">Nessuna presenza</span>
                                        {% elif record.shift_status == 'ferie' %}
                                        <span class="fw-bold" style="color: #28a745 !important;">{{ record.clock_out|format_time_italian if record.clock_out else '--:--' }}</span>
                                        {% elif record.shift_status == 'permesso' %}
                                        <span class="fw-bold" style="color: #6f42c1 !important;">{{ record.clock_out|format_time_italian if record.clock_out else '--:--' }}</span>
                                        {% elif record.shift_status == 'malattia' %}
                                        <span class="fw-bold" style="color: #fd7e14 !important;">{{ record.clock_out|format_time_italian if record.clock_out else '--:--' }}</span>
                                        {% elif record.clock_out %}
                                        {% set indicators = record.get_attendance_indicators() %}
                                        <span style="{% if indicators.exit == 'anticipo' %}color: #ffc107 !important;{% elif indicators.exit == 'straordinario' %}color: #0dcaf0 !important;{% else %}color: #212529 !important;{% endif %}">
                                            {{ record.clock_out|format_time_italian }}
                                            {% if indicators.exit == 'anticipo' %}
                                            <i class="fas fa-exclamation-triangle text-warning ms-1" title="Uscita anticipata"></i>
                                            {% elif indicators.exit == 'straordinario' %}
                                            <i class="fas fa-thumbs-up text-info ms-1" title="Straordinario"></i>
                                            {% endif %}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">--:--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.shift_status == 'assente' %}
                                        <span class="badge bg-danger">Nessuna presenza</span>
                                        {% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}
                                        <span class="text-muted">--</span>
                                        {% elif record.clock_in and record.clock_out %}
                                        <span class="badge bg-primary">{{ format_hours(record.get_work_hours()) }}</span>
                                        {% else %}
                                        <span class="text-muted">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.shift_status == 'ferie' %}
                                        <span class="badge" style="background-color: #28a745;">Ferie</span>
                                        {% if record.notes and 'Ferie:' in record.notes %}
                                        <small class="d-block mt-1">{{ record.notes.replace('Ferie:', '').strip()[:50] }}{% if record.notes.replace('Ferie:', '').strip()|length > 50 %}...{% endif %}</small>
                                        {% endif %}
                                        {% elif record.shift_status == 'permesso' %}
                                        <span class="badge" style="background-color: #6f42c1;">Permesso</span>
                                        {% if record.notes and 'Permesso:' in record.notes %}
                                        <small class="d-block mt-1">{{ record.notes.replace('Permesso:', '').strip()[:50] }}{% if record.notes.replace('Permesso:', '').strip()|length > 50 %}...{% endif %}</small>
                                        {% endif %}
                                        {% elif record.shift_status == 'malattia' %}
                                        <span class="badge" style="background-color: #fd7e14;">Malattia</span>
                                        {% if record.notes and 'Malattia:' in record.notes %}
                                        <small class="d-block mt-1">{{ record.notes.replace('Malattia:', '').strip()[:50] }}{% if record.notes.replace('Malattia:', '').strip()|length > 50 %}...{% endif %}</small>
                                        {% endif %}
                                        {% elif record.notes %}
                                        <small>{{ record.notes[:50] }}{% if record.notes|length > 50 %}...{% endif %}</small>
                                        {% else %}
                                        <span class="text-muted">--</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    <!-- Legenda indicatori -->
                    <div class="mt-3 p-3 bg-dark border rounded">
                        <h6 class="mb-2 text-light">Legenda Indicatori:</h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <small class="text-light">
                                    <i class="fas fa-exclamation-triangle text-danger me-1"></i>
                                    <strong>Ritardo:</strong> Entrata oltre 15 minuti dopo l'orario di lavoro della sede
                                </small>
                            </div>
                            <div class="col-md-6">
                                <small class="text-light">
                                    <i class="fas fa-thumbs-up text-info me-1"></i>
                                    <strong>Anticipo:</strong> Entrata prima dell'orario di lavoro
                                </small>
                            </div>
                            <div class="col-md-6">
                                <small class="text-light">
                                    <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                    <strong>Uscita Anticipata:</strong> Uscita oltre 5 minuti prima della fine orario
                                </small>
                            </div>
                            <div class="col-md-6">
                                <small class="text-light">
                                    <i class="fas fa-thumbs-up text-info me-1"></i>
                                    <strong>Straordinario:</strong> Uscita oltre 10 minuti dopo la fine orario
                                </small>
                            </div>
                            <div class="col-md-6">
                                <small class="text-success">
                                    <span style="color: #28a745 !important;">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        <strong>Ferie:</strong> Orari standard di lavoro dell'utente (Verde)
                                    </span>
                                </small>
                            </div>
                            <div class="col-md-6">
                                <small style="color: #6f42c1 !important;">
                                    <i class="fas fa-clock me-1"></i>
                                    <strong>Permesso:</strong> Orari specifici della richiesta (Viola)
                                </small>
                            </div>
                            <div class="col-md-6">
                                <small style="color: #fd7e14 !important;">
                                    <i class="fas fa-thermometer-half me-1"></i>
                                    <strong>Malattia:</strong> Orari standard di lavoro dell'utente (Arancione)
                                </small>
                            </div>
                        </div>
                    </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Nessuna presenza registrata nel periodo selezionato.
                </div>
                {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if today_events %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-calendar-day me-2"></i>Attività di Oggi
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if user_status %}
                        <div class="col-md-4">
                            <div class="text-center">
                                <h6 class="text-muted">Stato Attuale</h6>
                                <span class="badge {% if user_status == 'dentro' %}bg-success{% elif user_status == 'pausa' %}bg-warning{% else %}bg-secondary{% endif %} fs-6">
                                    {{ user_status|title }}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if today_events %}
                        <div class="col-md-4">
                            <div class="text-center">
                                <h6 class="text-muted">Eventi Oggi</h6>
                                <p class="mb-0">
                                    {% for event in today_events %}
                                    <small class="d-block">
                                        <span class="badge {% if event.event_type == 'clock_in' %}bg-success{% elif event.event_type == 'clock_out' %}bg-danger{% elif event.event_type == 'break_start' %}bg-warning{% else %}bg-info{% endif %} me-1">
                                            {{ event.event_type }}
                                        </span>
                                        {{ event.timestamp_italian.strftime('%H:%M') }}
                                        {% if event.is_manual %}
                                        <span class="badge bg-secondary ms-1" title="Inserimento manuale">
                                            <i class="fas fa-keyboard"></i>
                                        </span>
                                        {% endif %}
                                    </small>
                                    {% endfor %}
                                </p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if today_work_hours %}
                        <div class="col-md-4">
                            <div class="text-center">
                                <h6 class="text-muted">Ore Lavorate Oggi</h6>
                                <span class="badge bg-primary fs-6">{{ format_hours(today_work_hours) }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal for Timesheet Reopen Request -->
{% if timesheet_is_consolidated and not pending_reopen_request and current_month_timesheet %}
<div class="modal fade" id="requestReopenModal" tabindex="-1" aria-labelledby="requestReopenModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="requestReopenModalLabel">
                    <i class="fas fa-unlock-alt me-2"></i>Richiedi Riapertura Timesheet
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('attendance.request_timesheet_reopen', year=current_month_timesheet.year, month=current_month_timesheet.month) }}" id="requestReopenForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i>
                        Stai richiedendo la riapertura del timesheet per <strong>{{ current_month_timesheet.month }}/{{ current_month_timesheet.year }}</strong>.
                        Un responsabile dovrà approvare la tua richiesta.
                    </div>
                    <div class="mb-3">
                        <label for="reopen_reason" class="form-label">
                            <i class="fas fa-comment-alt me-1"></i>Motivazione della richiesta <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="reopen_reason" name="reason" rows="4" required 
                                  placeholder="Spiega perché hai bisogno di riaprire questo timesheet..."></textarea>
                        <div class="form-text">
                            Fornisci una spiegazione dettagliata per aiutare il responsabile a valutare la tua richiesta.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Annulla
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-paper-plane me-1"></i>Invia Richiesta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
// Funzione per caricare una presenza nel form inline per modifica
function editManualEntry(dateStr) {
    // Scroll al form
    document.getElementById('entry_date_inline').scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Carica i dati via AJAX
    fetch(`/attendance/edit_manual_entry/${dateStr}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('entry_date_inline').value = data.data.date;
                document.getElementById('clock_in_time_inline').value = data.data.clock_in || '';
                document.getElementById('clock_out_time_inline').value = data.data.clock_out || '';
                document.getElementById('break_start_time_inline').value = data.data.break_start || '';
                document.getElementById('break_end_time_inline').value = data.data.break_end || '';
                document.getElementById('notes_inline').value = data.data.notes || '';
                
                // Focus sul primo campo
                document.getElementById('clock_in_time_inline').focus();
            } else {
                alert('Impossibile caricare i dati della presenza');
            }
        })
        .catch(error => {
            console.error('Errore:', error);
            alert('Errore nel caricamento dei dati');
        });
}

// Funzione per pre-popolare la data nel form inline
function addManualEntry(dateStr) {
    // Scroll al form
    document.getElementById('entry_date_inline').scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Pre-popola solo la data
    document.getElementById('entry_date_inline').value = dateStr;
    document.getElementById('clock_in_time_inline').value = '';
    document.getElementById('clock_out_time_inline').value = '';
    document.getElementById('break_start_time_inline').value = '';
    document.getElementById('break_end_time_inline').value = '';
    document.getElementById('notes_inline').value = '';
    
    // Focus sul campo ora entrata
    document.getElementById('clock_in_time_inline').focus();
}

// Funzione per eliminare una presenza manuale
function deleteManualEntry(dateStr) {
    if (confirm('Sei sicuro di voler eliminare questa presenza?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/attendance/delete_manual_entry/${dateStr}`;
        document.body.appendChild(form);
        form.submit();
    }
}
</script>

{% endblock %}