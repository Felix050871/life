{% extends "base.html" %}

{% block title %}Presenze - Gestione Presenze{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-clock me-2"></i>Gestione Presenze</h2>
        <p class="text-muted">Registra le tue ore di lavoro</p>
    </div>
</div>



<!-- Attendance History -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-history me-2"></i>Storico Presenze 
                {% if view_mode == 'team' %}- Team
                {% elif view_mode == 'sede' %}- Sede
                {% else %}- Personali{% endif %}</h5>
                <div class="d-flex gap-2">
                    {% if current_user.role == 'Management' %}
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('attendance', view='personal', start_date=start_date, end_date=end_date) }}" 
                           class="btn btn-sm {% if view_mode == 'personal' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            <i class="fas fa-user me-1"></i>Le Mie
                        </a>
                        <a href="{{ url_for('attendance', view='team', start_date=start_date, end_date=end_date) }}" 
                           class="btn btn-sm {% if view_mode == 'team' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            <i class="fas fa-users me-1"></i>Team
                        </a>
                    </div>
                    {% elif current_user.can_view_attendance() %}
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('attendance', view='personal', start_date=start_date, end_date=end_date) }}" 
                           class="btn btn-sm {% if view_mode == 'personal' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            <i class="fas fa-user me-1"></i>Le Mie
                        </a>
                        {% if current_user.can_view_attendance() %}
                        <a href="{{ url_for('attendance', view='sede', start_date=start_date, end_date=end_date) }}" 
                           class="btn btn-sm {% if view_mode == 'sede' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            <i class="fas fa-building me-1"></i>Sede
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                    <button type="button" class="btn btn-success btn-sm" onclick="exportToCSV()">
                        <i class="fas fa-file-csv me-1"></i>Esporta CSV
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Date Filter Form -->
                <form method="GET" action="{{ url_for('attendance') }}" class="row g-3 mb-4">
                    {% if current_user.role == 'Management' or current_user.can_view_attendance() %}
                    <input type="hidden" name="view" value="{{ view_mode }}">
                    {% endif %}
                    <div class="col-md-3">
                        <label for="start_date" class="form-label">Data Inizio</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" 
                               value="{{ request.args.get('start_date', start_date) }}">
                    </div>
                    <div class="col-md-3">
                        <label for="end_date" class="form-label">Data Fine</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" 
                               value="{{ request.args.get('end_date', end_date) }}">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-filter me-1"></i>Filtra
                        </button>
                        <a href="{{ url_for('attendance', view=view_mode) }}" class="btn btn-outline-secondary">
                            <i class="fas fa-undo me-1"></i>Reset
                        </a>
                    </div>
                </form>
                {% if records %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                {% if show_team_data %}<th>Utente</th>{% endif %}
                                <th>Entrata</th>
                                <th>Pausa</th>
                                <th>Uscita</th>
                                <th>Ore Lavorate</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in records %}
                            <tr {% if record.shift_status == 'assente' %}class="table-danger bg-danger bg-opacity-25"{% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}class="table-info bg-info bg-opacity-10"{% endif %}>
                                <td>
                                    {{ record.date.strftime('%d/%m/%Y') }}
                                    {% if record.shift_status == 'assente' %}
                                    <i class="fas fa-exclamation-circle text-danger ms-2" title="Nessuna presenza e nessuna comunicazione di ferie/permessi/malattia"></i>
                                    {% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}
                                    <i class="fas fa-calendar-alt text-info ms-2" title="{{ record.shift_status|title }}"></i>
                                    {% endif %}
                                </td>
                                {% if show_team_data %}
                                <td>
                                    {% if record.user %}
                                    <span class="text-primary">{{ record.user.get_full_name() }}</span>
                                    <small class="text-muted d-block">{{ record.user.role }}</small>
                                    {% else %}
                                    <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                <td>
                                    {% if record.shift_status == 'assente' %}
                                    <span class="text-danger fw-bold">Nessuna presenza</span>
                                    {% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}
                                    <span class="text-info fw-bold">{{ record.shift_status|title }}</span>
                                    {% elif record.clock_in %}
                                    {% set indicators = record.get_attendance_indicators() %}
                                    <span style="{% if indicators.entry == 'ritardo' %}color: #dc3545 !important;{% elif indicators.entry == 'anticipo' %}color: #0dcaf0 !important;{% else %}color: white !important;{% endif %}">
                                        {{ record.clock_in|format_time_italian }}
                                        {% if indicators.entry == 'ritardo' %}
                                        <i class="fas fa-exclamation-triangle text-danger ms-1" title="Entrata in ritardo"></i>
                                        {% elif indicators.entry == 'anticipo' %}
                                        <i class="fas fa-thumbs-up text-info ms-1" title="Entrata in anticipo"></i>
                                        {% endif %}
                                    </span>
                                    {% else %}
                                    <span class="text-muted">--:--</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.shift_status == 'assente' %}
                                    <span class="text-danger fw-bold">--</span>
                                    {% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}
                                    <span class="text-info">--</span>
                                    {% elif record.break_start and record.break_end %}
                                    <span class="text-warning">{{ record.break_start|format_time_italian }}</span> - 
                                    <span class="text-info">{{ record.break_end|format_time_italian }}</span>
                                    {% elif record.break_start %}
                                    <span class="text-warning">{{ record.break_start|format_time_italian }}</span> - 
                                    <span class="text-muted">--:--</span>
                                    {% else %}
                                    <span class="text-muted">--:--</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.shift_status == 'assente' %}
                                    <span class="text-danger fw-bold">Nessuna presenza</span>
                                    {% elif record.shift_status in ['ferie', 'permesso', 'malattia'] %}
                                    <span class="text-info">--</span>
                                    {% elif record.clock_out %}
                                    {% set indicators = record.get_attendance_indicators() %}
                                    <span style="{% if indicators.exit == 'anticipo' %}color: #ffc107 !important;{% elif indicators.exit == 'straordinario' %}color: #0dcaf0 !important;{% else %}color: white !important;{% endif %}">
                                        {{ record.clock_out|format_time_italian }}
                                        {% if indicators.exit == 'anticipo' %}
                                        <i class="fas fa-exclamation-triangle text-warning ms-1" title="Uscita anticipata"></i>
                                        {% elif indicators.exit == 'straordinario' %}
                                        <i class="fas fa-thumbs-up text-info ms-1" title="Straordinario"></i>
                                        {% endif %}
                                    </span>
                                    {% else %}
                                    <span class="text-muted">--:--</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.shift_status == 'assente' %}
                                    <span class="badge bg-danger">Nessuna presenza</span>
                                    {% elif record.shift_status == 'ferie' %}
                                    <span class="badge bg-success">Ferie</span>
                                    {% elif record.shift_status == 'permesso' %}
                                    <span class="badge bg-warning">Permesso</span>
                                    {% elif record.shift_status == 'malattia' %}
                                    <span class="badge bg-info">Malattia</span>
                                    {% elif record.clock_in and record.clock_out %}
                                    <span class="badge bg-primary">{{ format_hours(record.get_work_hours()) }}</span>
                                    {% else %}
                                    <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.notes %}
                                    <small>{{ record.notes[:50] }}{% if record.notes|length > 50 %}...{% endif %}</small>
                                    {% else %}
                                    <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Legenda indicatori -->
                {% if records %}
                <div class="mt-3 p-3 bg-dark border rounded">
                    <h6 class="mb-2 text-light">Legenda Indicatori:</h6>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <small class="text-light">
                                <i class="fas fa-exclamation-triangle text-danger me-1"></i>
                                <strong>Ritardo:</strong> Entrata oltre 15 minuti dopo l'orario di lavoro della sede
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-light">
                                <i class="fas fa-thumbs-up text-info me-1"></i>
                                <strong>Anticipo:</strong> Entrata prima dell'orario di lavoro
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-light">
                                <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                <strong>Uscita Anticipata:</strong> Uscita oltre 5 minuti prima della fine orario
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-light">
                                <i class="fas fa-thumbs-up text-info me-1"></i>
                                <strong>Straordinario:</strong> Uscita oltre 5 minuti dopo la fine orario
                            </small>
                        </div>
                        <div class="col-12">
                            <small class="text-light">
                                <i class="fas fa-exclamation-circle text-danger me-1"></i>
                                <strong>Nessuna presenza:</strong> Nessuna presenza e nessuna comunicazione di ferie/permessi/malattia
                            </small>
                        </div>
                        <div class="col-12">
                            <small class="text-light">
                                <i class="fas fa-calendar-alt text-info me-1"></i>
                                <strong>Ferie/Permessi/Malattia:</strong> Richieste approvate per assenza autorizzata
                            </small>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% else %}
                <p class="text-muted text-center">Nessuna registrazione trovata</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal di Conferma Personalizzato -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Avvertenza</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Il messaggio verrà inserito qui dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="confirmModalOk">Continua</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('it-IT', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    const timeDisplay = document.getElementById('time-display');
    if (timeDisplay) {
        timeDisplay.textContent = timeString;
    }
}

function exportToCSV() {
    // Costruisce URL con parametri correnti
    const params = new URLSearchParams(window.location.search);
    params.set('format', 'csv');
    
    // Reindirizza al server per scaricare CSV
    const csvUrl = '/export_attendance_csv?' + params.toString();
    window.open(csvUrl, '_blank');
}

// Update time every second
setInterval(updateTime, 1000);
updateTime(); // Initial call

// Handle clock-in with shift verification
async function handleClockIn() {
    try {
        const response = await fetch('{{ url_for("check_shift_before_clock_in") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        
        const data = await response.json();
        
        if (!data.success) {
            alert(data.message);
            return;
        }
        
        if (data.needs_confirmation) {
            showConfirmModal('Avvertenza', data.message, function() {
                submitClockIn();
            });
        } else {
            submitClockIn();
        }
    } catch (error) {
        console.error('Error checking shift:', error);
        showConfirmModal('Errore', 'Errore nella verifica del turno. Vuoi procedere comunque con la registrazione?', function() {
            submitClockIn();
        });
    }
}

// Handle clock-out with shift verification
async function handleClockOut() {
    try {
        const response = await fetch('{{ url_for("check_shift_before_clock_out") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        
        const data = await response.json();
        
        if (!data.success) {
            alert(data.message);
            return;
        }
        
        if (data.needs_confirmation) {
            showConfirmModal('Avvertenza', data.message, function() {
                submitClockOut();
            });
        } else {
            submitClockOut();
        }
    } catch (error) {
        console.error('Error checking shift:', error);
        showConfirmModal('Errore', 'Errore nella verifica del turno. Vuoi procedere comunque con la registrazione?', function() {
            submitClockOut();
        });
    }
}

// Submit clock-in form
function submitClockIn() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("clock_in") }}';
    
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrf_token';
    csrfToken.value = '{{ csrf_token() }}';
    
    form.appendChild(csrfToken);
    document.body.appendChild(form);
    form.submit();
}

// Submit clock-out form
function submitClockOut() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("clock_out") }}';
    
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrf_token';
    csrfToken.value = '{{ csrf_token() }}';
    
    form.appendChild(csrfToken);
    document.body.appendChild(form);
    form.submit();
}

// Funzione per mostrare modal di conferma personalizzato
function showConfirmModal(title, message, onConfirm) {
    document.getElementById('confirmModalLabel').textContent = title;
    document.getElementById('confirmModalBody').textContent = message;
    
    // Rimuovi eventi precedenti
    const okButton = document.getElementById('confirmModalOk');
    const newOkButton = okButton.cloneNode(true);
    okButton.parentNode.replaceChild(newOkButton, okButton);
    
    // Aggiungi nuovo evento
    newOkButton.addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
        modal.hide();
        onConfirm();
    });
    
    // Mostra il modal
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

// Funzione per mostrare modal informativo
function showInfoModal(title, message) {
    // Usa lo stesso modal ma senza il bottone annulla
    document.getElementById('confirmModalLabel').textContent = title;
    document.getElementById('confirmModalBody').textContent = message;
    
    // Nasconde il bottone annulla e cambia il testo del bottone OK
    const modal = document.getElementById('confirmModal');
    const cancelBtn = modal.querySelector('.btn-secondary');
    const okBtn = modal.querySelector('.btn-primary');
    
    cancelBtn.style.display = 'none';
    okBtn.textContent = 'OK';
    
    // Rimuovi eventi precedenti
    const newOkButton = okBtn.cloneNode(true);
    okBtn.parentNode.replaceChild(newOkButton, okBtn);
    
    // Aggiungi evento per chiudere
    newOkButton.addEventListener('click', function() {
        const modalInstance = bootstrap.Modal.getInstance(modal);
        modalInstance.hide();
        
        // Ripristina lo stato originale del modal
        cancelBtn.style.display = 'inline-block';
        newOkButton.textContent = 'Continua';
    });
    
    // Mostra il modal
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
}
</script>
{% endblock %}
