{% extends "base.html" %}

{% block title %}Saldi Ferie e Permessi - Tutti i Dipendenti{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-users me-2"></i>Saldi Ferie e Permessi - Tutti i Dipendenti</h2>
                <p class="text-muted">Visualizza i saldi di ferie e permessi di tutti i dipendenti</p>
            </div>
            <div>
                <a href="{{ url_for('leave.leave_requests', view='view') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-list me-2"></i>Tutte le Richieste
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Summary Stats -->
{% if balances %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h6 class="card-title">Totale Dipendenti</h6>
                <h3 class="mb-0">{{ balances|length }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title">Ferie Totali Maturate</h6>
                <h3 class="mb-0">{{ (balances|sum(attribute='leave.accrued_days'))|round(1) }}</h3>
                <small>giorni</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6 class="card-title">Permessi Totali Maturati</h6>
                <h3 class="mb-0">{{ (balances|sum(attribute='permit.accrued_hours'))|round(1) }}</h3>
                <small>ore</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <h6 class="card-title">Dipendenti con Saldo Negativo</h6>
                <h3 class="mb-0">
                    {{ balances|selectattr('leave.balance_days', 'lt', 0)|list|length + balances|selectattr('permit.balance_hours', 'lt', 0)|list|length }}
                </h3>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Balances Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-table me-2"></i>Saldi per Dipendente
        </h5>
        {% if balances %}
        <button class="btn btn-outline-success btn-sm" onclick="exportToExcel()">
            <i class="fas fa-file-excel me-1"></i>Esporta in Excel
        </button>
        {% endif %}
    </div>
    <div class="card-body">
        {% if balances %}
        <!-- Search/Filter -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Cerca dipendente per nome o username...">
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="balancesTable">
                <thead>
                    <tr>
                        <th>Dipendente</th>
                        <th>Username</th>
                        <th>Data Assunzione</th>
                        <th>Mesi Lavorati</th>
                        <th class="text-center">Ferie Maturate</th>
                        <th class="text-center">Ferie Usufruite</th>
                        <th class="text-center">Ferie Disponibili</th>
                        <th class="text-center">Permessi Maturati</th>
                        <th class="text-center">Permessi Usufruiti</th>
                        <th class="text-center">Permessi Disponibili</th>
                    </tr>
                </thead>
                <tbody>
                    {% for balance in balances %}
                    <tr>
                        <td>
                            <strong>{{ balance.full_name }}</strong>
                        </td>
                        <td>
                            <small class="text-muted">{{ balance.username }}</small>
                        </td>
                        <td>
                            {% if balance.hire_date %}
                            <small>{{ balance.hire_date.strftime('%d/%m/%Y') }}</small>
                            {% else %}
                            <small class="text-muted">--</small>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-secondary">{{ balance.leave.months_worked|round(0) }}</span>
                        </td>
                        <!-- Ferie -->
                        <td class="text-center">
                            <span class="text-success">{{ balance.leave.accrued_days|round(2)|replace('.', ',') }}</span>
                        </td>
                        <td class="text-center">
                            <span class="text-warning">{{ balance.leave.used_days|round(2)|replace('.', ',') }}</span>
                        </td>
                        <td class="text-center">
                            <strong class="{% if balance.leave.balance_days < 0 %}text-danger{% elif balance.leave.balance_days < 5 %}text-warning{% else %}text-primary{% endif %}">
                                {{ balance.leave.balance_days|round(2)|replace('.', ',') }}
                            </strong>
                            {% if balance.leave.balance_days < 0 %}
                            <i class="fas fa-exclamation-triangle text-danger ms-1" title="Saldo negativo"></i>
                            {% endif %}
                        </td>
                        <!-- Permessi -->
                        <td class="text-center">
                            <span class="text-success">{{ balance.permit.accrued_hours|round(2)|replace('.', ',') }}</span>
                        </td>
                        <td class="text-center">
                            <span class="text-warning">{{ balance.permit.used_hours|round(2)|replace('.', ',') }}</span>
                        </td>
                        <td class="text-center">
                            <strong class="{% if balance.permit.balance_hours < 0 %}text-danger{% elif balance.permit.balance_hours < 10 %}text-warning{% else %}text-primary{% endif %}">
                                {{ balance.permit.balance_hours|round(2)|replace('.', ',') }}
                            </strong>
                            {% if balance.permit.balance_hours < 0 %}
                            <i class="fas fa-exclamation-triangle text-danger ms-1" title="Saldo negativo"></i>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>Nessun dipendente trovato con dati HR configurati
        </div>
        {% endif %}
    </div>
</div>

<!-- Info -->
<div class="alert alert-info mt-4">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Note:</strong>
    <ul class="mb-0 mt-2">
        <li>I saldi vengono calcolati in tempo reale in base ai dati HR (maturazione mensile) e alle richieste approvate</li>
        <li>I dipendenti con saldo negativo hanno usufruito pi√π giorni/ore di quelli maturati</li>
        <li>I calcoli tengono conto automaticamente della percentuale part-time se presente</li>
        <li>Vengono visualizzati solo i dipendenti attivi con dati HR configurati</li>
    </ul>
</div>

<!-- jQuery (required for DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable
    var table = $('#balancesTable').DataTable({
        order: [[0, 'asc']], // Ordina per nome dipendente di default
        pageLength: 25,
        language: {
            search: "",
            searchPlaceholder: "Cerca...",
            lengthMenu: "Mostra _MENU_ dipendenti",
            info: "Mostra _START_ a _END_ di _TOTAL_ dipendenti",
            infoEmpty: "Mostra 0 a 0 di 0 dipendenti",
            infoFiltered: "(filtrati da _MAX_ totali)",
            paginate: {
                first: "Primo",
                last: "Ultimo",
                next: "Successivo",
                previous: "Precedente"
            },
            zeroRecords: "Nessun dipendente trovato"
        },
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
        columnDefs: [
            { type: 'num', targets: [3, 4, 5, 6, 7, 8, 9] } // Colonne numeriche
        ]
    });
    
    // Custom search input
    $('#searchInput').on('keyup', function() {
        table.search(this.value).draw();
    });
});

// Export to Excel functionality
function exportToExcel() {
    // Get table element
    var table = document.getElementById('balancesTable');
    
    // Create workbook and worksheet
    var wb = XLSX.utils.table_to_book(table, {sheet: "Saldi Ferie e Permessi"});
    
    // Generate filename with current date
    var today = new Date().toISOString().slice(0,10);
    var filename = 'saldi_ferie_permessi_' + today + '.xlsx';
    
    // Save file
    XLSX.writeFile(wb, filename);
}
</script>

<!-- Include SheetJS library for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

{% endblock %}
