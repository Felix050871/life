{% extends "base.html" %}

{% block title %}Gestione HR - Life Platform{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
        <i class="fas fa-id-card me-2"></i>
        Gestione Risorse Umane
    </h1>
    {% if current_user.can_manage_hr_data() %}
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exportConfigModal">
        <i class="fas fa-filter me-2"></i>Filtri e Export
    </button>
    {% endif %}
</div>

<!-- Summary Cards - Row 1: Demografia e Contratti -->
<div class="row g-3 mb-3">
    <!-- 1. Dipendenti Totali -->
    <div class="col-lg-3 col-md-6">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 opacity-75">Dipendenti Totali</h6>
                        <h2 class="card-title mb-0">{{ statistics.total_employees }}</h2>
                        <small class="opacity-75">
                            <i class="fas fa-check-circle me-1"></i>{{ statistics.with_hr_data }} con dati HR
                        </small>
                    </div>
                    <i class="fas fa-users fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Dipendenti Uomini -->
    <div class="col-lg-3 col-md-6">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 opacity-75">Dipendenti Uomini</h6>
                        <h2 class="card-title mb-0">{{ statistics.male_count }}</h2>
                        <small class="opacity-75">
                            {% if statistics.total_employees > 0 %}
                            {{ (statistics.male_count / statistics.total_employees * 100)|round(1) }}% del totale
                            {% else %}
                            0% del totale
                            {% endif %}
                        </small>
                    </div>
                    <i class="fas fa-mars fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Dipendenti Donne -->
    <div class="col-lg-3 col-md-6">
        <div class="card text-white h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 opacity-75">Dipendenti Donne</h6>
                        <h2 class="card-title mb-0">{{ statistics.female_count }}</h2>
                        <small class="opacity-75">
                            {% if statistics.total_employees > 0 %}
                            {{ (statistics.female_count / statistics.total_employees * 100)|round(1) }}% del totale
                            {% else %}
                            0% del totale
                            {% endif %}
                        </small>
                    </div>
                    <i class="fas fa-venus fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Contratti Attivi -->
    <div class="col-lg-3 col-md-6">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 opacity-75">Contratti Attivi</h6>
                        <h2 class="card-title mb-0">{{ statistics.active_contracts }}</h2>
                        <small class="opacity-75">
                            <i class="fas fa-hourglass-half me-1"></i>{{ statistics.in_probation }} in prova
                        </small>
                    </div>
                    <i class="fas fa-file-contract fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards - Row 2: Tipologie Contrattuali e Fasce d'Età -->
<div class="row g-3 mb-4">
    <!-- 5. Tempo Indeterminato -->
    <div class="col-lg-3 col-md-6">
        <div class="card text-white h-100" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 opacity-75">Tempo Indeterminato</h6>
                        <h2 class="card-title mb-0">{{ statistics.tempo_indeterminato }}</h2>
                        <small class="opacity-75">
                            <i class="fas fa-infinity me-1"></i>Contratti permanenti
                        </small>
                    </div>
                    <i class="fas fa-handshake fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. Tempo Determinato -->
    <div class="col-lg-3 col-md-6">
        <div class="card bg-warning text-dark h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 opacity-75">Tempo Determinato</h6>
                        <h2 class="card-title mb-0">{{ statistics.tempo_determinato }}</h2>
                        <small class="opacity-75">
                            <i class="fas fa-calendar-alt me-1"></i>Contratti a termine
                        </small>
                    </div>
                    <i class="fas fa-clock fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. Under 36 -->
    <div class="col-lg-3 col-md-6">
        <div class="card text-white h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 opacity-75">Under 36</h6>
                        <h2 class="card-title mb-0">{{ statistics.under_36 }}</h2>
                        <small class="opacity-75">
                            <i class="fas fa-birthday-cake me-1"></i>Giovani lavoratori
                        </small>
                    </div>
                    <i class="fas fa-user-graduate fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 8. Over 36 -->
    <div class="col-lg-3 col-md-6">
        <div class="card bg-secondary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 opacity-75">Over 36</h6>
                        <h2 class="card-title mb-0">{{ statistics.total_employees - statistics.under_36 }}</h2>
                        <small class="opacity-75">
                            <i class="fas fa-user-tie me-1"></i>Esperienza matura
                        </small>
                    </div>
                    <i class="fas fa-user-check fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Criticità Cards -->
{% if statistics.contracts_expiring > 0 or statistics.expired_certifications > 0 or statistics.expiring_certifications > 0 %}
<div class="row g-3 mb-4">
    <div class="col-12">
        <h5 class="text-warning mb-3">
            <i class="fas fa-exclamation-triangle me-2"></i>Criticità da Gestire
        </h5>
    </div>
    
    <!-- Contratti in Scadenza -->
    {% if statistics.contracts_expiring > 0 %}
    <div class="col-lg-4 col-md-6">
        <div class="card bg-danger text-white h-100 alert-card" style="cursor: pointer;" data-filter-type="contract-expiring">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 opacity-75">Contratti in Scadenza</h6>
                        <h2 class="card-title mb-0">{{ statistics.contracts_expiring }}</h2>
                        <small class="opacity-75">
                            <i class="fas fa-calendar-times me-1"></i>Entro 60 giorni
                        </small>
                    </div>
                    <i class="fas fa-hourglass-end fa-3x opacity-50"></i>
                </div>
                <div class="mt-3">
                    <small class="opacity-75">
                        <i class="fas fa-hand-pointer me-1"></i>Clicca per filtrare
                    </small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Certificazioni Scadute -->
    {% if statistics.expired_certifications > 0 %}
    <div class="col-lg-4 col-md-6">
        <div class="card text-white h-100 alert-card" style="cursor: pointer; background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);" data-filter-type="cert-expired">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 opacity-75">Certificazioni Scadute</h6>
                        <h2 class="card-title mb-0">{{ statistics.expired_certifications }}</h2>
                        <small class="opacity-75">
                            <i class="fas fa-times-circle me-1"></i>Immediate
                        </small>
                    </div>
                    <i class="fas fa-certificate fa-3x opacity-50"></i>
                </div>
                <div class="mt-3">
                    <small class="opacity-75">
                        <i class="fas fa-hand-pointer me-1"></i>Clicca per filtrare
                    </small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Certificazioni in Scadenza -->
    {% if statistics.expiring_certifications > 0 %}
    <div class="col-lg-4 col-md-6">
        <div class="card bg-warning text-dark h-100 alert-card" style="cursor: pointer;" data-filter-type="cert-expiring">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 opacity-75">Certificazioni in Scadenza</h6>
                        <h2 class="card-title mb-0">{{ statistics.expiring_certifications }}</h2>
                        <small class="opacity-75">
                            <i class="fas fa-exclamation-circle me-1"></i>In scadenza
                        </small>
                    </div>
                    <i class="fas fa-award fa-3x opacity-50"></i>
                </div>
                <div class="mt-3">
                    <small class="opacity-75">
                        <i class="fas fa-hand-pointer me-1"></i>Clicca per filtrare
                    </small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Filters Bar -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-lg-4 col-md-6">
                <label class="form-label small text-muted">
                    <i class="fas fa-search me-1"></i>Ricerca
                </label>
                <input type="text" id="searchInput" class="form-control" 
                       placeholder="Cerca per nome, matricola, email...">
            </div>
            <div class="col-lg-2 col-md-6">
                <label class="form-label small text-muted">
                    <i class="fas fa-venus-mars me-1"></i>Genere
                </label>
                <select id="filterGender" class="form-select">
                    <option value="">Tutti</option>
                    <option value="M">Uomini</option>
                    <option value="F">Donne</option>
                </select>
            </div>
            <div class="col-lg-2 col-md-6">
                <label class="form-label small text-muted">
                    <i class="fas fa-building me-1"></i>Sede
                </label>
                <select id="filterSede" class="form-select">
                    <option value="">Tutte le sedi</option>
                    {% for sede in sedi %}
                    <option value="{{ sede.name }}">{{ sede.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2 col-md-6">
                <label class="form-label small text-muted">
                    <i class="fas fa-file-contract me-1"></i>Tipo Contratto
                </label>
                <select id="filterContract" class="form-select">
                    <option value="">Tutti</option>
                    <option value="Tempo Indeterminato">Tempo Indeterminato</option>
                    <option value="Tempo Determinato">Tempo Determinato</option>
                </select>
            </div>
            <div class="col-lg-2 col-md-6">
                <label class="form-label small text-muted">
                    <i class="fas fa-file-contract me-1"></i>Contratto
                </label>
                <select id="filterStatus" class="form-select">
                    <option value="">Tutti</option>
                    <option value="Attivo" selected>Attivi</option>
                    <option value="Non attivo">Non attivi</option>
                </select>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <button id="clearFilters" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-times me-1"></i>Pulisci Filtri
                </button>
                <span id="filterCount" class="ms-3 text-muted small"></span>
            </div>
        </div>
    </div>
</div>

<!-- HR Data Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-list me-2"></i>Elenco Dipendenti
        </h5>
        <span id="resultCount" class="badge bg-primary">{{ users_data|length }} dipendenti</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="hrTable" class="table table-hover">
                <thead>
                    <tr>
                        <th class="sortable" data-column="0" style="cursor: pointer;">
                            Matricola <i class="fas fa-sort ms-1 text-muted"></i>
                        </th>
                        <th class="sortable" data-column="1" style="cursor: pointer;">
                            Dipendente <i class="fas fa-sort ms-1 text-muted"></i>
                        </th>
                        <th class="sortable" data-column="2" style="cursor: pointer;">
                            Sede <i class="fas fa-sort ms-1 text-muted"></i>
                        </th>
                        <th class="sortable" data-column="3" style="cursor: pointer;">
                            Tipo Contratto <i class="fas fa-sort ms-1 text-muted"></i>
                        </th>
                        <th class="sortable" data-column="4" style="cursor: pointer;">
                            Data Assunzione <i class="fas fa-sort ms-1 text-muted"></i>
                        </th>
                        <th class="sortable" data-column="5" style="cursor: pointer;">
                            Certificazioni <i class="fas fa-sort ms-1 text-muted"></i>
                        </th>
                        <th class="sortable" data-column="6" style="cursor: pointer;">
                            Contratto <i class="fas fa-sort ms-1 text-muted"></i>
                        </th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in users_data %}
                    <tr data-gender="{{ data.gender or '' }}" 
                        data-age="{{ data.age or '' }}"
                        data-contract="{{ data.contract_type }}"
                        data-status="{{ data.contract_status }}"
                        data-sede="{{ data.hr_data.sede.name if data.hr_data and data.hr_data.sede else '' }}"
                        data-contract-expiring="{{ 'true' if data.contract_expiring else 'false' }}"
                        data-cert-expired="{{ 'true' if data.has_expired_certs else 'false' }}"
                        data-cert-expiring="{{ 'true' if data.has_expiring_certs else 'false' }}">
                        <td>
                            {% if data.has_data %}
                            <strong>{{ data.matricola }}</strong>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if data.user.profile_image %}
                            <img src="{{ url_for('static', filename='uploads/profiles/' + data.user.profile_image) }}" 
                                 alt="{{ data.user.get_full_name() }}" 
                                 class="rounded-circle me-2" 
                                 style="width: 32px; height: 32px; object-fit: cover;">
                            {% else %}
                            <i class="fas fa-user-circle fa-2x me-2 text-muted"></i>
                            {% endif %}
                            <strong>{{ data.user.get_full_name() }}</strong>
                            {% if data.gender %}
                            <span class="ms-1 small text-muted">
                                {% if data.gender == 'F' %}
                                <i class="fas fa-venus text-info"></i>
                                {% elif data.gender == 'M' %}
                                <i class="fas fa-mars text-primary"></i>
                                {% endif %}
                            </span>
                            {% endif %}
                            <br><small class="text-muted">{{ data.user.role }}
                            {% if data.age %}
                            - {{ data.age }} anni
                            {% endif %}
                            </small>
                        </td>
                        <td>
                            {% if data.hr_data and data.hr_data.sede %}
                            <i class="fas fa-building me-1 text-primary"></i>{{ data.hr_data.sede.name }}
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ data.contract_type }}</td>
                        <td>{{ data.hire_date }}</td>
                        <td class="text-center">
                            {% if data.expiry_status %}
                                {% if data.expiry_status.color == 'danger' %}
                                    <span class="badge bg-danger" 
                                          data-bs-toggle="tooltip" 
                                          data-bs-placement="top" 
                                          title="{{ data.expiry_status.name }}: {{ data.expiry_status.text }}">
                                        <i class="fas {{ data.expiry_status.icon }} me-1"></i>Scaduta
                                    </span>
                                {% elif data.expiry_status.color == 'warning' %}
                                    <span class="badge bg-warning text-dark" 
                                          data-bs-toggle="tooltip" 
                                          data-bs-placement="top" 
                                          title="{{ data.expiry_status.name }}: {{ data.expiry_status.text }}">
                                        <i class="fas {{ data.expiry_status.icon }} me-1"></i>{{ data.expiry_status.days_left }}gg
                                    </span>
                                {% elif data.expiry_status.color == 'orange' %}
                                    <span class="badge bg-info text-dark" 
                                          data-bs-toggle="tooltip" 
                                          data-bs-placement="top" 
                                          title="{{ data.expiry_status.name }}: {{ data.expiry_status.text }}">
                                        <i class="fas {{ data.expiry_status.icon }} me-1"></i>{{ data.expiry_status.days_left }}gg
                                    </span>
                                {% else %}
                                    <span class="badge bg-success" 
                                          data-bs-toggle="tooltip" 
                                          data-bs-placement="top" 
                                          title="{{ data.expiry_status.name }}: {{ data.expiry_status.text }}">
                                        <i class="fas {{ data.expiry_status.icon }} me-1"></i>OK
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted small">N/D</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if data.contract_status == 'Attivo' %}
                            <span class="badge bg-success">
                                <i class="fas fa-check me-1"></i>Attivo
                            </span>
                            {% elif data.contract_status == 'Non attivo' %}
                            <span class="badge bg-danger">
                                <i class="fas fa-times me-1"></i>Non attivo
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">{{ data.contract_status }}</span>
                            {% endif %}
                            
                            {% if data.is_probation %}
                            <span class="badge bg-warning ms-1">
                                <i class="fas fa-hourglass-half me-1"></i>In prova
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('hr.hr_detail', user_id=data.user.id) }}" 
                               class="btn btn-sm btn-outline-primary" 
                               title="Visualizza Dettagli">
                                <i class="fas fa-eye"></i>
                                {% if current_user.can_manage_hr_data() %}Gestisci{% else %}Visualizza{% endif %}
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-info-circle me-2"></i>
                            Nessun dipendente trovato.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Export Personalizzato -->
<div class="modal fade" id="exportConfigModal" tabindex="-1" aria-labelledby="exportConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportConfigModalLabel">
                    <i class="fas fa-filter me-2"></i>Filtri Personalizzati
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="exportConfigForm" method="POST" action="{{ url_for('hr.hr_list') }}">
                <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Seleziona i campi da includere nell'export e applica eventuali filtri. La lista a video e l'export Excel saranno filtrati di conseguenza.
                    </div>
                    
                    <!-- Pulsanti Seleziona Tutto / Deseleziona Tutto -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllFields()">
                            <i class="fas fa-check-double me-1"></i>Seleziona Tutti
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllFields()">
                            <i class="fas fa-times me-1"></i>Deseleziona Tutti
                        </button>
                    </div>
                    
                    <!-- Accordion per categorie -->
                    <div class="accordion" id="exportFieldsAccordion">
                        <!-- SEZIONE 1: DATI CONTRATTUALI -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#contrattualiSection">
                                    <i class="fas fa-file-contract me-2"></i>DATI CONTRATTUALI
                                </button>
                            </h2>
                            <div id="contrattualiSection" class="accordion-collapse collapse show" data-bs-parent="#exportFieldsAccordion">
                                <div class="accordion-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="matricola" id="field_matricola" checked>
                                                <label class="form-check-label" for="field_matricola">Matricola</label>
                                            </div>
                                            <input type="text" class="form-control form-control-sm mt-1" name="filter_matricola" placeholder="Filtro...">
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="hire_date" id="field_hire_date" checked>
                                                <label class="form-check-label" for="field_hire_date">Data Assunzione</label>
                                            </div>
                                            <input type="date" class="form-control form-control-sm mt-1" name="filter_hire_date" placeholder="Filtro data...">
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="contract_type" id="field_contract_type" checked>
                                                <label class="form-check-label" for="field_contract_type">Tipo Contratto</label>
                                            </div>
                                            <select class="form-select form-select-sm mt-1" name="filter_contract_type">
                                                <option value="">Tutti</option>
                                                <option value="Tempo Indeterminato">Tempo Indeterminato</option>
                                                <option value="Tempo Determinato">Tempo Determinato</option>
                                                <option value="Apprendistato">Apprendistato</option>
                                                <option value="Stage/Tirocinio">Stage/Tirocinio</option>
                                                <option value="Collaborazione">Collaborazione</option>
                                                <option value="In Distacco">In Distacco</option>
                                                <option value="Consulente/P.IVA">Consulente/P.IVA</option>
                                                <option value="Altro">Altro</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="ccnl" id="field_ccnl" checked>
                                                <label class="form-check-label" for="field_ccnl">CCNL</label>
                                            </div>
                                            <input type="text" class="form-control form-control-sm mt-1" name="filter_ccnl" placeholder="Filtro...">
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="mansione" id="field_mansione" checked>
                                                <label class="form-check-label" for="field_mansione">Mansione</label>
                                            </div>
                                            <input type="text" class="form-control form-control-sm mt-1" name="filter_mansione" placeholder="Filtro...">
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="qualifica" id="field_qualifica" checked>
                                                <label class="form-check-label" for="field_qualifica">Qualifica</label>
                                            </div>
                                            <input type="text" class="form-control form-control-sm mt-1" name="filter_qualifica" placeholder="Filtro...">
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="sede_assunzione" id="field_sede_assunzione" checked>
                                                <label class="form-check-label" for="field_sede_assunzione">Sede Assunzione</label>
                                            </div>
                                            <select class="form-select form-select-sm mt-1" name="filter_sede_assunzione">
                                                <option value="">Tutte</option>
                                                {% for sede in all_sedi %}
                                                <option value="{{ sede.id }}">{{ sede.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SEZIONE 2: ANAGRAFICA RISORSA -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#anagraficaSection">
                                    <i class="fas fa-address-card me-2"></i>ANAGRAFICA RISORSA
                                </button>
                            </h2>
                            <div id="anagraficaSection" class="accordion-collapse collapse" data-bs-parent="#exportFieldsAccordion">
                                <div class="accordion-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="education_level" id="field_education_level" checked>
                                                <label class="form-check-label" for="field_education_level">Titolo di Studio</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="birth_date" id="field_birth_date" checked>
                                                <label class="form-check-label" for="field_birth_date">Data di Nascita</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="gender" id="field_gender" checked>
                                                <label class="form-check-label" for="field_gender">Sesso</label>
                                            </div>
                                            <select class="form-select form-select-sm mt-1" name="filter_gender">
                                                <option value="">Tutti</option>
                                                <option value="M">Maschio</option>
                                                <option value="F">Femmina</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="codice_fiscale" id="field_codice_fiscale" checked>
                                                <label class="form-check-label" for="field_codice_fiscale">Codice Fiscale</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="city" id="field_city" checked>
                                                <label class="form-check-label" for="field_city">Città Residenza</label>
                                            </div>
                                            <input type="text" class="form-control form-control-sm mt-1" name="filter_city" placeholder="Filtro...">
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="phone" id="field_phone" checked>
                                                <label class="form-check-label" for="field_phone">Telefono</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="driver_license" id="field_driver_license" checked>
                                                <label class="form-check-label" for="field_driver_license">Patente</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SEZIONE 3: VISITE E FORMAZIONE -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#formazioneSection">
                                    <i class="fas fa-graduation-cap me-2"></i>VISITE E FORMAZIONE
                                </button>
                            </h2>
                            <div id="formazioneSection" class="accordion-collapse collapse" data-bs-parent="#exportFieldsAccordion">
                                <div class="accordion-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="medical_visit" id="field_medical_visit" checked>
                                                <label class="form-check-label" for="field_medical_visit">Visita Medica</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="training_general" id="field_training_general" checked>
                                                <label class="form-check-label" for="field_training_general">Formazione Generale</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="training_rspp" id="field_training_rspp" checked>
                                                <label class="form-check-label" for="field_training_rspp">Formazione RSPP</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input field-checkbox" type="checkbox" name="fields" value="training_first_aid" id="field_training_first_aid" checked>
                                                <label class="form-check-label" for="field_training_first_aid">Formazione Primo Soccorso</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Annulla
                    </button>
                    <a href="{{ url_for('hr.hr_reset_filters') }}" class="btn btn-warning">
                        <i class="fas fa-redo me-1"></i>Resetta Filtri
                    </a>
                    <button type="submit" name="action" value="apply_filters" class="btn btn-primary">
                        <i class="fas fa-filter me-1"></i>Applica Filtri
                    </button>
                    <button type="submit" name="action" value="export" class="btn btn-success">
                        <i class="fas fa-file-excel me-1"></i>Export Excel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.opacity-50 {
    opacity: 0.5;
}
.opacity-75 {
    opacity: 0.75;
}
</style>

<script>
function selectAllFields() {
    document.querySelectorAll('.field-checkbox').forEach(cb => cb.checked = true);
}

function deselectAllFields() {
    document.querySelectorAll('.field-checkbox').forEach(cb => cb.checked = false);
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    const searchInput = document.getElementById('searchInput');
    const filterGender = document.getElementById('filterGender');
    const filterSede = document.getElementById('filterSede');
    const filterContract = document.getElementById('filterContract');
    const filterStatus = document.getElementById('filterStatus');
    const clearButton = document.getElementById('clearFilters');
    const table = document.getElementById('hrTable');
    const resultCount = document.getElementById('resultCount');
    const filterCount = document.getElementById('filterCount');
    
    // Variable to track alert card filter
    let alertCardFilter = null;
    
    // Alert card click handlers
    const alertCards = document.querySelectorAll('.alert-card');
    alertCards.forEach(card => {
        card.addEventListener('click', function() {
            const filterType = this.getAttribute('data-filter-type');
            
            // Toggle filter if clicking same card
            if (alertCardFilter === filterType) {
                alertCardFilter = null;
                // Remove active styling from all cards
                alertCards.forEach(c => {
                    c.style.border = '';
                    c.style.boxShadow = '';
                });
            } else {
                alertCardFilter = filterType;
                // Remove active styling from all cards
                alertCards.forEach(c => {
                    c.style.border = '';
                    c.style.boxShadow = '';
                });
                // Add active styling to clicked card
                this.style.border = '3px solid white';
                this.style.boxShadow = '0 0 20px rgba(255,255,255,0.5)';
            }
            
            // Clear other filters when clicking alert card
            searchInput.value = '';
            filterGender.value = '';
            filterSede.value = '';
            filterContract.value = '';
            filterStatus.value = '';
            
            filterTable();
        });
    });
    
    // Attach event listeners
    searchInput.addEventListener('input', filterTable);
    filterGender.addEventListener('change', filterTable);
    filterSede.addEventListener('change', filterTable);
    filterContract.addEventListener('change', filterTable);
    filterStatus.addEventListener('change', filterTable);
    clearButton.addEventListener('click', clearFilters);
    
    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const genderFilter = filterGender.value;
        const sedeFilter = filterSede.value;
        const contractFilter = filterContract.value;
        const statusFilter = filterStatus.value;
        
        const rows = table.querySelectorAll('tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            // Skip empty state row
            if (row.querySelector('td[colspan]')) {
                row.style.display = 'none';
                return;
            }
            
            const cells = row.querySelectorAll('td');
            const matricola = cells[0].textContent.toLowerCase();
            const nome = cells[1].textContent.toLowerCase();
            const sede = cells[2].textContent.trim();
            const contratto = cells[3].textContent.trim();
            const status = row.getAttribute('data-status');
            const gender = row.getAttribute('data-gender');
            const rowSede = row.getAttribute('data-sede');
            const contractExpiring = row.getAttribute('data-contract-expiring');
            const certExpired = row.getAttribute('data-cert-expired');
            const certExpiring = row.getAttribute('data-cert-expiring');
            
            // Apply filters
            let matchesSearch = searchTerm === '' || 
                               matricola.includes(searchTerm) || 
                               nome.includes(searchTerm);
            
            let matchesGender = genderFilter === '' || gender === genderFilter;
            let matchesSede = sedeFilter === '' || rowSede === sedeFilter;
            let matchesContract = contractFilter === '' || contratto === contractFilter;
            let matchesStatus = statusFilter === '' || status === statusFilter;
            
            // Alert card filter
            let matchesAlertFilter = true;
            if (alertCardFilter === 'contract-expiring') {
                matchesAlertFilter = contractExpiring === 'true';
            } else if (alertCardFilter === 'cert-expired') {
                matchesAlertFilter = certExpired === 'true';
            } else if (alertCardFilter === 'cert-expiring') {
                matchesAlertFilter = certExpiring === 'true';
            }
            
            if (matchesSearch && matchesGender && matchesSede && matchesContract && matchesStatus && matchesAlertFilter) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update result count
        resultCount.textContent = visibleCount + ' dipendenti';
        
        // Update filter count message
        const activeFilters = [];
        if (searchTerm) activeFilters.push('ricerca');
        if (genderFilter) activeFilters.push('genere');
        if (sedeFilter) activeFilters.push('sede');
        if (contractFilter) activeFilters.push('contratto');
        if (statusFilter) activeFilters.push('stato');
        if (alertCardFilter === 'contract-expiring') activeFilters.push('contratti in scadenza');
        if (alertCardFilter === 'cert-expired') activeFilters.push('certificazioni scadute');
        if (alertCardFilter === 'cert-expiring') activeFilters.push('certificazioni in scadenza');
        
        if (activeFilters.length > 0) {
            filterCount.textContent = `Filtri attivi: ${activeFilters.join(', ')}`;
            filterCount.classList.add('text-primary');
            filterCount.classList.remove('text-muted');
        } else {
            filterCount.textContent = '';
            filterCount.classList.remove('text-primary');
            filterCount.classList.add('text-muted');
        }
    }
    
    function clearFilters() {
        searchInput.value = '';
        filterGender.value = '';
        filterSede.value = '';
        filterContract.value = '';
        filterStatus.value = '';
        alertCardFilter = null;
        
        // Remove active styling from all alert cards
        alertCards.forEach(c => {
            c.style.border = '';
            c.style.boxShadow = '';
        });
        
        filterTable();
    }
    
    // Table sorting functionality
    const sortableHeaders = document.querySelectorAll('.sortable');
    let currentSortColumn = null;
    let currentSortDirection = 'asc';
    
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const column = parseInt(this.getAttribute('data-column'));
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => !row.querySelector('td[colspan]'));
            
            // Determine sort direction
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortDirection = 'asc';
                currentSortColumn = column;
            }
            
            // Update all header icons
            sortableHeaders.forEach(h => {
                const icon = h.querySelector('i');
                icon.className = 'fas fa-sort ms-1 text-muted';
            });
            
            // Update current header icon
            const currentIcon = this.querySelector('i');
            if (currentSortDirection === 'asc') {
                currentIcon.className = 'fas fa-sort-up ms-1 text-primary';
            } else {
                currentIcon.className = 'fas fa-sort-down ms-1 text-primary';
            }
            
            // Sort rows
            rows.sort((a, b) => {
                let aValue = a.cells[column].textContent.trim();
                let bValue = b.cells[column].textContent.trim();
                
                // Special handling for dates (column 4 - Data Assunzione)
                if (column === 4) {
                    // Convert DD/MM/YYYY to comparable format
                    const parseDate = (dateStr) => {
                        if (dateStr === '-') return new Date(0);
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            return new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                        return new Date(0);
                    };
                    aValue = parseDate(aValue);
                    bValue = parseDate(bValue);
                }
                
                // Compare values
                let comparison = 0;
                if (aValue > bValue) {
                    comparison = 1;
                } else if (aValue < bValue) {
                    comparison = -1;
                }
                
                return currentSortDirection === 'asc' ? comparison : -comparison;
            });
            
            // Reorder rows in DOM
            rows.forEach(row => tbody.appendChild(row));
        });
    });
    
    // Apply default filter on page load (show only active contracts)
    filterTable();
});
</script>
{% endblock %}
