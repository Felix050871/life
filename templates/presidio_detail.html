{% extends "base.html" %}

{% block title %}Dettaglio Presidio - Gestione Presenze{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-shield-alt me-2"></i>Dettaglio Presidio
        <small class="text-muted">{{ start_date.strftime('%d/%m/%Y') }} - {{ end_date.strftime('%d/%m/%Y') }}</small>
    </h1>
    <div>
        <a href="{{ url_for('presidio_coverage') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Torna alla Lista
        </a>
        <a href="{{ url_for('edit_presidio_coverage', coverage_id=coverage_by_day[coverage_by_day.keys()|list|first][0].id) }}" 
           class="btn btn-primary">
            <i class="fas fa-edit me-1"></i>Modifica Presidio
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-week me-2"></i>Coperture Settimanali
                </h5>
            </div>
            <div class="card-body">
                {% if coverage_by_day %}
                    {% for day_num in range(7) %}
                        {% set day_name = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'][day_num] %}
                        <div class="row mb-4">
                            <div class="col-md-2">
                                <h6 class="text-primary fw-bold">{{ day_name }}</h6>
                            </div>
                            <div class="col-md-10">
                                {% if day_num in coverage_by_day %}
                                    {% for coverage in coverage_by_day[day_num] %}
                                        <div class="card mb-2 border-start border-primary border-3">
                                            <div class="card-body py-2">
                                                <div class="row align-items-center">
                                                    <div class="col-md-3">
                                                        <span class="badge bg-secondary">
                                                            {{ coverage.get_time_range() }}
                                                        </span>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <span class="badge bg-info">
                                                            {{ coverage.get_required_roles_display() }}
                                                        </span>
                                                    </div>
                                                    <div class="col-md-4">
                                                        {% if coverage.description %}
                                                            <small class="text-muted">{{ coverage.description }}</small>
                                                        {% else %}
                                                            <small class="text-muted">Nessuna descrizione</small>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-md-2 text-end">
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="{{ url_for('edit_presidio_coverage', coverage_id=coverage.id) }}" 
                                                               class="btn btn-outline-primary btn-sm">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            <form method="POST" action="{{ url_for('delete_presidio_coverage', coverage_id=coverage.id) }}" 
                                                                  class="d-inline confirm-form" data-message="Sei sicuro di voler eliminare questa copertura?">
                                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                                <button type="submit" class="btn btn-outline-danger btn-sm">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>Nessuna copertura configurata
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% if not loop.last %}<hr>{% endif %}
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-shield-alt fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">Nessuna Copertura Configurata</h4>
                        <p class="text-muted">Non ci sono coperture configurate per questo periodo.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Informazioni Presidio
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Periodo di Validità:</strong> {{ start_date.strftime('%d/%m/%Y') }} - {{ end_date.strftime('%d/%m/%Y') }}</p>
                        <p><strong>Numero Coperture:</strong> {{ coverage_by_day.values()|list|length }}</p>
                    </div>
                    <div class="col-md-6">
                        {% if coverage_by_day %}
                            {% set sample_coverage = coverage_by_day[coverage_by_day.keys()|list|first][0] %}
                            <p><strong>Creato da:</strong> {{ sample_coverage.creator.get_full_name() }}</p>
                            <p><strong>Data Creazione:</strong> {{ sample_coverage.created_at.strftime('%d/%m/%Y alle %H:%M') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Gestione modal di conferma personalizzato per evitare "una pagina incorporata"
document.addEventListener('DOMContentLoaded', function() {
    // Intercetta tutti i form con class="confirm-form"
    document.querySelectorAll('.confirm-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = this.dataset.message || 'Sei sicuro di voler procedere?';
            showCustomConfirm(message, () => {
                this.submit();
            });
        });
    });
});

function showCustomConfirm(message, onConfirm) {
    let modal = document.getElementById('customConfirmModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.innerHTML = `
            <div class="modal fade" id="customConfirmModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Conferma</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="customConfirmBody">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                            <button type="button" class="btn btn-primary" id="customConfirmOk">Conferma</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal = document.getElementById('customConfirmModal');
    }
    
    document.getElementById('customConfirmBody').textContent = message;
    
    const okBtn = document.getElementById('customConfirmOk');
    okBtn.onclick = function() {
        const modalInstance = bootstrap.Modal.getInstance(modal);
        modalInstance.hide();
        if (onConfirm) onConfirm();
    };
    
    new bootstrap.Modal(modal).show();
}
</script>
{% endblock %}