{% extends "base.html" %}

{% block title %}Le Mie Presenze - {{ month_name }} {{ year }}{% endblock %}

{% block content %}
<!-- Overlay di caricamento -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
    <div class="text-center">
        <div class="spinner-border text-light" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">Caricamento...</span>
        </div>
        <div class="mt-3 text-white h4" id="loadingText">Elaborazione in corso...</div>
    </div>
</div>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-check me-2"></i>
                        Le Mie Presenze - {{ month_name }} {{ year }}
                    </h5>
                </div>

                <div class="card-body">
                    <!-- Navigazione mese e pulsanti azione -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="btn-group" role="group">
                                {% if month > 1 %}
                                <a href="{{ url_for('attendance.my_attendance', year=year, month=month-1) }}" class="btn btn-outline-primary">
                                    <i class="fas fa-chevron-left"></i> {{ ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'][month-1] }}
                                </a>
                                {% else %}
                                <a href="{{ url_for('attendance.my_attendance', year=year-1, month=12) }}" class="btn btn-outline-primary">
                                    <i class="fas fa-chevron-left"></i> Dicembre {{ year - 1 }}
                                </a>
                                {% endif %}
                                
                                <button type="button" class="btn btn-primary" disabled>
                                    {{ month_name }} {{ year }}
                                </button>
                                
                                {% if month < 12 %}
                                <a href="{{ url_for('attendance.my_attendance', year=year, month=month+1) }}" class="btn btn-outline-primary">
                                    {{ ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'][month+1] }} <i class="fas fa-chevron-right"></i>
                                </a>
                                {% else %}
                                <a href="{{ url_for('attendance.my_attendance', year=year+1, month=1) }}" class="btn btn-outline-primary">
                                    Gennaio {{ year + 1 }} <i class="fas fa-chevron-right"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            {% if can_edit %}
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-info" onclick="bulkFillTimesheet()">
                                    <i class="fas fa-magic me-1"></i>Compila Automaticamente
                                </button>
                                <button type="button" class="btn btn-success" onclick="saveAllSessions()">
                                    <i class="fas fa-save me-1"></i>Salva Tutto
                                </button>
                                {% if not timesheet.is_consolidated %}
                                <button type="button" class="btn btn-warning" onclick="consolidateTimesheet()">
                                    <i class="fas fa-lock me-1"></i>Consolida Timesheet
                                </button>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if timesheet.is_consolidated %}
                    <div class="alert alert-info">
                        <i class="fas fa-lock me-2"></i>
                        <strong>Timesheet Consolidato</strong><br>
                        Questo timesheet è stato consolidato il {{ timesheet.consolidated_at.strftime('%d/%m/%Y alle %H:%M') }} e non può più essere modificato.
                    </div>
                    {% endif %}

                    <!-- Tabella presenze -->
                    <form id="attendanceForm" method="POST" action="{{ url_for('attendance.save_month_sessions') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="year" value="{{ year }}">
                        <input type="hidden" name="month" value="{{ month }}">
                        <input type="hidden" name="timesheet_id" value="{{ timesheet.id }}">
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover" id="attendanceTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 6%;">Giorno</th>
                                        <th style="width: 8%;">Data</th>
                                        <th style="width: 10%;">Commessa</th>
                                        <th style="width: 10%;">Tipologia</th>
                                        <th style="width: 7%;">Entrata</th>
                                        <th style="width: 7%;">Inizio Pausa</th>
                                        <th style="width: 7%;">Fine Pausa</th>
                                        <th style="width: 7%;">Uscita</th>
                                        <th style="width: 6%;">Tot Ore</th>
                                        <th style="width: 10%;">Stato</th>
                                        <th style="width: 12%;">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for day_row in grid %}
                                    <!-- Mostra assenza se presente -->
                                    {% if day_row.leave_block %}
                                    <tr class="{{ day_row.leave_block.highlight_class }}">
                                        <td>{{ day_row.weekday_name }}</td>
                                        <td>{{ day_row.date_display }}</td>
                                        <td colspan="2">
                                            <strong>{{ day_row.leave_block.leave_type }}</strong>
                                        </td>
                                        <td>{{ day_row.leave_block.start_time or '-' }}</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>{{ day_row.leave_block.end_time or '-' }}</td>
                                        <td class="text-center">
                                            {% if day_row.leave_block.total_hours > 0 %}
                                            <strong>{{ "%.1f"|format(day_row.leave_block.total_hours) }}</strong>
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if day_row.leave_block.is_validated %}
                                            <span class="badge bg-success">Assenza Validata</span>
                                            {% else %}
                                            <span class="badge bg-warning text-dark">Assenza in Attesa</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if day_row.can_add_session and can_edit %}
                                            <button type="button" class="btn btn-sm btn-primary" onclick="addNewRow({{ day_row.day_num }})">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endif %}
                                    
                                    <!-- Mostra sessioni di lavoro -->
                                    {% for session in day_row.sessions %}
                                    <tr class="session-row {% if day_row.is_weekend %}table-secondary{% elif day_row.is_holiday %}table-info{% endif %}" 
                                        data-day="{{ day_row.day_num }}" 
                                        data-row-index="{{ loop.index0 }}">
                                        <!-- Giorno e Data solo sulla prima riga se non c'è assenza -->
                                        {% if loop.first and not day_row.leave_block %}
                                        <td>{{ day_row.weekday_name }}</td>
                                        <td>{{ day_row.date_display }}</td>
                                        {% else %}
                                        <td></td>
                                        <td></td>
                                        {% endif %}
                                        
                                        <!-- Commessa -->
                                        <td>
                                            <input type="hidden" name="rows[{{ day_row.day_num }}_{{ loop.index0 }}][session_id]" value="{{ session.session_id or '' }}">
                                            <input type="hidden" name="rows[{{ day_row.day_num }}_{{ loop.index0 }}][day]" value="{{ day_row.day_num }}">
                                            <input type="hidden" name="rows[{{ day_row.day_num }}_{{ loop.index0 }}][source]" value="{{ session.source }}">
                                            
                                            {% if active_commesse|length > 1 %}
                                            <select class="form-select form-select-sm" name="rows[{{ day_row.day_num }}_{{ loop.index0 }}][commessa_id]" 
                                                    {% if not session.is_editable or not can_edit %}disabled{% endif %}>
                                                <option value="">N/A</option>
                                                {% for commessa in active_commesse %}
                                                <option value="{{ commessa.id }}" {% if session.commessa_id == commessa.id %}selected{% endif %}>
                                                    {{ commessa.codice }} - {{ commessa.cliente }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            {% elif active_commesse|length == 1 %}
                                            <span class="text-muted">{{ active_commesse[0].codice }} - {{ active_commesse[0].cliente }}</span>
                                            <input type="hidden" name="rows[{{ day_row.day_num }}_{{ loop.index0 }}][commessa_id]" value="{{ active_commesse[0].id }}">
                                            {% else %}
                                            <span class="text-muted">N/A</span>
                                            <input type="hidden" name="rows[{{ day_row.day_num }}_{{ loop.index0 }}][commessa_id]" value="">
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Tipologia -->
                                        <td>
                                            <select class="form-select form-select-sm" name="rows[{{ day_row.day_num }}_{{ loop.index0 }}][attendance_type_id]" 
                                                    {% if not session.is_editable or not can_edit %}disabled{% endif %}>
                                                {% for type in attendance_types %}
                                                <option value="{{ type.id }}" {% if session.attendance_type_id == type.id %}selected{% endif %}>{{ type.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        
                                        <!-- Orari -->
                                        <td>
                                            <input type="time" class="form-control form-control-sm" 
                                                   name="rows[{{ day_row.day_num }}_{{ loop.index0 }}][clock_in]"
                                                   value="{{ session.clock_in }}"
                                                   {% if not session.is_editable or not can_edit %}readonly{% endif %}>
                                        </td>
                                        <td>
                                            <input type="time" class="form-control form-control-sm" 
                                                   name="rows[{{ day_row.day_num }}_{{ loop.index0 }}][break_start]"
                                                   value="{{ session.break_start }}"
                                                   {% if not session.is_editable or not can_edit %}readonly{% endif %}>
                                        </td>
                                        <td>
                                            <input type="time" class="form-control form-control-sm" 
                                                   name="rows[{{ day_row.day_num }}_{{ loop.index0 }}][break_end]"
                                                   value="{{ session.break_end }}"
                                                   {% if not session.is_editable or not can_edit %}readonly{% endif %}>
                                        </td>
                                        <td>
                                            <input type="time" class="form-control form-control-sm" 
                                                   name="rows[{{ day_row.day_num }}_{{ loop.index0 }}][clock_out]"
                                                   value="{{ session.clock_out }}"
                                                   {% if not session.is_editable or not can_edit %}readonly{% endif %}>
                                        </td>
                                        
                                        <!-- Tot Ore -->
                                        <td class="text-center">
                                            <strong>{{ "%.1f"|format(session.total_hours) }}</strong>
                                        </td>
                                        
                                        <!-- Stato -->
                                        <td>
                                            {% if session.source == 'auto' %}
                                            <span class="badge bg-primary">Automatico</span>
                                            {% elif session.source == 'manual' %}
                                            <span class="badge bg-secondary">Manuale</span>
                                            {% else %}
                                            <span class="badge bg-light text-dark">-</span>
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Azioni -->
                                        <td>
                                            {% if loop.first and day_row.can_add_session and can_edit %}
                                            <button type="button" class="btn btn-sm btn-primary" onclick="addNewRow({{ day_row.day_num }})">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            {% endif %}
                                            {% if session.can_delete and can_edit %}
                                            <button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    
                                    <!-- Se non ci sono sessioni E non c'è assenza, mostra riga vuota per giorni lavorativi -->
                                    {% if not day_row.sessions and not day_row.leave_block and not day_row.is_weekend and not day_row.is_holiday %}
                                    <tr class="session-row" data-day="{{ day_row.day_num }}">
                                        <td>{{ day_row.weekday_name }}</td>
                                        <td>{{ day_row.date_display }}</td>
                                        <td colspan="7" class="text-center text-muted">
                                            <em>Nessuna presenza registrata</em>
                                        </td>
                                        <td>-</td>
                                        <td>
                                            {% if day_row.can_add_session and can_edit %}
                                            <button type="button" class="btn btn-sm btn-primary" onclick="addNewRow({{ day_row.day_num }})">
                                                <i class="fas fa-plus"></i> Aggiungi
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template nascosto per nuove righe -->
<table style="display:none;">
    <tbody id="rowTemplate">
        <tr class="session-row new-row" data-row-index="NEW">
            <td></td>
            <td></td>
            <td>
                <input type="hidden" name="NEW_session_id" value="">
                <input type="hidden" name="NEW_day" value="">
                <input type="hidden" name="NEW_source" value="manual">
                
                {% if active_commesse|length > 1 %}
                <select class="form-select form-select-sm" name="NEW_commessa_id">
                    <option value="">N/A</option>
                    {% for commessa in active_commesse %}
                    <option value="{{ commessa.id }}">{{ commessa.codice }} - {{ commessa.cliente }}</option>
                    {% endfor %}
                </select>
                {% elif active_commesse|length == 1 %}
                <span class="text-muted">{{ active_commesse[0].codice }} - {{ active_commesse[0].cliente }}</span>
                <input type="hidden" name="NEW_commessa_id" value="{{ active_commesse[0].id }}">
                {% else %}
                <span class="text-muted">N/A</span>
                <input type="hidden" name="NEW_commessa_id" value="">
                {% endif %}
            </td>
            <td>
                <select class="form-select form-select-sm" name="NEW_attendance_type_id">
                    {% for type in attendance_types %}
                    <option value="{{ type.id }}" {% if type.is_default %}selected{% endif %}>{{ type.name }}</option>
                    {% endfor %}
                </select>
            </td>
            <td><input type="time" class="form-control form-control-sm" name="NEW_clock_in"></td>
            <td><input type="time" class="form-control form-control-sm" name="NEW_break_start"></td>
            <td><input type="time" class="form-control form-control-sm" name="NEW_break_end"></td>
            <td><input type="time" class="form-control form-control-sm" name="NEW_clock_out"></td>
            <td class="text-center"><strong>-</strong></td>
            <td><span class="badge bg-warning text-dark">Nuova</span></td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    </tbody>
</table>

<script>
const CAN_EDIT = {{ 'true' if can_edit else 'false' }};
let rowCounter = 0;

function addNewRow(day) {
    if (!CAN_EDIT) {
        alert('Timesheet consolidato, non modificabile');
        return;
    }
    
    // Clona il template
    const template = document.getElementById('rowTemplate').querySelector('tr').cloneNode(true);
    const uniqueId = `new_${day}_${rowCounter++}`;
    
    // Imposta il giorno PRIMA di modificare i nomi
    const dayInput = template.querySelector('[name="NEW_day"]');
    if (dayInput) {
        dayInput.value = day;
    }
    
    // Aggiorna tutti i name attributes con l'ID univoco
    template.querySelectorAll('[name^="NEW_"]').forEach(input => {
        const oldName = input.getAttribute('name');
        // NEW_session_id -> rows[uniqueId][session_id]
        const fieldName = oldName.substring(4); // Rimuove "NEW_"
        const newName = `rows[${uniqueId}][${fieldName}]`;
        input.setAttribute('name', newName);
    });
    
    template.setAttribute('data-day', day);
    template.classList.add('can-delete');
    
    // Trova l'ultima riga del giorno e inserisci dopo
    const table = document.getElementById('attendanceTable').querySelector('tbody');
    const dayRows = Array.from(table.querySelectorAll(`tr[data-day="${day}"]`));
    
    if (dayRows.length > 0) {
        const lastRow = dayRows[dayRows.length - 1];
        lastRow.after(template);
    } else {
        // Non dovrebbe succedere, ma come fallback
        table.appendChild(template);
    }
}

function removeRow(button) {
    if (!CAN_EDIT) {
        alert('Timesheet consolidato, non modificabile');
        return;
    }
    
    const row = button.closest('tr');
    
    if (row.classList.contains('new-row')) {
        // Righe nuove non salvate: rimuovi semplicemente dal DOM
        row.remove();
    } else {
        // Righe salvate (manuali): marca per cancellazione
        const sessionIdInput = row.querySelector('input[name*="[session_id]"]');
        if (sessionIdInput && sessionIdInput.value) {
            // Aggiungi un campo hidden per segnalare la cancellazione
            const deleteInput = document.createElement('input');
            deleteInput.type = 'hidden';
            deleteInput.name = sessionIdInput.name.replace('[session_id]', '[delete]');
            deleteInput.value = 'true';
            row.appendChild(deleteInput);
            
            // Nascondi visualmente la riga
            row.style.opacity = '0.3';
            row.style.textDecoration = 'line-through';
            
            // Disabilita il pulsante cancella
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-check"></i> Eliminata';
            button.classList.remove('btn-danger');
            button.classList.add('btn-secondary');
        }
    }
}

function saveAllSessions() {
    if (!CAN_EDIT) {
        alert('Timesheet consolidato, non modificabile');
        return;
    }
    
    if (!confirm('Salvare tutte le modifiche al timesheet?')) {
        return;
    }
    
    showLoadingOverlay('Salvataggio in corso...');
    document.getElementById('attendanceForm').submit();
}

function consolidateTimesheet() {
    if (!confirm('Sei sicuro di voler consolidare questo timesheet? Dopo la consolidazione non potrai più modificarlo.')) {
        return;
    }
    
    showLoadingOverlay('Consolidamento in corso...');
    
    // Ottieni il token CSRF dal form
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    
    fetch("{{ url_for('attendance.consolidate_timesheet') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            year: {{ year }},
            month: {{ month }}
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoadingOverlay();
        if (data.success) {
            alert(data.message);
            window.location.reload();
        } else {
            alert('Errore: ' + data.message);
        }
    })
    .catch(error => {
        hideLoadingOverlay();
        alert('Errore di connessione: ' + error);
    });
}

function bulkFillTimesheet() {
    if (!CAN_EDIT) {
        alert('Timesheet consolidato, non modificabile');
        return;
    }
    
    if (!confirm('Compilare automaticamente tutti i giorni vuoti con gli orari standard del tuo orario di lavoro?\n\nVerranno saltati: weekend, festività, giorni con assenze approvate e giorni già compilati.')) {
        return;
    }
    
    showLoadingOverlay('Compilazione automatica in corso...');
    
    // Ottieni il token CSRF dal form
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    
    fetch("{{ url_for('attendance.bulk_fill_sessions') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            year: {{ year }},
            month: {{ month }}
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoadingOverlay();
        if (data.success) {
            alert(data.message);
            window.location.reload();
        } else {
            alert('Errore: ' + data.message);
        }
    })
    .catch(error => {
        hideLoadingOverlay();
        alert('Errore di connessione: ' + error);
    });
}

function showLoadingOverlay(message) {
    const overlay = document.getElementById('loadingOverlay');
    document.getElementById('loadingText').textContent = message;
    overlay.style.display = 'flex';
}

function hideLoadingOverlay() {
    document.getElementById('loadingOverlay').style.display = 'none';
}
</script>
{% endblock %}
